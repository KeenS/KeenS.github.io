<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
    <head>
        
        
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-43779888-1"></script>
        <script>
         window.dataLayer = window.dataLayer || [];
         function gtag(){dataLayer.push(arguments);}
         gtag('js', new Date());

         gtag('config', 'UA-43779888-1');
        </script>
        

        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

        <meta name="twitter:card" content="summary" />
        <meta name="twitter:site" content="@blackenedgold" />
        <meta name="twitter:title" content="コンパイラの人からみたWebAssembly | κeenのHappy Hacκing Blog"/>
        <meta name="twitter:description" content="コンパイラ勉強会での発表用" />

        <title>コンパイラの人からみたWebAssembly | κeenのHappy Hacκing Blog</title>
        <link rel="stylesheet" href="//KeenS.github.io/reveal.js/css/reveal.css">
        <link rel='stylesheet' href='//fonts.googleapis.com/css?family=Open+Sans:400,300,600' type='text/css'>
        <link rel="stylesheet" href="//KeenS.github.io/libraries/normalize.3.0.1.css" />
        <link rel="stylesheet" href="//KeenS.github.io/css/liquorice.css" />
        <link rel="stylesheet" href="//KeenS.github.io/highlight.js/styles/agate.css">
        <link rel="stylesheet" href="//KeenS.github.io/css/cleanveal.css" type="text/css" />
        <link rel="apple-touch-icon" sizes="180x180" href="//KeenS.github.io/apple-touch-icon.png">
        <link rel="icon" type="image/png" href="//KeenS.github.io/favicon-32x32.png" sizes="32x32">
        <link rel="icon" type="image/png" href="//KeenS.github.io/favicon-16x16.png" sizes="16x16">
        <link rel="manifest" href="//KeenS.github.io/manifest.json">
        <link rel="mask-icon" href="//KeenS.github.io/safari-pinned-tab.svg" color="#5bbad5">
        <link rel="apple-touch-icon-precomposed" href="//KeenS.github.io/apple-touch-icon-144-precomposed.png" sizes="144x144" />
        <link rel="alternate" href="" type="application/rss+xml" title="κeenのHappy Hacκing Blog" />
        
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
        <script>
         if( window.location.search.match( /print-pdf/gi ) ) {
             var link = document.createElement( 'link' );
             link.rel = 'stylesheet';
             link.type = 'text/css';
             link.href = '\/\/KeenS.github.io\/reveal.js/css/print/pdf.css';
             document.getElementsByTagName( 'head' )[0].appendChild( link );
         }
        </script>
        
    </head>
    <body class="li-body">

<header class="li-page-header" id="page-header">
    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <div class="li-brand li-left">
                <a href="//KeenS.github.io/">κeenのHappy Hacκing Blog</a> | Lispエイリアンの狂想曲</div>
                <div class="li-menu li-right">
                    <span class="li-menu-icon" onclick="javascript:toggle('menu');">&#9776;</span>
                    <ul id="menu2" class="li-menu-items">
                        
                            <li><a href="//KeenS.github.io/about/"> About </a></li>
                        
                            <li><a href="//KeenS.github.io/index.xml"> Atom </a></li>
                        
                            <li><a href="//KeenS.github.io/post/"> Blog </a></li>
                        
                            <li><a href="//KeenS.github.io/slide/"> Slide </a></li>
                        
                    </ul>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="sixteen columns">
                <ul id="menu" class="li-menu-items li-menu-mobile">
                    
                        <li><a href="//KeenS.github.io/about/"> About </a></li>
                    
                        <li><a href="//KeenS.github.io/index.xml"> Atom </a></li>
                    
                        <li><a href="//KeenS.github.io/post/"> Blog </a></li>
                    
                        <li><a href="//KeenS.github.io/slide/"> Slide </a></li>
                    
                </ul>
            </div>
        </div>
    </div>
</header>






<article id="article-container" class="li-article" style="height: 100%">
    <header id="article-header" class="li-article-header" style="position:fixed;z-index:10;">
        <h1 class="li-article-title">コンパイラの人からみたWebAssembly</h1>
        <div class="li-article-meta">
    <time class="li-article-date">2017-01-22</time>
    <ul class="li-article-tag">
    
        <li>
            <a href="//KeenS.github.io/categories/webassembly">WebAssembly</a>
        </li>
    
        <li>
            <a href="//KeenS.github.io/categories/compiler">compiler</a>
        </li>
    
</ul>

</div>

    </header>
    <div class="reveal">
        <div class="slides">
            <!-- raw HTML omitted -->
<h1 id="webassembly">コンパイラの人からみたWebAssembly</h1>
<hr>
<p><a href="https://connpass.com/event/46850/">コンパイラ勉強会 - connpass</a></p>
<!-- raw HTML omitted -->
<p>===</p>
<h1 id="about-me">About Me</h1>
<hr>
<p><img src="//KeenS.github.io/images/kappa.png" alt="κeenのアイコン"> <!-- raw HTML omitted --></p>
<ul>
<li>κeen</li>
<li><a href="https://twitter.com/blackenedgold">@blackenedgold</a></li>
<li>Github: <a href="https://github.com/KeenS">KeenS</a></li>
<li><a href="https://idein.jp/">Idein Inc.</a>のエンジニア</li>
<li>Lisp, ML, Rust, Shell Scriptあたりを書きます</li>
</ul>
<p>===</p>
<h1 id="heading">アジェンダ</h1>
<hr>
<ul>
<li>WebAssemblyの概要</li>
<li>具体的な話</li>
<li>WebAssembly吐こうとした話</li>
</ul>
<p>===</p>
<h1 id="webassembly1">WebAssemblyの概要</h1>
<!-- raw HTML omitted -->
<p>===</p>
<h1 id="javascript">JavaScript</h1>
<hr>
<ul>
<li>ブラウザ上で動くスクリプト言語</li>
<li>動的型付</li>
<li>高級</li>
<li>GCとかある</li>
<li>今までブラウザで動く唯一の言語だった</li>
<li>遅い
<ul>
<li>各ブラウザJITなどで補強</li>
</ul>
</li>
</ul>
<p>===</p>
<h1 id="asmjshttpasmjsorg"><a href="http://asmjs.org/">asm.js</a></h1>
<hr>
<ul>
<li>プラウザ上で動く言語</li>
<li>低級</li>
<li>GCなし</li>
<li>JSのサブセット
<ul>
<li>asm.jsをサポートしないプラウザでも動かせる</li>
</ul>
</li>
<li>コンパイラから生成されることを想定
<ul>
<li>emscriptenなど</li>
</ul>
</li>
</ul>
<p>===</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">geometricMean</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span> <span class="nx">end</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">start</span> <span class="o">=</span> <span class="nx">start</span><span class="o">|</span><span class="mi">0</span><span class="p">;</span> <span class="c1">// start has type int
</span><span class="c1"></span>  <span class="nx">end</span> <span class="o">=</span> <span class="nx">end</span><span class="o">|</span><span class="mi">0</span><span class="p">;</span>     <span class="c1">// end has type int
</span><span class="c1"></span>  <span class="k">return</span> <span class="o">+</span><span class="nx">exp</span><span class="p">(</span><span class="o">+</span><span class="nx">logSum</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span> <span class="nx">end</span><span class="p">)</span> <span class="o">/</span> <span class="o">+</span><span class="p">(</span><span class="p">(</span><span class="nx">end</span> <span class="o">-</span> <span class="nx">start</span><span class="p">)</span><span class="o">|</span><span class="mi">0</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">...</span>
</code></pre></div><p>===</p>
<h1 id="asmjs">asm.jsの問題点</h1>
<hr>
<ul>
<li>JS互換文法なため嵩張る</li>
<li>パースも遅い</li>
<li>そもそもコンパイラが吐くならバイナリでも良いのでは？</li>
</ul>
<p>===</p>
<h1 id="webassembly2">WebAssembly</h1>
<hr>
<ul>
<li>ブラウザ上で動く言語
<ul>
<li>仮想機械命令？</li>
</ul>
</li>
<li>低級</li>
<li>バイナリフォーマット
<ul>
<li>ロード、パース時間が短かい</li>
<li>パース20倍くらい速いらしい</li>
</ul>
</li>
<li>wasm32とwasm64がある</li>
<li>セマンティクスは（今のところ）ams.jsをほぼ踏襲
<ul>
<li>実行エンジンは既存のものを使える</li>
</ul>
</li>
<li>将来SIMD、スレッドなどの拡張が入る</li>
</ul>
<p>===</p>
<h1 id="wasm">WASMのゴール</h1>
<hr>
<ul>
<li>ポータブルでコンパクトで速い</li>
<li>仕様策定と実装をインクリメンタルにやっていく
<ul>
<li>今はとりあえずC/C++をターゲットに</li>
</ul>
</li>
<li>既存のJS環境と協調する
<ul>
<li>JSとの相互呼び出しとか</li>
</ul>
</li>
<li>ブラウザ以外への組込みもサポート
<ul>
<li>Node.jsとか</li>
</ul>
</li>
<li>プラットフォームになる
<ul>
<li>ツール類のサポートとか</li>
</ul>
</li>
</ul>
<p>===</p>
<h1 id="webassembly3">なぜWebAssembly?</h1>
<hr>
<ul>
<li>実行までのレイテンシが短かい</li>
<li>asm.jsより速度を出しやすい設計</li>
<li>クライアントヘビーにしやすい？</li>
<li><strong>JSを補完する存在</strong></li>
<li>non-determinismが少ない</li>
<li>LLVM IRと比べてデコードが速くてコンパクト</li>
<li>(<strong>code generator IR</strong> vs optimization IR)</li>
<li>余計なことをしない
<ul>
<li>fast mathとかはない</li>
<li>既に最適化されたコードが吐かれる前提</li>
</ul>
</li>
</ul>
<p>===</p>
<h1 id="webassembly4">WebAssemblyの現状</h1>
<hr>
<ul>
<li>Minimum Viable Product(MVP)</li>
<li>機能を削ってとりあえず動くものを作ってる</li>
<li>今はC/C++からLLVMを通して吐けるのが目標</li>
<li>今後SIMDとかスレッドとかDOM APIとか増えていく</li>
<li>ChromeとFirefoxでオプトインで使える
<ul>
<li>そろそろFirefoxで普通に動く</li>
</ul>
</li>
</ul>
<p>===</p>
<h1 id="heading1">具体的な話</h1>
<!-- raw HTML omitted -->
<p>===</p>
<h1 id="heading2">セマンティクス</h1>
<hr>
<ul>
<li><a href="https://github.com/WebAssembly/spec">https://github.com/WebAssembly/spec</a></li>
<li>形式的定義されている</li>
<li>実行以外にも静的バリデーションもある</li>
<li>1ファイル1モジュール
<ul>
<li>JSのモジュールと同じ概念</li>
</ul>
</li>
</ul>
<p>===</p>
<h1 id="heading3">実行モデル</h1>
<hr>
<ul>
<li>i32,i64,f32,f64のみ
<ul>
<li>bitエンコーディングは指定</li>
</ul>
</li>
<li>スタックマシン
<ul>
<li>命令のオペランドや関数の引数はスタック経由で渡す</li>
<li>バイナリがコンパクト+雑にコンパイルしても速い</li>
</ul>
</li>
<li>無限のローカル変数が使える
<ul>
<li>型がある</li>
</ul>
</li>
<li>関数の引数はローカル変数経由で渡される</li>
<li>コントロールフローはgotoじゃなくてstructured
<ul>
<li>静的検証がしやすい</li>
</ul>
</li>
</ul>
<p>===</p>
<h1 id="wasmwast">wasm、wast</h1>
<hr>
<ul>
<li>バイナリフォーマットだけでは人間が読めない</li>
<li>テキストフォーマットも欲しい</li>
<li>バイナリ: wasm
<ul>
<li>コンパクト</li>
<li>intとかもパッキングする</li>
</ul>
</li>
<li>テキスト: wast
<ul>
<li>人間可読+機械可読=S式</li>
<li>低級にもちょっと高級にも書ける</li>
</ul>
</li>
</ul>
<p>===</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">geometricMean</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span> <span class="nx">end</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">start</span> <span class="o">=</span> <span class="nx">start</span><span class="o">|</span><span class="mi">0</span><span class="p">;</span> <span class="c1">// start has type int
</span><span class="c1"></span>  <span class="nx">end</span> <span class="o">=</span> <span class="nx">end</span><span class="o">|</span><span class="mi">0</span><span class="p">;</span>     <span class="c1">// end has type int
</span><span class="c1"></span>  <span class="k">return</span> <span class="o">+</span><span class="nx">exp</span><span class="p">(</span><span class="o">+</span><span class="nx">logSum</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span> <span class="nx">end</span><span class="p">)</span> <span class="o">/</span> <span class="o">+</span><span class="p">(</span><span class="p">(</span><span class="nx">end</span> <span class="o">-</span> <span class="nx">start</span><span class="p">)</span><span class="o">|</span><span class="mi">0</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">...</span>
</code></pre></div><p>===</p>
<pre><code class="language-wasm" data-lang="wasm">(module
  (type (;0;) (func (param i64 i64) (result f64)))
  (type (;1;) (func (param i64 i64) (result f64)))
  (type (;2;) (func (param f64) (result f64)))
  (func (;0;) (type 0) (param i64 i64) (result f64)
    (get_local 0)
    (get_local 1)
    (call 1)
    (get_local 1)
    (get_local 0)
    (i64.sub)
    (f64.convert_s/i64)
    (f64.div)
    (call 2))
  ...)
</code></pre><p>===</p>
<pre><code class="language-wasm" data-lang="wasm">(module
  (type (;0;) (func (param i64 i64) (result f64)))
  (type (;1;) (func (param i64 i64) (result f64)))
  (type (;2;) (func (param f64) (result f64)))
  (func (;0;) (type 0) (param i64 i64) (result f64)
    (call 2
      (f64.div
       (call 1 (get_local 0) (get_local 1))
       (f64.convert_s/i64
        (i64.sub
         (get_local 1)
         (get_local 0))))))
  ...)
</code></pre><p>===</p>
<pre><code>0000000: 0061 736d                                 ; WASM_BINARY_MAGIC
0000004: 0d00 0000                                 ; WASM_BINARY_VERSION
; section &quot;TYPE&quot; (1)
0000008: 01                                        ; section code
0000009: 00                                        ; section size (guess)
000000a: 03                                        ; num types
; type 0
000000b: 60                                        ; func
000000c: 02                                        ; num params
000000d: 7e                                        ; i64
000000e: 7e                                        ; i64
000000f: 01                                        ; num results
0000010: 7c                                        ; f64
; type 1
0000011: 60                                        ; func
0000012: 02                                        ; num params
0000013: 7e                                        ; i64
0000014: 7e                                        ; i64
0000015: 01                                        ; num results
0000016: 7c                                        ; f64
; type 2
0000017: 60                                        ; func
0000018: 01                                        ; num params
0000019: 7c                                        ; f64
000001a: 01                                        ; num results
000001b: 7c                                        ; f64
0000009: 12                                        ; FIXUP section size
; section &quot;FUNCTION&quot; (3)
000001c: 03                                        ; section code
000001d: 00                                        ; section size (guess)
000001e: 03                                        ; num functions
000001f: 00                                        ; function 0 signature index
0000020: 01                                        ; function 1 signature index
0000021: 02                                        ; function 2 signature index
000001d: 04                                        ; FIXUP section size
; section &quot;CODE&quot; (10)
000002e: 0a                                        ; section code
000002f: 00                                        ; section size (guess)
0000030: 03                                        ; num functions
; function body 0
0000031: 00                                        ; func body size (guess)
0000032: 00                                        ; local decl count
0000033: 20                                        ; get_local
0000034: 00                                        ; local index
0000035: 20                                        ; get_local
0000036: 01                                        ; local index
0000037: 10                                        ; call
0000038: 01                                        ; func index
0000039: 20                                        ; get_local
000003a: 01                                        ; local index
000003b: 20                                        ; get_local
000003c: 00                                        ; local index
000003d: 7d                                        ; i64.sub
000003e: b9                                        ; f64.convert_s/i64
000003f: a3                                        ; f64.div
0000040: 10                                        ; call
0000041: 02                                        ; func index
0000042: 0b                                        ; end
0000031: 11                                        ; FIXUP func body size
...
</code></pre><p>===</p>
<h1 id="js-api">JS API</h1>
<hr>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">importObj</span> <span class="o">=</span> <span class="p">{</span><span class="nx">js</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">import1</span><span class="o">:</span> <span class="p">(</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;hello,&#34;</span><span class="p">)</span><span class="p">,</span>
    <span class="nx">import2</span><span class="o">:</span> <span class="p">(</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;world!&#34;</span><span class="p">)</span>
<span class="p">}</span><span class="p">}</span><span class="p">;</span>
<span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;demo.wasm&#39;</span><span class="p">)</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span> <span class="p">=&gt;</span>
    <span class="nx">response</span><span class="p">.</span><span class="nx">arrayBuffer</span><span class="p">(</span><span class="p">)</span>
<span class="p">)</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">buffer</span> <span class="p">=&gt;</span>
    <span class="nx">WebAssembly</span><span class="p">.</span><span class="nx">instantiate</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="nx">importObj</span><span class="p">)</span>
<span class="p">)</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="p">(</span><span class="p">{</span><span class="nx">module</span><span class="p">,</span> <span class="nx">instance</span><span class="p">}</span><span class="p">)</span> <span class="p">=&gt;</span>
    <span class="nx">instance</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">f</span><span class="p">(</span><span class="p">)</span>
</code></pre></div><p>===</p>
<h1 id="heading4">メモリ</h1>
<hr>
<ul>
<li>メモリアドレスが0から始まって飛びのない <strong>リニアメモリ</strong>
<ul>
<li>命令で伸び縮み出来る</li>
<li>将来複数のリニアメモリとか出てくるかも</li>
</ul>
</li>
<li>メモリサイズは32bit(wasm32)か64bit(wasm64)が選べる
<ul>
<li>現状はwasm32のみ</li>
<li>1つのモジュールでメモリ4GiBバイトも使わないから普通は32bitで十分</li>
</ul>
</li>
<li>アドレッシングは <code>アドレス+オフセット</code></li>
<li>アラインメントは必須ではない（した方が速い）</li>
<li>コード列のメモリは見えない</li>
<li>スタックスキャンも出来ない</li>
</ul>
<p>===</p>
<h1 id="heading5">例外とか</h1>
<hr>
<ul>
<li>Trap &ndash; WebAssemblyのインスタンスが異常終了する
<ul>
<li>例えばメモリの範囲外アクセスとか</li>
</ul>
</li>
<li>スタックオーバーフロー
<ul>
<li>オーバーフローするとインスタンスが異常終了する</li>
<li>処理系/環境毎にスタック長は違う
<ul>
<li>non-determinism</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>===</p>
<h1 id="heading6">テーブル</h1>
<hr>
<ul>
<li>要素の配列的なもの
<ul>
<li>整数インデックスでアクセス出来る</li>
</ul>
</li>
<li>今のところ関数を入れてindrect callするため</li>
<li>将来的にはOSのハンドラとかGCの参照とか</li>
</ul>
<p>===</p>
<h1 id="heading7">ローカル変数</h1>
<hr>
<ul>
<li>無限にある型付きストレージ</li>
<li>0 初期化</li>
<li>関数の引数もローカル変数に入る</li>
</ul>
<p>===</p>
<h1 id="heading8">グローバル変数</h1>
<hr>
<ul>
<li>型付きストレージ</li>
<li>可変/不変がある</li>
<li>不変Globにsetするとvalidationエラー</li>
<li>リニアメモリとは違うメモリ領域</li>
</ul>
<p>===</p>
<h1 id="import--export">import / export</h1>
<hr>
<ul>
<li>他のモジュールから色々インポート出来る</li>
<li>関数</li>
<li>テーブル</li>
<li>グローバル変数</li>
<li>リニアメモリ</li>
<li>勿論exportも</li>
</ul>
<p>===</p>
<h1 id="heading9">一旦まとめ</h1>
<hr>
<ul>
<li>WASMは1ファイル1モジュール</li>
<li>WASMには以下がある
<ul>
<li>関数
<ul>
<li>関数内ローカル変数</li>
</ul>
</li>
<li>リニアメモリ</li>
<li>グローバル変数</li>
<li>テーブル</li>
<li>importテーブル</li>
<li>exportテーブル</li>
</ul>
</li>
</ul>
<p>===</p>
<h1 id="heading10">命令の話</h1>
<hr>
<ul>
<li>コントロールフロー</li>
<li>Call</li>
<li>パラメトリック</li>
<li>変数アクセス</li>
<li>メモリ関連</li>
<li>定数</li>
<li>比較</li>
<li>数値</li>
<li>変換</li>
<li>再解釈</li>
</ul>
<p>===</p>
<h1 id="heading11">コントロールフロー</h1>
<hr>
<ul>
<li><code>loop</code> + <code>br</code> (名前付き)</li>
<li><code>block</code> + <code>br</code> (名前付き)</li>
<li><code>br_if</code> or <code>br_table</code></li>
<li><code>if</code> + <code>else</code> + <code>end</code></li>
<li><code>return</code></li>
<li>等</li>
</ul>
<p>===</p>
<h1 id="heading12">コントロールフロー</h1>
<hr>
<ul>
<li>gotoがない
<ul>
<li><code>br</code> はブランチじゃなくてブレイク</li>
</ul>
</li>
<li>gotoからstructuredに<a href="https://github.com/kripken/emscripten/blob/master/docs/paper.pdf">変換出来る</a>
<ul>
<li>loop, block, br, br_ifを使う</li>
</ul>
</li>
<li>高級言語から変換するなら <code>if</code> を使う
<ul>
<li>ifが2系統あることになる</li>
</ul>
</li>
</ul>
<p>===</p>
<h1 id="call">Call</h1>
<hr>
<ul>
<li><code>call</code></li>
<li><code>call_indirect</code>
<ul>
<li>関数テーブルを使った呼び出し</li>
<li>ダイナミックな関数ディスパッチに</li>
</ul>
</li>
</ul>
<p>===</p>
<h1 id="heading13">パラメトリック</h1>
<hr>
<ul>
<li><code>drop</code></li>
<li><code>select</code>
<ul>
<li>三項演算子相当</li>
</ul>
</li>
</ul>
<p>===</p>
<h1 id="heading14">変数アクセス</h1>
<hr>
<ul>
<li><code>get/set_local</code></li>
<li><code>get/set_global</code></li>
<li><code>tee_local</code>
<ul>
<li>スタックに値を残しつつset</li>
</ul>
</li>
</ul>
<p>===</p>
<h1 id="heading15">メモリ関連</h1>
<hr>
<ul>
<li><code>{i,f}{32,64}.load{,8,16,32,64}{,_s,_u}</code></li>
<li><code>{i,f}{32,64}.store{,8,16,32}</code></li>
<li><code>current_memory</code></li>
<li><code>grow_memory</code>
<ul>
<li>メモリを増やす命令もある</li>
</ul>
</li>
</ul>
<p>===</p>
<h1 id="heading16">定数</h1>
<hr>
<ul>
<li><code>{i,f}{32,64}.const</code></li>
</ul>
<p>===</p>
<h1 id="heading17">比較</h1>
<hr>
<ul>
<li>各種 <code>eq</code>, <code>eqz</code>, <code>ne`,</code>lt<code>, </code>le<code>, </code>gt<code>, </code>ge`</li>
</ul>
<p>===</p>
<h1 id="heading18">数値</h1>
<hr>
<ul>
<li>四則(<code>i32.add</code>とか)</li>
<li>論理(<code>i64.popcnt</code>とか)</li>
<li>丸め,最{大,小}(<code>f32.ceil</code>とか)</li>
<li>ルート(<code>f64.sqrt</code>とか)</li>
</ul>
<p>===</p>
<h1 id="heading19">変換</h1>
<hr>
<ul>
<li><code>f32.convert_s/i32</code>とか</li>
<li><code>i32.wrap/i64</code>とか</li>
</ul>
<p>===</p>
<h1 id="heading20">再解釈</h1>
<hr>
<ul>
<li><code>i32.reinterpret/f32</code>とか</li>
<li>ビットキャスト</li>
<li>ビットエンコーディングが定まってるのでwell-defined</li>
</ul>
<p>===</p>
<h1 id="wasm1">WASM吐こうとした話</h1>
<!-- raw HTML omitted -->
<p>===</p>
<h1 id="heading21">作ったやつ</h1>
<hr>
<ul>
<li>なんかコンパイラ作ろうと思い立った</li>
<li><a href="https://github.com/KeenS/webml">KeenS/webml: An ML like toy language compiler</a></li>
<li>とりあえずSMLのサブセット</li>
<li>Rust製</li>
<li>未完成
<ul>
<li>正月気抜いてたら進捗ダメでした</li>
</ul>
</li>
</ul>
<p>===</p>
<h1 id="heading22">やりたかったこと</h1>
<hr>
<ul>
<li>ブラウザで動くコンパイラ作ってみたい
<ul>
<li>Rustはemscripten通せる</li>
</ul>
</li>
<li>WebAssembly面白そう</li>
<li>SML処理系作りたかった</li>
<li>最適化書く練習</li>
</ul>
<p>===</p>
<h1 id="heading23">中身</h1>
<hr>
<ul>
<li>パーサ、AST, HIR, MIR, LIR</li>
<li>LIRがレジスタマシンなのでそれをWASMに変換したい</li>
<li>オンメモリで生成するためにアセンブラ自作
<ul>
<li><a href="https://github.com/KeenS/WebAssembler-rs">KeenS/WebAssembler-rs: An in memory wasm assembler for Rust</a></li>
<li>ブラウザで動かすのに必要</li>
</ul>
</li>
<li>最適化はまだ</li>
</ul>
<p>===</p>
<h1 id="heading24">コード生成</h1>
<hr>
<ul>
<li>(ほぼ)SSAの1変数 = 1ローカル変数
<ul>
<li>どうせエンジン側でレジスタ割り当てするでしょ</li>
</ul>
</li>
<li>スタックはほぼ使わない</li>
<li>gotoを構造化制御フローにする
<ul>
<li>一応出来る</li>
<li><a href="https://github.com/kripken/emscripten/blob/master/docs/paper.pdf">Reloop</a></li>
<li>何言ってるのかよく分からない</li>
<li>ステートマシンは勿論可能</li>
</ul>
</li>
<li>→自分で考えた</li>
<li>なんかつらいので詳解します</li>
<li>みんな基本ブロックとCFGは分かるかな？</li>
</ul>
<p>===</p>
<h1 id="block">blockと前方ジャンプ</h1>
<hr>
<ul>
<li><code>block</code> + <code>break</code> で前方ジャンプ</li>
<li>閉じ括弧の位置にジャンプ</li>
<li><code>block</code> の位置は自由</li>
</ul>
<p>===</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>===</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>===</p>
<h1 id="loop">loopと前方ジャンプ</h1>
<hr>
<ul>
<li><code>loop</code> + <code>break</code>で後方ジャンプ
<ul>
<li><code>loop</code> からの <code>break</code> はいわゆる <code>continue</code></li>
</ul>
</li>
<li>開き括弧の位置にジャンプ</li>
<li>閉じ括弧の位置は自由</li>
</ul>
<p>===</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>===</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>===</p>
<h1 id="heading25">ジャンプのクロス</h1>
<hr>
<ul>
<li>単一gotoは割り当て出来る</li>
<li>複数のgotoが入り組んだら？</li>
</ul>
<p>===</p>
<h1 id="heading26">前前</h1>
<hr>
<pre><code>   [ ]--+
    |   |
+--[ ]  |
|   |   |
|  [ ]&lt;-+
|   |
+-&gt;[ ]
</code></pre><p>===</p>
<h1 id="heading27">前前</h1>
<hr>
<pre><code>(block
  (block
    ...
    (br 0)-+
    ...    |
    (br 1)-+-+
  )&lt;-------+ |
)&lt;-----------+
</code></pre><p>===</p>
<h1 id="heading28">後後</h1>
<hr>
<pre><code>   [ ]&lt;-+
    |   |
+-&gt;[ ]  |
|   |   |
|  [ ]--+
|   |
+--[ ]
</code></pre><p>===</p>
<h1 id="heading29">後後</h1>
<hr>
<pre><code>(loop&lt;-----+
  (loop&lt;---+-+
    ...    | |
    (br 1)-+ |
    ...      |
    (br 0)---+
  )
)
</code></pre><p>===</p>
<h1 id="heading30">後前</h1>
<hr>
<pre><code>   [ ]&lt;-+
    |   |
+--[ ]  |
|   |   |
|  [ ]--+
|   |
+-&gt;[ ]
</code></pre><p>===</p>
<h1 id="heading31">後前</h1>
<hr>
<pre><code>(block
  (loop&lt;---+
    ...    |
    (br 1)-+-+
    ...    | |
    (br 0)-+ |
  )          |
)&lt;-----------+
</code></pre><p>===</p>
<h1 id="heading32">前後</h1>
<hr>
<pre><code>   [ ]--+
    |   |
+-&gt;[ ]  |
|   |   |
|  [ ]&lt;-+
|   |
+--[ ]
</code></pre><p>===</p>
<h1 id="heading33">前後</h1>
<hr>
<ul>
<li>出来ない…？</li>
<li>部分的にステートマーシン作る？</li>
<li>ブロック組み換えたら出来る…？</li>
<li>emscriptenはステートマシンっぽい？</li>
<li>どうすればいいか不明</li>
<li>もはやCPS変換して全部Callにする？
<ul>
<li>Compiling With Continuations!!!</li>
</ul>
</li>
</ul>
<p>===</p>
<h1 id="heading34">アルゴリズム</h1>
<hr>
<ol>
<li>loopを良い感じに割り当てる</li>
</ol>
<ul>
<li>最初はジャンプ位置と一番最後のgotoで作って、境界がクロスしないようにendを伸ばす</li>
</ul>
<ol start="2">
<li>blockを外側のloopめいっぱい使って割り当てる</li>
</ol>
<ul>
<li>loopと同じく最小に割り当てて、blockをloopまで伸ばす</li>
</ul>
<p>===</p>
<h1 id="heading35">ランタイム</h1>
<hr>
<ul>
<li>スタック走査出来ない</li>
<li>GC書けないのでは？？？</li>
<li>今のところターゲットはC/C++なので問題ない</li>
<li>将来はGC Integration入るかも</li>
</ul>
<p>===</p>
<h1 id="heading36">現状の解</h1>
<hr>
<ol>
<li>メモリの自動管理を諦める</li>
<li>リージョン推論や線形型で静的管理する</li>
<li>スタックを使わないコードにする</li>
</ol>
<ul>
<li>Compiling With Continuations!!!</li>
</ul>
<p>===</p>
<h1 id="heading37">まとめ</h1>
<hr>
<ul>
<li>ブラウザでアセンブリっぽいコードが動くよ</li>
<li>バイナリはコンパクトだよ</li>
<li>コントロールフロー難しいよ</li>
<li>ランタイム難しいよ</li>
<li>Compiling With Continuations</li>
</ul>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->

        </div>
    </div>
</article>

<footer class="li-page-footer">
    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <div class="li-page-footer-legal">
                    &copy; 2019. All rights reserved. 
                </div>
                <div class="li-page-footer-theme">
                    <span class=""><a href="http://github.com/eliasson/liquorice/">liquorice</a> is a theme for <a href="http://hugo.spf13.com">hugo</a></span>
                </div>
            </div>
        </div>
    </div>
</footer>

<script src="//KeenS.github.io/reveal.js/lib/js/head.min.js"></script>
<script src="//KeenS.github.io/reveal.js/js/reveal.js"></script>

<script>

 
 
 Reveal.initialize({
     controls: true,
     progress: true,
     history: false,
     center: false,
     slideNumber: true,

     
     transition: Reveal.getQueryHash().transition || 'none', 

     
     
     

     
     dependencies: [
	 { src: '\/\/KeenS.github.io\/reveal.js/lib/js/classList.js', condition: function() { return !document.body.classList; } },
	 { src: '\/\/KeenS.github.io\/reveal.js/plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
	 { src: '\/\/KeenS.github.io\/reveal.js/plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
	 { src: '\/\/KeenS.github.io\/highlight.js/highlight.min.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
	 { src: '\/\/KeenS.github.io\/reveal.js/plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
	 { src: '\/\/KeenS.github.io\/reveal.js/plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } },
         { src: '\/\/KeenS.github.io\/reveal.js/plugin/math/math.js', async: true }
     ]
 });

</script>

<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
<script type="text/javascript">
 function toggle(id) {
     var e = document.getElementById(id);
     e.style.display == 'block' ? e.style.display = 'none' : e.style.display = 'block';
 }
</script>
<script src="https://unpkg.com/mermaid@7.0.4/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true
     });</script>

    </body>
</html>


<script>
 window.onload = 
     
     (function(document, Reveal) {
         return function() {
             var page_header = document.getElementById("page-header");
             var article_header = document.getElementById("article-header");


             function displayHeader() {
                 article_header.style.display = "block";
                 page_header.style.display = "block";

             }
             function hideHeader() {
                 article_header.style.display = "none";
                 page_header.style.display = "none";
             }
             Reveal.addEventListener( 'slidechanged', function( event ) {
                 if (event.indexh === 0 && event.indexv === 0) {
                     displayHeader();
                 } else {
                     hideHeader();
                 }
             } );

         }
     })(document, Reveal);
</script>
