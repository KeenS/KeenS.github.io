<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
    <head>
        
        
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-43779888-1"></script>
        <script>
         window.dataLayer = window.dataLayer || [];
         function gtag(){dataLayer.push(arguments);}
         gtag('js', new Date());

         gtag('config', 'UA-43779888-1');
        </script>
        

        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

        <meta name="twitter:site" content="@blackenedgold" />
        <meta name="twitter:title" content="自作コンパイラをブラウザ上で動かす | κeenのHappy Hacκing Blog"/>
        <meta name="twitter:description" content="このエントリは言語実装 Advent Calendar 2020の1日目の記事です。
次はsisshiki1969さんで「RustでつくるRuby、その後の進捗」です。

κeenです。
昔からちまちま作ってるSML処理系をブラウザ上で動かすことができたのでその進捗報告です。" />
        <meta property="og:title" content="自作コンパイラをブラウザ上で動かす | κeenのHappy Hacκing Blog" />
        <meta property="og:type" content="article" />
        <meta property="og:url" content="https:///blog/2020/11/30/jisakukonpairawoburauzauedeugokasu/" />
        <meta property="og:description" content="このエントリは言語実装 Advent Calendar 2020の1日目の記事です。
次はsisshiki1969さんで「RustでつくるRuby、その後の進捗」です。

κeenです。
昔からちまちま作ってるSML処理系をブラウザ上で動かすことができたのでその進捗報告です。" />
        <meta name="twitter:card" content="summary_large_image" />
        <meta property="og:image" content="https://KeenS.github.io/images/ogp/post/jisakukonpairawoburauzauedeugokasu.png" />
        <meta name="twitter:image" content="https://KeenS.github.io/images/ogp/post/jisakukonpairawoburauzauedeugokasu.png" />
        
        <meta property="og:article:published_time" content="2020-11-30 01:47:29 &#43;0900 JST" />
        <meta property="og:article:modified_time" content="2020-11-30 01:47:29 &#43;0900 JST" />
        
        <meta property="og:article:author" content="κeen" />

        <title>自作コンパイラをブラウザ上で動かす | κeenのHappy Hacκing Blog</title>
        <link rel="stylesheet" href='//fonts.googleapis.com/css?family=Open+Sans:400,300,600' type='text/css' />
        <link rel="stylesheet" href="/libraries/normalize.3.0.1.css" />
        <link rel="stylesheet" href="/css/liquorice.css" />
        <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
        <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
        <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
        <link rel="manifest" href="/manifest.json">
        <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
        <meta name="theme-color" content="#ffffff">
        <link rel="apple-touch-icon-precomposed" href="/apple-touch-icon-144-precomposed.png" sizes="144x144" />
        <link rel="stylesheet" href="/css/syntax-monokai.css" />
<script type="text/x-mathjax-config">
 MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ["\\(","\\)"]] } });
</script>
<script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_CHTML"></script>
</script>
<meta http-equiv="X-UA-Compatible" CONTENT="IE=EmulateIE7" />
<link rel="stylesheet" href="//unpkg.com/mermaid@7.0.4/dist/mermaid.forest.min.css">

    </head>
    <body class="li-body">

<header class="li-page-header" id="page-header">
    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <div class="li-brand li-left">
                <a href="/">κeenのHappy Hacκing Blog</a> | Lispエイリアンの狂想曲</div>
                <div class="li-menu li-right">
                    <span class="li-menu-icon" onclick="javascript:toggle('menu');">&#9776;</span>
                    <ul id="menu2" class="li-menu-items">
                        
                            <li><a href="/about/"> About </a></li>
                        
                            <li><a href="/index.xml"> Atom </a></li>
                        
                            <li><a href="/post/"> Blog </a></li>
                        
                            <li><a href="/slide/"> Slide </a></li>
                        
                    </ul>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="sixteen columns">
                <ul id="menu" class="li-menu-items li-menu-mobile">
                    
                        <li><a href="/about/"> About </a></li>
                    
                        <li><a href="/index.xml"> Atom </a></li>
                    
                        <li><a href="/post/"> Blog </a></li>
                    
                        <li><a href="/slide/"> Slide </a></li>
                    
                </ul>
            </div>
        </div>
    </div>
</header>






    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <article class="li-article">
                    <header class="li-article-header">
                        <h1 class="li-article-title">自作コンパイラをブラウザ上で動かす</h1>
                        <div class="li-article-meta">
    <time class="li-article-date">2020-11-30</time>
    <ul class="li-article-tag">
    
        <li>
            <a href="/categories/sml">SML</a>
        </li>
    
        <li>
            <a href="/categories/compiler">compiler</a>
        </li>
    
        <li>
            <a href="/categories/%e8%a8%80%e8%aa%9e%e5%ae%9f%e8%a3%85">言語実装</a>
        </li>
    
        <li>
            <a href="/categories/%e8%a8%80%e8%aa%9e%e5%ae%9f%e8%a3%85-advent-calendar">言語実装 Advent Calendar</a>
        </li>
    
        <li>
            <a href="/categories/advent-calendar">Advent Calendar</a>
        </li>
    
        <li>
            <a href="/categories/advent-calendar-2020">Advent Calendar 2020</a>
        </li>
    
</ul>

</div>

                    </header>
                    <section>
                        <p>このエントリは<a href="https://qiita.com/advent-calendar/2020/lang_dev">言語実装 Advent Calendar 2020</a>の1日目の記事です。
次はsisshiki1969さんで「RustでつくるRuby、その後の進捗」です。</p>

<p>κeenです。
昔からちまちま作ってるSML処理系をブラウザ上で動かすことができたのでその進捗報告です。</p>

<p>ちまちま作ってるSML処理系とはこれのことです。</p>

<p><a href="https://github.com/KeenS/webml">KeenS/webml: A Standard ML Compiler for the Web</a></p>

<p>今回実装したオンラインコンパイラは以下で試すことができます：</p>

<p><a href="https://keens.github.io/webml/online-compiler.html">WebML Online Compiler</a></p>

<p>まあ、ブラウザで動くのでここに貼ることもできるんですけどね。</p>

<div>
    <form id="form">
        <textarea id="program" cols="25" rows="10">
fun fib 0 = 1
|   fib 1 = 1
|   fib n = fib (n - 1) + fib (n - 2)
val _ = print (fib 10)
</textarea>
        <button id="button" type="button" disabled>Loading the compiler</button>
    </form>
    <div>
        <div id="error" style="display:none;">
            <p>Error:</p>
            <p id="error-message", class="message-box error"></p>
        </div>
        <div id="output" style="display:none;">
            <p>Output:</p>
            <p id="output-message" class="message-box correct"></p>
        </div>
    </div>
</div>

<p>こういうのどうやって作ったの？っていうのを話していけたらなと思います。</p>

<h1 id="設計">設計</h1>

<p>そもそもの話、WebMLはブラウザで動かすために設計、実装されています。
スタートから違うじゃんと思うかもしれませんが、スタートから違うとして、どう違えばいいのかも必要な情報でしょう。
では、ブラウザで動かすための設計とはというと、以下のことに気をつけて書かれています。</p>

<ol>
<li>実装言語にブラウザ上で動く仕組みをもっているものを選ぶ</li>
<li>コンパイルターゲットにブラウザ上で動く仕組みをもっているものを選ぶ</li>
<li>コンパイル中にファイルや外部プロセスに依存しない</li>
<li>コンパイル結果やランタイムがWebでも動くように配慮する</li>
</ol>

<p>2以外は<a href="https://emscripten.org">emscripten</a>でゴリ押しするという手もあるのですが、色々な理由で私は選択肢から外しました。</p>

<p>emscriptenを選択肢から外すとWeb上で言語を動かす仕組みはJavaScriptか<a href="https://webassembly.org">WebAssembly</a>（WASM）になります。
私はWASMに全振りする選択をとりました。というかWASMで遊ぶためにこのプロジェクトをはじめました。</p>

<p>というのを踏まえて上記の条件をWebMLにあてはめてみましょう。</p>

<h2 id="実装言語">実装言語</h2>

<p>Rustで書きました。
RustはWASMへのコンパイルターゲット（<code>wasm32-unkonwn-unknown</code>）をもっているので容易にブラウザ上で動かすことができます。</p>

<p>WebMLを始めた頃はまだ実験的機能扱いでしたが、今やRustがWASMを使うときの最有力候補になっています。</p>

<h2 id="コンパイルターゲット">コンパイルターゲット</h2>

<p>WASMを選びました。
これは前述のように「WASMをターゲットにするコンパイラを作ればブラウザ上でコンパイルできるのでは」というアイディアに基いて始めたプロジェクトなので当たり前っちゃ当たり前ですね。</p>

<h2 id="コンパイルプロセス">コンパイルプロセス</h2>

<p>全てメモリ内で完結するようにしました。
ここでネックになるのがアセンブラです。
WASMアセンブラは<a href="https://github.com/WebAssembly/binaryen">binaryen</a>などの公式CLIツールが配られてますが、CLIツールなので外部プロセスを起動しなければなりません。さらに入力も出力もファイルです。
しかしながらブラウザ上で外部プロセスやファイルなどは扱えません。</p>

<p>仕方ないので全てメモリ内で完結するWASMアセンブラ、<a href="https://github.com/KeenS/WebAssembler-rs">WebAssembler-rs</a>を作りました。WASMが正式勧告になる前から作ってたので途中でバイナリフォーマットが変わって泣きの目をみたなんて開発秘話もあります。</p>

<h2 id="webで動くオブジェクトやランタイム">Webで動くオブジェクトやランタイム</h2>

<p>まあ、要するに <code>libc</code> に依存しないようにすればいいわけです。</p>

<p>ランタイムはいくつかのパーツに分かれます。GCと標準ライブラリ。
GCと標準ライブラリさえどうにかすれば吐いたバイナリはそれらだけに依存するように作れば話は済みます。
なのでGCと標準ライブラリをどうするかが問題です。</p>

<h3 id="gc">GC</h3>

<p>GCはRustで書いてWASMにコンパイルしています。
ただしlibcを使えないので <code>#![no_std]</code> にして、<a href="https://doc.rust-lang.org/core/arch/wasm32/index.html">intrinsic</a>の<a href="https://doc.rust-lang.org/core/arch/wasm32/fn.memory_grow.html">memory_grow</a>や<a href="https://doc.rust-lang.org/core/arch/wasm32/fn.memory_size.html">memory_size</a>を使ってイチからメモリ管理しようとしています。…が実態は実装がおいついてなくてゴミを回収しない、いわゆるZeroGCになっています。</p>

<p>私は<a href="/blog/2017/12/07/webassemblynogc/">過去にWASM生書きでGCを実装したことがある</a>のですが、アロケータAPIとかの兼ね合いで流用はできないので再実装することになる見込です。</p>

<h3 id="標準ライブラリ">標準ライブラリ</h3>

<p>標準ライブラリはWASMで表現できるもの（<code>+</code> など）はコンパイラの組み込みにして、それ以外はFFIとして実装しています。
FFIはWASMの <code>import</code> の仕組みを利用して実装されています。
<code>print</code> を例に採ると <code>prelude.sml</code> で以下のように定義されています。</p>
<div class="highlight"><pre class="chroma"><code class="language-sml" data-lang="sml"><span class="kr">fun</span> <span class="nf">print</span> <span class="n">x</span> <span class="n">=</span> <span class="p">_</span><span class="n">externcall</span><span class="p">(</span><span class="s2">&#34;js-ffi&#34;</span><span class="err">.&#34;print&#34;:</span> <span class="p">(</span><span class="n">int</span><span class="p">)</span> <span class="n">-&gt;</span> <span class="n">unit</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span></code></pre></div>
<p>そしてブラウザ上で動かすときに以下のようにして <code>print</code> の実装を与えています。</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kd">let</span> <span class="nx">buffer</span> <span class="o">=</span> <span class="nx">compile_string</span><span class="p">(</span><span class="nx">str</span><span class="p">).</span><span class="nx">buffer</span><span class="p">;</span>
<span class="kd">let</span> <span class="nx">importObj</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&#34;js-ffi&#34;</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">print</span><span class="o">:</span> <span class="nx">showOutput</span>
    <span class="p">},</span>
    <span class="c1">// ...
</span><span class="c1"></span><span class="p">};</span>
<span class="nx">WebAssembly</span><span class="p">.</span><span class="nx">instantiate</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="nx">importObj</span><span class="p">)</span>
</code></pre></div>
<p>SML側で型さえ与えられれば実行時に自由にJS側で実装を与えられるので <code>print</code> も簡単に実装できてしまえます。
ついでにいうと <code>print</code> をどう実装するかに裁量が残るので今回のようにページ内に結果を出力するなんてこともできます。</p>

<h1 id="オンラインコンパイラの実装のためにしたこと">オンラインコンパイラの実装のためにしたこと</h1>

<p>上記のようなコンパイラの設計をしたとして、オンラインコンパイラの実装のためにやったことを書いておきます。</p>

<ol>
<li>コンパイラをWASMにコンパイル</li>
<li>ブラウザでリンクする仕組みの開発</li>
<li>WASMをサーバやブラウザ内から取得して実行</li>
</ol>

<h2 id="コンパイラをwasmにコンパイル">コンパイラをWASMにコンパイル</h2>

<p>ちょっとWASMがごちゃごちゃするのでIとTの記法を使って状況を説明します。</p>

<p>以下のような図を書いたときに</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">+-----+----------+--------+
| src | compiler | target |
+-----+----------+--------+
      | runtime  |
      +----------+</code></pre></div>
<p>runtime上で動くcompilerを使ってsrcからtargetに変換するということを表わします。</p>

<p>また以下のような図を書いたときに</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">+--------+
|  code  |
+--------+
| interp |
+--------+</code></pre></div>
<p>interpを使ってcodeを解釈するということを表わします。</p>

<p>これらの記法を使うと、以前は以下のような状況でした。</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">+------------+-------+---------------+
| webml(src) | rustc | webml(x86_64) |
+------------+-------+---------------+
             |  OS   |
             +-------+

+---------------+-------+----------------+
| webml-rt(src) | rustc | webml-rt(wasm) |
+---------------+-------+----------------+
                |  OS   |
                +-------+

+-----+-------+------+
| SML | webml | WASM |
+-----+-------+------+
      |  OS   |
      +-------+


+-----------------+
| WASM + webml-rt |
+-----------------+
|     browser     |
+-----------------+
|       OS        |
+-----------------+</code></pre></div>
<p>手元のPC上で動くWebMLコンパイラを使って事前にSMLのコードをコンパイルしておき、それをブラウザにロードしていました。</p>

<p>今回のオンラインコンパイラの実装でコンパイラもブラウザ上で動くようになりました。</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">+------------+-------+-------------+
| webml(src) | rustc | webml(wasm) | &lt;-- ターゲットがwasmになった
+------------+-------+-------------+
             |  OS   |
             +-------+

+---------------+-------+----------------+
| webml-rt(src) | rustc | webml-rt(wasm) |
+---------------+-------+----------------+
                |  OS   |
                +-------+

+-----+---------+------+
| SML |  webml  | WASM |
+-----+---------+------+
      | borwser | &lt;---------------------- ブラウザで動くようになった
      +---------+
      |   OS    |
      +---------+

+-----------------+
| WASM + webml-rt |
+-----------------+
|     browser     |
+-----------------+
|       OS        |
+-----------------+</code></pre></div>
<h2 id="ブラウザでリンクする仕組みの開発">ブラウザでリンクする仕組みの開発</h2>

<p>上を見てもらったら分かるように、WASMとランタイムはそれぞれ別でコンパイルされ、ブラウザ上でリンクしています。
ブラウザ上でWASMファイルをパースしてリンクした新しいWASMファイルを生成するのは骨ですが、幸いにもブラウザ上でWASMモジュールを上手く組み合わせる仕組みがあります。</p>

<p>WASMはブラウザ上ではモジュールという単位で管理されます。
上記例でいうとwebml、webml-rt、SMLのコンパイル結果などがそうですね。
モジュールにはexportsといってJavaScriptから関数のように見えるAPIが生えています。
一方でモジュールを作るときにはimportsといってJavaScriptから関数や値などを渡せます。
これらを使ってexportsとimportsをJavaScriptで繋げてあげることでリンクを実現しています。</p>

<p>面白いことに、WASMのモジュールのexportsにはメモリ（メモリ全体）もあります。
importsで他のモジュールのメモリを読み込むこともできます。
現時点ではメモリ空間は1つしかないのでモジュールは自分でメモリを作ってexportするかメモリを作らずにimportするかしかありません。
この仕組みを上手く使ってるのがGCです。
GCのモジュールはメモリと <code>alloc</code> 関数をexportしていて、SMLのコードの方でそれらをインポートして使っています。</p>

<p>冒頭の方で <code>print</code> の例として載せたコードの省略した部分をちゃんと載せるとこうなっています。</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kd">let</span> <span class="nx">buffer</span> <span class="o">=</span> <span class="nx">compile_string</span><span class="p">(</span><span class="nx">str</span><span class="p">).</span><span class="nx">buffer</span><span class="p">;</span>
<span class="kd">let</span> <span class="nx">importObj</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&#34;js-ffi&#34;</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">print</span><span class="o">:</span> <span class="nx">showOutput</span>
    <span class="p">},</span>
    <span class="s2">&#34;webml-rt&#34;</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">alloc</span><span class="o">:</span> <span class="nx">rtObj</span><span class="p">.</span><span class="nx">alloc</span><span class="p">,</span>
        <span class="nx">init</span><span class="o">:</span> <span class="nx">rtObj</span><span class="p">.</span><span class="nx">init</span><span class="p">,</span>
        <span class="nx">memory</span><span class="o">:</span> <span class="nx">rtObj</span><span class="p">.</span><span class="nx">memory</span>
    <span class="p">},</span>
<span class="p">};</span>
<span class="nx">WebAssembly</span><span class="p">.</span><span class="nx">instantiate</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="nx">importObj</span><span class="p">)</span>
</code></pre></div>
<p><code>importObj</code> にランタイム（<code>rtObj</code>） のメモリ（<code>memory</code>）や <code>alloc</code> 関数を渡しています。</p>

<h2 id="wasmを取得して実行">WASMを取得して実行</h2>

<p>WASMを取得して実行するにあたっていくつか解決しないといけない問題がありました</p>

<ol>
<li>謎のセキュリティ機構でロードできない問題</li>
<li>WASMのプリミティブ型以外は受け渡せない問題</li>
<li>WASMのコンパイル/実行</li>
</ol>

<p>1は未だもって不明です。JavaScriptの文法で <code>import &quot;wasm=_ile.wasm&quot;</code> と書けば自然とロードしてくれるはずだったのですが、MIMEタイプが許可されてないとかでロードエラーが起きました。
どうやらサーバの設定の問題（開発に使ったのはRubyのWEBrickです）のようなのですが、それっぽい設定をしてもダメでした。</p>

<p>2は問題としては分かりやすいです。WASMには先程説明したとおり、 <code>i32</code> 、 <code>i64</code> 、 <code>f32</code> 、 <code>f64</code> の型しかありません。
独自定義の構造体はおろか、文字列なども存在しません。もちろん、imports/exportsでもこれらの型しか扱えません。
これでは今回のように文字列を渡してコンパイルしてもらってバイト列を返してもらうような関数を定義できません。
これには一応解決策があります。メモリはJavaScriptから読めるのでポインタだけ関数の引数でやりとりして、実データメモリ経由でやりとりする方法で解決できます。
とはいえ、これを1つ1つやるのは人間のやることではないので自動でやってくれる仕組みを導入します。</p>

<p>3はまあ分かりやすいです。JS APIの <code>WebAssembly</code> を実行するだけです。
ただし（ロードやコンパイルに時間がかかることを想定して）APIが非同期に設計されているので少しだけ面倒です。</p>

<p>3は言ってしまえばやるだけなので1、2の解決策だけ紹介します。とはいってもツールを使うだけですが。</p>

<h3 id="wasm-bindgen-wasm-pack">wasm-bindgen/wasm-pack</h3>

<p><a href="https://github.com/rustwasm/wasm-bindgen">wasm-bindgen</a>がRustとWASMの橋渡しをするためのRustライブライで、<a href="https://github.com/rustwasm/wasm-pack">wasm-pack</a>がRustのコードをブラウザで扱いやすいようにビルドしてくれるビルドツールです。
おおむねwasm-bindgenが2を、wasm-packが1、2を解決してくれます。</p>

<h4 id="wasm-bindgen">wasm-bindgen</h4>

<p>使い方はシンプルです。
WASMビルドの際にJS側に晒したいAPIに <code>#[wasm_bindgen]</code> を付与するだけです。
今回の私のコンパイラではこのようなコードを書きました。</p>
<div class="highlight"><pre class="chroma"><code class="language-rust" data-lang="rust"><span class="cp">#[cfg(target_arch = </span><span class="s">&#34;wasm32&#34;</span><span class="cp">)]</span><span class="w">
</span><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">wasm_bindgen</span>::<span class="n">prelude</span>::<span class="o">*</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="cp">#[cfg(target_arch = </span><span class="s">&#34;wasm32&#34;</span><span class="cp">)]</span><span class="w">
</span><span class="w"></span><span class="cp">#[cfg_attr(target_arch = </span><span class="s">&#34;wasm32&#34;</span><span class="cp">, wasm_bindgen)]</span><span class="w">
</span><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">compile_string</span><span class="p">(</span><span class="n">input</span>: <span class="nb">String</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">JsValue</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">prelude</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">include_str</span><span class="o">!</span><span class="p">(</span><span class="s">&#34;../ml_src/prelude.sml&#34;</span><span class="p">).</span><span class="n">to_string</span><span class="p">();</span><span class="w">
</span><span class="w">    </span><span class="n">prelude</span><span class="p">.</span><span class="n">push_str</span><span class="p">(</span><span class="o">&amp;</span><span class="n">input</span><span class="p">);</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span>::<span class="n">default</span><span class="p">();</span><span class="w">
</span><span class="w">    </span><span class="n">compile_str</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prelude</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">config</span><span class="p">).</span><span class="n">map_err</span><span class="p">(</span><span class="o">|</span><span class="n">e</span><span class="o">|</span><span class="w"> </span><span class="n">format</span><span class="o">!</span><span class="p">(</span><span class="s">&#34;Compile failed: {}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">).</span><span class="n">into</span><span class="p">())</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span></code></pre></div>
<p>関数の返り値に <code>Result</code> を指定したかったら <code>Result&lt;Vec&lt;u8&gt;, JsValue&gt;</code> のように <code>Err</code> 側に必ず <code>JsValue</code> を指定しないといけないだとか、いくつかのデータ型はJSに渡せないなどの制約はありますがおおむね素直に動いてくれます。</p>

<h4 id="wasm-pack">wasm-pack</h4>

<p>こっちも使い方はシンプルです。Cargoの代わりに <code>wasm-pack</code> を使ってビルドします。</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">$ wasm-pack build --target web</code></pre></div>
<p>wasm-packにはいくつかビルドモードがありますが、私はnpmツール群を避けて通りたいのでピュアなWeb向けの成果物を出してくれる <code>web</code> を選択しています。デフォルトでは <code>bundler</code> になっています。</p>

<p>ビルドが終わると <code>pkg/</code> 以下にいくつかのファイルが生成されます。</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">$ ls pkg
README.md  package.json  webml.d.ts  webml.js  webml_bg.wasm  webml_bg.wasm.d.ts</code></pre></div>
<p>このうちブラウザ上では <code>webml.js</code> のみをロードすればよいことになっています。
<code>*.wasm</code> が本体、<code>*.ts</code> は（TypeScript向けの）補助ファイル、 <code>*.js</code> がWASM &lt;-&gt; JSのグルーコードです。</p>

<p>グルーコードについて言及しましょう。
例えば今回の <code>compile_string</code> は <code>webml.js</code> で以下のように定義されています。
<code>wasm.compile_string</code> をラップする形で文字列やバイト列の操作を請け負ってるのが見てとれるかと思います。</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="cm">/**
</span><span class="cm">* @param {string} input
</span><span class="cm">* @returns {Uint8Array}
</span><span class="cm">*/</span>
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">compile_string</span><span class="p">(</span><span class="nx">input</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">retptr</span> <span class="o">=</span> <span class="nx">wasm</span><span class="p">.</span><span class="nx">__wbindgen_export_0</span><span class="p">.</span><span class="nx">value</span> <span class="o">-</span> <span class="mi">16</span><span class="p">;</span>
        <span class="nx">wasm</span><span class="p">.</span><span class="nx">__wbindgen_export_0</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">retptr</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">ptr0</span> <span class="o">=</span> <span class="nx">passStringToWasm0</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="nx">wasm</span><span class="p">.</span><span class="nx">__wbindgen_malloc</span><span class="p">,</span> <span class="nx">wasm</span><span class="p">.</span><span class="nx">__wbindgen_realloc</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">len0</span> <span class="o">=</span> <span class="nx">WASM_VECTOR_LEN</span><span class="p">;</span>
        <span class="nx">wasm</span><span class="p">.</span><span class="nx">compile_string</span><span class="p">(</span><span class="nx">retptr</span><span class="p">,</span> <span class="nx">ptr0</span><span class="p">,</span> <span class="nx">len0</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">r0</span> <span class="o">=</span> <span class="nx">getInt32Memory0</span><span class="p">()[</span><span class="nx">retptr</span> <span class="o">/</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">0</span><span class="p">];</span>
        <span class="kd">var</span> <span class="nx">r1</span> <span class="o">=</span> <span class="nx">getInt32Memory0</span><span class="p">()[</span><span class="nx">retptr</span> <span class="o">/</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
        <span class="kd">var</span> <span class="nx">v1</span> <span class="o">=</span> <span class="nx">getArrayU8FromWasm0</span><span class="p">(</span><span class="nx">r0</span><span class="p">,</span> <span class="nx">r1</span><span class="p">).</span><span class="nx">slice</span><span class="p">();</span>
        <span class="nx">wasm</span><span class="p">.</span><span class="nx">__wbindgen_free</span><span class="p">(</span><span class="nx">r0</span><span class="p">,</span> <span class="nx">r1</span> <span class="o">*</span> <span class="mi">1</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">v1</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
        <span class="nx">wasm</span><span class="p">.</span><span class="nx">__wbindgen_export_0</span><span class="p">.</span><span class="nx">value</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>ところでこのグルーコドはロード問題なども請け負ってくれます。
コードを読んだところ <code>import</code> でWASMファイルとして読み込むとエラーになりますが、 <code>fetch</code> でバイナリ列として取り出して <code>WebAssembly</code> APIでコンパイルするとエラーにならなようです。</p>

<h1 id="まとめ">まとめ</h1>

<p>ブラウザでコンパイラを動かすためのコンパイラの設計や、その設計をした上でどのようなことをすれば動くのかを紹介しました。</p>

<p>設計としてはコンパイラやコンパイル結果がWeb上で動くように配慮する必要があります。
実装としてはRustを使って開発した上でwasm-bindgen/wasm-packを使ってコンパイルし、ブラウザ上でランタイムとコンパイル結果をリンクする形になります。</p>

<p>今回実装したオンラインコンパイラはtextareaの内容をそのままコンパイルしただけでした。
将来<a href="https://ace.c9.io">ace</a>などのWebエディタと統合したり1行づつ評価するREPLを作ったりをやっていきたいですね。</p>

<h1 id="付録">付録</h1>

<h2 id="a-webassemblyとは">A: WebAssemblyとは</h2>

<p>ここまで話題に出てきたWebAssemblyとは何かという話を軽くします。</p>

<p>WebAssemblyはブラウザ上で（も）動く言語です。
<a href="https://www.w3.org/TR/wasm-core-1/">2019年12月にW3C正式勧告</a>となり主要ブラウザで実装されています。
フォーマットはバイナリで、スタックマシンです。
機械語を直接ブラウザで動かせる仕組みと勘違いしてる人がたまにいますが、名前に反してアセンブリではありません。
中間言語、JVMでいうバイトコードのようなポジションですね。</p>

<p>以下のような見た目をしています。</p>
<pre><code class="language-webassembly" data-lang="webassembly">(module
  (func $i (import &#34;imports&#34; &#34;imported_func&#34;) (param i32))
  (func $new_page
    (grow_memory (i32.const 3))
    (call $i))
  (func (export &#34;exported_func&#34;)
    (i32.const 42)
    (call $new_page)
    (call $i))
  (memory 1 10))</code></pre>
<p>モジュールや関数などがあり、機械語とは程遠いですね。</p>

<h2 id="webassemblyの生い立ち">WebAssemblyの生い立ち</h2>

<ol>
<li>CをJavaScriptにコンパイルするempscriptenが登場する</li>
<li>どうせ機械生成ならと、特殊記法で高速に実行できるasm.jsが登場する

<ul>
<li>JavaScriptのサブセットなのでasm.jsをサポートしてないブラウザでも動く</li>
</ul></li>
<li>asm.jsは実行は高速だがロードが遅い問題があった</li>
<li>JavaScriptの文法を捨ててバイナリにしたらコンパクトになってダウンロードもパースも速くなるんじゃね？</li>
<li>→WebAssemblyの誕生</li>
</ol>

<p>その生い立ちから、まずはC/C++ to WASMのコンパイラを満足に書ける程度の仕様が策定されました。
つまり、最小限のWASMはJavaScriptに表現力で勝ることはないです。
じゃあ何故WASMを選ぶのかというと1つはバイナリが動いて面白いから。もう1つが将来への期待です。</p>

<p>最小限のWASMはJavaScriptに及ばないのですが、その後の方向性としてJSにはないSIMDやスレッドなどのAPIが足される予定です。</p>

<p><a href="https://webassembly.org/roadmap/">Roadmap - WebAssembly</a></p>

<p>そういった意味で将来が期待されるプロジェクトです。</p>

<h2 id="webassemblyの使いどころ">WebAssemblyの使いどころ</h2>

<p>基本的にはブラウザで速度が欲しいときに使います。
例えばゲームエンジンのUnityは<a href="https://blogs.unity3d.com/2018/08/15/webassembly-is-here/">WebAssemblyへの出力が可能</a>です</p>

<p>あとはブラウザで動く関係上サンドボックス機構がついてるのでそれを利用するケースがあります。
<a href="https://cloudblogs.microsoft.com/opensource/2020/04/07/announcing-krustlet-kubernetes-rust-kubelet-webassembly-wasm/">Kebernetes上でDockerコンテナの代わりにWASMを動かす</a>だとか。
名前に反してブラウザで動くとは限らないんですね。</p>

<h2 id="コンパイルターゲットとしてのwebassembly">コンパイルターゲットとしてのWebAssembly</h2>

<p>ブラウザで動かすにしてもJavaScriptやemscripten経由じゃだめなの？という疑問に答えておこうと思います。</p>

<p>1つはセマンティクスの問題。
WebAssemblyには数値型が <code>i32</code> 、 <code>i64</code> 、 <code>f32</code> 、 <code>f64</code> と4つあります。
一方でJavaScriptの数値型は<code>number</code> と <code>BigInt</code> のみです。
Cのような32bit整数型がJavaScriptにないんですね。
なのでCの <code>1 + 1</code> を素直に <code>1 + 1</code> にコンパイルできないのです。
これはJavaScriptに限らず高級言語から高級言語にコンパイルすると常にこういったセマンティクスの違いの問題がつきまといます。
なので比較的低級で意味論も素直なWebAssemblyにコンパイルするのは理に適っています。</p>

<p>1つは利用ケース。
上で紹介したように、WebAssemblyはブラウザ以外でも利用例があります。
なんなら、ローカルマシンで実行できるバイナリを吐く<a href="https://github.com/bytecodealliance/lucet">コンパイラ</a>もあります。「ポータブルなバイナリフォーマット」としてのWebAssemblyは価値があります。</p>

<p>1つはWebAssemblyでしかできないことを狙って。
先程言及したように、将来WebAssemblyでしかできない機能が導入される予定です。
そういったものを見越してWebAssemblyを使ってみるのも面白いでしょう。</p>

<h3 id="emscripten問題">emscripten問題</h3>

<p>直接JavaScriptにコンパイルするのはつらくても、細かなところまで面倒をみてくれるemscriptenならどうなのという疑問にも答えておきます。
数年前にちょろっと調べたときの記憶で書いてるので色々間違ってるかもしれませんが、当時私がemscriptenでなくWebAssemblyを選んだ理由を書いておきます。</p>

<h4 id="ホスト環境の再現はほしくない">ホスト環境の再現はほしくない</h4>

<p>emscriptenは既存のコードをそのままWebブラウザで動かせるように色々気を使ってます。
特にlibcもブラウザで動くように再実装しています（ファイルシステムとかも実装されてます）。</p>

<p>ですが私がやりたいのはWeb向けに設計された言語の設計と実装です。
<code>print</code> の例のように裏はそのままJavaScriptと繋がっていてほしいのです。
そういった点で、emscriptenの方向性は私の目指すものと違いました。</p>

<h4 id="バイナリサイズが大きい">バイナリサイズが大きい</h4>

<p>上記のlibcを移植してる話に繋がるのですが、バイナリサイズ<sup class="footnote-ref" id="fnref:1"><a href="#fn:1">1</a></sup>がとても大きいです。
Hello Worldをするのにしばらく待たされるくらい重いです。
一方でWebMLのランタイムとHello Worldをコンパイルした程度のコードなら両者合わせても1KiBにも満たないサイズなのでロードは一瞬です。</p>

<p>ゲームのようにそもそも重いものを動かすなら我慢できるかもしれませんが、私のようにちょろっと動くプログラミング言語を作るのには向いてなさそうでした。</p>

<h4 id="カスタマイズ性が分からなかった">カスタマイズ性が分からなかった</h4>

<p>チュートリアルをやって少しだけ調べた状態での印象です。
<code>puts(&quot;Hello, World&quot;);</code> するとアラートで画面にメッセージが表示されたりと期待しない挙動をよくしていました。
また、特定のAPIを叩くと勝手にロード、実行される仕組みになってるのでGCのようにライブラリとして使いたいものの動かし方が分かりませんでした。</p>

<p>ちゃんと調べれば出てくるのでしょうが、前述のいくつかの理由もあいまってそこまで調べずにあきらめてしまいました。</p>

<p>現時点ではWebAssembly周りのエコシステムが発達してきているのでemscriptenは使わなくてよかったのかな、と振り返ってます。</p>

<h2 id="b-オンラインコンパイラのコード">B: オンラインコンパイラのコード</h2>
<div class="highlight"><pre class="chroma"><code class="language-html" data-lang="html"><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">form</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;form&#34;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">textarea</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;program&#34;</span> <span class="na">cols</span><span class="o">=</span><span class="s">&#34;25&#34;</span> <span class="na">rows</span><span class="o">=</span><span class="s">&#34;10&#34;</span><span class="p">&gt;</span>
fun fib 0 = 1
|   fib 1 = 1
|   fib n = fib (n - 1) + fib (n - 2)
val _ = print (fib 10)
<span class="p">&lt;/</span><span class="nt">textarea</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">button</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;button&#34;</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;button&#34;</span> <span class="na">disabled</span><span class="p">&gt;</span>Loading the compiler<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;error&#34;</span> <span class="na">style</span><span class="o">=</span><span class="s">&#34;display:none;&#34;</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Error:<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">p</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;error-message&#34;</span><span class="err">,</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;message-box error&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;output&#34;</span> <span class="na">style</span><span class="o">=</span><span class="s">&#34;display:none;&#34;</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Output:<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">p</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;output-message&#34;</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;message-box correct&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">style</span><span class="p">&gt;</span>
 <span class="p">.</span><span class="nc">message-box</span> <span class="p">{</span>
     <span class="k">padding</span><span class="p">:</span> <span class="mi">5</span><span class="kt">px</span><span class="p">;</span>
 <span class="p">}</span>
 <span class="p">.</span><span class="nc">correct</span> <span class="p">{</span>
     <span class="k">background</span><span class="p">:</span> <span class="mh">#eeeebb</span><span class="p">;</span>
 <span class="p">}</span>
 <span class="p">.</span><span class="nc">error</span> <span class="p">{</span>
     <span class="k">background</span><span class="p">:</span> <span class="mh">#eebbbb</span><span class="p">;</span>
 <span class="p">}</span>
<span class="p">&lt;/</span><span class="nt">style</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;module&#34;</span><span class="p">&gt;</span>
 <span class="kr">import</span> <span class="p">{</span> <span class="k">default</span> <span class="nx">as</span> <span class="nx">compilerInit</span><span class="p">,</span> <span class="nx">compile_string</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;https://KeenS.github.io/webml/compiler/webml.js&#39;</span><span class="p">;</span>
 <span class="kr">import</span> <span class="p">{</span> <span class="k">default</span> <span class="nx">as</span> <span class="nx">rtInit</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;https://KeenS.github.io/webml/compiler/webml_rt.js&#39;</span><span class="p">;</span>

 <span class="kd">let</span> <span class="nx">input</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&#34;program&#34;</span><span class="p">);</span>
 <span class="kd">let</span> <span class="nx">output</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&#34;output&#34;</span><span class="p">);</span>
 <span class="kd">let</span> <span class="nx">outputMessage</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&#34;output-message&#34;</span><span class="p">);</span>
 <span class="kd">let</span> <span class="nx">error</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&#34;error&#34;</span><span class="p">);</span>
 <span class="kd">let</span> <span class="nx">errorMessage</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&#34;error-message&#34;</span><span class="p">);</span>
 <span class="kd">let</span> <span class="nx">button</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&#34;button&#34;</span><span class="p">);</span>

 <span class="kd">function</span> <span class="nx">showOutput</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
     <span class="nx">outputMessage</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">str</span><span class="p">;</span>
     <span class="nx">output</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s2">&#34;inline&#34;</span><span class="p">;</span>
     <span class="nx">errorMessage</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>
     <span class="nx">error</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s2">&#34;none&#34;</span><span class="p">;</span>
 <span class="p">}</span>

 <span class="kd">function</span> <span class="nx">showError</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
     <span class="nx">outputMessage</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>
     <span class="nx">output</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s2">&#34;none&#34;</span><span class="p">;</span>
     <span class="nx">errorMessage</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">str</span><span class="p">;</span>
     <span class="nx">error</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s2">&#34;inline&#34;</span><span class="p">;</span>
 <span class="p">}</span>

 <span class="kr">async</span> <span class="kd">function</span> <span class="nx">init</span><span class="p">()</span> <span class="p">{</span>
     <span class="kd">let</span> <span class="p">[</span><span class="nx">compilerObj</span><span class="p">,</span> <span class="nx">rtObj</span><span class="p">]</span> <span class="o">=</span> <span class="kr">await</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
         <span class="nx">compilerInit</span><span class="p">(),</span>
         <span class="nx">rtInit</span><span class="p">()</span>
     <span class="p">]);</span>
     <span class="kd">function</span> <span class="nx">compileAndRun</span><span class="p">(</span><span class="nx">str</span><span class="p">,</span> <span class="nx">output</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">try</span> <span class="p">{</span>
             <span class="kd">let</span> <span class="nx">buffer</span> <span class="o">=</span> <span class="nx">compile_string</span><span class="p">(</span><span class="nx">str</span><span class="p">).</span><span class="nx">buffer</span><span class="p">;</span>
             <span class="kd">let</span> <span class="nx">importObj</span> <span class="o">=</span> <span class="p">{</span>
                 <span class="s2">&#34;js-ffi&#34;</span><span class="o">:</span> <span class="p">{</span>
                     <span class="nx">print</span><span class="o">:</span> <span class="nx">showOutput</span>
                 <span class="p">},</span>
                 <span class="s2">&#34;webml-rt&#34;</span><span class="o">:</span> <span class="p">{</span>
                     <span class="nx">alloc</span><span class="o">:</span> <span class="nx">rtObj</span><span class="p">.</span><span class="nx">alloc</span><span class="p">,</span>
                     <span class="nx">init</span><span class="o">:</span> <span class="nx">rtObj</span><span class="p">.</span><span class="nx">init</span><span class="p">,</span>
                     <span class="nx">memory</span><span class="o">:</span> <span class="nx">rtObj</span><span class="p">.</span><span class="nx">memory</span>
                 <span class="p">},</span>
             <span class="p">};</span>
             <span class="nx">WebAssembly</span><span class="p">.</span><span class="nx">instantiate</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="nx">importObj</span><span class="p">)</span>
                        <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span> <span class="p">=&gt;</span> <span class="nx">showError</span><span class="p">(</span><span class="s2">&#34;Browser returned an error: &#34;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">))</span>
         <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
             <span class="nx">showError</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
         <span class="p">}</span>
     <span class="p">}</span>
     <span class="k">return</span> <span class="nx">compileAndRun</span><span class="p">;</span>
 <span class="p">}</span>
 <span class="nx">init</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">compileAndRun</span> <span class="p">=&gt;</span> <span class="p">{</span>
     <span class="nx">button</span><span class="p">.</span><span class="nx">removeAttribute</span><span class="p">(</span><span class="s2">&#34;disabled&#34;</span><span class="p">);</span>
     <span class="nx">button</span><span class="p">.</span><span class="nx">onclick</span> <span class="o">=</span> <span class="nx">arg</span> <span class="p">=&gt;</span> <span class="nx">compileAndRun</span><span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="nx">output</span><span class="p">);</span>
     <span class="nx">button</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">&#34;Run&#34;</span><span class="p">;</span>
 <span class="p">});</span>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span></code></pre></div>
<section>
<style>
 .message-box {
     padding: 5px;
 }
 .correct {
     background: #eeeebb;
 }
 .error {
     background: #eebbbb;
 }
</style>
<script type="module">
 import { default as compilerInit, compile_string } from 'https://KeenS.github.io/webml/compiler/webml.js';
 import { default as rtInit } from 'https://KeenS.github.io/webml/compiler/webml_rt.js';

 let input = document.getElementById("program");
 let output = document.getElementById("output");
 let outputMessage = document.getElementById("output-message");
 let error = document.getElementById("error");
 let errorMessage = document.getElementById("error-message");
 let button = document.getElementById("button");

 function showOutput(str) {
     outputMessage.innerHTML = str;
     output.style.display = "inline";
     errorMessage.innerHTML = "";
     error.style.display = "none";
 }

 function showError(str) {
     outputMessage.innerHTML = "";
     output.style.display = "none";
     errorMessage.innerHTML = str;
     error.style.display = "inline";
 }

 async function init() {
     let [compilerObj, rtObj] = await Promise.all([
         compilerInit(),
         rtInit()
     ]);
     function compileAndRun(str, output) {
         try {
             let buffer = compile_string(str).buffer;
             let importObj = {
                 "js-ffi": {
                     print: showOutput
                 },
                 "webml-rt": {
                     alloc: rtObj.alloc,
                     init: rtObj.init,
                     memory: rtObj.memory
                 },
             };
             WebAssembly.instantiate(buffer, importObj)
                        .catch(err => showError("Browser returned an error: " + err))
         } catch (e) {
             showError(e)
         }
     }
     return compileAndRun;
 }
 init().then(compileAndRun => {
     button.removeAttribute("disabled");
     button.onclick = arg => compileAndRun(input.value, output);
     button.innerHTML = "Run";
 });
</script>
</section>
<div class="footnotes">

<hr />

<ol>
<li id="fn:1">厳密にはJavaScriptなのでバイナリではなくテキスト
 <a class="footnote-return" href="#fnref:1"><sup>[return]</sup></a></li>
</ol>
</div>
                    </section>
                </article>
            </div>
        </div>

        <div class="row li-author">
    <div class="sixteen columns">
        Written by <strong>κeen</strong>
    </div>
</div>


        <div class="row li-pagination">
            <div class="eight columns">
                <div class="li-pagination-previous">
                    
                        Later article<br />
                        <a href="/blog/2020/11/30/idristtedonnagengo_/"> 依存型のあるHaskellことIdrisってどんな言語？</a>
                    
                </div>
            </div>
            <div class="eight columns">
                <div class="li-pagination-next">
                    
                        Older article<br />
                        <a href="/slide/rust_with_fearless_concurrency/"> Rust with Fearless Concurrency</a>
                    
                </div>
            </div>
        </div>
    </div>

<footer class="li-page-footer">
    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <div class="li-page-footer-legal">
                    &copy; 2021. All rights reserved. 
                </div>
                <div class="li-page-footer-theme">
                    <span class=""><a href="https://github.com/eliasson/liquorice/">liquorice</a> is a theme for <a href="http://hugo.spf13.com">hugo</a></span>
                </div>
            </div>
        </div>
    </div>
</footer>

<script type="text/javascript">
 function toggle(id) {
     var e = document.getElementById(id);
     e.style.display == 'block' ? e.style.display = 'none' : e.style.display = 'block';
 }
</script>
<script src="https://unpkg.com/mermaid@7.0.4/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true
     });</script>

    </body>
</html>

