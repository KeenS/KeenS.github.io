<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
    <head>
        
        
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-43779888-1"></script>
        <script>
         window.dataLayer = window.dataLayer || [];
         function gtag(){dataLayer.push(arguments);}
         gtag('js', new Date());

         gtag('config', 'UA-43779888-1');
        </script>
        

        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

        <meta name="twitter:site" content="@blackenedgold" />
        <meta name="twitter:title" content="Rustの環境構築（Emacs） | κeenのHappy Hacκing Blog"/>
        <meta name="twitter:description" content="このエントリはRust 3 Advent Calendar 2020の2日目の記事です。前回はstnaoさんでRust,Wasm,Dockerで&rdquo;hello world&rdquo;をする MacOs catalinaでした。

κeenです。そういえばRustの環境構築の記事を最近みかけないなと思ったので書きます。
それとEmacsのセットアップや開発方法なども記します。" />
        <meta property="og:title" content="Rustの環境構築（Emacs） | κeenのHappy Hacκing Blog" />
        <meta property="og:type" content="article" />
        <meta property="og:url" content="https:///blog/2020/12/01/rustnokankyoukouchiku_emacs_/" />
        <meta property="og:description" content="このエントリはRust 3 Advent Calendar 2020の2日目の記事です。前回はstnaoさんでRust,Wasm,Dockerで&rdquo;hello world&rdquo;をする MacOs catalinaでした。

κeenです。そういえばRustの環境構築の記事を最近みかけないなと思ったので書きます。
それとEmacsのセットアップや開発方法なども記します。" />
        
        <meta name="twitter:card" content="summary" />
        <meta property="og:article:published_time" content="2020-12-01 23:17:11 &#43;0900 JST" />
        <meta property="og:article:modified_time" content="2020-12-01 23:17:11 &#43;0900 JST" />
        
        <meta property="og:article:author" content="κeen" />

        <title>Rustの環境構築（Emacs） | κeenのHappy Hacκing Blog</title>
        <link rel="stylesheet" href='//fonts.googleapis.com/css?family=Open+Sans:400,300,600' type='text/css' />
        <link rel="stylesheet" href="/libraries/normalize.3.0.1.css" />
        <link rel="stylesheet" href="/css/liquorice.css" />
        <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
        <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
        <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
        <link rel="manifest" href="/manifest.json">
        <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
        <meta name="theme-color" content="#ffffff">
        <link rel="apple-touch-icon-precomposed" href="/apple-touch-icon-144-precomposed.png" sizes="144x144" />
        <link rel="stylesheet" href="/css/syntax-monokai.css" />
<script type="text/x-mathjax-config">
 MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ["\\(","\\)"]] } });
</script>
<script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_CHTML"></script>
</script>
<meta http-equiv="X-UA-Compatible" CONTENT="IE=EmulateIE7" />
<link rel="stylesheet" href="//unpkg.com/mermaid@7.0.4/dist/mermaid.forest.min.css">

    </head>
    <body class="li-body">

<header class="li-page-header" id="page-header">
    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <div class="li-brand li-left">
                <a href="/">κeenのHappy Hacκing Blog</a> | Lispエイリアンの狂想曲</div>
                <div class="li-menu li-right">
                    <span class="li-menu-icon" onclick="javascript:toggle('menu');">&#9776;</span>
                    <ul id="menu2" class="li-menu-items">
                        
                            <li><a href="/about/"> About </a></li>
                        
                            <li><a href="/index.xml"> Atom </a></li>
                        
                            <li><a href="/post/"> Blog </a></li>
                        
                            <li><a href="/slide/"> Slide </a></li>
                        
                    </ul>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="sixteen columns">
                <ul id="menu" class="li-menu-items li-menu-mobile">
                    
                        <li><a href="/about/"> About </a></li>
                    
                        <li><a href="/index.xml"> Atom </a></li>
                    
                        <li><a href="/post/"> Blog </a></li>
                    
                        <li><a href="/slide/"> Slide </a></li>
                    
                </ul>
            </div>
        </div>
    </div>
</header>






    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <article class="li-article">
                    <header class="li-article-header">
                        <h1 class="li-article-title">Rustの環境構築（Emacs）</h1>
                        <div class="li-article-meta">
    <time class="li-article-date">2020-12-01</time>
    <ul class="li-article-tag">
    
        <li>
            <a href="/categories/rust">Rust</a>
        </li>
    
        <li>
            <a href="/categories/rust-advent-calendar">Rust Advent Calendar</a>
        </li>
    
        <li>
            <a href="/categories/advent-calendar-2020">Advent Calendar 2020</a>
        </li>
    
        <li>
            <a href="/categories/advent-calendar">Advent Calendar</a>
        </li>
    
</ul>

</div>

                    </header>
                    <section>
                        <p>このエントリは<a href="https://qiita.com/advent-calendar/2020/rust3">Rust 3 Advent Calendar 2020</a>の2日目の記事です。前回はstnaoさんで<a href="https://qiita.com/stnao/items/c366cabffa77becdf9ef">Rust,Wasm,Dockerで&rdquo;hello world&rdquo;をする MacOs catalina</a>でした。</p>

<p>κeenです。そういえばRustの環境構築の記事を最近みかけないなと思ったので書きます。
それとEmacsのセットアップや開発方法なども記します。</p>

<h1 id="コンパイラのインストール">コンパイラのインストール</h1>

<p><a href="https://rustup.rs">rustup</a>を使います。</p>

<p>以下の<a href="https://rustup.rs">rustup.rs</a>にアクセスしたら出てくるとおり以下のコマンドを叩くだけです。</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ curl --proto <span class="s1">&#39;=https&#39;</span> --tlsv1.2 -sSf https://sh.rustup.rs <span class="p">|</span> sh</code></pre></div>
<p>たまに得体の知れないコマンドシェルスクリプトを直接 <code>sh</code> に流すのを嫌う人がいますが、
そもそも得体のしれないバイナリ（rustコンパイラ）をインストールしようとしてるので気にしすぎでしょう。</p>

<p>さて、上記コマンドを実行すると以下のようにインストールが走ります。</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">info: downloading installer

Welcome to Rust!

This will download and install the official compiler for the Rust
programming language, and its package manager, Cargo.

Rustup metadata and toolchains will be installed into the Rustup
home directory, located at:

  /home/shun/.rustup

This can be modified with the RUSTUP_HOME environment variable.

The Cargo home directory located at:

  /home/shun/.cargo

This can be modified with the CARGO_HOME environment variable.

The cargo, rustc, rustup and other commands will be added to
Cargo&#39;s bin directory, located at:

  /home/shun/.cargo/bin

This path will then be added to your PATH environment variable by
modifying the profile files located at:

  /home/shun/.profile
  /home/shun/.bash_profile
  /home/shun/.bashrc
  /home/shun/.zshenv

You can uninstall at any time with rustup self uninstall and
these changes will be reverted.

Current installation options:


   default host triple: x86_64-unknown-linux-gnu
     default toolchain: stable (default)
               profile: default
  modify PATH variable: yes

1) Proceed with installation (default)
2) Customize installation
3) Cancel installation</code></pre></div>
<p>選択肢がでてきますが、そのまま1を選びましょう。</p>

<p>1を選ぶとさらに進んでコンパイラツールチェーンのインストールがはじまります。</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">info: profile set to &#39;default&#39;
info: default host triple is x86_64-unknown-linux-gnu
info: syncing channel updates for &#39;stable-x86_64-unknown-linux-gnu&#39;
info: latest update on 2020-11-19, rust version 1.48.0 (7eac88abb 2020-11-16)
info: downloading component &#39;cargo&#39;
info: downloading component &#39;clippy&#39;
info: downloading component &#39;rust-docs&#39;
 13.3 MiB /  13.3 MiB (100 %)  10.7 MiB/s in  1s ETA:  0s
info: downloading component &#39;rust-std&#39;
 22.0 MiB /  22.0 MiB (100 %)  10.7 MiB/s in  2s ETA:  0s
info: downloading component &#39;rustc&#39;
 66.2 MiB /  66.2 MiB (100 %)  10.3 MiB/s in  6s ETA:  0s
info: downloading component &#39;rustfmt&#39;
info: installing component &#39;cargo&#39;
info: using up to 500.0 MiB of RAM to unpack components
info: installing component &#39;clippy&#39;
info: installing component &#39;rust-docs&#39;
info: installing component &#39;rust-std&#39;
 22.0 MiB /  22.0 MiB (100 %)  15.7 MiB/s in  1s ETA:  0s
info: installing component &#39;rustc&#39;
 66.2 MiB /  66.2 MiB (100 %)  18.1 MiB/s in  3s ETA:  0s
info: installing component &#39;rustfmt&#39;
info: default toolchain set to &#39;stable-x86_64-unknown-linux-gnu&#39;

  stable-x86_64-unknown-linux-gnu installed - rustc 1.48.0 (7eac88abb 2020-11-16)


Rust is installed now. Great!

To get started you need Cargo&#39;s bin directory ($HOME/.cargo/bin) in your PATH
environment variable. Next time you log in this will be done
automatically.

To configure your current shell, run:
source $HOME/.cargo/env</code></pre></div>
<p>最後に、表示されたコマンドを読み込んで現在のシェルで有効にします。</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">$ source $HOME/.cargo/env</code></pre></div>
<h1 id="ツールのインストール">ツールのインストール</h1>

<h2 id="フォーマッタ-リンタ">フォーマッタ、リンタ</h2>

<p>公式で配布されている<a href="https://github.com/rust-lang/rustfmt">rustfmt</a>（フォーマッタ）と<a href="https://github.com/rust-lang/rust-clippy">clippy</a>（リンタ）が鉄板です。
インストールは…既に上記の方法でインストールされています。
確認してみましょう。</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">$ which rustfmt
/home/shun/.cargo/bin/rustfmt
$ which cargo-clippy
/home/shun/.cargo/bin/cargo-clippy</code></pre></div>
<p>もしインストールされていなかったら下記のコマンドでインストールできます。</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">$ rustup component add rustfmt clippy</code></pre></div>
<h2 id="lspサーバ">LSPサーバ</h2>

<p><a href="https://microsoft.github.io/language-server-protocol/">LSP</a>はマイクロソフトが提唱した言語処理系とエディタ/IDEがやりとりするためのプロトコルです。
ざっくり言うとLSPをサポートしている言語ならEmacsがEclipseやIntelliJ並にリッチな環境になります。</p>

<p>さて、RustのLSPサーバの状況なのですが、ツールが2つあります。</p>

<p>1つが<a href="https://github.com/rust-lang/rls">rls</a>で現行の公式推奨のLSPサーバです。</p>

<p>もう1つが<a href="https://github.com/rust-analyzer/rust-analyzer">rust-analyzer</a>で、一応実験的な実装とされています。
しかし出来がよく、<a href="https://github.com/rust-analyzer/rust-analyzer/issues/4224">rust-analyzerを公式のツールにしよう</a>とする動きもあります。</p>

<p>ここでは両方のインストール方法を紹介するので好きな方をインストールしてみて下さい。</p>

<p>因みに私はrust-analyzerを使っています。</p>

<h3 id="rls">RLS</h3>

<p>rustupでインストールできます。</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">$ rustup component add rls</code></pre></div>
<h3 id="rust-analyzer">rust-analyzer</h3>

<p>毎週<a href="https://github.com/rust-analyzer/rust-analyzer/releases">バイナリリリースがGitHubに作られる</a>ので、そこからダウンロードして使います。</p>

<p>私はLinux（Ubuntu）使いでかつ、 <code>~/bin</code> にパスを通しているので以下のコマンドを毎週叩いています。</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">$ curl -L https://github.com/rust-analyzer/rust-analyzer/releases/latest/download/rust-analyzer-linux -o ~/bin/rust-analyzer</code></pre></div>
<p>rust-analyzerは毎週更新されるので使う方はGitHubの右上にある[Watch]から[Custom]の[Releases]にチェックを入れて、毎週のリリースの通知を受け取るとよいでしょう<sup class="footnote-ref" id="fnref:1"><a href="#fn:1">1</a></sup></p>

<h2 id="その他">その他</h2>

<p><code>cargo install</code> でRust製ツールをインストールできます。</p>

<p>個人的には <a href="https://github.com/killercup/cargo-edit"><code>cargo-edit</code></a>をよく使っています。</p>

<p>以下のコマンドでインストールできます。</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">$ cargo install cargo-edit</code></pre></div>
<p>あとで紹介するcargo-minor-modeでもサポートがあるのでおすすめです。</p>

<h1 id="emacsのセットアップ">Emacsのセットアップ</h1>

<p>使ってるパッケージは以下です。</p>

<ul>
<li><a href="https://github.com/rust-lang/rust-mode">rust-mode</a>: Rustのメジャーモード</li>
<li><a href="https://github.com/emacs-lsp/lsp-mode">lsp-mode</a>: 上述のLSPのEmacsサポート。Rustサポートも同梱されます。</li>
<li><a href="https://github.com/emacs-lsp/lsp-ui">lsp-ui</a>: LSPの表示レイヤー</li>
<li><a href="https://github.com/kwrooijen/cargo.el">cargo</a>: CargoをEmacsから呼び出せるキーバインド</li>
</ul>

<p>私は<a href="https://github.com/jwiegley/use-package">use-package</a>ユーザなので以下のように設定をしています。</p>
<div class="highlight"><pre class="chroma"><code class="language-emacs-lisp" data-lang="emacs-lisp"><span class="p">(</span><span class="nb">setq</span> <span class="nv">exec-path</span> <span class="p">(</span><span class="nf">cons</span> <span class="p">(</span><span class="nf">expand-file-name</span> <span class="s">&#34;~/bin&#34;</span><span class="p">)</span> <span class="nv">exec-path</span><span class="p">))</span>
<span class="p">(</span><span class="nb">setq</span> <span class="nv">exec-path</span> <span class="p">(</span><span class="nf">cons</span> <span class="p">(</span><span class="nf">expand-file-name</span> <span class="s">&#34;~/.cargo/bin&#34;</span><span class="p">)</span> <span class="nv">exec-path</span><span class="p">))</span>

<span class="c1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="c1">;;; #rust</span>

<span class="p">(</span><span class="nb">use-package</span> <span class="nv">rust-mode</span>
  <span class="nb">:ensure</span> <span class="no">t</span>
  <span class="nb">:custom</span> <span class="nv">rust-format-on-save</span> <span class="no">t</span><span class="p">)</span>


<span class="p">(</span><span class="nb">use-package</span> <span class="nv">cargo</span>
  <span class="nb">:ensure</span> <span class="no">t</span>
  <span class="nb">:hook</span> <span class="p">(</span><span class="nv">rust-mode</span> <span class="o">.</span> <span class="nv">cargo-minor-mode</span><span class="p">))</span>

<span class="c1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="c1">;;; #lsp</span>

<span class="p">(</span><span class="nb">use-package</span> <span class="nv">lsp-mode</span>
  <span class="nb">:ensure</span> <span class="no">t</span>
  <span class="nb">:hook</span> <span class="p">(</span><span class="nv">rust-mode</span> <span class="o">.</span> <span class="nv">lsp</span><span class="p">)</span>
  <span class="nb">:bind</span> <span class="p">(</span><span class="s">&#34;C-c h&#34;</span> <span class="o">.</span> <span class="nv">lsp-describe-thing-at-point</span><span class="p">)</span>
  <span class="nb">:custom</span> <span class="p">(</span><span class="nv">lsp-rust-server</span> <span class="ss">&#39;rust-analyzer</span><span class="p">))</span>
<span class="p">(</span><span class="nb">use-package</span> <span class="nv">lsp-ui</span>
  <span class="nb">:ensure</span> <span class="no">t</span><span class="p">)</span></code></pre></div>
<p>1つづつ解説していきます。</p>
<div class="highlight"><pre class="chroma"><code class="language-emacs-lisp" data-lang="emacs-lisp"><span class="p">(</span><span class="nb">setq</span> <span class="nv">exec-path</span> <span class="p">(</span><span class="nf">cons</span> <span class="p">(</span><span class="nf">expand-file-name</span> <span class="s">&#34;~/bin&#34;</span><span class="p">)</span> <span class="nv">exec-path</span><span class="p">))</span></code></pre></div>
<p><code>~/bin</code> を <code>exec-path</code> に加えます。私はrust-analyzerをここにインストールしているので必要です。</p>
<div class="highlight"><pre class="chroma"><code class="language-emacs-lisp" data-lang="emacs-lisp"><span class="p">(</span><span class="nb">setq</span> <span class="nv">exec-path</span> <span class="p">(</span><span class="nf">cons</span> <span class="p">(</span><span class="nf">expand-file-name</span> <span class="s">&#34;~/.cargo/bin&#34;</span><span class="p">)</span> <span class="nv">exec-path</span><span class="p">))</span></code></pre></div>
<p><code>~/.cargo/bin</code> を <code>exec-path</code> に加えます。cargoやrustfmtなどをEmacsから使うために必要です。</p>
<div class="highlight"><pre class="chroma"><code class="language-emacs-lisp" data-lang="emacs-lisp"><span class="p">(</span><span class="nb">use-package</span> <span class="nv">rust-mode</span>
  <span class="nb">:ensure</span> <span class="no">t</span>
  <span class="c1">; ...</span>
<span class="p">)</span></code></pre></div>
<p>rust-modeのパッケージを使う宣言です。なければインストールします。</p>
<div class="highlight"><pre class="chroma"><code class="language-emacs-lisp" data-lang="emacs-lisp">  <span class="nb">:custom</span> <span class="nv">rust-format-on-save</span> <span class="nv">t</span></code></pre></div>
<p>ファイルを保存する度に <code>rustfmt</code> を適用します。</p>
<div class="highlight"><pre class="chroma"><code class="language-emacs-lisp" data-lang="emacs-lisp"><span class="p">(</span><span class="nb">use-package</span> <span class="nv">cargo</span>
  <span class="nb">:ensure</span> <span class="no">t</span>
  <span class="c1">; ...</span>
<span class="p">)</span></code></pre></div>
<p>cargoのパッケージを使う宣言です。なければインストールします。</p>
<div class="highlight"><pre class="chroma"><code class="language-emacs-lisp" data-lang="emacs-lisp">  <span class="nb">:hook</span> <span class="p">(</span><span class="nv">rust-mode</span> <span class="o">.</span> <span class="nv">cargo-minor-mode</span><span class="p">)</span></code></pre></div>
<p><code>rust-mode-hook</code> に <code>cargo-minor-mode</code> を追加します。
これで <code>rust-mode</code> が起動するときは <code>cargo-minor-mode</code> がonになります。</p>
<div class="highlight"><pre class="chroma"><code class="language-emacs-lisp" data-lang="emacs-lisp"><span class="p">(</span><span class="nb">use-package</span> <span class="nv">lsp-mode</span>
  <span class="nb">:ensure</span> <span class="no">t</span>
  <span class="c1">; ...)</span></code></pre></div>
<p>lsp-modeのパッケージを使う宣言です。なければインストールします。</p>
<div class="highlight"><pre class="chroma"><code class="language-emacs-lisp" data-lang="emacs-lisp">  <span class="nb">:hook</span> <span class="p">(</span><span class="nv">rust-mode</span> <span class="o">.</span> <span class="nv">lsp</span><span class="p">)</span></code></pre></div>
<p><code>rust-mode-hook</code> に <code>lsp</code> を追加します。
これで <code>rust-mode</code> が起動するときは <code>lsp-mode</code> がonになります。</p>
<div class="highlight"><pre class="chroma"><code class="language-emacs-lisp" data-lang="emacs-lisp">  <span class="nb">:bind</span> <span class="p">(</span><span class="s">&#34;C-c h&#34;</span> <span class="o">.</span> <span class="nv">lsp-describe-thing-at-point</span><span class="p">)</span></code></pre></div>
<p><code>lsp-mode</code> では <code>C-c h</code> に <code>lsp-describe-thing-at-point</code> を割り当てます。</p>

<p>因みに <code>lsp-rust</code> のデフォルトのLSPバックエンドはrust-analyzerです。
RLSを使う方は <code>:custom (lsp-rust-server 'rls)</code> などの設定が必要になるでしょう。</p>
<div class="highlight"><pre class="chroma"><code class="language-emacs-lisp" data-lang="emacs-lisp"><span class="p">(</span><span class="nb">use-package</span> <span class="nv">lsp-ui</span>
  <span class="nb">:ensure</span> <span class="no">t</span><span class="p">)</span></code></pre></div>
<p>lsp-uiのパッケージを使う宣言です。なければインストールします。</p>

<p>その他お好みで設定して下さい。</p>

<h1 id="設定した環境の使いかた">設定した環境の使いかた</h1>

<h2 id="基本編">基本編</h2>

<p>基本は自動で動いてくれます。ちょっとプロジェクトを作ってテストしてみましょう。</p>

<p><code>cargo new</code> でプロジェクトを作ります。</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">$ cargo new test-project
     Created binary (application) `test-project` package</code></pre></div>
<p>プロジェクトをEmacsで開いてみましょう（<code>find-file</code>で <code>src/main.rs</code> を選択）。
lsp-modeがワークスペースをインポートするか尋いてくるので <code>i</code> と入力してインポートします。</p>

<p><img src="/images/Rustnokankyoukouchiku_Emacs_/import_project.png" alt="プロジェクトを開いたときの様子" /></p>

<p>初回はrust-analyzer/rlsの初期化に少し時間がかかります。</p>

<p><code>cargo new</code> で動くプロジェクトが作られているのでcargo-minor-modeのキーバインドを使って走らせてみましょう。</p>

<p><code>C-c C-c r</code> です。</p>

<p><img src="/images/Rustnokankyoukouchiku_Emacs_/cargo_run.png" alt="C-c C-c rで走らせたところ" /></p>

<p>下のウィンドウに &ldquo;Hello world!&rdquo; と表示されていますね。成功です。</p>

<p>それではlsp-modeの補完を試してみましょう。
ファイルの先頭に <code>use std::collections::HashMap;</code> と入力しようとしてみて下さい。
すると<a href="https://github.com/company-mode/company-mode">company</a>で補完がされるはずです。</p>

<p><img src="/images/Rustnokankyoukouchiku_Emacs_/completion_hashmap.png" alt="use std::collections::HashMap;を補完しているところ" /></p>

<p>次にツールでインストールしたcargo-editを使っていみましょう。cargo-minor-mode経由で使えます。
<code>C-c C-c a RET regex RET</code> と入力してみて下さい。</p>

<p><img src="/images/Rustnokankyoukouchiku_Emacs_/cargo_add.png" alt="cargo addを使っているところ" /></p>

<p>cargo-editでインストールされたサブコマンド、 <code>cargo add</code> を使ってパッケージを追加してくれます。
これは <code>Cargo.toml</code> の <code>[dependencies]</code> に <code>regex = &quot;最新のバージョン&quot;</code> を追記する指示です。
どうやらlsp-modeが追記を読み込んでくれないようなので <code>M-x lsp-restart-workspace</code> でリロードしましょう。</p>

<p>今追加したregexパッケージを使ってみましょう。
<code>let regex = Regex::new(&quot;foo.*&quot;).unwarp();</code> と入力しようとしてみて下さい。</p>

<p><img src="/images/Rustnokankyoukouchiku_Emacs_/completion_regex.png" alt="regex::Regexを補完しているところ" /></p>

<p>補完候補がでてきます。
このうち <code>regex::Regex</code> を選択するとファイルの先頭に <code>use regex::Regex;</code> が自動で追記されます。
なんとオートインポートまでされるんですね。
なんかドキュメントがオーバーレイ表示されて邪魔な場合は <code>M-x lsp-ui-doc-hide</code> とでもしてみて下さい。</p>

<p>続いて関連関数の <code>new</code> を入力するシーンでももちろん補完されます。</p>

<p><img src="/images/Rustnokankyoukouchiku_Emacs_/completion_regex_new.png" alt="Regex::newを補完しているところ" /></p>

<p>それではこれの型検査（<code>cargo check</code>）をしてみましょう。
cargo-minor-modeの <code>C-c C-c k</code> を使います。</p>

<p><img src="/images/Rustnokankyoukouchiku_Emacs_/compile.png" alt="C-c C-c kでチェックしているところ" /></p>

<p>未使用アイテムの警告が出て、エラーが0なのでチェックは通っているようですね。</p>

<h2 id="発展編">発展編</h2>

<p>普段の開発では私は以下の機能をよく使います。</p>

<ul>
<li>LSPの補完</li>
<li>LSPの定義ジャンプ（<code>M-.</code>）と元の場所に戻る（<code>M-,</code>）</li>
<li>LSPのActions（<code>s-l a a</code>）</li>
<li>cargo-minor-modeのcheck（<code>C-c C-c k</code>）

<ul>
<li>Rustの型検査だけやってくれる <code>cargo check</code> を起動する</li>
</ul></li>
<li>cargo-minor-modeのcheck（<code>C-c C-c K</code>）

<ul>
<li>Rustのlinterの <code>cargo clippy</code> を起動する</li>
</ul></li>
<li>cargo-minor-modeのtest（<code>C-c C-c t</code>）

<ul>
<li>テストを走らせる <code>cargo test</code> を起動する</li>
</ul></li>
<li>cargo-minor-modeのadd（<code>C-c C-c a</code>）

<ul>
<li>cargo-editプラグインの依存パッケージ追加コマンド <code>cargo add</code> を起動する</li>
</ul></li>
<li><code>C-c C-c k</code> のあとの <code>M-g M-n</code>/<code>M-g M-p</code> （next-error/previous-error）

<ul>
<li>Cargoの出したエラーの起きたソースの位置に飛べる</li>
</ul></li>
</ul>

<p>そんなに多くないので簡単に覚えられると思います。
このうち、Actionについて知らないと分からないと思うので説明しておきます。</p>

<p>LSPにはActionというものがあるようです。
コードの特定の場所にカーソルを合わせたときにLSPサーバがActionを提示できるならそれが表示されます。
例えば変数のリネームなどです。</p>

<p>rust-analyzerは結構面白いActionを提示してくれます。
例えば以下は <code>match</code> の空の腕の部分にカーソルを合わせた状態です。</p>

<p><img src="/images/Rustnokankyoukouchiku_Emacs_/action.png" alt="Actionが表示された画面" /></p>

<p>右上に赤字で表示されているようにパターンが足りていないのでエラーになります。
その下に &ldquo;Fill match arms&rdquo; とありますね。これがActionです。</p>

<p><img src="/images/Rustnokankyoukouchiku_Emacs_/action_cursor.png" alt="Actionはクリックできることを示す画面" /></p>

<p>このActionを実行してみましょう。マウスを使ってクリックするか、<code>s-l a a</code> と入力すると実行できます。
上の画像はマウスカーソルを合わせたところです。Emacsでもマウス操作ができるんですね。
なお、yasnippetが必要なので <code>yas-minor-mode</code> がonになってるかは確認しましょう。</p>

<p>Actionを適用すると以下のように補完されます。</p>

<p><img src="/images/Rustnokankyoukouchiku_Emacs_/action_applied.png" alt="Actionを適用したあとの画面" /></p>

<p>今回なmatchに必要な <code>Ok</code> と <code>Err</code> が補完されています。
型までみて賢く動作してくれるんですね。すごいですね。</p>

<p><img src="/images/Rustnokankyoukouchiku_Emacs_/complete_snippets.png" alt="Actionの適用後、最後まで書いた画面" /></p>

<p>あとはこれを埋めてコードを完成させましょう。</p>

<p>便利ですね。</p>

<h1 id="まとめ">まとめ</h1>

<p>Rustのツール群のインストール方法、Emacsのセットアップ方法、Emacsでの開発環境を紹介しました。</p>
<div class="footnotes">

<hr />

<ol>
<li id="fn:1">毎週のリリースの他に毎晩のプレリリースもあり、そちらも通知されてしまいますが、私は我慢して表示させるがままにしています。
 <a class="footnote-return" href="#fnref:1"><sup>[return]</sup></a></li>
</ol>
</div>
                    </section>
                </article>
            </div>
        </div>

        <div class="row li-author">
    <div class="sixteen columns">
        Written by <strong>κeen</strong>
    </div>
</div>


        <div class="row li-pagination">
            <div class="eight columns">
                <div class="li-pagination-previous">
                    
                        &nbsp;
                    
                </div>
            </div>
            <div class="eight columns">
                <div class="li-pagination-next">
                    
                        Older article<br />
                        <a href="/blog/2020/12/01/idrisnoinsuto_ru/"> Idrisのインストール</a>
                    
                </div>
            </div>
        </div>
    </div>

<footer class="li-page-footer">
    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <div class="li-page-footer-legal">
                    &copy; 2020. All rights reserved. 
                </div>
                <div class="li-page-footer-theme">
                    <span class=""><a href="https://github.com/eliasson/liquorice/">liquorice</a> is a theme for <a href="http://hugo.spf13.com">hugo</a></span>
                </div>
            </div>
        </div>
    </div>
</footer>

<script type="text/javascript">
 function toggle(id) {
     var e = document.getElementById(id);
     e.style.display == 'block' ? e.style.display = 'none' : e.style.display = 'block';
 }
</script>
<script src="https://unpkg.com/mermaid@7.0.4/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true
     });</script>

    </body>
</html>

