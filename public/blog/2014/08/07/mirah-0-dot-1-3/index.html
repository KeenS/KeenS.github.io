<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
    <head>
        
        
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-43779888-1"></script>
        <script>
         window.dataLayer = window.dataLayer || [];
         function gtag(){dataLayer.push(arguments);}
         gtag('js', new Date());

         gtag('config', 'UA-43779888-1');
        </script>
        

        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

        <meta name="twitter:site" content="@blackenedgold" />
        <meta name="twitter:title" content="Mirah 0.1.3がリリースされました | κeenのHappy Hacκing Blog"/>
        <meta name="twitter:description" content="本日2回目のκeenです。次はRuby-likeな文法でJavaが書けるMirah言語の0.1.3がリリースたのでこれを期にMirahの紹介をします。" />
        <meta property="og:title" content="Mirah 0.1.3がリリースされました | κeenのHappy Hacκing Blog" />
        <meta property="og:type" content="article" />
        <meta property="og:url" content="/blog/2014/08/07/mirah-0-dot-1-3/" />
        <meta name="twitter:card" content="summary_large_image" />
        <meta property="og:image" content="https://KeenS.github.io//images/ogp/post/mirah-0-dot-1-3.png" />
        <meta name="twitter:image" content="https://KeenS.github.io//images/ogp/post/mirah-0-dot-1-3.png" />
        
        <meta property="og:article:published_time" content="2014-08-07 23:52:15 &#43;0000 UTC" />
        <meta property="og:article:modified_time" content="2014-08-07 23:52:15 &#43;0000 UTC" />
        
        <meta property="og:article:author" content="κeen" />

        <title>Mirah 0.1.3がリリースされました | κeenのHappy Hacκing Blog</title>
        <link rel="stylesheet" href='//fonts.googleapis.com/css?family=Open+Sans:400,300,600' type='text/css' />
        <link rel="stylesheet" href="/libraries/normalize.3.0.1.css" />
        <link rel="stylesheet" href="/css/liquorice.css" />
        <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
        <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
        <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
        <link rel="manifest" href="/manifest.json">
        <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
        <meta name="theme-color" content="#ffffff">
        <link rel="apple-touch-icon-precomposed" href="/apple-touch-icon-144-precomposed.png" sizes="144x144" />
        <link rel="stylesheet" href="/css/syntax-monokai.css" />
<script type="text/x-mathjax-config">
 MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ["\\(","\\)"]] } });
</script>
<script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_CHTML"></script>
</script>
<meta http-equiv="X-UA-Compatible" CONTENT="IE=EmulateIE7" />
<link rel="stylesheet" href="//unpkg.com/mermaid@7.0.4/dist/mermaid.forest.min.css">

    </head>
    <body class="li-body">

<header class="li-page-header" id="page-header">
    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <div class="li-brand li-left">
                <a href="/">κeenのHappy Hacκing Blog</a> | Lispエイリアンの狂想曲</div>
                <div class="li-menu li-right">
                    <span class="li-menu-icon" onclick="javascript:toggle('menu');">&#9776;</span>
                    <ul id="menu2" class="li-menu-items">
                        
                            <li><a href="/about/"> About </a></li>
                        
                            <li><a href="/index.xml"> Atom </a></li>
                        
                            <li><a href="/post/"> Blog </a></li>
                        
                            <li><a href="/slide/"> Slide </a></li>
                        
                    </ul>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="sixteen columns">
                <ul id="menu" class="li-menu-items li-menu-mobile">
                    
                        <li><a href="/about/"> About </a></li>
                    
                        <li><a href="/index.xml"> Atom </a></li>
                    
                        <li><a href="/post/"> Blog </a></li>
                    
                        <li><a href="/slide/"> Slide </a></li>
                    
                </ul>
            </div>
        </div>
    </div>
</header>






    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <article class="li-article">
                    <header class="li-article-header">
                        <h1 class="li-article-title">Mirah 0.1.3がリリースされました</h1>
                        <div class="li-article-meta">
    <time class="li-article-date">2014-08-07</time>
    <ul class="li-article-tag">
    
        <li>
            <a href="/categories/mirah">Mirah</a>
        </li>
    
        <li>
            <a href="/categories/java">Java</a>
        </li>
    
        <li>
            <a href="/categories/ruby">Ruby</a>
        </li>
    
</ul>

</div>

                    </header>
                    <section>
                        <p>本日2回目のκeenです。次はRuby-likeな文法でJavaが書けるMirah言語の0.1.3がリリースたのでこれを期にMirahの紹介をします。</p>

<h1 id="mirahとは">Mirahとは？</h1>

<p><a href="http://mirah.org">公式ページ</a>。JRubyの開発者がJRubyのためにJavaを書くのが嫌になったという理由で作り始めた言語です。2008年にスタートだったかな？JRubyの開発の片手間に開発してるのでコミットペースはゆっくりです。</p>

<p><a href="https://github.com/mirah/mirah">github</a>のREADMEから引用すると、</p>

<ul>
<li>Ruby-like シンタックス</li>
<li>.classにコンパイルされる</li>
<li>Javaと同じスピード</li>
<li>ランタイムライブラリ必要なし</li>
</ul>

<p>な言語です。私的には</p>

<ul>
<li>型推論がある</li>
<li>マクロがある</li>
<li>面倒な部分はコンパイラが補ってくれる</li>
</ul>

<p>、Javaです。多くのJVM上の言語は独自言語+Java FFIって感じですが、Mirahは文法をRuby風にしただけで、吐かれるバイトコードはJavaコンパイラが吐くのものと等価です。</p>

<h1 id="サンプルコード">サンプルコード</h1>

<p>一番Javaっぽいコードを見せましょう。ファイル名は<code>HelloWorld.mirah</code>の他に<code>hello_world.mirah</code>でも構いません。</p>
<div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">HelloWorld</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">main</span><span class="p">(</span><span class="ss">args</span><span class="p">:</span><span class="nb">String</span><span class="o">[]</span><span class="p">)</span><span class="ss">:void</span>
    <span class="no">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">&#34;Hello World&#34;</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></div>
<p>まあ、Javaですね。JavaのstaticメソッドとRubyのクラスメソッドが対応しています。これをMirahの機能を使って書き換えていきます。</p>

<h2 id="暗黙のクラス">暗黙のクラス</h2>

<p>ファイル名からクラス名が推測出来るので省略することが出来ます。すなわち、トップレベルのメソッド定義は推測されたクラス内でのメソッド定義として扱われます。</p>
<div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">main</span><span class="p">(</span><span class="ss">args</span><span class="p">:</span><span class="nb">String</span><span class="o">[]</span><span class="p">)</span><span class="ss">:void</span>
  <span class="no">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">&#34;Hello World&#34;</span><span class="p">)</span>
<span class="k">end</span></code></pre></div>
<p>これでも動きます。</p>

<h2 id="暗黙のmain">暗黙のmain</h2>

<p>トップレベルの式はmain内のものとして扱われます。</p>
<div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="no">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">&#34;Hello World&#34;</span><span class="p">)</span></code></pre></div>
<p>こうも書けることになります。ただし、argsにアクセス出来ないので複雑なことをやりたかったら大人しく<code>self.main</code>を書きましょう。</p>

<h2 id="putsマクロ">putsマクロ</h2>

<p>mirahには組込みで<code>puts</code>というマクロが定義されています。これはコンパイル時に<code>System.out.println</code>に展開されます。</p>
<div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="nb">puts</span> <span class="s2">&#34;Hello World&#34;</span></code></pre></div>
<p>こう書けます。ここまでくるとRubyと同じコードになりますね。あ、()が省略可能なのは良いですよね。Ruby系の言語ではよくあることです。</p>

<h1 id="もうちょっとサンプル">もうちょっとサンプル</h1>

<p>mirah/exmpleから面白いのを拾ってきます。だいたいRubyです。</p>

<h2 id="リテラル">リテラル</h2>

<p>ほぼRubyです。つまり、<code>[]</code>が配列ではなくArrayListになってます。尚、自動でintがIntegerに変換されてます。
また、hashはHashMapです。</p>
<div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="n">str</span> <span class="o">=</span> <span class="s1">&#39;non-interpolated string&#39;</span>
<span class="n">str2</span> <span class="o">=</span> <span class="s2">&#34;interpolated is better than </span><span class="si">#{</span><span class="n">str</span><span class="si">}</span><span class="s2">&#34;</span>
<span class="n">heredoc</span> <span class="o">=</span> <span class="s">&lt;&lt;EOS
</span><span class="s"></span><span class="n">this</span> <span class="n">is</span> <span class="n">a</span> <span class="n">here</span> <span class="n">doc</span>
<span class="no">EOS</span>
<span class="n">int</span> <span class="o">=</span> <span class="mi">42</span>
<span class="n">char</span> <span class="o">=</span> <span class="sc">?a</span>
<span class="n">float</span> <span class="o">=</span> <span class="mi">3</span><span class="o">.</span><span class="mi">14159265358979323846264</span>
<span class="n">regex</span> <span class="o">=</span> <span class="sr">/\d(cow)+\w\\/</span>  <span class="c1"># in Java, this would be &#34;\\\\d(cow)+\\\\w\\\\\\\\&#34;</span>
<span class="n">regex2</span> <span class="o">=</span> <span class="sr">/interpolated </span><span class="si">#{</span><span class="n">regex</span><span class="si">}</span><span class="sr">/</span>
<span class="n">list</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="o">]</span>
<span class="n">list</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">array</span> <span class="o">=</span> <span class="n">byte</span><span class="o">[</span><span class="mi">5</span><span class="o">]</span>
<span class="n">array</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="n">byte</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="nb">hash</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&#34;one&#34;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&#34;two&#34;</span> <span class="o">=&gt;</span> <span class="mi">2</span> <span class="p">}</span>
<span class="nb">hash</span><span class="o">[</span><span class="s2">&#34;three&#34;</span><span class="o">]</span> <span class="o">=</span> <span class="mi">3</span></code></pre></div>
<h2 id="修飾import">修飾import</h2>
<div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="n">import</span> <span class="n">java</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">HashMap</span> <span class="n">as</span> <span class="n">H</span></code></pre></div>
<p>って書けます</p>

<h2 id="型推論">型推論</h2>

<p>Swingの例です。変数の型を書いてないことに注目して下さい。</p>
<div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="n">import</span> <span class="n">javax</span><span class="o">.</span><span class="n">swing</span><span class="o">.</span><span class="n">JFrame</span>
<span class="n">import</span> <span class="n">javax</span><span class="o">.</span><span class="n">swing</span><span class="o">.</span><span class="n">JButton</span>

<span class="c1"># FIXME blocks need to be inside a MethodDefinition, but main doesn&#39;t</span>
<span class="c1"># have one.</span>
<span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">run</span>
  <span class="n">frame</span> <span class="o">=</span> <span class="no">JFrame</span><span class="o">.</span><span class="n">new</span> <span class="s2">&#34;Welcome to Mirah&#34;</span>
  <span class="n">frame</span><span class="o">.</span><span class="n">setSize</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">300</span>
  <span class="n">frame</span><span class="o">.</span><span class="n">setVisible</span> <span class="kp">true</span>

  <span class="n">button</span> <span class="o">=</span> <span class="no">JButton</span><span class="o">.</span><span class="n">new</span> <span class="s2">&#34;Press me&#34;</span>
  <span class="n">frame</span><span class="o">.</span><span class="n">add</span> <span class="n">button</span>
  <span class="n">frame</span><span class="o">.</span><span class="n">show</span>

  <span class="n">button</span><span class="o">.</span><span class="n">addActionListener</span> <span class="k">do</span> <span class="o">|</span><span class="n">event</span><span class="o">|</span>
    <span class="no">JButton</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">getSource</span><span class="p">)</span><span class="o">.</span><span class="n">setText</span> <span class="s2">&#34;Mirah Rocks!&#34;</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">run</span></code></pre></div>
<h2 id="暗黙のinterface及び暗黙のabstractメソッド">暗黙のInterface及び暗黙のabstractメソッド</h2>

<p>先のSwingの例を良く見て下さい。この部分です。</p>
<div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby">  <span class="n">button</span><span class="o">.</span><span class="n">addActionListener</span> <span class="k">do</span> <span class="o">|</span><span class="n">event</span><span class="o">|</span>
    <span class="no">JButton</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">getSource</span><span class="p">)</span><span class="o">.</span><span class="n">setText</span> <span class="s2">&#34;Mirah Rocks!&#34;</span>
  <span class="k">end</span></code></pre></div>
<p>Javaだと</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="n">button</span><span class="o">.</span><span class="na">addactionlistener</span><span class="o">(</span><span class="k">new</span> <span class="n">ActionListener</span><span class="o">(){</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">actionPerformed</span><span class="o">(</span><span class="n">ActionEvent</span> <span class="n">event</span><span class="o">){</span>
        <span class="n">JButton</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">getSource</span><span class="o">).</span><span class="na">setText</span><span class="o">(</span><span class="s">&#34;Mirah Rocks!&#34;</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">});</span></code></pre></div>
<p>となっていたところが、</p>

<ol>
<li>引数の型がインターフェースだったときはブロックで<code>new Class(){}</code>と同じ働きになる</li>
<li>abstractメソッドが一つのときはそれも省略出来る</li>
</ol>

<p>というルールにより簡潔に書けます。これで引数の中に文が現れるという最悪の事態を回避出来ます。Java8のlambda式に近いのかな？Java8に詳しくなくてゴメンなさい。</p>

<p>似たようなので、Threadも</p>
<div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="no">Thread</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
 <span class="c1"># do something</span>
<span class="k">end</span><span class="o">.</span><span class="n">start</span></code></pre></div>
<p>と書けます。</p>

<h2 id="マクロによる既存クラスの拡張">マクロによる既存クラスの拡張</h2>

<p>マクロは展開後のASTがJavaとして有効であれば良いのでJavaでは出来ない芸当が可能です。</p>

<p>シンプルだけど強力な例</p>
<div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="mi">10</span><span class="o">.</span><span class="n">times</span><span class="p">{</span> <span class="nb">puts</span> <span class="s2">&#34;Hi&#34;</span><span class="p">}</span></code></pre></div>
<p>intを<code>times</code>マクロで拡張してます。その他、<code>each</code>などの便利マクロや<code>attr_accessor</code>(getterとsetterを自動生成する)など色々あります。ユーザー定義のマクロで拡張も可能ですが、今シンプルに書けるシンタックスが議論中です。</p>

<h1 id="javaとの互換性とか完成度とか">Javaとの互換性とか完成度とか</h1>

<p>まだ未実装機能はいっぱいあります。<code>final</code>とか<code>synchronized</code>とか。あとスコープもRuby風に<code>private</code>以下で定義されたものはprivateですがメソッド/フィールド単位では制限出来ません<sup class="footnote-ref" id="fnref:1"><a href="#fn:1">1</a></sup>。ジェネリクスの構文もまだサポートされてません<sup class="footnote-ref" id="fnref:2"><a href="#fn:2">2</a></sup>のでジェネリクスの定義は不可能、使用も型推論で型を明示的に書かなくても良いときのみ可能です。インターフェースやアノテーションはあります。</p>

<p><a href="https://docs.google.com/spreadsheets/d/1t7NVsyysIlj6OF6E26OrVJ1AVrL8i2yzbMv92cdHN8c/edit#gid=0">ここ</a>にTODOがありますが、inner classやlambda(多分Java8のlambda式とは別もの)が弱いようです。</p>

<p>でもまあ、Mirah自体Mirahでセルフホスティングされてますし一つ言語を作れる程度には機能は揃ってます。遊んでみる分には十分使えると思います。</p>

<h1 id="マクロの話">マクロの話</h1>

<p>Mirahはオブジェクト指向で静的型付けの言語でマクロを実装してます。Lisper的には割と面白かったのでちょいと触れますね。</p>

<p>まずは簡単な例から。</p>
<div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="n">macro</span> <span class="k">def</span> <span class="nf">puts</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
  <span class="n">quote</span> <span class="p">{</span><span class="no">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="sb">` [node] `</span><span class="p">)}</span>
<span class="k">end</span></code></pre></div>
<p>Lisperなら</p>

<ul>
<li><code>macro def</code>で<code>defmacro</code></li>
<li><code>quote block</code>でquasiquote</li>
<li>バックスラッシュで囲んでunquote</li>
</ul>

<p>などが読み取れると思います。</p>

<p>今のはASTは陽には出てこない簡単な例でしたが、次はちょっと飛躍しますよ？</p>
<div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="n">macro</span> <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">abstract</span><span class="p">(</span><span class="ss">klass</span><span class="p">:</span><span class="no">ClassDefinition</span><span class="p">)</span>
  <span class="n">anno</span> <span class="o">=</span> <span class="no">Annotation</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@call</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="no">Constant</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">SimpleString</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;org.mirah.jvm.types.Modifiers&#39;</span><span class="p">)),</span>
                        <span class="o">[</span><span class="no">HashEntry</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">SimpleString</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;flags&#39;</span><span class="p">),</span> <span class="nb">Array</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span><span class="no">SimpleString</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;ABSTRACT&#39;</span><span class="p">)</span><span class="o">]</span><span class="p">))</span><span class="o">]</span><span class="p">)</span>
  <span class="n">klass</span><span class="o">.</span><span class="n">annotations</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">anno</span><span class="p">)</span>
  <span class="n">klass</span><span class="o">.</span><span class="n">setParent</span><span class="p">(</span><span class="kp">nil</span><span class="p">)</span>
  <span class="n">klass</span>
<span class="k">end</span></code></pre></div>
<ul>
<li>macroにも型がある。その型はASTの型。</li>
<li>というかClassDefinitionとかいう型がある</li>
<li>ASTをいじるときにASTのNodeオブジェクトのメンバをゴニョゴニョするという手段がある</li>
</ul>

<p>などが読み取れると思います。また、ClassDefinitionを受け取ってClassDefinitionを返しているのでmacro chainが可能ですね。</p>

<p>次はASTを自分で組み立てる例です。</p>
<div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby">  <span class="n">macro</span> <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">attr_reader</span><span class="p">(</span><span class="nb">hash</span><span class="ss">:Hash</span><span class="p">)</span>
    <span class="nb">methods</span> <span class="o">=</span> <span class="no">NodeList</span><span class="o">.</span><span class="n">new</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">size</span> <span class="o">=</span> <span class="nb">hash</span><span class="o">.</span><span class="n">size</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span>
      <span class="n">e</span> <span class="o">=</span> <span class="nb">hash</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
      <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="nb">method</span> <span class="o">=</span> <span class="n">quote</span> <span class="k">do</span>
        <span class="k">def</span> <span class="nf">`</span><span class="n">e</span><span class="o">.</span><span class="n">key</span><span class="sb">`:`</span><span class="n">e</span><span class="o">.</span><span class="n">value</span><span class="sb">`  #`</span>
          <span class="err">@</span><span class="sb">`e.key`</span>
        <span class="k">end</span>
      <span class="k">end</span>
      <span class="nb">methods</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">method</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="nb">methods</span>
  <span class="k">end</span></code></pre></div>
<p>NodeListがprognみたいなものでその中にMethodDefinitionを突っ込んでいってますね。中々楽しい。</p>

<p>余談:ところでgetterメソッド名がgetKeyじゃなくてkeyになってますよね。コンパイル後は変換してくれるのかなと思い、</p>
<div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="vi">@foo</span> <span class="o">=</span> <span class="s2">&#34;a&#34;</span>
<span class="kp">attr_accessor</span> <span class="ss">:foo</span> <span class="o">=&gt;</span> <span class="ss">:String</span></code></pre></div>
<p>をコンパイル、ディスアセンブルしてみました。すると、<code>foo</code>と<code>set_foo</code>というメソッドが定義されてましたorz。Ruby的にはまあ良いんですがコンパイル後はJavaなのでそこはgetKey/setKeyにしてほしかったですね。もしかしたら今はシンボルをキャメルケースに変換出来ないのかもしれません</p>

<p>閑話休題。また、呼び出し元の情報もとれます。これはStringの+マクロです。</p>
<div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="n">macro</span> <span class="k">def</span> <span class="nf">+</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
  <span class="n">quote</span> <span class="p">{</span> <span class="s2">&#34;</span><span class="si">#{</span><span class="sb">`@call.target`</span><span class="si">}#{</span><span class="sb">`arg`</span><span class="si">}</span><span class="s2">&#34;</span> <span class="p">}</span>
<span class="k">end</span></code></pre></div>
<p><code>@call</code>に呼び出し元の情報が入ってるのでそれを使って情報をとれます。</p>

<p>gensymなんかもあります。これはintのtimesマクロです。</p>
<div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="n">macro</span> <span class="k">def</span> <span class="nf">times</span><span class="p">(</span><span class="ss">block</span><span class="p">:</span><span class="no">Block</span><span class="p">)</span>
  <span class="n">i</span> <span class="o">=</span> <span class="k">if</span> <span class="n">block</span><span class="o">.</span><span class="n">arguments</span> <span class="o">&amp;&amp;</span> <span class="n">block</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">required_size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="n">block</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">required</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">identifier</span>
  <span class="k">else</span>
    <span class="n">gensym</span>
  <span class="k">end</span>
  <span class="n">last</span> <span class="o">=</span> <span class="n">gensym</span>
  <span class="n">quote</span> <span class="p">{</span>
    <span class="k">while</span> <span class="sb">`i`</span> <span class="o">&lt;</span> <span class="sb">`last`</span>
      <span class="n">init</span> <span class="p">{</span> <span class="sb">`i`</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="sb">`last`</span> <span class="o">=</span> <span class="sb">`@call.target`</span><span class="p">}</span>
      <span class="n">post</span> <span class="p">{</span> <span class="sb">`i`</span> <span class="o">=</span> <span class="sb">`i`</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">}</span>
      <span class="sb">`block.body`</span>
    <span class="k">end</span>
  <span class="p">}</span>
<span class="k">end</span></code></pre></div>
<p>whileの中にある<code>init</code>と<code>post</code>はRubyでいう<code>BEGIN</code>と<code>END</code>、JVM的には<code>for</code>の実装のために使われているのでしょうか。</p>

<h1 id="まとめとか雑感とか">まとめとか雑感とか</h1>

<p>0.1.3で一番大きな変更はセルフホストされたことですね。今まではJRubyで書かれてたのでHello Worldのコンパイルに16秒とか掛かってました。今のmirahc.jarはかなり小さく、1MBちょっとしかありません。</p>

<p>入手法はgithubから良いかんじにダウンロード出来るんじゃないですかね？（適当）</p>

<p>古いバージョンにはMirahのコードと等価なJavaのソースを吐くオプションがありましたがコンパイラが変わってなくなりました。かつてheadiusはこの機能を使って吐いたコードをJRubyにコミットしたことがあるそうです。今新しいコンパイラが安定してきたのでそろそろ再実装されそうです。</p>

<p>exampleですが一応私のコミットも入ってます。<code>grep keen NOTICE</code>ってやってみて下さい。</p>

<p>mirah-mode.elをちまちま書いてますが道程は通そうです。ブロックコメント(<code>/* .. */</code>)がネスト可能なのですが、正規表現だと<code>/*/*</code>を<code>/*</code>2つと<code>*/</code>1つと認識しちゃってつらいです。</p>

<p>今回細かいところは省きましたがexampleとかあと公式ページとかgithubのwikiとか見て下さいね。</p>

<p>ある程度の完成度になってきてるのでみなさんも遊んでみて下さい。</p>
<div class="footnotes">

<hr />

<ol>
<li id="fn:1">pull-reqは入ってるのですが、まだマージされてません
 <a class="footnote-return" href="#fnref:1"><sup>[return]</sup></a></li>
<li id="fn:2">まだリテラルの議論が終わってないだけで、内部はジェネリクスに対応してるので近い内に入りそうな気はします。
 <a class="footnote-return" href="#fnref:2"><sup>[return]</sup></a></li>
</ol>
</div>
                    </section>
                </article>
            </div>
        </div>

        <div class="row li-author">
    <div class="sixteen columns">
        Written by <strong>κeen</strong>
    </div>
</div>


        <div class="row li-pagination">
            <div class="eight columns">
                <div class="li-pagination-previous">
                    
                        Later article<br />
                        <a href="/blog/2014/08/13/emacs-utility-functions/"> Emacs便利機能/Tips紹介</a>
                    
                </div>
            </div>
            <div class="eight columns">
                <div class="li-pagination-next">
                    
                        Older article<br />
                        <a href="/blog/2014/08/07/shibuya-dot-xss-tt-number-5-nican-jia-sitekimasita/"> Shibuya.XSS TT #5 に参加してきました</a>
                    
                </div>
            </div>
        </div>
    </div>

<footer class="li-page-footer">
    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <div class="li-page-footer-legal">
                    &copy; 2020. All rights reserved. 
                </div>
                <div class="li-page-footer-theme">
                    <span class=""><a href="https://github.com/eliasson/liquorice/">liquorice</a> is a theme for <a href="http://hugo.spf13.com">hugo</a></span>
                </div>
            </div>
        </div>
    </div>
</footer>

<script type="text/javascript">
 function toggle(id) {
     var e = document.getElementById(id);
     e.style.display == 'block' ? e.style.display = 'none' : e.style.display = 'block';
 }
</script>
<script src="https://unpkg.com/mermaid@7.0.4/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true
     });</script>

    </body>
</html>

