<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
    <head>
        
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

        <title>Mirah 0.1.3がリリースされました | κeenのHappy Hacκing Blog</title>
        <link rel="stylesheet" href='http://fonts.googleapis.com/css?family=Open+Sans:400,300,600' type='text/css' />
        <link rel="stylesheet" href="http://keens.github.io//libraries/normalize.3.0.1.css" />
        <link rel="stylesheet" href="http://keens.github.io//css/liquorice.css" />
        <link rel="shortcut icon" href="http://KeenS.github.io/favicon.ico" />
        <link rel="apple-touch-icon-precomposed" href="http://KeenS.github.io/apple-touch-icon-144-precomposed.png" sizes="144x144" />
        <link rel="alternate" href="" type="application/rss+xml" title="κeenのHappy Hacκing Blog" />
        
        <script>
         (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
             (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                                  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
         })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

         ga('create', 'UA-43779888-1', 'auto');
         ga('send', 'pageview');

        </script>
        
        <link rel="stylesheet" href="http://keens.github.io//highlight.js/styles/xcode.css" />
<script src="http://keens.github.io//highlight.js/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script type="text/x-mathjax-config">
 MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ["\\(","\\)"]] } });
</script>
<script type="text/javascript"
        src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML">
</script>
<meta http-equiv="X-UA-Compatible" CONTENT="IE=EmulateIE7" />

    </head>
    <body class="li-body">

<header class="li-page-header">
    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <div class="li-brand li-left">
                <a href="http://keens.github.io//">κeenのHappy Hacκing Blog</a> | Lispエイリアンの狂想曲</div>
                <div class="li-menu li-right">
                    <span class="li-menu-icon" onclick="javascript:toggle('menu');">&#9776;</span>
                    <ul id="menu2" class="li-menu-items">
                        
                            <li><a href="http://KeenS.github.io/about"> About </a></li>
                        
                            <li><a href="http://KeenS.github.io/post/"> Blog </a></li>
                        
                            <li><a href="http://KeenS.github.io/slide/"> Slide </a></li>
                        
                    </ul>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="sixteen columns">
                <ul id="menu" class="li-menu-items li-menu-mobile">
                    
                        <li><a href="http://KeenS.github.io/about"> About </a></li>
                    
                        <li><a href="http://KeenS.github.io/post/"> Blog </a></li>
                    
                        <li><a href="http://KeenS.github.io/slide/"> Slide </a></li>
                    
                </ul>
            </div>
        </div>
    </div>
</header>






    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <article class="li-article">
                    <header class="li-article-header">
                        <h1 class="li-article-title">Mirah 0.1.3がリリースされました</h1>
                        <div class="li-article-meta">
    <time class="li-article-date">2014-08-07</time>
    <ul class="li-article-tag">
    
        <li>
            <a href="http://KeenS.github.io/categories/mirah">Mirah</a>
        </li>
    
        <li>
            <a href="http://KeenS.github.io/categories/java">Java</a>
        </li>
    
        <li>
            <a href="http://KeenS.github.io/categories/ruby">Ruby</a>
        </li>
    
</ul>

</div>

                    </header>
                    <section>
                        

<p>本日2回目のκeenです。次はRuby-likeな文法でJavaが書けるMirah言語の0.1.3がリリースたのでこれを期にMirahの紹介をします。</p>

<h1 id="mirahとは:bd19912fa4d362f5c3ffb4b0e0056c12">Mirahとは？</h1>

<p><a href="http://mirah.org">公式ページ</a>。JRubyの開発者がJRubyのためにJavaを書くのが嫌になったという理由で作り始めた言語です。2008年にスタートだったかな？JRubyの開発の片手間に開発してるのでコミットペースはゆっくりです。</p>

<p><a href="https://github.com/mirah/mirah">github</a>のREADMEから引用すると、</p>

<ul>
<li>Ruby-like シンタックス</li>
<li>.classにコンパイルされる</li>
<li>Javaと同じスピード</li>
<li>ランタイムライブラリ必要なし</li>
</ul>

<p>な言語です。私的には</p>

<ul>
<li>型推論がある</li>
<li>マクロがある</li>
<li>面倒な部分はコンパイラが補ってくれる</li>
</ul>

<p>、Javaです。多くのJVM上の言語は独自言語+Java FFIって感じですが、Mirahは文法をRuby風にしただけで、吐かれるバイトコードはJavaコンパイラが吐くのものと等価です。</p>

<h1 id="サンプルコード:bd19912fa4d362f5c3ffb4b0e0056c12">サンプルコード</h1>

<p>一番Javaっぽいコードを見せましょう。ファイル名は<code>HelloWorld.mirah</code>の他に<code>hello_world.mirah</code>でも構いません。</p>

<pre><code class="language-ruby">class HelloWorld
  def self.main(args:String[]):void
    System.out.println(&quot;Hello World&quot;)
  end
end
</code></pre>

<p>まあ、Javaですね。JavaのstaticメソッドとRubyのクラスメソッドが対応しています。これをMirahの機能を使って書き換えていきます。</p>

<h2 id="暗黙のクラス:bd19912fa4d362f5c3ffb4b0e0056c12">暗黙のクラス</h2>

<p>ファイル名からクラス名が推測出来るので省略することが出来ます。すなわち、トップレベルのメソッド定義は推測されたクラス内でのメソッド定義として扱われます。</p>

<pre><code class="language-ruby">def self.main(args:String[]):void
  System.out.println(&quot;Hello World&quot;)
end
</code></pre>

<p>これでも動きます。</p>

<h2 id="暗黙のmain:bd19912fa4d362f5c3ffb4b0e0056c12">暗黙のmain</h2>

<p>トップレベルの式はmain内のものとして扱われます。</p>

<pre><code class="language-ruby">System.out.println(&quot;Hello World&quot;)
</code></pre>

<p>こうも書けることになります。ただし、argsにアクセス出来ないので複雑なことをやりたかったら大人しく<code>self.main</code>を書きましょう。</p>

<h2 id="putsマクロ:bd19912fa4d362f5c3ffb4b0e0056c12">putsマクロ</h2>

<p>mirahには組込みで<code>puts</code>というマクロが定義されています。これはコンパイル時に<code>System.out.println</code>に展開されます。</p>

<pre><code class="language-ruby">puts &quot;Hello World&quot;
</code></pre>

<p>こう書けます。ここまでくるとRubyと同じコードになりますね。あ、()が省略可能なのは良いですよね。Ruby系の言語ではよくあることです。</p>

<h1 id="もうちょっとサンプル:bd19912fa4d362f5c3ffb4b0e0056c12">もうちょっとサンプル</h1>

<p>mirah/exmpleから面白いのを拾ってきます。だいたいRubyです。</p>

<h2 id="リテラル:bd19912fa4d362f5c3ffb4b0e0056c12">リテラル</h2>

<p>ほぼRubyです。つまり、<code>[]</code>が配列ではなくArrayListになってます。尚、自動でintがIntegerに変換されてます。
また、hashはHashMapです。</p>

<pre><code class="language-ruby">str = 'non-interpolated string'
str2 = &quot;interpolated is better than #{str}&quot;
heredoc = &lt;&lt;EOS
this is a here doc
EOS
int = 42
char = ?a
float = 3.14159265358979323846264
regex = /\d(cow)+\w\\/  # in Java, this would be &quot;\\\\d(cow)+\\\\w\\\\\\\\&quot;
regex2 = /interpolated #{regex}/
list = [1, 2, 3]
list[2] = 4
array = byte[5]
array[0] = byte(0)
hash = { &quot;one&quot; =&gt; 1, &quot;two&quot; =&gt; 2 }
hash[&quot;three&quot;] = 3
</code></pre>

<h2 id="修飾import:bd19912fa4d362f5c3ffb4b0e0056c12">修飾import</h2>

<pre><code class="language-ruby">import java.util.HashMap as H
</code></pre>

<p>って書けます</p>

<h2 id="型推論:bd19912fa4d362f5c3ffb4b0e0056c12">型推論</h2>

<p>Swingの例です。変数の型を書いてないことに注目して下さい。</p>

<pre><code class="language-ruby">import javax.swing.JFrame
import javax.swing.JButton

# FIXME blocks need to be inside a MethodDefinition, but main doesn't
# have one.
def self.run
  frame = JFrame.new &quot;Welcome to Mirah&quot;
  frame.setSize 300, 300
  frame.setVisible true

  button = JButton.new &quot;Press me&quot;
  frame.add button
  frame.show

  button.addActionListener do |event|
    JButton(event.getSource).setText &quot;Mirah Rocks!&quot;
  end
end

run
</code></pre>

<h2 id="暗黙のinterface及び暗黙のabstractメソッド:bd19912fa4d362f5c3ffb4b0e0056c12">暗黙のInterface及び暗黙のabstractメソッド</h2>

<p>先のSwingの例を良く見て下さい。この部分です。</p>

<pre><code class="language-ruby">  button.addActionListener do |event|
    JButton(event.getSource).setText &quot;Mirah Rocks!&quot;
  end
</code></pre>

<p>Javaだと</p>

<pre><code class="language-java">button.addactionlistener(new ActionListener(){
    public void actionPerformed(ActionEvent event){
        JButton(event.getSource).setText(&quot;Mirah Rocks!&quot;);
    }
});
</code></pre>

<p>となっていたところが、</p>

<ol>
<li>引数の型がインターフェースだったときはブロックで<code>new Class(){}</code>と同じ働きになる</li>
<li>abstractメソッドが一つのときはそれも省略出来る</li>
</ol>

<p>というルールにより簡潔に書けます。これで引数の中に文が現れるという最悪の事態を回避出来ます。Java8のlambda式に近いのかな？Java8に詳しくなくてゴメンなさい。</p>

<p>似たようなので、Threadも</p>

<pre><code class="language-ruby">Thread.new do
 # do something
end.start
</code></pre>

<p>と書けます。</p>

<h2 id="マクロによる既存クラスの拡張:bd19912fa4d362f5c3ffb4b0e0056c12">マクロによる既存クラスの拡張</h2>

<p>マクロは展開後のASTがJavaとして有効であれば良いのでJavaでは出来ない芸当が可能です。</p>

<p>シンプルだけど強力な例</p>

<pre><code class="language-ruby">10.times{ puts &quot;Hi&quot;}
</code></pre>

<p>intを<code>times</code>マクロで拡張してます。その他、<code>each</code>などの便利マクロや<code>attr_accessor</code>(getterとsetterを自動生成する)など色々あります。ユーザー定義のマクロで拡張も可能ですが、今シンプルに書けるシンタックスが議論中です。</p>

<h1 id="javaとの互換性とか完成度とか:bd19912fa4d362f5c3ffb4b0e0056c12">Javaとの互換性とか完成度とか</h1>

<p>まだ未実装機能はいっぱいあります。<code>final</code>とか<code>synchronized</code>とか。あとスコープもRuby風に<code>private</code>以下で定義されたものはprivateですがメソッド/フィールド単位では制限出来ません<sup class="footnote-ref" id="fnref:bd19912fa4d362f5c3ffb4b0e0056c12:1"><a rel="footnote" href="#fn:bd19912fa4d362f5c3ffb4b0e0056c12:1">1</a></sup>。ジェネリクスの構文もまだサポートされてません<sup class="footnote-ref" id="fnref:bd19912fa4d362f5c3ffb4b0e0056c12:2"><a rel="footnote" href="#fn:bd19912fa4d362f5c3ffb4b0e0056c12:2">2</a></sup>のでジェネリクスの定義は不可能、使用も型推論で型を明示的に書かなくても良いときのみ可能です。インターフェースやアノテーションはあります。</p>

<p><a href="https://docs.google.com/spreadsheets/d/1t7NVsyysIlj6OF6E26OrVJ1AVrL8i2yzbMv92cdHN8c/edit#gid=0">ここ</a>にTODOがありますが、inner classやlambda(多分Java8のlambda式とは別もの)が弱いようです。</p>

<p>でもまあ、Mirah自体Mirahでセルフホスティングされてますし一つ言語を作れる程度には機能は揃ってます。遊んでみる分には十分使えると思います。</p>

<h1 id="マクロの話:bd19912fa4d362f5c3ffb4b0e0056c12">マクロの話</h1>

<p>Mirahはオブジェクト指向で静的型付けの言語でマクロを実装してます。Lisper的には割と面白かったのでちょいと触れますね。</p>

<p>まずは簡単な例から。</p>

<pre><code class="language-ruby">macro def puts(node)
  quote {System.out.println(` [node] `)}
end
</code></pre>

<p>Lisperなら</p>

<ul>
<li><code>macro def</code>で<code>defmacro</code></li>
<li><code>quote block</code>でquasiquote</li>
<li>バックスラッシュで囲んでunquote</li>
</ul>

<p>などが読み取れると思います。</p>

<p>今のはASTは陽には出てこない簡単な例でしたが、次はちょっと飛躍しますよ？</p>

<pre><code class="language-ruby">macro def self.abstract(klass:ClassDefinition)
  anno = Annotation.new(@call.name.position, Constant.new(SimpleString.new('org.mirah.jvm.types.Modifiers')),
                        [HashEntry.new(SimpleString.new('flags'), Array.new([SimpleString.new('ABSTRACT')]))])
  klass.annotations.add(anno)
  klass.setParent(nil)
  klass
end
</code></pre>

<ul>
<li>macroにも型がある。その型はASTの型。</li>
<li>というかClassDefinitionとかいう型がある</li>
<li>ASTをいじるときにASTのNodeオブジェクトのメンバをゴニョゴニョするという手段がある</li>
</ul>

<p>などが読み取れると思います。また、ClassDefinitionを受け取ってClassDefinitionを返しているのでmacro chainが可能ですね。</p>

<p>次はASTを自分で組み立てる例です。</p>

<pre><code class="language-ruby">  macro def self.attr_reader(hash:Hash)
    methods = NodeList.new
    i = 0
    size = hash.size
    while i &lt; size
      e = hash.get(i)
      i += 1
      method = quote do
        def `e.key`:`e.value`  #`
          @`e.key`
        end
      end
      methods.add(method)
    end
    methods
  end
</code></pre>

<p>NodeListがprognみたいなものでその中にMethodDefinitionを突っ込んでいってますね。中々楽しい。</p>

<p>余談:ところでgetterメソッド名がgetKeyじゃなくてkeyになってますよね。コンパイル後は変換してくれるのかなと思い、</p>

<pre><code class="language-ruby">@foo = &quot;a&quot;
attr_accessor :foo =&gt; :String
</code></pre>

<p>をコンパイル、ディスアセンブルしてみました。すると、<code>foo</code>と<code>set_foo</code>というメソッドが定義されてましたorz。Ruby的にはまあ良いんですがコンパイル後はJavaなのでそこはgetKey/setKeyにしてほしかったですね。もしかしたら今はシンボルをキャメルケースに変換出来ないのかもしれません</p>

<p>閑話休題。また、呼び出し元の情報もとれます。これはStringの+マクロです。</p>

<pre><code class="language-ruby">macro def +(arg)
  quote { &quot;#{`@call.target`}#{`arg`}&quot; }
end
</code></pre>

<p><code>@call</code>に呼び出し元の情報が入ってるのでそれを使って情報をとれます。</p>

<p>gensymなんかもあります。これはintのtimesマクロです。</p>

<pre><code class="language-ruby">macro def times(block:Block)
  i = if block.arguments &amp;&amp; block.arguments.required_size() &gt; 0
    block.arguments.required(0).name.identifier
  else
    gensym
  end
  last = gensym
  quote {
    while `i` &lt; `last`
      init { `i` = 0; `last` = `@call.target`}
      post { `i` = `i` + 1 }
      `block.body`
    end
  }
end
</code></pre>

<p>whileの中にある<code>init</code>と<code>post</code>はRubyでいう<code>BEGIN</code>と<code>END</code>、JVM的には<code>for</code>の実装のために使われているのでしょうか。</p>

<h1 id="まとめとか雑感とか:bd19912fa4d362f5c3ffb4b0e0056c12">まとめとか雑感とか</h1>

<p>0.1.3で一番大きな変更はセルフホストされたことですね。今まではJRubyで書かれてたのでHello Worldのコンパイルに16秒とか掛かってました。今のmirahc.jarはかなり小さく、1MBちょっとしかありません。</p>

<p>入手法はgithubから良いかんじにダウンロード出来るんじゃないですかね？（適当）</p>

<p>古いバージョンにはMirahのコードと等価なJavaのソースを吐くオプションがありましたがコンパイラが変わってなくなりました。かつてheadiusはこの機能を使って吐いたコードをJRubyにコミットしたことがあるそうです。今新しいコンパイラが安定してきたのでそろそろ再実装されそうです。</p>

<p>exampleですが一応私のコミットも入ってます。<code>grep keen NOTICE</code>ってやってみて下さい。</p>

<p>mirah-mode.elをちまちま書いてますが道程は通そうです。ブロックコメント(<code>/* .. */</code>)がネスト可能なのですが、正規表現だと<code>/*/*</code>を<code>/*</code>2つと<code>*/</code>1つと認識しちゃってつらいです。</p>

<p>今回細かいところは省きましたがexampleとかあと公式ページとかgithubのwikiとか見て下さいね。</p>

<p>ある程度の完成度になってきてるのでみなさんも遊んでみて下さい。</p>
<div class="footnotes">

<hr />

<ol>
<li id="fn:bd19912fa4d362f5c3ffb4b0e0056c12:1">pull-reqは入ってるのですが、まだマージされてません
 <a class="footnote-return" href="#fnref:bd19912fa4d362f5c3ffb4b0e0056c12:1"><sup>[return]</sup></a></li>
<li id="fn:bd19912fa4d362f5c3ffb4b0e0056c12:2">まだリテラルの議論が終わってないだけで、内部はジェネリクスに対応してるので近い内に入りそうな気はします。
 <a class="footnote-return" href="#fnref:bd19912fa4d362f5c3ffb4b0e0056c12:2"><sup>[return]</sup></a></li>
</ol>
</div>

                    </section>
                </article>
            </div>
        </div>

        <div class="row li-author">
    <div class="sixteen columns">
        Written by <strong>κeen</strong>
    </div>
</div>


        <div class="row li-pagination">
            <div class="eight columns">
                <div class="li-pagination-previous">
                    
                        Later article<br />
                        <a href="http://keens.github.io/blog/2014/08/13/emacs-utility-functions"> Emacs便利機能/Tips紹介</a>
                    
                </div>
            </div>
            <div class="eight columns">
                <div class="li-pagination-next">
                    
                        Older article<br />
                        <a href="http://keens.github.io/blog/2014/08/07/shibuya-dot-xss-tt-number-5-nican-jia-sitekimasita"> Shibuya.XSS TT #5 に参加してきました</a>
                    
                </div>
            </div>
        </div>
    </div>

<footer class="li-page-footer">
    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <div class="li-page-footer-legal">
                    &copy; 2015. All rights reserved. 
                </div>
                <div class="li-page-footer-theme">
                    <span class=""><a href="https://github.com/eliasson/liquorice/">liquorice</a> is a theme for <a href="http://hugo.spf13.com">hugo</a></span>
                </div>
            </div>
        </div>
    </div>
</footer>

    <script type="text/javascript">
    <!--
    function toggle(id) {
        var e = document.getElementById(id);
        e.style.display == 'block' ? e.style.display = 'none' : e.style.display = 'block';
    }
    
    </script>
    <script type="text/javascript">
    <!--
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', ""]);
        _gaq.push(['_trackPageview']);

        (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
    -->
    </script>
    </body>
</html>

