<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
    <head>
        
        
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-43779888-1"></script>
        <script>
         window.dataLayer = window.dataLayer || [];
         function gtag(){dataLayer.push(arguments);}
         gtag('js', new Date());

         gtag('config', 'UA-43779888-1');
        </script>
        

        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

        <meta name="twitter:site" content="@blackenedgold" />
        <meta name="twitter:title" content="WebAssemblyでGC | κeenのHappy Hacκing Blog"/>
        <meta name="twitter:description" content="κeenです。この記事はWebAssembly Advent Calendar 2017 8日目の記事です。WebAssemblyでガーベジコレクションする話。
2017-12-08: ページサイズに関する誤りを訂正しました。その他加筆。" />
        <meta property="og:title" content="WebAssemblyでGC | κeenのHappy Hacκing Blog" />
        <meta property="og:type" content="article" />
        <meta property="og:url" content="/blog/2017/12/07/webassemblynogc/" />
        <meta property=":description" content="κeenです。この記事はWebAssembly Advent Calendar 2017 8日目の記事です。WebAssemblyでガーベジコレクションする話。
2017-12-08: ページサイズに関する誤りを訂正しました。その他加筆。" />
        <meta name="twitter:card" content="summary_large_image" />
        <meta property="og:image" content="https://KeenS.github.io//images/ogp/post/WebAssemblynoGC.png" />
        <meta name="twitter:image" content="https://KeenS.github.io//images/ogp/post/WebAssemblynoGC.png" />
        
        <meta property="og:article:published_time" content="2017-12-07 23:19:41 &#43;0900 JST" />
        <meta property="og:article:modified_time" content="2017-12-07 23:19:41 &#43;0900 JST" />
        
        <meta property="og:article:author" content="κeen" />

        <title>WebAssemblyでGC | κeenのHappy Hacκing Blog</title>
        <link rel="stylesheet" href='//fonts.googleapis.com/css?family=Open+Sans:400,300,600' type='text/css' />
        <link rel="stylesheet" href="/libraries/normalize.3.0.1.css" />
        <link rel="stylesheet" href="/css/liquorice.css" />
        <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
        <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
        <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
        <link rel="manifest" href="/manifest.json">
        <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
        <meta name="theme-color" content="#ffffff">
        <link rel="apple-touch-icon-precomposed" href="/apple-touch-icon-144-precomposed.png" sizes="144x144" />
        <link rel="stylesheet" href="/css/syntax-monokai.css" />
<script type="text/x-mathjax-config">
 MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ["\\(","\\)"]] } });
</script>
<script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_CHTML"></script>
</script>
<meta http-equiv="X-UA-Compatible" CONTENT="IE=EmulateIE7" />
<link rel="stylesheet" href="//unpkg.com/mermaid@7.0.4/dist/mermaid.forest.min.css">

    </head>
    <body class="li-body">

<header class="li-page-header" id="page-header">
    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <div class="li-brand li-left">
                <a href="/">κeenのHappy Hacκing Blog</a> | Lispエイリアンの狂想曲</div>
                <div class="li-menu li-right">
                    <span class="li-menu-icon" onclick="javascript:toggle('menu');">&#9776;</span>
                    <ul id="menu2" class="li-menu-items">
                        
                            <li><a href="/about/"> About </a></li>
                        
                            <li><a href="/index.xml"> Atom </a></li>
                        
                            <li><a href="/post/"> Blog </a></li>
                        
                            <li><a href="/slide/"> Slide </a></li>
                        
                    </ul>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="sixteen columns">
                <ul id="menu" class="li-menu-items li-menu-mobile">
                    
                        <li><a href="/about/"> About </a></li>
                    
                        <li><a href="/index.xml"> Atom </a></li>
                    
                        <li><a href="/post/"> Blog </a></li>
                    
                        <li><a href="/slide/"> Slide </a></li>
                    
                </ul>
            </div>
        </div>
    </div>
</header>






    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <article class="li-article">
                    <header class="li-article-header">
                        <h1 class="li-article-title">WebAssemblyでGC</h1>
                        <div class="li-article-meta">
    <time class="li-article-date">2017-12-07</time>
    <ul class="li-article-tag">
    
        <li>
            <a href="/categories/webassembly">WebAssembly</a>
        </li>
    
        <li>
            <a href="/categories/%e8%a8%80%e8%aa%9e%e5%ae%9f%e8%a3%85">言語実装</a>
        </li>
    
        <li>
            <a href="/categories/gc">GC</a>
        </li>
    
        <li>
            <a href="/categories/advent-calendar">Advent Calendar</a>
        </li>
    
        <li>
            <a href="/categories/advent-calendar-2017">Advent Calendar 2017</a>
        </li>
    
</ul>

</div>

                    </header>
                    <section>
                        <p>κeenです。この記事は<a href="https://qiita.com/advent-calendar/2017/webassembly">WebAssembly Advent Calendar 2017</a> 8日目の記事です。WebAssemblyでガーベジコレクションする話。
2017-12-08: ページサイズに関する誤りを訂正しました。その他加筆。</p>

<p>はじめてWebAssemblyを聞いたとき、「ブラウザでアセンブラが動くのか、よし、コンパイラを作ろう」と思ったかと思います。
私もそのうちの一人で去年頃<a href="https://github.com/KeenS/webml">こんなコンパイラ</a>を作り始めました。
しかしご覧のように進捗芳しくありません。
進捗が悪い理由の1つにGCがあります。最初はGCをCかRustで書いてemscriptenを通すつもりでしたがemscriptenを通したコードはどうにも扱いづらく、すぐに断念しました。
今でこそRustのwasm32-unknown-unknownのターゲットがありますが当時はemscriptenしか選択肢がありませんでした。</p>

<p>また、wasmには<a href="https://github.com/WebAssembly/design/issues/1079">GCサポートが追加される予定</a>ですがまだ使えないので絵に書いた餅。</p>

<p>残る手段は1つ。アセンブラ手書きです。アセンブラ手書きでGCを書いていきます。</p>

<h1 id="リニアメモリ">リニアメモリ</h1>

<p>GCの前にリニアメモリを押さえておきましょう。詳しくは<a href="http://webassembly.org/docs/semantics/#linear-memory">ドキュメント</a>をみて下さい。ここで覚えておいてほしいのは</p>

<ul>
<li>アドレスは <em>0から始まって</em> 飛びがない</li>
<li>データはナチュラルアラインされた方がアクセスは速いがアラインされていなくてもアクセス可能</li>
<li>メモリは(wasm32では)Max 4GiB。ポインタも32bit</li>
<li>メモリは<code>grow_memory</code>で<del>16KiB</del>64KiB単位で増やせる <a href="https://twitter.com/tzik_tack/status/938811214704009220">tzikさん指摘ありがとうございます。</a></li>
<li>メモリはモジュール間でimport/exportできる

<ul>
<li>GCモジュールとミューテータ(言語)に分けられる</li>
</ul></li>
</ul>

<p>アドレスが0から始まるので保守的GCが少しやりづらそう？</p>

<h1 id="肩慣らし">肩慣らし</h1>

<p>いきなりどんとGCが来ても困ると思うので軽くwasmのコードを書いてみましょう。
とはいっても生の.watは少々書きづらくマクロを使いたいので生成することを考えます。
ここは餅は餅屋、S式はLispで異論ないと思います。</p>

<p>まずは準備。外部コマンドを使うので<code>uiop</code>を使い、シンボルが大文字にならないようにread-caseを<code>:invert</code>にしておきます。</p>
<div class="highlight"><pre class="chroma"><code class="language-lisp" data-lang="lisp"><span class="p">(</span><span class="nf">require</span> <span class="ss">&#39;uiop</span><span class="p">)</span>
<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nf">readtable-case</span> <span class="vg">*readtable*</span><span class="p">)</span> <span class="ss">:invert</span><span class="p">)</span></code></pre></div>
<p>さて、生成自体は簡単で、</p>
<div class="highlight"><pre class="chroma"><code class="language-lisp" data-lang="lisp"><span class="p">(</span><span class="nf">print</span> <span class="o">&#39;</span><span class="p">(</span><span class="nv">module</span>
  <span class="p">(</span><span class="nv">func</span> <span class="nv">$i</span> <span class="p">(</span><span class="nf">import</span> <span class="s">&#34;imports&#34;</span> <span class="s">&#34;imported_func&#34;</span><span class="p">)</span> <span class="p">(</span><span class="nv">param</span> <span class="nv">i32</span><span class="p">))</span>
  <span class="p">(</span><span class="nv">func</span> <span class="nv">$new_page</span>
    <span class="p">(</span><span class="nv">grow_memory</span> <span class="p">(</span><span class="nv">i32.const</span> <span class="mi">3</span><span class="p">))</span>
    <span class="p">(</span><span class="nv">call</span> <span class="nv">$i</span><span class="p">))</span>
  <span class="p">(</span><span class="nv">func</span> <span class="p">(</span><span class="nf">export</span> <span class="s">&#34;exported_func&#34;</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">i32.const</span> <span class="mi">42</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">call</span> <span class="nv">$new_page</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">call</span> <span class="nv">$i</span><span class="p">))</span>
  <span class="p">(</span><span class="nv">memory</span> <span class="mi">1</span> <span class="mi">10</span><span class="p">)</span>
<span class="p">))</span></code></pre></div>
<p>のように.watのコードを<code>print</code>してあげればOKです。もう少し皮を被せてアセンブルまでやるようにすれば</p>
<div class="highlight"><pre class="chroma"><code class="language-lisp" data-lang="lisp"><span class="p">(</span><span class="nb">defun</span> <span class="nv">write-wasm</span> <span class="p">(</span><span class="nv">filename</span> <span class="nv">wasm</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">with-open-file</span> <span class="p">(</span><span class="nv">f</span> <span class="nv">filename</span> <span class="ss">:direction</span> <span class="ss">:output</span> <span class="ss">:if-does-not-exist</span> <span class="ss">:create</span> <span class="ss">:if-exists</span> <span class="ss">:supersede</span><span class="p">)</span>
    <span class="p">(</span><span class="nf">print</span> <span class="nv">wasm</span> <span class="nv">f</span><span class="p">)))</span>

<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">wasm</span> <span class="nv">~~~~</span><span class="p">))</span>
  <span class="p">(</span><span class="nv">write-wasm</span> <span class="s">&#34;simple.wat&#34;</span> <span class="nv">wasm</span><span class="p">)</span>
  <span class="p">(</span><span class="nv">uiop:run-program</span> <span class="s">&#34;wast2wasm simple.wat -o simple.wasm&#34;</span><span class="p">))</span></code></pre></div>
<p>こうなり、ファイルを実行すると<code>simple.wasm</code>の生成までやってくれます。</p>

<p>あとはこういうファイルを用意してブラウザで開けば動きます。</p>
<div class="highlight"><pre class="chroma"><code class="language-html" data-lang="html"><span class="cp">&lt;!doctype html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">lang</span><span class="o">=</span><span class="s">&#34;en&#34;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">&#34;UTF-8&#34;</span><span class="p">/&gt;</span>
        <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Document<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
         <span class="kd">var</span> <span class="nx">importObject</span> <span class="o">=</span> <span class="p">{</span>
             <span class="nx">imports</span><span class="o">:</span> <span class="p">{</span>
                 <span class="nx">imported_func</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">arg</span><span class="p">)</span> <span class="p">{</span>
                     <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">arg</span><span class="p">);</span>
                 <span class="p">}</span>
             <span class="p">}</span>
         <span class="p">};</span>
         <span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;simple.wasm&#39;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span> <span class="p">=&gt;</span>
             <span class="nx">response</span><span class="p">.</span><span class="nx">arrayBuffer</span><span class="p">()</span>
         <span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">bytes</span> <span class="p">=&gt;</span>
             <span class="nx">WebAssembly</span><span class="p">.</span><span class="nx">instantiate</span><span class="p">(</span><span class="nx">bytes</span><span class="p">,</span> <span class="nx">importObject</span><span class="p">)</span>
         <span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">results</span> <span class="p">=&gt;</span> <span class="p">{</span>
             <span class="nx">results</span><span class="p">.</span><span class="nx">instance</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">exported_func</span><span class="p">();</span>
         <span class="p">});</span>
        <span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span></code></pre></div>
<h1 id="gc">GC</h1>

<p>肩も馴れてもうwasmはいくらでも書けると思うのでGCを実装していきます。</p>

<h2 id="戦略">戦略</h2>

<ul>
<li>GCにも色々ありますがブラウザで動かす以上JSとのFFIもあるでしょうしnon-movingなものにしましょう</li>
<li>grow_memoryでキリの良いアドレスが帰ってくるのでそれを使いましょう</li>
<li>C言語と違って「このマクロをデータ型定義に埋め込めば何でもGCできます」とはいかないので(単純にマクロがないため)メタデータとデータは分離しましょう</li>
<li>地味にスタックとレジスタの走査ができないのでポインタは手でヒープに退避しましょう。これがルートセットになります。</li>
</ul>

<p>ということでbitmap式のMark and Sweepを採用します。またかよと思った方、ええ、好きなんです。</p>

<h2 id="イメージ">イメージ</h2>

<p>このGCを使うときのイメージはこんな感じです。</p>
<div class="highlight"><pre class="chroma"><code class="language-html" data-lang="html">(defwfun $main (<span class="err">&amp;</span>aux (gc i32) (state i32)) nil
  `(
    ; GCデータを初期化
    (set_local ,gc (call $new-gc))
    (call $gc-init (get_local ,gc))
    ; この時点ではまだデータは0
    (call $print (call $gc--allocated-data (get_local ,gc)))
    ; 今から確保するメモリのポインタをヒープに退避する準備。多くは関数の先頭でやる
    (set_local ,state (call $gc-save-state (get_local ,gc)))
    ; 4byteのメモリを確保し、ポインタを保護
    (call $gc-protect (get_local ,gc) (call $gc-alloc (get_local ,gc) (i32.const 4)))
    (call $gc-protect (get_local ,gc) (call $gc-alloc (get_local ,gc) (i32.const 4)))
    (call $gc-protect (get_local ,gc) (call $gc-alloc (get_local ,gc) (i32.const 4)))
    ; この時点で3つデータを確保している
    (call $print (call $gc--allocated-data (get_local ,gc)))
    ; GCを走らせる
    (call $gc-run (get_local ,gc))
    ; ポインタは退避されているので回収されない
    (call $print (call $gc--allocated-data (get_local ,gc)))
    ; 退避する前の状態に戻す。多くは関数の末尾でやる
    (call $gc-restore-state (get_local ,gc) (get_local ,state))
    ; ポインタを保護してない状態でGCを走らせる
    (call $gc-run (get_local ,gc))
    ; 回収される
    (call $print (call $gc--allocated-data (get_local ,gc)))))</code></pre></div>
<p>さて、イメージも湧いたところで作って行きます。</p>

<h2 id="データレイアウト">データレイアウト</h2>

<p>2種類の構造体を使います。それぞれ1ページ、<del>16KiB</del>64KiB使います。
C言語風に書くとこうです。</p>
<div class="highlight"><pre class="chroma"><code class="language-C" data-lang="C"><span class="k">struct</span> <span class="n">gc</span> <span class="p">{</span>
  <span class="k">struct</span> <span class="n">heap_page</span> <span class="p">(</span><span class="o">*</span><span class="n">pages</span><span class="p">)[</span><span class="mi">11</span><span class="p">],</span> <span class="c1">// 4 x 2^0 byte, 4 x 2^1 byte, ..., 4 x 2^10 byte
</span><span class="c1"></span>  <span class="n">size_t</span> <span class="n">arena_top</span><span class="p">,</span>
  <span class="c1">// in the number of pointers
</span><span class="c1"></span>  <span class="n">size_t</span> <span class="n">arena_size</span><span class="p">,</span>
  <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">arena</span><span class="p">)[]</span>
<span class="p">};</span>
<span class="k">struct</span> <span class="n">heap_page</span> <span class="p">{</span>
  <span class="c1">// bitmaps enough to manage the 4byte-sized data pages
</span><span class="c1"></span>  <span class="n">uint64_t</span> <span class="n">bitmaps</span><span class="p">[</span><span class="o">*</span><span class="n">page</span><span class="o">-</span><span class="n">size</span><span class="o">*</span> <span class="o">/</span> <span class="mi">4</span> <span class="o">/</span>  <span class="mi">64</span><span class="p">],</span>
  <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">next</span><span class="p">,</span>
  <span class="c1">// in bytes
</span><span class="c1"></span>  <span class="n">size_t</span> <span class="n">data_size</span>
  <span class="c1">// in the number of cell
</span><span class="c1"></span>  <span class="n">size_t</span> <span class="n">heap_size</span><span class="p">,</span>
  <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">)[]</span>
<span class="p">};</span></code></pre></div>
<p>図にするとこうです。</p>
<pre><code>                         ポインタの一時退避場所↓
+---+- ... -+---+-----------+------------+- ... -+
| + | pages | + | arena_top | arena_size | arena | gc
+-|-+- ... -+-|-+-----------+------------+- ... -+
0 | 4        |   44                               2^16
  |
  |                       実際のデータ領域↓
+---------+---+-----------+-----------+- .. -+
| bitmaps | + | data_size | heap_size | data | heap_page
+---------+-|-+-----------+-----------+- .. -+
  +---------+
  .
  .
  |
+---------+---+-----------+-----------+- .. -+
| bitmaps | + | data_size | heap_size | data | heap_page
+---------+-|-+-----------+-----------+- .. -+
  +---------+
  |
  x</code></pre>
<p>図には1種類しか書かれてませんが<code>heap_page</code>は4byteから4096byteまで11種類のサイズ毎にリンクトリストが用意されています。</p>

<h3 id="アリーナ">アリーナ</h3>

<p>アリーナは代替スタック変数領域で、スタックとして使います。関数内でアロケートしたポインタはルートセットに含まれておらず、放っておくと回収されるのでアリーナに置いて保護します。
GC時にはアリーナはルートセットになります。</p>

<h3 id="heap-pageとbitmaps">heap_pageとbitmaps</h3>

<p>宣言どおりデータとメタデータを分離してます。その他にもBitmap GCには色々利点があるので気になる方は調べてみて下さい。</p>

<p>bitmapsとデータ領域は連動していて、bitmapsのn bit目が1ならデータ領域のnセル目が使用中です。アロケートするときはbitmapsを舐めて0なbitに対応するセルを使います。もちろんbitmapsのbitも立てます。
GC時には一旦すべてのbitmapをクリアし、ルートセットから辿れるものにのみマークすればOKです。</p>

<h3 id="ポインタとマーク">ポインタとマーク</h3>

<p>さて、アロケートはマークからデータに飛ぶので問題ないのですが、マーク時はポインタからマークに飛ぶのでやや厄介です。
ここはページが<del>16KiB</del>64KiBアラインされていることを使います。</p>

<p>ページが<del>16KiB</del>64KiBアラインされているのでページのアドレスは下位<del>14bit</del>16bitが0です。なので単にポインタの下位<del>14bit</del>16bitをクリアしてあげると自分が所属しているページのアドレスが手に入るのです。</p>

<h3 id="2017-12-08-追記-限界">2017-12-08 追記: 限界</h3>

<p>ここでは4096 byteまでのページしか用意していません。それ以上はこのGCではアロケートに失敗というか<code>unreachable</code>に入ってエラーになります。ちゃんと実装するならフリーリストなどで管理しましょう。
/ 追記</p>

<h2 id="実装">実装</h2>

<p>淡々と実装していきます。Common Lispには解説を入れないので雰囲気で追って下さい</p>

<p>まず使いそうな定数とWASMの関数を便利に書くマクロを準備します。</p>
<div class="highlight"><pre class="chroma"><code class="language-common-lisp" data-lang="common-lisp"><span class="c1">; 訂正</span>
<span class="c1">; (defparameter *page-size* (* 16  1024))</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*page-size*</span> <span class="p">(</span><span class="nf">*</span> <span class="mi">64</span>  <span class="mi">1024</span><span class="p">))</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*null-ptr*</span> <span class="o">&#39;</span><span class="p">(</span><span class="nv">i32.const</span> <span class="mi">0</span><span class="p">))</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*sizeof-i32*</span> <span class="mi">4</span><span class="p">)</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*sizeof-i64*</span> <span class="mi">8</span><span class="p">)</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*sizeof-ptr*</span> <span class="mi">4</span><span class="p">)</span>

<span class="p">(</span><span class="k">eval-when</span> <span class="p">(</span><span class="ss">:compile-toplevel</span> <span class="ss">:load-toplevel</span> <span class="ss">:execute</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">defun</span> <span class="nv">split-list</span> <span class="p">(</span><span class="nc">list</span> <span class="nv">sep</span><span class="p">)</span>
    <span class="p">(</span><span class="k">labels</span> <span class="p">((</span><span class="nv">recc</span> <span class="p">(</span><span class="nv">left</span> <span class="nf">rest</span><span class="p">)</span>
               <span class="p">(</span><span class="nb">cond</span>
                 <span class="p">((</span><span class="nc">null</span> <span class="nf">rest</span><span class="p">)</span> <span class="p">(</span><span class="nc">cons</span> <span class="p">(</span><span class="nf">nreverse</span> <span class="nv">left</span><span class="p">)</span> <span class="nf">rest</span><span class="p">))</span>
                 <span class="p">((</span><span class="nf">eql</span> <span class="p">(</span><span class="nf">car</span> <span class="nf">rest</span><span class="p">)</span> <span class="nv">sep</span><span class="p">)</span>
                  <span class="p">(</span><span class="nc">cons</span> <span class="p">(</span><span class="nf">nreverse</span> <span class="nv">left</span><span class="p">)</span> <span class="p">(</span><span class="nf">cdr</span> <span class="nf">rest</span><span class="p">)))</span>
                 <span class="p">(</span><span class="no">t</span> <span class="p">(</span><span class="nv">recc</span>
                     <span class="p">(</span><span class="nc">cons</span> <span class="p">(</span><span class="nf">car</span> <span class="nf">rest</span><span class="p">)</span> <span class="nv">left</span><span class="p">)</span>
                     <span class="p">(</span><span class="nf">cdr</span> <span class="nf">rest</span><span class="p">))))))</span>
      <span class="p">(</span><span class="nv">recc</span> <span class="p">()</span> <span class="nc">list</span><span class="p">))))</span>

<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*wasm-funs*</span> <span class="no">nil</span><span class="p">)</span>

<span class="p">(</span><span class="nb">defmacro</span> <span class="nv">defwfun</span> <span class="p">(</span><span class="nv">name</span> <span class="nv">param-list</span> <span class="nv">result</span> <span class="k">&amp;body</span> <span class="nv">body</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let*</span> <span class="p">((</span><span class="nv">param-list</span> <span class="p">(</span><span class="nv">split-list</span> <span class="nv">param-list</span> <span class="ss">&#39;&amp;aux</span><span class="p">))</span>
         <span class="p">(</span><span class="nv">params</span> <span class="p">(</span><span class="nf">car</span> <span class="nv">param-list</span><span class="p">))</span>
         <span class="p">(</span><span class="nv">auxs</span>   <span class="p">(</span><span class="nf">cdr</span> <span class="nv">param-list</span><span class="p">))</span>
         <span class="p">(</span><span class="nv">param-types</span> <span class="p">(</span><span class="nf">mapcar</span> <span class="nf">#&#39;cadr</span> <span class="nv">params</span><span class="p">))</span>
         <span class="p">(</span><span class="nv">param-vars</span>  <span class="p">(</span><span class="nf">mapcar</span> <span class="nf">#&#39;car</span> <span class="nv">params</span><span class="p">))</span>
         <span class="p">(</span><span class="nv">aux-types</span>   <span class="p">(</span><span class="nf">mapcar</span> <span class="nf">#&#39;cadr</span> <span class="nv">auxs</span><span class="p">))</span>
         <span class="p">(</span><span class="nv">aux-vars</span>    <span class="p">(</span><span class="nf">mapcar</span> <span class="nf">#&#39;car</span> <span class="nv">auxs</span><span class="p">)))</span>
    <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">bindings</span> <span class="p">(</span><span class="nb">loop</span>
                       <span class="ss">:for</span> <span class="nv">var</span> <span class="ss">:in</span> <span class="p">(</span><span class="nf">append</span> <span class="nv">param-vars</span> <span class="nv">aux-vars</span><span class="p">)</span>
                       <span class="ss">:for</span> <span class="nv">i</span> <span class="ss">:=</span> <span class="mi">0</span> <span class="nv">then</span> <span class="p">(</span><span class="nf">1+</span> <span class="nv">i</span><span class="p">)</span>
                       <span class="ss">:collect</span> <span class="p">(</span><span class="nc">list</span> <span class="nv">var</span> <span class="nv">i</span><span class="p">)))</span>
          <span class="p">(</span><span class="nv">param</span> <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nc">null</span> <span class="nv">param-types</span><span class="p">)</span> <span class="p">()</span> <span class="p">(</span><span class="nc">list</span> <span class="p">(</span><span class="nc">cons</span> <span class="ss">&#39;param</span> <span class="nv">param-types</span><span class="p">))))</span>
          <span class="p">(</span><span class="nv">local</span> <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nc">null</span> <span class="nv">aux-types</span><span class="p">)</span> <span class="p">()</span> <span class="p">(</span><span class="nc">list</span> <span class="p">(</span><span class="nc">cons</span> <span class="ss">&#39;local</span> <span class="nv">aux-types</span><span class="p">))))</span>
          <span class="p">(</span><span class="nv">result</span> <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nf">eql</span> <span class="no">nil</span> <span class="nv">result</span><span class="p">)</span> <span class="p">()</span> <span class="p">(</span><span class="nc">list</span> <span class="p">(</span><span class="nc">list</span> <span class="ss">&#39;result</span> <span class="nv">result</span><span class="p">)))))</span>
      <span class="o">`</span><span class="p">(</span><span class="nb">push</span>
        <span class="p">(</span><span class="k">let</span> <span class="o">,</span><span class="nv">bindings</span>
          <span class="p">(</span><span class="nf">append</span> <span class="o">`</span><span class="p">(</span><span class="nv">func</span> <span class="o">,</span><span class="ss">&#39;,name</span> <span class="o">,@</span><span class="ss">&#39;,param</span> <span class="o">,@</span><span class="ss">&#39;,result</span>
                         <span class="o">,@</span><span class="ss">&#39;,local</span>
                         <span class="p">)</span>
                  <span class="o">,@</span><span class="nv">body</span><span class="p">))</span>
        <span class="vg">*wasm-funs*</span><span class="p">))))</span></code></pre></div>
<p>このマクロで関数はこのように書けます。</p>
<div class="highlight"><pre class="chroma"><code class="language-common-lisp" data-lang="common-lisp"><span class="p">(</span><span class="nv">defwfun</span> <span class="nv">$add</span> <span class="p">((</span><span class="nv">x</span> <span class="nv">i32</span><span class="p">)</span> <span class="p">(</span><span class="nv">y</span> <span class="nv">i32</span><span class="p">))</span> <span class="nv">i32</span>
  <span class="o">`</span><span class="p">((</span><span class="nv">i32.add</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">x</span><span class="p">)</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">y</span><span class="p">))))</span></code></pre></div>
<p>Common Lispの関数定義に倣って引数リストの<code>&amp;aux</code>以降はローカル変数とします。</p>

<p>ユーティリティ</p>
<div class="highlight"><pre class="chroma"><code class="language-common-lisp" data-lang="common-lisp"><span class="c1">;;; utils</span>
<span class="p">(</span><span class="nv">defwfun</span> <span class="nv">$new-page</span> <span class="p">()</span> <span class="nv">i32</span>
  <span class="o">`</span><span class="p">((</span><span class="nv">i32.mul</span> <span class="p">(</span><span class="nv">i32.const</span> <span class="o">,</span><span class="vg">*page-size*</span><span class="p">)</span> <span class="p">(</span><span class="nv">grow_memory</span> <span class="p">(</span><span class="nv">i32.const</span> <span class="mi">1</span><span class="p">)))))</span></code></pre></div>
<p>先の構造体に対応する定数を手作業で定義していきます。
11のポインタの初期化などはCommon Lisp側の<code>loop</code>で自動生成します。</p>
<div class="highlight"><pre class="chroma"><code class="language-common-lisp" data-lang="common-lisp"><span class="cm">#|
</span><span class="cm">struct gc {
</span><span class="cm">  struct heap_page (*pages)[11], // 4 x 2^0 byte, 4 x 2^1 byte, ..., 4 x 2^10 byte
</span><span class="cm">  size_t arena_top,
</span><span class="cm">  // in the number of pointers
</span><span class="cm">  size_t arena_size,
</span><span class="cm">  void (*arena)[]
</span><span class="cm">};
</span><span class="cm">|#</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*sizeof-gc*</span> <span class="p">(</span><span class="nf">+</span> <span class="p">(</span><span class="nf">*</span> <span class="mi">11</span> <span class="vg">*sizeof-ptr*</span><span class="p">)</span> <span class="vg">*sizeof-ptr*</span> <span class="vg">*sizeof-ptr*</span><span class="p">))</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*offset-gc-heap-page*</span>  <span class="mi">0</span><span class="p">)</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*offset-gc-arena-top*</span>  <span class="p">(</span><span class="nf">+</span> <span class="vg">*offset-gc-heap-page*</span>  <span class="p">(</span><span class="nf">*</span> <span class="mi">11</span> <span class="vg">*sizeof-ptr*</span><span class="p">)))</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*offset-gc-arena-size*</span> <span class="p">(</span><span class="nf">+</span> <span class="vg">*offset-gc-arena-top*</span>  <span class="vg">*sizeof-ptr*</span><span class="p">))</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*offset-gc-arena*</span>      <span class="p">(</span><span class="nf">+</span> <span class="vg">*offset-gc-arena-size*</span> <span class="vg">*sizeof-ptr*</span><span class="p">))</span>
<span class="cm">#|
</span><span class="cm">struct heap_page {
</span><span class="cm">  // bitmaps enough to manage the 4byte-sized data pages
</span><span class="cm">  uint64_t bitmaps[*page-size* / 4 /  64],
</span><span class="cm">  struct page *next,
</span><span class="cm">  // in bytes
</span><span class="cm">  size_t data_size
</span><span class="cm">  // in the number of cell
</span><span class="cm">  size_t heap_size,
</span><span class="cm">  void (*data)[]
</span><span class="cm">};
</span><span class="cm">|#</span>

<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*bitmap-size*</span> <span class="p">(</span><span class="nf">/</span> <span class="vg">*page-size*</span> <span class="mi">4</span> <span class="mi">64</span><span class="p">))</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*sizeof-heap-page*</span> <span class="p">(</span><span class="nf">+</span> <span class="p">(</span><span class="nf">*</span> <span class="mi">8</span> <span class="vg">*bitmap-size*</span><span class="p">)</span> <span class="vg">*sizeof-ptr*</span> <span class="vg">*sizeof-ptr*</span><span class="p">))</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*offset-heap-page-bitmaps*</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*offset-heap-page-next*</span>      <span class="p">(</span><span class="nf">+</span> <span class="vg">*offset-heap-page-bitmaps*</span>   <span class="p">(</span><span class="nf">*</span> <span class="mi">8</span> <span class="vg">*bitmap-size*</span><span class="p">)))</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*offset-heap-page-data-size*</span> <span class="p">(</span><span class="nf">+</span> <span class="vg">*offset-heap-page-next*</span>      <span class="vg">*sizeof-ptr*</span><span class="p">))</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*offset-heap-page-heap-size*</span> <span class="p">(</span><span class="nf">+</span> <span class="vg">*offset-heap-page-data-size*</span> <span class="vg">*sizeof-ptr*</span><span class="p">))</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*offset-heap-page-heap-data*</span> <span class="p">(</span><span class="nf">+</span> <span class="vg">*offset-heap-page-heap-size*</span> <span class="vg">*sizeof-ptr*</span><span class="p">))</span>

<span class="c1">;;; struct gc;</span>
<span class="p">(</span><span class="nv">defwfun</span> <span class="nv">$new-gc</span> <span class="p">()</span> <span class="nv">i32</span>
  <span class="o">&#39;</span><span class="p">((</span><span class="nv">call</span> <span class="nv">$new-page</span><span class="p">)))</span>

<span class="p">(</span><span class="nv">defwfun</span> <span class="nv">$gc-init</span> <span class="p">((</span><span class="nv">gc</span> <span class="nv">i32</span><span class="p">))</span> <span class="no">nil</span>
  <span class="o">`</span><span class="p">(</span><span class="c1">;; pages</span>
    <span class="o">,@</span><span class="p">(</span><span class="nb">loop</span>
         <span class="ss">:for</span> <span class="nv">i</span> <span class="ss">:from</span> <span class="mi">0</span> <span class="ss">:below</span> <span class="mi">11</span> <span class="ss">:collect</span>
           <span class="o">`</span><span class="p">(</span><span class="nv">i32.store</span> <span class="o">,</span><span class="p">(</span><span class="nf">intern</span> <span class="p">(</span><span class="nf">format</span> <span class="no">nil</span> <span class="s">&#34;OFFSET=~a&#34;</span> <span class="p">(</span><span class="nf">+</span> <span class="vg">*offset-gc-heap-page*</span> <span class="p">(</span><span class="nf">*</span> <span class="nv">i</span> <span class="vg">*sizeof-ptr*</span><span class="p">))))</span>
                       <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">gc</span><span class="p">)</span>
                       <span class="o">,</span><span class="vg">*null-ptr*</span><span class="p">))</span>
    <span class="c1">;; arena_top</span>
    <span class="p">(</span><span class="nv">i32.store</span> <span class="o">,</span><span class="p">(</span><span class="nf">intern</span> <span class="p">(</span><span class="nf">format</span> <span class="no">nil</span> <span class="s">&#34;OFFSET=~a&#34;</span> <span class="vg">*offset-gc-arena-top*</span><span class="p">))</span>
               <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">gc</span><span class="p">)</span>
               <span class="p">(</span><span class="nv">i32.const</span> <span class="mi">0</span><span class="p">))</span>
    <span class="c1">;; arena_size</span>
    <span class="p">(</span><span class="nv">i32.store</span> <span class="o">,</span><span class="p">(</span><span class="nf">intern</span> <span class="p">(</span><span class="nf">format</span> <span class="no">nil</span> <span class="s">&#34;OFFSET=~a&#34;</span> <span class="vg">*offset-gc-arena-size*</span><span class="p">))</span>
               <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">gc</span><span class="p">)</span>
               <span class="p">(</span><span class="nv">i32.const</span> <span class="o">,</span><span class="p">(</span><span class="nf">floor</span> <span class="p">(</span><span class="nf">-</span> <span class="vg">*page-size*</span> <span class="vg">*sizeof-gc*</span><span class="p">)</span> <span class="vg">*sizeof-ptr*</span><span class="p">)))))</span>

<span class="c1">;;; struct heap_page;</span>
                                        <span class="c1">; heap data must be 8 byte aligned</span>
<span class="p">(</span><span class="nb">assert</span> <span class="p">(</span><span class="nf">zerop</span> <span class="p">(</span><span class="nf">rem</span> <span class="vg">*sizeof-heap-page*</span> <span class="mi">8</span><span class="p">)))</span>

<span class="p">(</span><span class="nv">defwfun</span> <span class="nv">$new-heap-page</span> <span class="p">()</span> <span class="nv">i32</span>
  <span class="o">&#39;</span><span class="p">((</span><span class="nv">call</span> <span class="nv">$new-page</span><span class="p">)))</span>

<span class="p">(</span><span class="nv">defwfun</span> <span class="nv">$init-heap-page</span> <span class="p">((</span><span class="nv">page</span> <span class="nv">i32</span><span class="p">)</span> <span class="p">(</span><span class="nv">size</span> <span class="nv">i32</span><span class="p">))</span> <span class="no">nil</span>
  <span class="o">`</span><span class="p">(</span><span class="c1">;; bitmaps</span>
    <span class="o">,@</span><span class="p">(</span><span class="nb">loop</span> <span class="ss">:for</span> <span class="nv">i</span> <span class="ss">:from</span> <span class="mi">0</span> <span class="ss">:below</span> <span class="vg">*bitmap-size*</span> <span class="ss">:collect</span>
           <span class="o">`</span><span class="p">(</span><span class="nv">i64.store</span> <span class="o">,</span><span class="p">(</span><span class="nf">intern</span> <span class="p">(</span><span class="nf">format</span> <span class="no">nil</span> <span class="s">&#34;OFFSET=~a&#34;</span> <span class="p">(</span><span class="nf">+</span> <span class="vg">*offset-heap-page-bitmaps*</span> <span class="p">(</span><span class="nf">*</span> <span class="nv">i</span> <span class="mi">8</span><span class="p">))))</span>
                       <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">page</span><span class="p">)</span>
                       <span class="p">(</span><span class="nv">i64.const</span> <span class="mi">0</span><span class="p">)))</span>
    <span class="c1">;; next</span>
    <span class="p">(</span><span class="nv">i32.store</span> <span class="o">,</span><span class="p">(</span><span class="nf">intern</span> <span class="p">(</span><span class="nf">format</span> <span class="no">nil</span> <span class="s">&#34;OFFSET=~a&#34;</span> <span class="vg">*offset-heap-page-next*</span><span class="p">))</span>
               <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">page</span><span class="p">)</span>
               <span class="o">,</span><span class="vg">*null-ptr*</span><span class="p">)</span>
    <span class="c1">;; data-size</span>
    <span class="p">(</span><span class="nv">i32.store</span> <span class="o">,</span><span class="p">(</span><span class="nf">intern</span> <span class="p">(</span><span class="nf">format</span> <span class="no">nil</span> <span class="s">&#34;OFFSET=~a&#34;</span> <span class="vg">*offset-heap-page-data-size*</span><span class="p">))</span>
               <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">page</span><span class="p">)</span>
               <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">size</span><span class="p">))</span>
    <span class="c1">;; heap-size</span>
    <span class="p">(</span><span class="nv">i32.store</span> <span class="o">,</span><span class="p">(</span><span class="nf">intern</span> <span class="p">(</span><span class="nf">format</span> <span class="no">nil</span> <span class="s">&#34;OFFSET=~a&#34;</span> <span class="vg">*offset-heap-page-heap-size*</span><span class="p">))</span>
               <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">page</span><span class="p">)</span>
               <span class="p">(</span><span class="nv">i32.div_u</span> <span class="p">(</span><span class="nv">i32.const</span> <span class="o">,</span><span class="p">(</span><span class="nf">-</span> <span class="vg">*page-size*</span> <span class="vg">*sizeof-heap-page*</span><span class="p">))</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">size</span><span class="p">)))))</span></code></pre></div>
<p>ちょっとトリッキーなのが<code>load</code>/<code>store</code>のオフセットの指定。
<code>(i32.store offset=4 hoge fuga)</code>のように書くのですがCommon Lispでは<code>offset=4</code>一つでシンボル扱いになって動的生成が面倒です。<code>,(intern (format nil &quot;OFFSET=~a&quot; 4))</code>のように毎度<code>intern</code>で生成するゴリ押しでやってます。
本当は関数に纏めたかったけどアセンブラ感が減るのでやめました。</p>

<p><code>(assert (zerop (rem *sizeof-heap-page* 8)))</code>ですが、<code>heap_page</code>から取得したポインタが全て64bitアラインになるように配慮です。</p>

<p>次にサイズから2の累乗に丸めあげる処理です。Cでいうマクロのように毎度インライン展開するようにCommon Lispの関数として定義します。単純な２分探索ですが、本当は4, 8 byteがよく使われるのでそれに合わせてアンバランスドな２分探索をした方がいいらしいです。</p>
<div class="highlight"><pre class="chroma"><code class="language-common-lisp" data-lang="common-lisp"><span class="p">(</span><span class="nb">defun</span> <span class="nv">calc-heap-index</span> <span class="p">(</span><span class="nv">size</span><span class="p">)</span>
  <span class="c1">;; Simple binary search.</span>
  <span class="c1">;; Should be optimized to common size (frequently 4 bytes and 8bytes)</span>
  <span class="o">`</span><span class="p">(</span><span class="k">if</span> <span class="nv">i32</span> <span class="p">(</span><span class="nv">i32.le_u</span> <span class="o">,</span><span class="nv">size</span> <span class="p">(</span><span class="nv">i32.const</span> <span class="mi">128</span><span class="p">))</span>
                                        <span class="c1">; size &lt;= 128</span>
       <span class="p">(</span><span class="k">if</span> <span class="nv">i32</span> <span class="p">(</span><span class="nv">i32.le_u</span> <span class="o">,</span><span class="nv">size</span> <span class="p">(</span><span class="nv">i32.const</span> <span class="mi">8</span><span class="p">))</span>
                                        <span class="c1">; size &lt;= 8</span>
           <span class="p">(</span><span class="k">if</span> <span class="nv">i32</span> <span class="p">(</span><span class="nv">i32.le_u</span> <span class="o">,</span><span class="nv">size</span> <span class="p">(</span><span class="nv">i32.const</span> <span class="mi">4</span><span class="p">))</span>
                                        <span class="c1">; size &lt;= 4</span>
               <span class="p">(</span><span class="nv">i32.const</span> <span class="mi">0</span><span class="p">)</span>
                                        <span class="c1">; 4 &lt; size &lt;= 8</span>
               <span class="p">(</span><span class="nv">i32.const</span> <span class="mi">1</span><span class="p">))</span>
                                        <span class="c1">; 8 &lt; size &lt;= 128</span>
           <span class="p">(</span><span class="k">if</span> <span class="nv">i32</span> <span class="p">(</span><span class="nv">i32.le_u</span> <span class="o">,</span><span class="nv">size</span> <span class="p">(</span><span class="nv">i32.const</span> <span class="mi">32</span><span class="p">))</span>
                                        <span class="c1">; 8 &lt; size &lt;= 32</span>
               <span class="p">(</span><span class="k">if</span> <span class="nv">i32</span> <span class="p">(</span><span class="nv">i32.le_u</span> <span class="o">,</span><span class="nv">size</span> <span class="p">(</span><span class="nv">i32.const</span> <span class="mi">16</span><span class="p">))</span>
                                        <span class="c1">; 8 &lt; size &lt;= 16</span>
                   <span class="p">(</span><span class="nv">i32.const</span> <span class="mi">2</span><span class="p">)</span>
                                        <span class="c1">; 16 &lt; size &lt;= 32</span>
                   <span class="p">(</span><span class="nv">i32.const</span> <span class="mi">3</span><span class="p">))</span>
                                        <span class="c1">; 32 &lt; size &lt;= 128</span>
               <span class="p">(</span><span class="k">if</span> <span class="nv">i32</span> <span class="p">(</span><span class="nv">i32.le_u</span> <span class="o">,</span><span class="nv">size</span> <span class="p">(</span><span class="nv">i32.const</span> <span class="mi">64</span><span class="p">))</span>
                                        <span class="c1">; 32 &lt; size &lt;= 64</span>
                   <span class="p">(</span><span class="nv">i32.const</span> <span class="mi">4</span><span class="p">)</span>
                                        <span class="c1">; 64 &lt; size &lt;= 128</span>
                   <span class="p">(</span><span class="nv">i32.const</span> <span class="mi">5</span><span class="p">))))</span>
                                        <span class="c1">; 128 &lt; size</span>
       <span class="p">(</span><span class="k">if</span> <span class="nv">i32</span> <span class="p">(</span><span class="nv">i32.le_u</span> <span class="o">,</span><span class="nv">size</span> <span class="p">(</span><span class="nv">i32.const</span> <span class="mi">1024</span><span class="p">))</span>
                                        <span class="c1">; 128 &lt; size &lt;= 1024</span>
           <span class="p">(</span><span class="k">if</span> <span class="nv">i32</span> <span class="p">(</span><span class="nv">i32.le_u</span> <span class="o">,</span><span class="nv">size</span> <span class="p">(</span><span class="nv">i32.const</span> <span class="mi">512</span><span class="p">))</span>
                                        <span class="c1">; 128 &lt; size &lt;= 512</span>
               <span class="p">(</span><span class="k">if</span> <span class="nv">i32</span> <span class="p">(</span><span class="nv">i32.le_u</span> <span class="o">,</span><span class="nv">size</span> <span class="p">(</span><span class="nv">i32.const</span> <span class="mi">256</span><span class="p">))</span>
                                        <span class="c1">; 128 &lt; size &lt;= 256</span>
                   <span class="p">(</span><span class="nv">i32.const</span> <span class="mi">6</span><span class="p">)</span>
                                        <span class="c1">; 256 &lt; size &lt;= 512</span>
                   <span class="p">(</span><span class="nv">i32.const</span> <span class="mi">7</span><span class="p">))</span>
                                        <span class="c1">; 512 &lt; size &lt;= 1024</span>
               <span class="p">(</span><span class="nv">i32.const</span> <span class="mi">8</span><span class="p">))</span>
                                        <span class="c1">; 1024 &lt; size</span>
           <span class="p">(</span><span class="k">if</span> <span class="nv">i32</span> <span class="p">(</span><span class="nv">i32.le_u</span> <span class="o">,</span><span class="nv">size</span> <span class="p">(</span><span class="nv">i32.const</span> <span class="mi">2048</span><span class="p">))</span>
                                        <span class="c1">; 1024 &lt; size &lt;= 2048</span>
               <span class="p">(</span><span class="nv">i32.const</span> <span class="mi">9</span><span class="p">)</span>
               <span class="p">(</span><span class="k">if</span> <span class="nv">i32</span> <span class="p">(</span><span class="nv">i32.le_u</span> <span class="o">,</span><span class="nv">size</span> <span class="p">(</span><span class="nv">i32.const</span> <span class="mi">4096</span><span class="p">))</span>
                                        <span class="c1">; 2048 &lt; size &lt;= 4096</span>
                   <span class="p">(</span><span class="nv">i32.const</span> <span class="mi">10</span><span class="p">)</span>
                                        <span class="c1">; 4096 &lt; size</span>
                   <span class="p">(</span><span class="nv">unreachable</span><span class="p">))))))</span></code></pre></div>
<p>ヒーブを増やす内部処理。</p>
<div class="highlight"><pre class="chroma"><code class="language-common-lisp" data-lang="common-lisp"><span class="p">(</span><span class="nv">defwfun</span> <span class="nv">$gc--append-heap-page</span> <span class="p">((</span><span class="nv">gc</span> <span class="nv">i32</span><span class="p">)</span> <span class="p">(</span><span class="nv">heap-page</span> <span class="nv">i32</span><span class="p">)</span> <span class="p">(</span><span class="nv">size</span> <span class="nv">i32</span><span class="p">)</span>
                                <span class="k">&amp;aux</span> <span class="p">(</span><span class="nv">heap-index</span> <span class="nv">i32</span><span class="p">)</span> <span class="p">(</span><span class="nv">heap-page-ptr</span> <span class="nv">i32</span><span class="p">)</span> <span class="p">(</span><span class="nv">heap-page-next-ptr</span> <span class="nv">i32</span><span class="p">))</span> <span class="no">nil</span>
  <span class="o">`</span><span class="p">((</span><span class="nv">set_local</span> <span class="o">,</span><span class="nv">heap-index</span> <span class="p">(</span><span class="nv">i32.mul</span> <span class="p">(</span><span class="nv">i32.const</span> <span class="mi">4</span><span class="p">)</span> <span class="o">,</span><span class="p">(</span><span class="nv">calc-heap-index</span> <span class="o">`</span><span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">size</span><span class="p">))))</span>
    <span class="p">(</span><span class="nv">set_local</span> <span class="o">,</span><span class="nv">heap-page-ptr</span>
               <span class="p">(</span><span class="nv">i32.load</span> <span class="o">,</span><span class="p">(</span><span class="nf">intern</span> <span class="p">(</span><span class="nf">format</span> <span class="no">nil</span> <span class="s">&#34;OFFSET=~a&#34;</span> <span class="vg">*offset-gc-heap-page*</span><span class="p">))</span>
                         <span class="p">(</span><span class="nv">i32.add</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">gc</span><span class="p">)</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">heap-index</span><span class="p">))))</span>
    <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nv">i32.eqz</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">heap-page-ptr</span><span class="p">))</span>
        <span class="c1">;; if no page exist let it be the first page</span>
        <span class="p">(</span><span class="nv">i32.store</span> <span class="o">,</span><span class="p">(</span><span class="nf">intern</span> <span class="p">(</span><span class="nf">format</span> <span class="no">nil</span> <span class="s">&#34;OFFSET=~a&#34;</span> <span class="vg">*offset-gc-heap-page*</span><span class="p">))</span>
                   <span class="p">(</span><span class="nv">i32.add</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">gc</span><span class="p">)</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">heap-index</span><span class="p">))</span>
                   <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">heap-page</span><span class="p">))</span>
        <span class="c1">;; if at least 1 page exist, append it to the end</span>
        <span class="p">(</span><span class="nb">loop</span> <span class="nv">$loop</span>
           <span class="p">(</span><span class="nv">set_local</span> <span class="o">,</span><span class="nv">heap-page-next-ptr</span>
                      <span class="p">(</span><span class="nv">i32.load</span> <span class="o">,</span><span class="p">(</span><span class="nf">intern</span> <span class="p">(</span><span class="nf">format</span> <span class="no">nil</span> <span class="s">&#34;OFFSET=~a&#34;</span> <span class="vg">*offset-heap-page-next*</span><span class="p">))</span>
                                <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">heap-page-ptr</span><span class="p">)))</span>
           <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nv">i32.eqz</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">heap-page-next-ptr</span><span class="p">))</span>
               <span class="p">(</span><span class="k">block</span>
                   <span class="p">(</span><span class="nv">i32.store</span> <span class="o">,</span><span class="p">(</span><span class="nf">intern</span> <span class="p">(</span><span class="nf">format</span> <span class="no">nil</span> <span class="s">&#34;OFFSET=~a&#34;</span> <span class="vg">*offset-heap-page-next*</span><span class="p">))</span>
                              <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">heap-page-ptr</span><span class="p">)</span>
                              <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">heap-page</span><span class="p">))</span>
                 <span class="p">(</span><span class="nb">return</span><span class="p">))</span>
               <span class="p">(</span><span class="nv">set_local</span> <span class="o">,</span><span class="nv">heap-page-ptr</span> <span class="p">(</span><span class="nv">get_local,heap-page-next-ptr</span><span class="p">)))</span>
           <span class="p">(</span><span class="nv">br</span> <span class="nv">$loop</span><span class="p">)))))</span>

<span class="p">(</span><span class="nv">defwfun</span> <span class="nv">$gc-extend-heap-page</span> <span class="p">((</span><span class="nv">gc</span> <span class="nv">i32</span><span class="p">)</span> <span class="p">(</span><span class="nv">size</span> <span class="nv">i32</span><span class="p">)</span> <span class="k">&amp;aux</span> <span class="p">(</span><span class="nv">heap-page</span> <span class="nv">i32</span><span class="p">))</span> <span class="no">nil</span>
  <span class="o">`</span><span class="p">((</span><span class="nv">set_local</span> <span class="o">,</span><span class="nv">heap-page</span> <span class="p">(</span><span class="nv">call</span> <span class="nv">$new-heap-page</span><span class="p">))</span>
    <span class="p">(</span><span class="nv">call</span> <span class="nv">$init-heap-page</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">heap-page</span><span class="p">)</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">size</span><span class="p">))</span>
    <span class="p">(</span><span class="nv">call</span> <span class="nv">$gc--append-heap-page</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">gc</span><span class="p">)</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">heap-page</span><span class="p">)</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">size</span><span class="p">))))</span></code></pre></div>
<p>アロケーション処理。ごちゃごちゃしてますがコメントだけ拾い読みすると何をやってるかはわかります。</p>

<p>GCからヒープのリストを指定して、ヒーブのリストから空いてるヒーブを探して、ヒーブの中から空いてるセルを探すので関数が3つに分かれてます。
また、大本の<code>alloc</code>関数はメモリが足りなければGCを起動したりメモリを増やしたりします。</p>
<div class="highlight"><pre class="chroma"><code class="language-common-lisp" data-lang="common-lisp"><span class="p">(</span><span class="nv">defwfun</span> <span class="nv">$gc--alloc-page</span> <span class="p">((</span><span class="nv">page</span> <span class="nv">i32</span><span class="p">)</span> <span class="p">(</span><span class="nv">size</span> <span class="nv">i32</span><span class="p">)</span> <span class="k">&amp;aux</span>  <span class="p">(</span><span class="nv">bitmap</span> <span class="nv">i64</span><span class="p">)</span> <span class="p">(</span><span class="nv">i</span> <span class="nv">i32</span><span class="p">)</span> <span class="p">(</span><span class="nv">j</span> <span class="nv">i32</span><span class="p">)</span> <span class="p">(</span><span class="nv">index</span> <span class="nv">i32</span><span class="p">))</span> <span class="nv">i32</span>
  <span class="o">`</span><span class="p">(</span>
                                        <span class="c1">; for i from 0 below *bitmap-size*</span>
    <span class="p">(</span><span class="k">block</span> <span class="nv">$outer</span>
     <span class="p">(</span><span class="nb">loop</span> <span class="nv">$loop</span>
        <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nv">i32.le_u</span> <span class="p">(</span><span class="nv">i32.const</span> <span class="o">,</span><span class="vg">*bitmap-size*</span><span class="p">)</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">i</span><span class="p">))</span>
            <span class="p">(</span><span class="nv">br</span> <span class="nv">$outer</span><span class="p">))</span>
                                        <span class="c1">;   bitmap &lt;- page.bitmap[i]</span>
        <span class="p">(</span><span class="nv">set_local</span> <span class="o">,</span><span class="nv">bitmap</span> <span class="p">(</span><span class="nv">i64.load</span> <span class="o">,</span><span class="p">(</span><span class="nf">intern</span> <span class="p">(</span><span class="nf">format</span> <span class="no">nil</span> <span class="s">&#34;OFFSET=~a&#34;</span> <span class="vg">*offset-heap-page-bitmaps*</span><span class="p">))</span>
                                     <span class="p">(</span><span class="nv">i32.add</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">page</span><span class="p">)</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">i</span><span class="p">))))</span>
                                        <span class="c1">;   if bitmap == 1111...1111</span>
        <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nv">i64.eq</span> <span class="p">(</span><span class="nv">i64.const</span> <span class="mi">-1</span><span class="p">)</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">bitmap</span><span class="p">))</span>
                                        <span class="c1">;     next</span>
            <span class="p">(</span><span class="nv">br</span> <span class="nv">$loop</span><span class="p">))</span>
                                        <span class="c1">;   j &lt;- index of the first 0 in bitmap</span>
        <span class="p">(</span><span class="nv">set_local</span> <span class="o">,</span><span class="nv">j</span> <span class="p">(</span><span class="nv">i32.wrap/i64</span><span class="p">(</span><span class="nv">i64.ctz</span> <span class="p">(</span><span class="nv">i64.sub</span> <span class="p">(</span><span class="nv">i64.const</span> <span class="mi">-1</span><span class="p">)</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">bitmap</span><span class="p">)))))</span>
                                        <span class="c1">;   index &lt;- i*64+j</span>
        <span class="p">(</span><span class="nv">set_local</span> <span class="o">,</span><span class="nv">index</span> <span class="p">(</span><span class="nv">i32.add</span> <span class="p">(</span><span class="nv">i32.mul</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">i</span><span class="p">)</span> <span class="p">(</span><span class="nv">i32.const</span> <span class="mi">64</span><span class="p">))</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">j</span><span class="p">)))</span>
                                        <span class="c1">;   if page.heap_size &lt;= index</span>
        <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nv">i32.le_u</span> <span class="p">(</span><span class="nv">i32.load</span> <span class="o">,</span><span class="p">(</span><span class="nf">intern</span> <span class="p">(</span><span class="nf">format</span> <span class="no">nil</span> <span class="s">&#34;OFFSET=~a&#34;</span> <span class="vg">*offset-heap-page-heap-size*</span><span class="p">))</span>
                                <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">page</span><span class="p">))</span>
                      <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">index</span><span class="p">))</span>
                                        <span class="c1">;     return null</span>
            <span class="p">(</span><span class="nb">return</span> <span class="o">,</span><span class="vg">*null-ptr*</span><span class="p">)</span>
                                        <span class="c1">;   else</span>
            <span class="p">(</span><span class="k">block</span>
                                        <span class="c1">;     page.bitmap[i] &lt;- bitmap | (1 &lt;&lt; j)</span>
                <span class="p">(</span><span class="nv">i64.store</span> <span class="o">,</span><span class="p">(</span><span class="nf">intern</span> <span class="p">(</span><span class="nf">format</span> <span class="no">nil</span> <span class="s">&#34;OFFSET=~a&#34;</span> <span class="vg">*offset-heap-page-bitmaps*</span><span class="p">))</span>
                           <span class="p">(</span><span class="nv">i32.add</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">page</span><span class="p">)</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">i</span><span class="p">))</span>
                           <span class="p">(</span><span class="nv">i64.or</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">bitmap</span><span class="p">)</span> <span class="p">(</span><span class="nv">i64.shl</span> <span class="p">(</span><span class="nv">i64.const</span> <span class="mi">1</span><span class="p">)</span> <span class="p">(</span><span class="nv">i64.extend_u/i32</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">j</span><span class="p">)))))</span>
                                        <span class="c1">;     return &amp;page.data[index*size]</span>
                <span class="p">(</span><span class="nb">return</span> <span class="p">(</span><span class="nv">i32.add</span> <span class="p">(</span><span class="nv">i32.add</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">page</span><span class="p">)</span> <span class="p">(</span><span class="nv">i32.const</span> <span class="o">,</span><span class="vg">*offset-heap-page-heap-data*</span><span class="p">))</span>
                                 <span class="p">(</span><span class="nv">i32.mul</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">index</span><span class="p">)</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">size</span><span class="p">))))))</span>
        <span class="p">(</span><span class="nv">br</span> <span class="nv">$loop</span><span class="p">)))</span>
                                        <span class="c1">; return null</span>
    <span class="o">,</span><span class="vg">*null-ptr*</span><span class="p">))</span>

<span class="p">(</span><span class="nv">defwfun</span> <span class="nv">$gc--alloc-pages</span> <span class="p">((</span><span class="nv">pages</span> <span class="nv">i32</span><span class="p">)</span> <span class="p">(</span><span class="nv">size</span> <span class="nv">i32</span><span class="p">)</span> <span class="k">&amp;aux</span> <span class="p">(</span><span class="nv">ptr</span> <span class="nv">i32</span><span class="p">))</span> <span class="nv">i32</span>
  <span class="o">`</span><span class="p">(</span>
                                        <span class="c1">;  loop</span>
    <span class="p">(</span><span class="nb">loop</span> <span class="nv">$loop</span>
                                        <span class="c1">;   if (page.next is null)</span>
       <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nv">i32.eqz</span> <span class="p">(</span><span class="nv">get_local,</span> <span class="nv">pages</span><span class="p">))</span>
                                        <span class="c1">;     fail</span>
           <span class="p">(</span><span class="nb">return</span> <span class="p">(</span><span class="nv">i32.const</span> <span class="mi">0</span><span class="p">)))</span>
                                        <span class="c1">;   try alloc-page(page, size)</span>
       <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nv">i32.eqz</span> <span class="p">(</span><span class="nv">tee_local</span> <span class="o">,</span><span class="nv">ptr</span> <span class="p">(</span><span class="nv">call</span> <span class="nv">$gc--alloc-page</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">pages</span><span class="p">)</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">size</span><span class="p">))))</span>
           <span class="p">(</span><span class="nv">set_local</span> <span class="o">,</span><span class="nv">ptr</span> <span class="p">(</span><span class="nv">i32.load</span> <span class="o">,</span><span class="p">(</span><span class="nf">intern</span> <span class="p">(</span><span class="nf">format</span> <span class="no">nil</span> <span class="s">&#34;OFFSET=~a&#34;</span> <span class="vg">*offset-heap-page-next*</span><span class="p">))</span>
                                     <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">pages</span><span class="p">)))</span>
           <span class="p">(</span><span class="nb">return</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">ptr</span><span class="p">)))</span>
       <span class="p">(</span><span class="nv">br</span> <span class="nv">$loop</span><span class="p">))</span>
    <span class="p">(</span><span class="nv">unreachable</span><span class="p">)</span>
    <span class="p">)</span>
  <span class="p">)</span>

<span class="p">(</span><span class="nv">defwfun</span> <span class="nv">$gc--alloc</span> <span class="p">((</span><span class="nv">gc</span> <span class="nv">i32</span><span class="p">)</span> <span class="p">(</span><span class="nv">size</span> <span class="nv">i32</span><span class="p">)</span> <span class="k">&amp;aux</span> <span class="p">(</span><span class="nv">pages</span> <span class="nv">i32</span><span class="p">)</span> <span class="p">(</span><span class="nv">index</span> <span class="nv">i32</span><span class="p">))</span> <span class="nv">i32</span>
  <span class="o">`</span><span class="p">(</span>
                                        <span class="c1">; index &lt;- calc-index-by-size(size)</span>
    <span class="p">(</span><span class="nv">set_local</span> <span class="o">,</span><span class="nv">index</span> <span class="o">,</span><span class="p">(</span><span class="nv">calc-heap-index</span> <span class="o">`</span><span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">size</span><span class="p">)))</span>
                                        <span class="c1">; alloc-pages(gc.heaps[index], size)</span>
    <span class="p">(</span><span class="nv">set_local</span> <span class="o">,</span><span class="nv">pages</span> <span class="p">(</span><span class="nv">i32.load</span> <span class="o">,</span><span class="p">(</span><span class="nf">intern</span> <span class="p">(</span><span class="nf">format</span> <span class="no">nil</span> <span class="s">&#34;OFFSET=~a&#34;</span> <span class="vg">*offset-gc-heap-page*</span><span class="p">))</span>
                                <span class="p">(</span><span class="nv">i32.add</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">gc</span><span class="p">)</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">index</span><span class="p">))))</span>
    <span class="p">(</span><span class="nv">call</span> <span class="nv">$gc--alloc-pages</span>
          <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">pages</span><span class="p">)</span>
          <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">size</span><span class="p">))))</span>

<span class="p">(</span><span class="nv">defwfun</span> <span class="nv">$gc-alloc</span> <span class="p">((</span><span class="nv">gc</span> <span class="nv">i32</span><span class="p">)</span> <span class="p">(</span><span class="nv">data-size</span> <span class="nv">i32</span><span class="p">)</span> <span class="k">&amp;aux</span> <span class="p">(</span><span class="nv">size</span> <span class="nv">i32</span><span class="p">)</span> <span class="p">(</span><span class="nv">ptr</span> <span class="nv">i32</span><span class="p">))</span> <span class="nv">i32</span>
  <span class="o">`</span><span class="p">(</span>
                                        <span class="c1">; try alloc</span>
    <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nv">i32.eqz</span> <span class="p">(</span><span class="nv">tee_local</span> <span class="o">,</span><span class="nv">ptr</span> <span class="p">(</span><span class="nv">call</span> <span class="nv">$gc--alloc</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">gc</span><span class="p">)</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">data-size</span><span class="p">))))</span>
        <span class="p">(</span><span class="k">block</span>
                                        <span class="c1">; gc-run</span>
            <span class="p">(</span><span class="nv">call</span> <span class="nv">$gc-run</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">gc</span><span class="p">))</span>
                                        <span class="c1">; try alloc</span>
          <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nv">i32.eqz</span> <span class="p">(</span><span class="nv">tee_local</span> <span class="o">,</span><span class="nv">ptr</span> <span class="p">(</span><span class="nv">call</span> <span class="nv">$gc--alloc</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">gc</span><span class="p">)</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">data-size</span><span class="p">))))</span>
              <span class="p">(</span><span class="k">block</span>
                        <span class="c1">; FIXME: round up power of 2</span>
                  <span class="p">(</span><span class="nv">set_local</span> <span class="o">,</span><span class="nv">size</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">data-size</span><span class="p">))</span>
                                        <span class="c1">; extend-page</span>
                  <span class="p">(</span><span class="nv">call</span> <span class="nv">$gc-extend-heap-page</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">gc</span><span class="p">)</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">size</span><span class="p">))</span>
                                        <span class="c1">; alloc</span>
                <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nv">i32.eqz</span> <span class="p">(</span><span class="nv">tee_local</span> <span class="o">,</span><span class="nv">ptr</span> <span class="p">(</span><span class="nv">call</span> <span class="nv">$gc--alloc</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">gc</span><span class="p">)</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">data-size</span><span class="p">))))</span>
                    <span class="p">(</span><span class="nv">unreachable</span><span class="p">))))))</span>
    <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">ptr</span><span class="p">)))</span></code></pre></div>
<p>ヒープにポインタを退避する関数群。ただのスタックなのでシンプル。</p>
<div class="highlight"><pre class="chroma"><code class="language-common-lisp" data-lang="common-lisp"><span class="p">(</span><span class="nv">defwfun</span> <span class="nv">$gc-save-state</span> <span class="p">((</span><span class="nv">gc</span> <span class="nv">i32</span><span class="p">))</span> <span class="nv">i32</span>
  <span class="o">`</span><span class="p">((</span><span class="nv">i32.load</span> <span class="o">,</span><span class="p">(</span><span class="nf">intern</span> <span class="p">(</span><span class="nf">format</span> <span class="no">nil</span> <span class="s">&#34;OFFSET=~a&#34;</span> <span class="vg">*offset-gc-arena-top*</span><span class="p">))</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">gc</span><span class="p">))))</span>
<span class="p">(</span><span class="nv">defwfun</span> <span class="nv">$gc-protect</span> <span class="p">((</span><span class="nv">gc</span> <span class="nv">i32</span><span class="p">)</span> <span class="p">(</span><span class="nv">ptr</span> <span class="nv">i32</span><span class="p">)</span> <span class="k">&amp;aux</span> <span class="p">(</span><span class="nv">arena-top</span> <span class="nv">i32</span><span class="p">))</span> <span class="no">nil</span>
  <span class="o">`</span><span class="p">((</span><span class="nv">set_local</span> <span class="o">,</span><span class="nv">arena-top</span> <span class="p">(</span><span class="nv">i32.load</span> <span class="o">,</span><span class="p">(</span><span class="nf">intern</span> <span class="p">(</span><span class="nf">format</span> <span class="no">nil</span> <span class="s">&#34;OFFSET=~a&#34;</span> <span class="vg">*offset-gc-arena-top*</span><span class="p">))</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">gc</span><span class="p">)))</span>
    <span class="p">(</span><span class="nv">i32.store</span> <span class="o">,</span><span class="p">(</span><span class="nf">intern</span> <span class="p">(</span><span class="nf">format</span> <span class="no">nil</span> <span class="s">&#34;OFFSET=~a&#34;</span> <span class="vg">*offset-gc-arena*</span><span class="p">))</span>
               <span class="p">(</span><span class="nv">i32.add</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">gc</span><span class="p">)</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">arena-top</span><span class="p">))</span>
               <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">ptr</span><span class="p">))</span>
    <span class="p">(</span><span class="nv">i32.store</span> <span class="o">,</span><span class="p">(</span><span class="nf">intern</span> <span class="p">(</span><span class="nf">format</span> <span class="no">nil</span> <span class="s">&#34;OFFSET=~a&#34;</span> <span class="vg">*offset-gc-arena-top*</span><span class="p">))</span>
               <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">gc</span><span class="p">)</span>
               <span class="p">(</span><span class="nv">i32.add</span> <span class="p">(</span><span class="nv">i32.const</span> <span class="mi">4</span><span class="p">)</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">arena-top</span><span class="p">)))))</span>
<span class="p">(</span><span class="nv">defwfun</span> <span class="nv">$gc-restore-state</span> <span class="p">((</span><span class="nv">gc</span> <span class="nv">i32</span><span class="p">)</span> <span class="p">(</span><span class="nv">state</span> <span class="nv">i32</span><span class="p">))</span> <span class="no">nil</span>
    <span class="o">`</span><span class="p">((</span><span class="nv">i32.store</span> <span class="o">,</span><span class="p">(</span><span class="nf">intern</span> <span class="p">(</span><span class="nf">format</span> <span class="no">nil</span> <span class="s">&#34;OFFSET=~a&#34;</span> <span class="vg">*offset-gc-arena-top*</span><span class="p">))</span>
                 <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">gc</span><span class="p">)</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">state</span><span class="p">))))</span></code></pre></div>
<p>マーク処理。
先程解説してなかったのですが、アロケートしたデータをどうマークするかはユーザに任せます。
動的型付き言語ならデータに埋め込まれたタグで型を判別してマークするでしょう。
静的型付き言語ならタグを入れるか保守的にポインタっぽい値を全部マークする手もあるでしょう。
ここではダミーの何もせずマーク完了を返す関数にしています。</p>
<div class="highlight"><pre class="chroma"><code class="language-common-lisp" data-lang="common-lisp"><span class="p">(</span><span class="nv">defwfun</span> <span class="nv">$gc--clear-marks-page</span> <span class="p">((</span><span class="nv">page</span> <span class="nv">i32</span><span class="p">))</span> <span class="no">nil</span>
  <span class="c1">;; clear the bitmaps of the page</span>
  <span class="p">(</span><span class="nb">loop</span> <span class="ss">:for</span> <span class="nv">i</span> <span class="ss">:from</span> <span class="mi">0</span> <span class="ss">:below</span> <span class="vg">*bitmap-size*</span> <span class="ss">:collect</span>
       <span class="o">`</span><span class="p">(</span><span class="nv">i64.store</span> <span class="o">,</span><span class="p">(</span><span class="nf">intern</span> <span class="p">(</span><span class="nf">format</span> <span class="no">nil</span> <span class="s">&#34;OFFSET=~a&#34;</span> <span class="p">(</span><span class="nf">*</span> <span class="nv">i</span> <span class="mi">8</span><span class="p">)))</span>
                   <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">page</span><span class="p">)</span>
                   <span class="p">(</span><span class="nv">i64.const</span> <span class="mi">0</span><span class="p">))))</span>
<span class="p">(</span><span class="nv">defwfun</span> <span class="nv">$gc--clear-marks-pages</span> <span class="p">((</span><span class="nv">current-page</span> <span class="nv">i32</span><span class="p">))</span> <span class="no">nil</span>
  <span class="c1">;; call for $gc--clear-marks-page all the pages connected to this page</span>
  <span class="o">`</span><span class="p">((</span><span class="nb">loop</span> <span class="nv">$loop</span>
       <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nv">i32.eqz</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">current-page</span><span class="p">))</span>
           <span class="p">(</span><span class="nb">return</span><span class="p">))</span>
       <span class="p">(</span><span class="nv">call</span> <span class="nv">$gc--clear-marks-page</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">current-page</span><span class="p">))</span>
       <span class="p">(</span><span class="nv">set_local</span> <span class="o">,</span><span class="nv">current-page</span>
                  <span class="p">(</span><span class="nv">i32.load</span> <span class="o">,</span><span class="p">(</span><span class="nf">intern</span> <span class="p">(</span><span class="nf">format</span> <span class="no">nil</span> <span class="s">&#34;OFFSET=~a&#34;</span> <span class="vg">*offset-heap-page-next*</span><span class="p">))</span>
                            <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">current-page</span><span class="p">)))</span>
       <span class="p">(</span><span class="nv">br</span> <span class="nv">$loop</span><span class="p">))))</span>
<span class="p">(</span><span class="nv">defwfun</span> <span class="nv">$gc--clear-marks</span> <span class="p">((</span><span class="nv">gc</span> <span class="nv">i32</span><span class="p">))</span> <span class="no">nil</span>
  <span class="c1">;; cal $gc--clear-marks-pages for all the size of pages</span>
  <span class="p">(</span><span class="nb">loop</span>
     <span class="ss">:for</span> <span class="nv">i</span> <span class="ss">:from</span> <span class="mi">0</span> <span class="ss">:below</span> <span class="mi">11</span> <span class="ss">:collect</span>
       <span class="o">`</span><span class="p">(</span><span class="nv">call</span> <span class="nv">$gc--clear-marks-pages</span>
              <span class="p">(</span><span class="nv">i32.load</span> <span class="o">,</span><span class="p">(</span><span class="nf">intern</span> <span class="p">(</span><span class="nf">format</span> <span class="no">nil</span> <span class="s">&#34;OFFSET=~a&#34;</span> <span class="p">(</span><span class="nf">*</span> <span class="nv">i</span> <span class="vg">*sizeof-ptr*</span><span class="p">)))</span>
                        <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">gc</span><span class="p">)))))</span>
<span class="p">(</span><span class="nv">defwfun</span> <span class="nv">$gc--mark-data</span> <span class="p">((</span><span class="nv">ptr</span> <span class="nv">i32</span><span class="p">))</span> <span class="nv">i32</span>
                                        <span class="c1">; user defined data marking function</span>
  <span class="o">`</span><span class="p">((</span><span class="nv">i32.const</span> <span class="mi">1</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">get-page</span> <span class="p">(</span><span class="nv">ptr</span><span class="p">)</span>
  <span class="o">`</span><span class="p">(</span><span class="nv">i32.and</span> <span class="p">(</span><span class="nv">i32.const</span> <span class="o">,</span><span class="p">(</span><span class="nf">lognot</span><span class="p">(</span><span class="nf">1-</span> <span class="p">(</span><span class="nf">ash</span> <span class="mi">1</span> <span class="p">(</span><span class="nf">round</span> <span class="p">(</span><span class="nf">log</span> <span class="vg">*page-size*</span> <span class="mi">2</span><span class="p">))))))</span>
            <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">ptr</span><span class="p">)))</span>

<span class="p">(</span><span class="nv">defwfun</span> <span class="nv">$gc--mark-ptr</span>
    <span class="p">((</span><span class="nv">ptr</span> <span class="nv">i32</span><span class="p">)</span>
     <span class="k">&amp;aux</span> <span class="p">(</span><span class="nv">page</span> <span class="nv">i32</span><span class="p">)</span> <span class="p">(</span><span class="nv">size</span> <span class="nv">i32</span><span class="p">)</span> <span class="p">(</span><span class="nv">bitmap</span> <span class="nv">i64</span><span class="p">)</span> <span class="p">(</span><span class="nv">mask</span> <span class="nv">i64</span><span class="p">)</span>
     <span class="p">(</span><span class="nv">index-in-heap</span> <span class="nv">i32</span><span class="p">)</span> <span class="p">(</span><span class="nv">index-in-array</span> <span class="nv">i32</span><span class="p">)</span> <span class="p">(</span><span class="nv">index-in-i64</span> <span class="nv">i32</span><span class="p">))</span> <span class="nv">i32</span>
                                        <span class="c1">; mark the ptr and recursively the data</span>
  <span class="o">`</span><span class="p">(</span>
                                        <span class="c1">; page &lt;- get_page(ptr)</span>
    <span class="p">(</span><span class="nv">set_local</span> <span class="o">,</span><span class="nv">page</span> <span class="o">,</span><span class="p">(</span><span class="nv">get-page</span> <span class="nv">ptr</span><span class="p">))</span>
                                        <span class="c1">; size &lt;- get_size(page</span>
    <span class="p">(</span><span class="nv">set_local</span> <span class="o">,</span><span class="nv">size</span> <span class="p">(</span><span class="nv">i32.load</span> <span class="o">,</span><span class="p">(</span><span class="nf">intern</span> <span class="p">(</span><span class="nf">format</span> <span class="no">nil</span> <span class="s">&#34;OFFSET=~a&#34;</span> <span class="vg">*offset-heap-page-data-size*</span><span class="p">))</span>
                               <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">page</span><span class="p">)))</span>
                                        <span class="c1">; index &lt;- calc index(page, ptr)</span>
    <span class="p">(</span><span class="nv">set_local</span> <span class="o">,</span><span class="nv">index-in-heap</span>
               <span class="p">(</span><span class="nv">i32.div_u</span> <span class="p">(</span><span class="nv">i32.sub</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">ptr</span><span class="p">)</span>
                                   <span class="p">(</span><span class="nv">i32.add</span> <span class="p">(</span><span class="nv">get_local,page</span><span class="p">)</span>
                                            <span class="p">(</span><span class="nv">i32.const</span> <span class="o">,</span><span class="vg">*offset-heap-page-heap-data*</span><span class="p">)))</span>
                          <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">size</span><span class="p">)))</span>
    <span class="p">(</span><span class="nv">set_local</span> <span class="o">,</span><span class="nv">index-in-array</span> <span class="p">(</span><span class="nv">i32.div_u</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">index-in-heap</span><span class="p">)</span> <span class="p">(</span><span class="nv">i32.const</span> <span class="mi">64</span><span class="p">)))</span>
    <span class="p">(</span><span class="nv">set_local</span> <span class="o">,</span><span class="nv">index-in-i64</span>   <span class="p">(</span><span class="nv">i32.rem_u</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">index-in-heap</span><span class="p">)</span> <span class="p">(</span><span class="nv">i32.const</span> <span class="mi">64</span><span class="p">)))</span>
                                        <span class="c1">; if (! is_marked(page, index))</span>
    <span class="p">(</span><span class="nv">set_local</span> <span class="o">,</span><span class="nv">bitmap</span> <span class="p">(</span><span class="nv">i64.load</span> <span class="o">,</span><span class="p">(</span><span class="nf">intern</span> <span class="p">(</span><span class="nf">format</span> <span class="no">nil</span> <span class="s">&#34;OFFSET=~a&#34;</span> <span class="vg">*offset-heap-page-bitmaps*</span><span class="p">))</span>
                                 <span class="p">(</span><span class="nv">i32.add</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">page</span><span class="p">)</span>
                                          <span class="p">(</span><span class="nv">i32.mul</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">index-in-array</span><span class="p">)</span> <span class="p">(</span><span class="nv">i32.const</span> <span class="mi">8</span><span class="p">)))))</span>
    <span class="p">(</span><span class="nv">set_local</span> <span class="o">,</span><span class="nv">mask</span> <span class="p">(</span><span class="nv">i64.shl</span> <span class="p">(</span><span class="nv">i64.const</span> <span class="mi">1</span><span class="p">)</span> <span class="p">(</span><span class="nv">i64.extend_u/i32</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">index-in-i64</span><span class="p">))))</span>
    <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nv">i64.eqz</span> <span class="p">(</span><span class="nv">i64.and</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">bitmap</span><span class="p">)</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">mask</span><span class="p">)))</span>
                                        <span class="c1">;   mark(page, index)</span>
        <span class="p">(</span><span class="k">block</span>
            <span class="p">(</span><span class="nv">i64.store</span> <span class="o">,</span><span class="p">(</span><span class="nf">intern</span> <span class="p">(</span><span class="nf">format</span> <span class="no">nil</span> <span class="s">&#34;OFFSET=~a&#34;</span> <span class="vg">*offset-heap-page-bitmaps*</span><span class="p">))</span>
                       <span class="p">(</span><span class="nv">i32.add</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">page</span><span class="p">)</span>
                                <span class="p">(</span><span class="nv">i32.mul</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">index-in-array</span><span class="p">)</span> <span class="p">(</span><span class="nv">i32.const</span> <span class="mi">8</span><span class="p">)))</span>
                       <span class="p">(</span><span class="nv">i64.or</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">bitmap</span><span class="p">)</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">mask</span><span class="p">)))</span>
                                        <span class="c1">;   $gc--mark-data(ptr)</span>
          <span class="p">(</span><span class="nb">return</span> <span class="p">(</span><span class="nv">call</span> <span class="nv">$gc--mark-data</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">ptr</span><span class="p">)))))</span>
    <span class="p">(</span><span class="nb">return</span> <span class="p">(</span><span class="nv">i32.const</span> <span class="mi">1</span><span class="p">))))</span>

<span class="p">(</span><span class="nv">defwfun</span> <span class="nv">$gc--mark</span> <span class="p">((</span><span class="nv">gc</span> <span class="nv">i32</span><span class="p">)</span> <span class="k">&amp;aux</span> <span class="p">(</span><span class="nv">arena-top</span> <span class="nv">i32</span><span class="p">)</span> <span class="p">(</span><span class="nv">i</span> <span class="nv">i32</span><span class="p">))</span> <span class="no">nil</span>
  <span class="o">`</span><span class="p">(</span><span class="c1">; for each arena data call $gc--mark-ptr</span>
    <span class="p">(</span><span class="nv">set_local</span> <span class="o">,</span><span class="nv">arena-top</span> <span class="p">(</span><span class="nv">i32.load</span> <span class="o">,</span><span class="p">(</span><span class="nf">intern</span> <span class="p">(</span><span class="nf">format</span> <span class="no">nil</span> <span class="s">&#34;OFFSET=~a&#34;</span> <span class="vg">*offset-gc-arena-top*</span><span class="p">))</span>
                                    <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">gc</span><span class="p">)))</span>
    <span class="p">(</span><span class="nb">loop</span> <span class="nv">$loop</span>
       <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nv">i32.le_u</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">arena-top</span><span class="p">)</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">i</span><span class="p">))</span>
           <span class="p">(</span><span class="nb">return</span><span class="p">))</span>
       <span class="p">(</span><span class="nv">drop</span> <span class="p">(</span><span class="nv">call</span> <span class="nv">$gc--mark-ptr</span>
                   <span class="p">(</span><span class="nv">i32.load</span> <span class="o">,</span><span class="p">(</span><span class="nf">intern</span> <span class="p">(</span><span class="nf">format</span> <span class="no">nil</span> <span class="s">&#34;OFFSET=~a&#34;</span> <span class="vg">*offset-gc-arena*</span><span class="p">))</span>
                             <span class="p">(</span><span class="nv">i32.add</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">i</span><span class="p">)</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">gc</span><span class="p">)))))</span>
       <span class="p">(</span><span class="nv">set_local</span> <span class="o">,</span><span class="nv">i</span> <span class="p">(</span><span class="nv">i32.add</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">i</span> <span class="p">(</span><span class="nv">i32.const</span> <span class="mi">4</span><span class="p">))))</span>
       <span class="p">(</span><span class="nv">br</span> <span class="nv">$loop</span><span class="p">))))</span></code></pre></div>
<p>GC実行。普通のMark and Sweepとは違ってclear and mark。</p>
<div class="highlight"><pre class="chroma"><code class="language-common-lisp" data-lang="common-lisp"><span class="p">(</span><span class="nv">defwfun</span> <span class="nv">$gc-run</span> <span class="p">((</span><span class="nv">gc</span> <span class="nv">i32</span><span class="p">))</span> <span class="no">nil</span>
  <span class="o">`</span><span class="p">((</span><span class="nv">call</span> <span class="nv">$gc--clear-marks</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">gc</span><span class="p">))</span>
    <span class="p">(</span><span class="nv">call</span> <span class="nv">$gc--mark</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">gc</span><span class="p">))))</span></code></pre></div>
<p>デバッグ用の何か。確保されているセルの数を数えます。</p>
<div class="highlight"><pre class="chroma"><code class="language-common-lisp" data-lang="common-lisp"><span class="c1">;;; other utils</span>
<span class="p">(</span><span class="nv">defwfun</span> <span class="nv">$gc--allocated-data-page</span> <span class="p">((</span><span class="nv">page</span> <span class="nv">i32</span><span class="p">)</span> <span class="k">&amp;aux</span> <span class="p">(</span><span class="nv">sum</span> <span class="nv">i32</span><span class="p">))</span> <span class="nv">i32</span>
  <span class="o">`</span><span class="p">(</span><span class="o">,@</span><span class="p">(</span><span class="nb">loop</span> <span class="ss">:for</span> <span class="nv">i</span> <span class="ss">:from</span> <span class="mi">0</span> <span class="ss">:below</span> <span class="vg">*bitmap-size*</span> <span class="ss">:collect</span>
           <span class="o">`</span><span class="p">(</span><span class="nv">set_local</span> <span class="o">,</span><span class="nv">sum</span>
                       <span class="p">(</span><span class="nv">i32.add</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">sum</span><span class="p">)</span>
                                <span class="p">(</span><span class="nv">i32.wrap/i64</span>
                                 <span class="p">(</span><span class="nv">i64.popcnt</span> <span class="p">(</span><span class="nv">i64.load</span> <span class="o">,</span><span class="p">(</span><span class="nf">intern</span> <span class="p">(</span><span class="nf">format</span> <span class="no">nil</span> <span class="s">&#34;OFFSET=~a&#34;</span> <span class="p">(</span><span class="nf">*</span> <span class="nv">i</span> <span class="mi">8</span><span class="p">)))</span>
                                                       <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">page</span><span class="p">)))))))</span>
      <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">sum</span><span class="p">)))</span>

<span class="p">(</span><span class="nv">defwfun</span> <span class="nv">$gc--allocated-data-pages</span> <span class="p">((</span><span class="nv">current-page</span> <span class="nv">i32</span><span class="p">)</span> <span class="k">&amp;aux</span> <span class="p">(</span><span class="nv">sum</span> <span class="nv">i32</span><span class="p">))</span> <span class="nv">i32</span>
  <span class="o">`</span><span class="p">((</span><span class="nb">loop</span> <span class="nv">$loop</span>
       <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nv">i32.eqz</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">current-page</span><span class="p">))</span>
           <span class="p">(</span><span class="nb">return</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">sum</span><span class="p">)))</span>
       <span class="p">(</span><span class="nv">set_local</span> <span class="o">,</span><span class="nv">sum</span> <span class="p">(</span><span class="nv">i32.add</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">sum</span><span class="p">)</span>
                                <span class="p">(</span><span class="nv">call</span> <span class="nv">$gc--allocated-data-page</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">current-page</span><span class="p">))))</span>
       <span class="p">(</span><span class="nv">set_local</span> <span class="o">,</span><span class="nv">current-page</span>
                  <span class="p">(</span><span class="nv">i32.load</span> <span class="o">,</span><span class="p">(</span><span class="nf">intern</span> <span class="p">(</span><span class="nf">format</span> <span class="no">nil</span> <span class="s">&#34;OFFSET=~a&#34;</span> <span class="vg">*offset-heap-page-next*</span><span class="p">))</span>
                            <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">current-page</span><span class="p">)))</span>
       <span class="p">(</span><span class="nv">br</span> <span class="nv">$loop</span><span class="p">))</span>
    <span class="p">(</span><span class="nv">unreachable</span><span class="p">)))</span>
<span class="p">(</span><span class="nv">defwfun</span> <span class="nv">$gc--allocated-data</span> <span class="p">((</span><span class="nv">gc</span> <span class="nv">i32</span><span class="p">)</span> <span class="k">&amp;aux</span> <span class="p">(</span><span class="nv">sum</span> <span class="nv">i32</span><span class="p">))</span> <span class="nv">i32</span>
  <span class="o">`</span><span class="p">(</span><span class="o">,@</span><span class="p">(</span><span class="nb">loop</span>
         <span class="ss">:for</span> <span class="nv">i</span> <span class="ss">:from</span> <span class="mi">0</span> <span class="ss">:below</span> <span class="mi">11</span> <span class="ss">:collect</span>
           <span class="o">`</span><span class="p">(</span><span class="nv">set_local</span> <span class="o">,</span><span class="nv">sum</span>
                       <span class="p">(</span><span class="nv">i32.add</span> <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">sum</span><span class="p">)</span>
                                <span class="p">(</span><span class="nv">call</span> <span class="nv">$gc--allocated-data-pages</span>
                                      <span class="p">(</span><span class="nv">i32.load</span> <span class="o">,</span><span class="p">(</span><span class="nf">intern</span> <span class="p">(</span><span class="nf">format</span> <span class="no">nil</span> <span class="s">&#34;OFFSET=~a&#34;</span> <span class="p">(</span><span class="nf">*</span> <span class="nv">i</span> <span class="vg">*sizeof-ptr*</span><span class="p">)))</span>
                                                <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">gc</span><span class="p">))))))</span>
      <span class="p">(</span><span class="nv">get_local</span> <span class="o">,</span><span class="nv">sum</span><span class="p">)))</span></code></pre></div>
<p>はい。まだFIXMEが残ってるなど甘いところがありますがWASMでBitMap GCを書きました。
多分他人の書いたよくわかんバグってそうなGCを使う人はいないと思うので自作するときの参考にして下さい。</p>

<p>所感としては<code>get_local</code>と<code>const</code>が面倒、<code>loop</code>が<code>br</code>を呼ばないと先頭に戻ってくれないことに気づいた、などがあります。</p>

<p>今回のソースコードは<a href="https://github.com/KeenS/wasm-gc">ここ</a>にあります。</p>

<p>2017-12-08 追記:
今回のGCは2011年の上野先生の論文<sup class="footnote-ref" id="fnref:1"><a href="#fn:1">1</a></sup>  に多大な影響を受けています。
また、そのBitMap GCは2016年に並行版も開発されています<sup class="footnote-ref" id="fnref:2"><a href="#fn:2">2</a></sup>。
興味のある方はぜひご一読下さい。</p>

<p>/追記</p>

<h1 id="付録-生成された-wat-全文">付録 生成された .wat 全文</h1>

<p>2017-12-08 編集: ページサイズを16KiB -&gt; 64KiBの変更を取り入れました</p>
<pre><code class="language-wat" data-lang="wat">(module (func $print (import &#34;imports&#34; &#34;print&#34;) (param i32))
 (func $new-page (result i32)
  (i32.mul (i32.const 65536) (grow_memory (i32.const 1))))
 (func $new-gc (result i32) (call $new-page))
 (func $gc-init (param i32) (i32.store offset=0 (get_local 0) (i32.const 0))
  (i32.store offset=4 (get_local 0) (i32.const 0))
  (i32.store offset=8 (get_local 0) (i32.const 0))
  (i32.store offset=12 (get_local 0) (i32.const 0))
  (i32.store offset=16 (get_local 0) (i32.const 0))
  (i32.store offset=20 (get_local 0) (i32.const 0))
  (i32.store offset=24 (get_local 0) (i32.const 0))
  (i32.store offset=28 (get_local 0) (i32.const 0))
  (i32.store offset=32 (get_local 0) (i32.const 0))
  (i32.store offset=36 (get_local 0) (i32.const 0))
  (i32.store offset=40 (get_local 0) (i32.const 0))
  (i32.store offset=44 (get_local 0) (i32.const 0))
  (i32.store offset=48 (get_local 0) (i32.const 16371)))
 (func $new-heap-page (result i32) (call $new-page))
 (func $init-heap-page (param i32 i32)
  (i64.store offset=0 (get_local 0) (i64.const 0))
  (i64.store offset=8 (get_local 0) (i64.const 0))
  (i64.store offset=16 (get_local 0) (i64.const 0))
  (i64.store offset=24 (get_local 0) (i64.const 0))
  (i64.store offset=32 (get_local 0) (i64.const 0))
  (i64.store offset=40 (get_local 0) (i64.const 0))
  (i64.store offset=48 (get_local 0) (i64.const 0))
  (i64.store offset=56 (get_local 0) (i64.const 0))
  (i64.store offset=64 (get_local 0) (i64.const 0))
  (i64.store offset=72 (get_local 0) (i64.const 0))
  (i64.store offset=80 (get_local 0) (i64.const 0))
  (i64.store offset=88 (get_local 0) (i64.const 0))
  (i64.store offset=96 (get_local 0) (i64.const 0))
  (i64.store offset=104 (get_local 0) (i64.const 0))
  (i64.store offset=112 (get_local 0) (i64.const 0))
  (i64.store offset=120 (get_local 0) (i64.const 0))
  (i64.store offset=128 (get_local 0) (i64.const 0))
  (i64.store offset=136 (get_local 0) (i64.const 0))
  (i64.store offset=144 (get_local 0) (i64.const 0))
  (i64.store offset=152 (get_local 0) (i64.const 0))
  (i64.store offset=160 (get_local 0) (i64.const 0))
  (i64.store offset=168 (get_local 0) (i64.const 0))
  (i64.store offset=176 (get_local 0) (i64.const 0))
  (i64.store offset=184 (get_local 0) (i64.const 0))
  (i64.store offset=192 (get_local 0) (i64.const 0))
  (i64.store offset=200 (get_local 0) (i64.const 0))
  (i64.store offset=208 (get_local 0) (i64.const 0))
  (i64.store offset=216 (get_local 0) (i64.const 0))
  (i64.store offset=224 (get_local 0) (i64.const 0))
  (i64.store offset=232 (get_local 0) (i64.const 0))
  (i64.store offset=240 (get_local 0) (i64.const 0))
  (i64.store offset=248 (get_local 0) (i64.const 0))
  (i64.store offset=256 (get_local 0) (i64.const 0))
  (i64.store offset=264 (get_local 0) (i64.const 0))
  (i64.store offset=272 (get_local 0) (i64.const 0))
  (i64.store offset=280 (get_local 0) (i64.const 0))
  (i64.store offset=288 (get_local 0) (i64.const 0))
  (i64.store offset=296 (get_local 0) (i64.const 0))
  (i64.store offset=304 (get_local 0) (i64.const 0))
  (i64.store offset=312 (get_local 0) (i64.const 0))
  (i64.store offset=320 (get_local 0) (i64.const 0))
  (i64.store offset=328 (get_local 0) (i64.const 0))
  (i64.store offset=336 (get_local 0) (i64.const 0))
  (i64.store offset=344 (get_local 0) (i64.const 0))
  (i64.store offset=352 (get_local 0) (i64.const 0))
  (i64.store offset=360 (get_local 0) (i64.const 0))
  (i64.store offset=368 (get_local 0) (i64.const 0))
  (i64.store offset=376 (get_local 0) (i64.const 0))
  (i64.store offset=384 (get_local 0) (i64.const 0))
  (i64.store offset=392 (get_local 0) (i64.const 0))
  (i64.store offset=400 (get_local 0) (i64.const 0))
  (i64.store offset=408 (get_local 0) (i64.const 0))
  (i64.store offset=416 (get_local 0) (i64.const 0))
  (i64.store offset=424 (get_local 0) (i64.const 0))
  (i64.store offset=432 (get_local 0) (i64.const 0))
  (i64.store offset=440 (get_local 0) (i64.const 0))
  (i64.store offset=448 (get_local 0) (i64.const 0))
  (i64.store offset=456 (get_local 0) (i64.const 0))
  (i64.store offset=464 (get_local 0) (i64.const 0))
  (i64.store offset=472 (get_local 0) (i64.const 0))
  (i64.store offset=480 (get_local 0) (i64.const 0))
  (i64.store offset=488 (get_local 0) (i64.const 0))
  (i64.store offset=496 (get_local 0) (i64.const 0))
  (i64.store offset=504 (get_local 0) (i64.const 0))
  (i64.store offset=512 (get_local 0) (i64.const 0))
  (i64.store offset=520 (get_local 0) (i64.const 0))
  (i64.store offset=528 (get_local 0) (i64.const 0))
  (i64.store offset=536 (get_local 0) (i64.const 0))
  (i64.store offset=544 (get_local 0) (i64.const 0))
  (i64.store offset=552 (get_local 0) (i64.const 0))
  (i64.store offset=560 (get_local 0) (i64.const 0))
  (i64.store offset=568 (get_local 0) (i64.const 0))
  (i64.store offset=576 (get_local 0) (i64.const 0))
  (i64.store offset=584 (get_local 0) (i64.const 0))
  (i64.store offset=592 (get_local 0) (i64.const 0))
  (i64.store offset=600 (get_local 0) (i64.const 0))
  (i64.store offset=608 (get_local 0) (i64.const 0))
  (i64.store offset=616 (get_local 0) (i64.const 0))
  (i64.store offset=624 (get_local 0) (i64.const 0))
  (i64.store offset=632 (get_local 0) (i64.const 0))
  (i64.store offset=640 (get_local 0) (i64.const 0))
  (i64.store offset=648 (get_local 0) (i64.const 0))
  (i64.store offset=656 (get_local 0) (i64.const 0))
  (i64.store offset=664 (get_local 0) (i64.const 0))
  (i64.store offset=672 (get_local 0) (i64.const 0))
  (i64.store offset=680 (get_local 0) (i64.const 0))
  (i64.store offset=688 (get_local 0) (i64.const 0))
  (i64.store offset=696 (get_local 0) (i64.const 0))
  (i64.store offset=704 (get_local 0) (i64.const 0))
  (i64.store offset=712 (get_local 0) (i64.const 0))
  (i64.store offset=720 (get_local 0) (i64.const 0))
  (i64.store offset=728 (get_local 0) (i64.const 0))
  (i64.store offset=736 (get_local 0) (i64.const 0))
  (i64.store offset=744 (get_local 0) (i64.const 0))
  (i64.store offset=752 (get_local 0) (i64.const 0))
  (i64.store offset=760 (get_local 0) (i64.const 0))
  (i64.store offset=768 (get_local 0) (i64.const 0))
  (i64.store offset=776 (get_local 0) (i64.const 0))
  (i64.store offset=784 (get_local 0) (i64.const 0))
  (i64.store offset=792 (get_local 0) (i64.const 0))
  (i64.store offset=800 (get_local 0) (i64.const 0))
  (i64.store offset=808 (get_local 0) (i64.const 0))
  (i64.store offset=816 (get_local 0) (i64.const 0))
  (i64.store offset=824 (get_local 0) (i64.const 0))
  (i64.store offset=832 (get_local 0) (i64.const 0))
  (i64.store offset=840 (get_local 0) (i64.const 0))
  (i64.store offset=848 (get_local 0) (i64.const 0))
  (i64.store offset=856 (get_local 0) (i64.const 0))
  (i64.store offset=864 (get_local 0) (i64.const 0))
  (i64.store offset=872 (get_local 0) (i64.const 0))
  (i64.store offset=880 (get_local 0) (i64.const 0))
  (i64.store offset=888 (get_local 0) (i64.const 0))
  (i64.store offset=896 (get_local 0) (i64.const 0))
  (i64.store offset=904 (get_local 0) (i64.const 0))
  (i64.store offset=912 (get_local 0) (i64.const 0))
  (i64.store offset=920 (get_local 0) (i64.const 0))
  (i64.store offset=928 (get_local 0) (i64.const 0))
  (i64.store offset=936 (get_local 0) (i64.const 0))
  (i64.store offset=944 (get_local 0) (i64.const 0))
  (i64.store offset=952 (get_local 0) (i64.const 0))
  (i64.store offset=960 (get_local 0) (i64.const 0))
  (i64.store offset=968 (get_local 0) (i64.const 0))
  (i64.store offset=976 (get_local 0) (i64.const 0))
  (i64.store offset=984 (get_local 0) (i64.const 0))
  (i64.store offset=992 (get_local 0) (i64.const 0))
  (i64.store offset=1000 (get_local 0) (i64.const 0))
  (i64.store offset=1008 (get_local 0) (i64.const 0))
  (i64.store offset=1016 (get_local 0) (i64.const 0))
  (i64.store offset=1024 (get_local 0) (i64.const 0))
  (i64.store offset=1032 (get_local 0) (i64.const 0))
  (i64.store offset=1040 (get_local 0) (i64.const 0))
  (i64.store offset=1048 (get_local 0) (i64.const 0))
  (i64.store offset=1056 (get_local 0) (i64.const 0))
  (i64.store offset=1064 (get_local 0) (i64.const 0))
  (i64.store offset=1072 (get_local 0) (i64.const 0))
  (i64.store offset=1080 (get_local 0) (i64.const 0))
  (i64.store offset=1088 (get_local 0) (i64.const 0))
  (i64.store offset=1096 (get_local 0) (i64.const 0))
  (i64.store offset=1104 (get_local 0) (i64.const 0))
  (i64.store offset=1112 (get_local 0) (i64.const 0))
  (i64.store offset=1120 (get_local 0) (i64.const 0))
  (i64.store offset=1128 (get_local 0) (i64.const 0))
  (i64.store offset=1136 (get_local 0) (i64.const 0))
  (i64.store offset=1144 (get_local 0) (i64.const 0))
  (i64.store offset=1152 (get_local 0) (i64.const 0))
  (i64.store offset=1160 (get_local 0) (i64.const 0))
  (i64.store offset=1168 (get_local 0) (i64.const 0))
  (i64.store offset=1176 (get_local 0) (i64.const 0))
  (i64.store offset=1184 (get_local 0) (i64.const 0))
  (i64.store offset=1192 (get_local 0) (i64.const 0))
  (i64.store offset=1200 (get_local 0) (i64.const 0))
  (i64.store offset=1208 (get_local 0) (i64.const 0))
  (i64.store offset=1216 (get_local 0) (i64.const 0))
  (i64.store offset=1224 (get_local 0) (i64.const 0))
  (i64.store offset=1232 (get_local 0) (i64.const 0))
  (i64.store offset=1240 (get_local 0) (i64.const 0))
  (i64.store offset=1248 (get_local 0) (i64.const 0))
  (i64.store offset=1256 (get_local 0) (i64.const 0))
  (i64.store offset=1264 (get_local 0) (i64.const 0))
  (i64.store offset=1272 (get_local 0) (i64.const 0))
  (i64.store offset=1280 (get_local 0) (i64.const 0))
  (i64.store offset=1288 (get_local 0) (i64.const 0))
  (i64.store offset=1296 (get_local 0) (i64.const 0))
  (i64.store offset=1304 (get_local 0) (i64.const 0))
  (i64.store offset=1312 (get_local 0) (i64.const 0))
  (i64.store offset=1320 (get_local 0) (i64.const 0))
  (i64.store offset=1328 (get_local 0) (i64.const 0))
  (i64.store offset=1336 (get_local 0) (i64.const 0))
  (i64.store offset=1344 (get_local 0) (i64.const 0))
  (i64.store offset=1352 (get_local 0) (i64.const 0))
  (i64.store offset=1360 (get_local 0) (i64.const 0))
  (i64.store offset=1368 (get_local 0) (i64.const 0))
  (i64.store offset=1376 (get_local 0) (i64.const 0))
  (i64.store offset=1384 (get_local 0) (i64.const 0))
  (i64.store offset=1392 (get_local 0) (i64.const 0))
  (i64.store offset=1400 (get_local 0) (i64.const 0))
  (i64.store offset=1408 (get_local 0) (i64.const 0))
  (i64.store offset=1416 (get_local 0) (i64.const 0))
  (i64.store offset=1424 (get_local 0) (i64.const 0))
  (i64.store offset=1432 (get_local 0) (i64.const 0))
  (i64.store offset=1440 (get_local 0) (i64.const 0))
  (i64.store offset=1448 (get_local 0) (i64.const 0))
  (i64.store offset=1456 (get_local 0) (i64.const 0))
  (i64.store offset=1464 (get_local 0) (i64.const 0))
  (i64.store offset=1472 (get_local 0) (i64.const 0))
  (i64.store offset=1480 (get_local 0) (i64.const 0))
  (i64.store offset=1488 (get_local 0) (i64.const 0))
  (i64.store offset=1496 (get_local 0) (i64.const 0))
  (i64.store offset=1504 (get_local 0) (i64.const 0))
  (i64.store offset=1512 (get_local 0) (i64.const 0))
  (i64.store offset=1520 (get_local 0) (i64.const 0))
  (i64.store offset=1528 (get_local 0) (i64.const 0))
  (i64.store offset=1536 (get_local 0) (i64.const 0))
  (i64.store offset=1544 (get_local 0) (i64.const 0))
  (i64.store offset=1552 (get_local 0) (i64.const 0))
  (i64.store offset=1560 (get_local 0) (i64.const 0))
  (i64.store offset=1568 (get_local 0) (i64.const 0))
  (i64.store offset=1576 (get_local 0) (i64.const 0))
  (i64.store offset=1584 (get_local 0) (i64.const 0))
  (i64.store offset=1592 (get_local 0) (i64.const 0))
  (i64.store offset=1600 (get_local 0) (i64.const 0))
  (i64.store offset=1608 (get_local 0) (i64.const 0))
  (i64.store offset=1616 (get_local 0) (i64.const 0))
  (i64.store offset=1624 (get_local 0) (i64.const 0))
  (i64.store offset=1632 (get_local 0) (i64.const 0))
  (i64.store offset=1640 (get_local 0) (i64.const 0))
  (i64.store offset=1648 (get_local 0) (i64.const 0))
  (i64.store offset=1656 (get_local 0) (i64.const 0))
  (i64.store offset=1664 (get_local 0) (i64.const 0))
  (i64.store offset=1672 (get_local 0) (i64.const 0))
  (i64.store offset=1680 (get_local 0) (i64.const 0))
  (i64.store offset=1688 (get_local 0) (i64.const 0))
  (i64.store offset=1696 (get_local 0) (i64.const 0))
  (i64.store offset=1704 (get_local 0) (i64.const 0))
  (i64.store offset=1712 (get_local 0) (i64.const 0))
  (i64.store offset=1720 (get_local 0) (i64.const 0))
  (i64.store offset=1728 (get_local 0) (i64.const 0))
  (i64.store offset=1736 (get_local 0) (i64.const 0))
  (i64.store offset=1744 (get_local 0) (i64.const 0))
  (i64.store offset=1752 (get_local 0) (i64.const 0))
  (i64.store offset=1760 (get_local 0) (i64.const 0))
  (i64.store offset=1768 (get_local 0) (i64.const 0))
  (i64.store offset=1776 (get_local 0) (i64.const 0))
  (i64.store offset=1784 (get_local 0) (i64.const 0))
  (i64.store offset=1792 (get_local 0) (i64.const 0))
  (i64.store offset=1800 (get_local 0) (i64.const 0))
  (i64.store offset=1808 (get_local 0) (i64.const 0))
  (i64.store offset=1816 (get_local 0) (i64.const 0))
  (i64.store offset=1824 (get_local 0) (i64.const 0))
  (i64.store offset=1832 (get_local 0) (i64.const 0))
  (i64.store offset=1840 (get_local 0) (i64.const 0))
  (i64.store offset=1848 (get_local 0) (i64.const 0))
  (i64.store offset=1856 (get_local 0) (i64.const 0))
  (i64.store offset=1864 (get_local 0) (i64.const 0))
  (i64.store offset=1872 (get_local 0) (i64.const 0))
  (i64.store offset=1880 (get_local 0) (i64.const 0))
  (i64.store offset=1888 (get_local 0) (i64.const 0))
  (i64.store offset=1896 (get_local 0) (i64.const 0))
  (i64.store offset=1904 (get_local 0) (i64.const 0))
  (i64.store offset=1912 (get_local 0) (i64.const 0))
  (i64.store offset=1920 (get_local 0) (i64.const 0))
  (i64.store offset=1928 (get_local 0) (i64.const 0))
  (i64.store offset=1936 (get_local 0) (i64.const 0))
  (i64.store offset=1944 (get_local 0) (i64.const 0))
  (i64.store offset=1952 (get_local 0) (i64.const 0))
  (i64.store offset=1960 (get_local 0) (i64.const 0))
  (i64.store offset=1968 (get_local 0) (i64.const 0))
  (i64.store offset=1976 (get_local 0) (i64.const 0))
  (i64.store offset=1984 (get_local 0) (i64.const 0))
  (i64.store offset=1992 (get_local 0) (i64.const 0))
  (i64.store offset=2000 (get_local 0) (i64.const 0))
  (i64.store offset=2008 (get_local 0) (i64.const 0))
  (i64.store offset=2016 (get_local 0) (i64.const 0))
  (i64.store offset=2024 (get_local 0) (i64.const 0))
  (i64.store offset=2032 (get_local 0) (i64.const 0))
  (i64.store offset=2040 (get_local 0) (i64.const 0))
  (i32.store offset=2048 (get_local 0) (i32.const 0))
  (i32.store offset=2052 (get_local 0) (get_local 1))
  (i32.store offset=2056 (get_local 0)
   (i32.div_u (i32.const 63480) (get_local 1))))
 (func $gc--append-heap-page (param i32 i32 i32) (local i32 i32 i32)
  (set_local 3
   (i32.mul (i32.const 4)
    (if i32
        (i32.le_u (get_local 2) (i32.const 128))
        (if i32
            (i32.le_u (get_local 2) (i32.const 8))
            (if i32
                (i32.le_u (get_local 2) (i32.const 4))
                (i32.const 0)
                (i32.const 1))
            (if i32
                (i32.le_u (get_local 2) (i32.const 32))
                (if i32
                    (i32.le_u (get_local 2) (i32.const 16))
                    (i32.const 2)
                    (i32.const 3))
                (if i32
                    (i32.le_u (get_local 2) (i32.const 64))
                    (i32.const 4)
                    (i32.const 5))))
        (if i32
            (i32.le_u (get_local 2) (i32.const 1024))
            (if i32
                (i32.le_u (get_local 2) (i32.const 512))
                (if i32
                    (i32.le_u (get_local 2) (i32.const 256))
                    (i32.const 6)
                    (i32.const 7))
                (i32.const 8))
            (if i32
                (i32.le_u (get_local 2) (i32.const 2048))
                (i32.const 9)
                (if i32
                    (i32.le_u (get_local 2) (i32.const 4096))
                    (i32.const 10)
                    (unreachable)))))))
  (set_local 4 (i32.load offset=0 (i32.add (get_local 0) (get_local 3))))
  (if (i32.eqz (get_local 4))
      (i32.store offset=0 (i32.add (get_local 0) (get_local 3)) (get_local 1))
      (loop $loop (set_local 5
                   (i32.load offset=2048 (get_local 4))) (if (i32.eqz
                                                              (get_local 5))
                                                             (block
                                                                 (i32.store
                                                                  offset=2048
                                                                  (get_local 4)
                                                                  (get_local
                                                                   1))
                                                               (return))
                                                             (set_local 4
                                                              (get_local
                                                               5))) (br
                                                                     $loop))))
 (func $gc-extend-heap-page (param i32 i32) (local i32)
  (set_local 2 (call $new-heap-page))
  (call $init-heap-page (get_local 2) (get_local 1))
  (call $gc--append-heap-page (get_local 0) (get_local 2) (get_local 1)))
 (func $gc--alloc-page (param i32 i32) (result i32) (local i64 i32 i32 i32)
  (block $outer
    (loop $loop (if (i32.le_u (i32.const 256) (get_local 3))
                    (br $outer)) (set_local 2
                                  (i64.load offset=0
                                   (i32.add (get_local 0)
                                    (get_local 3)))) (if (i64.eq (i64.const -1)
                                                          (get_local 2))
                                                         (br $loop)) (set_local
                                                                      4
                                                                      (i32.wrap/i64
                                                                       (i64.ctz
                                                                        (i64.sub
                                                                         (i64.const
                                                                          -1)
                                                                         (get_local
                                                                          2))))) (set_local
                                                                                  5
                                                                                  (i32.add
                                                                                   (i32.mul
                                                                                    (get_local
                                                                                     3)
                                                                                    (i32.const
                                                                                     64))
                                                                                   (get_local
                                                                                    4))) (if (i32.le_u
                                                                                              (i32.load
                                                                                               offset=2056
                                                                                               (get_local
                                                                                                0))
                                                                                              (get_local
                                                                                               5))
                                                                                             (return
                                                                                              (i32.const
                                                                                               0))
                                                                                             (block
                                                                                                 (i64.store
                                                                                                  offset=0
                                                                                                  (i32.add
                                                                                                   (get_local
                                                                                                    0)
                                                                                                   (get_local
                                                                                                    3))
                                                                                                  (i64.or
                                                                                                   (get_local
                                                                                                    2)
                                                                                                   (i64.shl
                                                                                                    (i64.const
                                                                                                     1)
                                                                                                    (i64.extend_u/i32
                                                                                                     (get_local
                                                                                                      4)))))
                                                                                               (return
                                                                                                (i32.add
                                                                                                 (i32.add
                                                                                                  (get_local
                                                                                                   0)
                                                                                                  (i32.const
                                                                                                   2060))
                                                                                                 (i32.mul
                                                                                                  (get_local
                                                                                                   5)
                                                                                                  (get_local
                                                                                                   1)))))) (br
                                                                                                            $loop)))
  (i32.const 0))
 (func $gc--alloc-pages (param i32 i32) (result i32) (local i32)
  (loop $loop (if (i32.eqz (get_local 0))
                  (return (i32.const 0))) (if (i32.eqz
                                               (tee_local 2
                                                (call $gc--alloc-page
                                                 (get_local 0) (get_local 1))))
                                              (set_local 2
                                               (i32.load offset=2048
                                                (get_local 0)))
                                              (return (get_local 2))) (br
                                                                       $loop))
  (unreachable))
 (func $gc--alloc (param i32 i32) (result i32) (local i32 i32)
  (set_local 3
   (if i32
       (i32.le_u (get_local 1) (i32.const 128))
       (if i32
           (i32.le_u (get_local 1) (i32.const 8))
           (if i32
               (i32.le_u (get_local 1) (i32.const 4))
               (i32.const 0)
               (i32.const 1))
           (if i32
               (i32.le_u (get_local 1) (i32.const 32))
               (if i32
                   (i32.le_u (get_local 1) (i32.const 16))
                   (i32.const 2)
                   (i32.const 3))
               (if i32
                   (i32.le_u (get_local 1) (i32.const 64))
                   (i32.const 4)
                   (i32.const 5))))
       (if i32
           (i32.le_u (get_local 1) (i32.const 1024))
           (if i32
               (i32.le_u (get_local 1) (i32.const 512))
               (if i32
                   (i32.le_u (get_local 1) (i32.const 256))
                   (i32.const 6)
                   (i32.const 7))
               (i32.const 8))
           (if i32
               (i32.le_u (get_local 1) (i32.const 2048))
               (i32.const 9)
               (if i32
                   (i32.le_u (get_local 1) (i32.const 4096))
                   (i32.const 10)
                   (unreachable))))))
  (set_local 2 (i32.load offset=0 (i32.add (get_local 0) (get_local 3))))
  (call $gc--alloc-pages (get_local 2) (get_local 1)))
 (func $gc-alloc (param i32 i32) (result i32) (local i32 i32)
  (if (i32.eqz (tee_local 3 (call $gc--alloc (get_local 0) (get_local 1))))
      (block (call $gc-run (get_local 0))
        (if (i32.eqz
             (tee_local 3 (call $gc--alloc (get_local 0) (get_local 1))))
            (block (set_local 2 (get_local 1))
              (call $gc-extend-heap-page (get_local 0) (get_local 2))
              (if (i32.eqz
                   (tee_local 3 (call $gc--alloc (get_local 0) (get_local 1))))
                  (unreachable))))))
  (get_local 3))
 (func $gc-save-state (param i32) (result i32)
  (i32.load offset=44 (get_local 0)))
 (func $gc-protect (param i32 i32) (local i32)
  (set_local 2 (i32.load offset=44 (get_local 0)))
  (i32.store offset=52 (i32.add (get_local 0) (get_local 2)) (get_local 1))
  (i32.store offset=44 (get_local 0) (i32.add (i32.const 4) (get_local 2))))
 (func $gc-restore-state (param i32 i32)
  (i32.store offset=44 (get_local 0) (get_local 1)))
 (func $gc--clear-marks-page (param i32)
  (i64.store offset=0 (get_local 0) (i64.const 0))
  (i64.store offset=8 (get_local 0) (i64.const 0))
  (i64.store offset=16 (get_local 0) (i64.const 0))
  (i64.store offset=24 (get_local 0) (i64.const 0))
  (i64.store offset=32 (get_local 0) (i64.const 0))
  (i64.store offset=40 (get_local 0) (i64.const 0))
  (i64.store offset=48 (get_local 0) (i64.const 0))
  (i64.store offset=56 (get_local 0) (i64.const 0))
  (i64.store offset=64 (get_local 0) (i64.const 0))
  (i64.store offset=72 (get_local 0) (i64.const 0))
  (i64.store offset=80 (get_local 0) (i64.const 0))
  (i64.store offset=88 (get_local 0) (i64.const 0))
  (i64.store offset=96 (get_local 0) (i64.const 0))
  (i64.store offset=104 (get_local 0) (i64.const 0))
  (i64.store offset=112 (get_local 0) (i64.const 0))
  (i64.store offset=120 (get_local 0) (i64.const 0))
  (i64.store offset=128 (get_local 0) (i64.const 0))
  (i64.store offset=136 (get_local 0) (i64.const 0))
  (i64.store offset=144 (get_local 0) (i64.const 0))
  (i64.store offset=152 (get_local 0) (i64.const 0))
  (i64.store offset=160 (get_local 0) (i64.const 0))
  (i64.store offset=168 (get_local 0) (i64.const 0))
  (i64.store offset=176 (get_local 0) (i64.const 0))
  (i64.store offset=184 (get_local 0) (i64.const 0))
  (i64.store offset=192 (get_local 0) (i64.const 0))
  (i64.store offset=200 (get_local 0) (i64.const 0))
  (i64.store offset=208 (get_local 0) (i64.const 0))
  (i64.store offset=216 (get_local 0) (i64.const 0))
  (i64.store offset=224 (get_local 0) (i64.const 0))
  (i64.store offset=232 (get_local 0) (i64.const 0))
  (i64.store offset=240 (get_local 0) (i64.const 0))
  (i64.store offset=248 (get_local 0) (i64.const 0))
  (i64.store offset=256 (get_local 0) (i64.const 0))
  (i64.store offset=264 (get_local 0) (i64.const 0))
  (i64.store offset=272 (get_local 0) (i64.const 0))
  (i64.store offset=280 (get_local 0) (i64.const 0))
  (i64.store offset=288 (get_local 0) (i64.const 0))
  (i64.store offset=296 (get_local 0) (i64.const 0))
  (i64.store offset=304 (get_local 0) (i64.const 0))
  (i64.store offset=312 (get_local 0) (i64.const 0))
  (i64.store offset=320 (get_local 0) (i64.const 0))
  (i64.store offset=328 (get_local 0) (i64.const 0))
  (i64.store offset=336 (get_local 0) (i64.const 0))
  (i64.store offset=344 (get_local 0) (i64.const 0))
  (i64.store offset=352 (get_local 0) (i64.const 0))
  (i64.store offset=360 (get_local 0) (i64.const 0))
  (i64.store offset=368 (get_local 0) (i64.const 0))
  (i64.store offset=376 (get_local 0) (i64.const 0))
  (i64.store offset=384 (get_local 0) (i64.const 0))
  (i64.store offset=392 (get_local 0) (i64.const 0))
  (i64.store offset=400 (get_local 0) (i64.const 0))
  (i64.store offset=408 (get_local 0) (i64.const 0))
  (i64.store offset=416 (get_local 0) (i64.const 0))
  (i64.store offset=424 (get_local 0) (i64.const 0))
  (i64.store offset=432 (get_local 0) (i64.const 0))
  (i64.store offset=440 (get_local 0) (i64.const 0))
  (i64.store offset=448 (get_local 0) (i64.const 0))
  (i64.store offset=456 (get_local 0) (i64.const 0))
  (i64.store offset=464 (get_local 0) (i64.const 0))
  (i64.store offset=472 (get_local 0) (i64.const 0))
  (i64.store offset=480 (get_local 0) (i64.const 0))
  (i64.store offset=488 (get_local 0) (i64.const 0))
  (i64.store offset=496 (get_local 0) (i64.const 0))
  (i64.store offset=504 (get_local 0) (i64.const 0))
  (i64.store offset=512 (get_local 0) (i64.const 0))
  (i64.store offset=520 (get_local 0) (i64.const 0))
  (i64.store offset=528 (get_local 0) (i64.const 0))
  (i64.store offset=536 (get_local 0) (i64.const 0))
  (i64.store offset=544 (get_local 0) (i64.const 0))
  (i64.store offset=552 (get_local 0) (i64.const 0))
  (i64.store offset=560 (get_local 0) (i64.const 0))
  (i64.store offset=568 (get_local 0) (i64.const 0))
  (i64.store offset=576 (get_local 0) (i64.const 0))
  (i64.store offset=584 (get_local 0) (i64.const 0))
  (i64.store offset=592 (get_local 0) (i64.const 0))
  (i64.store offset=600 (get_local 0) (i64.const 0))
  (i64.store offset=608 (get_local 0) (i64.const 0))
  (i64.store offset=616 (get_local 0) (i64.const 0))
  (i64.store offset=624 (get_local 0) (i64.const 0))
  (i64.store offset=632 (get_local 0) (i64.const 0))
  (i64.store offset=640 (get_local 0) (i64.const 0))
  (i64.store offset=648 (get_local 0) (i64.const 0))
  (i64.store offset=656 (get_local 0) (i64.const 0))
  (i64.store offset=664 (get_local 0) (i64.const 0))
  (i64.store offset=672 (get_local 0) (i64.const 0))
  (i64.store offset=680 (get_local 0) (i64.const 0))
  (i64.store offset=688 (get_local 0) (i64.const 0))
  (i64.store offset=696 (get_local 0) (i64.const 0))
  (i64.store offset=704 (get_local 0) (i64.const 0))
  (i64.store offset=712 (get_local 0) (i64.const 0))
  (i64.store offset=720 (get_local 0) (i64.const 0))
  (i64.store offset=728 (get_local 0) (i64.const 0))
  (i64.store offset=736 (get_local 0) (i64.const 0))
  (i64.store offset=744 (get_local 0) (i64.const 0))
  (i64.store offset=752 (get_local 0) (i64.const 0))
  (i64.store offset=760 (get_local 0) (i64.const 0))
  (i64.store offset=768 (get_local 0) (i64.const 0))
  (i64.store offset=776 (get_local 0) (i64.const 0))
  (i64.store offset=784 (get_local 0) (i64.const 0))
  (i64.store offset=792 (get_local 0) (i64.const 0))
  (i64.store offset=800 (get_local 0) (i64.const 0))
  (i64.store offset=808 (get_local 0) (i64.const 0))
  (i64.store offset=816 (get_local 0) (i64.const 0))
  (i64.store offset=824 (get_local 0) (i64.const 0))
  (i64.store offset=832 (get_local 0) (i64.const 0))
  (i64.store offset=840 (get_local 0) (i64.const 0))
  (i64.store offset=848 (get_local 0) (i64.const 0))
  (i64.store offset=856 (get_local 0) (i64.const 0))
  (i64.store offset=864 (get_local 0) (i64.const 0))
  (i64.store offset=872 (get_local 0) (i64.const 0))
  (i64.store offset=880 (get_local 0) (i64.const 0))
  (i64.store offset=888 (get_local 0) (i64.const 0))
  (i64.store offset=896 (get_local 0) (i64.const 0))
  (i64.store offset=904 (get_local 0) (i64.const 0))
  (i64.store offset=912 (get_local 0) (i64.const 0))
  (i64.store offset=920 (get_local 0) (i64.const 0))
  (i64.store offset=928 (get_local 0) (i64.const 0))
  (i64.store offset=936 (get_local 0) (i64.const 0))
  (i64.store offset=944 (get_local 0) (i64.const 0))
  (i64.store offset=952 (get_local 0) (i64.const 0))
  (i64.store offset=960 (get_local 0) (i64.const 0))
  (i64.store offset=968 (get_local 0) (i64.const 0))
  (i64.store offset=976 (get_local 0) (i64.const 0))
  (i64.store offset=984 (get_local 0) (i64.const 0))
  (i64.store offset=992 (get_local 0) (i64.const 0))
  (i64.store offset=1000 (get_local 0) (i64.const 0))
  (i64.store offset=1008 (get_local 0) (i64.const 0))
  (i64.store offset=1016 (get_local 0) (i64.const 0))
  (i64.store offset=1024 (get_local 0) (i64.const 0))
  (i64.store offset=1032 (get_local 0) (i64.const 0))
  (i64.store offset=1040 (get_local 0) (i64.const 0))
  (i64.store offset=1048 (get_local 0) (i64.const 0))
  (i64.store offset=1056 (get_local 0) (i64.const 0))
  (i64.store offset=1064 (get_local 0) (i64.const 0))
  (i64.store offset=1072 (get_local 0) (i64.const 0))
  (i64.store offset=1080 (get_local 0) (i64.const 0))
  (i64.store offset=1088 (get_local 0) (i64.const 0))
  (i64.store offset=1096 (get_local 0) (i64.const 0))
  (i64.store offset=1104 (get_local 0) (i64.const 0))
  (i64.store offset=1112 (get_local 0) (i64.const 0))
  (i64.store offset=1120 (get_local 0) (i64.const 0))
  (i64.store offset=1128 (get_local 0) (i64.const 0))
  (i64.store offset=1136 (get_local 0) (i64.const 0))
  (i64.store offset=1144 (get_local 0) (i64.const 0))
  (i64.store offset=1152 (get_local 0) (i64.const 0))
  (i64.store offset=1160 (get_local 0) (i64.const 0))
  (i64.store offset=1168 (get_local 0) (i64.const 0))
  (i64.store offset=1176 (get_local 0) (i64.const 0))
  (i64.store offset=1184 (get_local 0) (i64.const 0))
  (i64.store offset=1192 (get_local 0) (i64.const 0))
  (i64.store offset=1200 (get_local 0) (i64.const 0))
  (i64.store offset=1208 (get_local 0) (i64.const 0))
  (i64.store offset=1216 (get_local 0) (i64.const 0))
  (i64.store offset=1224 (get_local 0) (i64.const 0))
  (i64.store offset=1232 (get_local 0) (i64.const 0))
  (i64.store offset=1240 (get_local 0) (i64.const 0))
  (i64.store offset=1248 (get_local 0) (i64.const 0))
  (i64.store offset=1256 (get_local 0) (i64.const 0))
  (i64.store offset=1264 (get_local 0) (i64.const 0))
  (i64.store offset=1272 (get_local 0) (i64.const 0))
  (i64.store offset=1280 (get_local 0) (i64.const 0))
  (i64.store offset=1288 (get_local 0) (i64.const 0))
  (i64.store offset=1296 (get_local 0) (i64.const 0))
  (i64.store offset=1304 (get_local 0) (i64.const 0))
  (i64.store offset=1312 (get_local 0) (i64.const 0))
  (i64.store offset=1320 (get_local 0) (i64.const 0))
  (i64.store offset=1328 (get_local 0) (i64.const 0))
  (i64.store offset=1336 (get_local 0) (i64.const 0))
  (i64.store offset=1344 (get_local 0) (i64.const 0))
  (i64.store offset=1352 (get_local 0) (i64.const 0))
  (i64.store offset=1360 (get_local 0) (i64.const 0))
  (i64.store offset=1368 (get_local 0) (i64.const 0))
  (i64.store offset=1376 (get_local 0) (i64.const 0))
  (i64.store offset=1384 (get_local 0) (i64.const 0))
  (i64.store offset=1392 (get_local 0) (i64.const 0))
  (i64.store offset=1400 (get_local 0) (i64.const 0))
  (i64.store offset=1408 (get_local 0) (i64.const 0))
  (i64.store offset=1416 (get_local 0) (i64.const 0))
  (i64.store offset=1424 (get_local 0) (i64.const 0))
  (i64.store offset=1432 (get_local 0) (i64.const 0))
  (i64.store offset=1440 (get_local 0) (i64.const 0))
  (i64.store offset=1448 (get_local 0) (i64.const 0))
  (i64.store offset=1456 (get_local 0) (i64.const 0))
  (i64.store offset=1464 (get_local 0) (i64.const 0))
  (i64.store offset=1472 (get_local 0) (i64.const 0))
  (i64.store offset=1480 (get_local 0) (i64.const 0))
  (i64.store offset=1488 (get_local 0) (i64.const 0))
  (i64.store offset=1496 (get_local 0) (i64.const 0))
  (i64.store offset=1504 (get_local 0) (i64.const 0))
  (i64.store offset=1512 (get_local 0) (i64.const 0))
  (i64.store offset=1520 (get_local 0) (i64.const 0))
  (i64.store offset=1528 (get_local 0) (i64.const 0))
  (i64.store offset=1536 (get_local 0) (i64.const 0))
  (i64.store offset=1544 (get_local 0) (i64.const 0))
  (i64.store offset=1552 (get_local 0) (i64.const 0))
  (i64.store offset=1560 (get_local 0) (i64.const 0))
  (i64.store offset=1568 (get_local 0) (i64.const 0))
  (i64.store offset=1576 (get_local 0) (i64.const 0))
  (i64.store offset=1584 (get_local 0) (i64.const 0))
  (i64.store offset=1592 (get_local 0) (i64.const 0))
  (i64.store offset=1600 (get_local 0) (i64.const 0))
  (i64.store offset=1608 (get_local 0) (i64.const 0))
  (i64.store offset=1616 (get_local 0) (i64.const 0))
  (i64.store offset=1624 (get_local 0) (i64.const 0))
  (i64.store offset=1632 (get_local 0) (i64.const 0))
  (i64.store offset=1640 (get_local 0) (i64.const 0))
  (i64.store offset=1648 (get_local 0) (i64.const 0))
  (i64.store offset=1656 (get_local 0) (i64.const 0))
  (i64.store offset=1664 (get_local 0) (i64.const 0))
  (i64.store offset=1672 (get_local 0) (i64.const 0))
  (i64.store offset=1680 (get_local 0) (i64.const 0))
  (i64.store offset=1688 (get_local 0) (i64.const 0))
  (i64.store offset=1696 (get_local 0) (i64.const 0))
  (i64.store offset=1704 (get_local 0) (i64.const 0))
  (i64.store offset=1712 (get_local 0) (i64.const 0))
  (i64.store offset=1720 (get_local 0) (i64.const 0))
  (i64.store offset=1728 (get_local 0) (i64.const 0))
  (i64.store offset=1736 (get_local 0) (i64.const 0))
  (i64.store offset=1744 (get_local 0) (i64.const 0))
  (i64.store offset=1752 (get_local 0) (i64.const 0))
  (i64.store offset=1760 (get_local 0) (i64.const 0))
  (i64.store offset=1768 (get_local 0) (i64.const 0))
  (i64.store offset=1776 (get_local 0) (i64.const 0))
  (i64.store offset=1784 (get_local 0) (i64.const 0))
  (i64.store offset=1792 (get_local 0) (i64.const 0))
  (i64.store offset=1800 (get_local 0) (i64.const 0))
  (i64.store offset=1808 (get_local 0) (i64.const 0))
  (i64.store offset=1816 (get_local 0) (i64.const 0))
  (i64.store offset=1824 (get_local 0) (i64.const 0))
  (i64.store offset=1832 (get_local 0) (i64.const 0))
  (i64.store offset=1840 (get_local 0) (i64.const 0))
  (i64.store offset=1848 (get_local 0) (i64.const 0))
  (i64.store offset=1856 (get_local 0) (i64.const 0))
  (i64.store offset=1864 (get_local 0) (i64.const 0))
  (i64.store offset=1872 (get_local 0) (i64.const 0))
  (i64.store offset=1880 (get_local 0) (i64.const 0))
  (i64.store offset=1888 (get_local 0) (i64.const 0))
  (i64.store offset=1896 (get_local 0) (i64.const 0))
  (i64.store offset=1904 (get_local 0) (i64.const 0))
  (i64.store offset=1912 (get_local 0) (i64.const 0))
  (i64.store offset=1920 (get_local 0) (i64.const 0))
  (i64.store offset=1928 (get_local 0) (i64.const 0))
  (i64.store offset=1936 (get_local 0) (i64.const 0))
  (i64.store offset=1944 (get_local 0) (i64.const 0))
  (i64.store offset=1952 (get_local 0) (i64.const 0))
  (i64.store offset=1960 (get_local 0) (i64.const 0))
  (i64.store offset=1968 (get_local 0) (i64.const 0))
  (i64.store offset=1976 (get_local 0) (i64.const 0))
  (i64.store offset=1984 (get_local 0) (i64.const 0))
  (i64.store offset=1992 (get_local 0) (i64.const 0))
  (i64.store offset=2000 (get_local 0) (i64.const 0))
  (i64.store offset=2008 (get_local 0) (i64.const 0))
  (i64.store offset=2016 (get_local 0) (i64.const 0))
  (i64.store offset=2024 (get_local 0) (i64.const 0))
  (i64.store offset=2032 (get_local 0) (i64.const 0))
  (i64.store offset=2040 (get_local 0) (i64.const 0)))
 (func $gc--clear-marks-pages (param i32)
  (loop $loop (if (i32.eqz (get_local 0))
                  (return)) (call $gc--clear-marks-page
                             (get_local 0)) (set_local 0
                                             (i32.load offset=2048
                                              (get_local 0))) (br $loop)))
 (func $gc--clear-marks (param i32)
  (call $gc--clear-marks-pages (i32.load offset=0 (get_local 0)))
  (call $gc--clear-marks-pages (i32.load offset=4 (get_local 0)))
  (call $gc--clear-marks-pages (i32.load offset=8 (get_local 0)))
  (call $gc--clear-marks-pages (i32.load offset=12 (get_local 0)))
  (call $gc--clear-marks-pages (i32.load offset=16 (get_local 0)))
  (call $gc--clear-marks-pages (i32.load offset=20 (get_local 0)))
  (call $gc--clear-marks-pages (i32.load offset=24 (get_local 0)))
  (call $gc--clear-marks-pages (i32.load offset=28 (get_local 0)))
  (call $gc--clear-marks-pages (i32.load offset=32 (get_local 0)))
  (call $gc--clear-marks-pages (i32.load offset=36 (get_local 0)))
  (call $gc--clear-marks-pages (i32.load offset=40 (get_local 0))))
 (func $gc--mark-data (param i32) (result i32) (i32.const 1))
 (func $gc--mark-ptr (param i32) (result i32)
  (local i32 i32 i64 i64 i32 i32 i32)
  (set_local 1 (i32.and (i32.const -65536) (get_local 0)))
  (set_local 2 (i32.load offset=2052 (get_local 1)))
  (set_local 5
   (i32.div_u (i32.sub (get_local 0) (i32.add (get_local 1) (i32.const 2060)))
    (get_local 2)))
  (set_local 6 (i32.div_u (get_local 5) (i32.const 64)))
  (set_local 7 (i32.rem_u (get_local 5) (i32.const 64)))
  (set_local 3
   (i64.load offset=0
    (i32.add (get_local 1) (i32.mul (get_local 6) (i32.const 8)))))
  (set_local 4 (i64.shl (i64.const 1) (i64.extend_u/i32 (get_local 7))))
  (if (i64.eqz (i64.and (get_local 3) (get_local 4)))
      (block
          (i64.store offset=0
           (i32.add (get_local 1) (i32.mul (get_local 6) (i32.const 8)))
           (i64.or (get_local 3) (get_local 4)))
        (return (call $gc--mark-data (get_local 0)))))
  (return (i32.const 1)))
 (func $gc--mark (param i32) (local i32 i32)
  (set_local 1 (i32.load offset=44 (get_local 0)))
  (loop $loop (if (i32.le_u (get_local 1) (get_local 2))
                  (return)) (drop
                             (call $gc--mark-ptr
                              (i32.load offset=52
                               (i32.add (get_local 2)
                                (get_local 0))))) (set_local 2
                                                   (i32.add
                                                    (get_local 2
                                                     (i32.const 4)))) (br
                                                                       $loop)))
 (func $gc-run (param i32) (call $gc--clear-marks (get_local 0))
  (call $gc--mark (get_local 0)))
 (func $gc--allocated-data-page (param i32) (result i32) (local i32)
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=0 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=8 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=16 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=24 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=32 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=40 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=48 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=56 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=64 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=72 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=80 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=88 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=96 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=104 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=112 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=120 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=128 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=136 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=144 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=152 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=160 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=168 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=176 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=184 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=192 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=200 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=208 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=216 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=224 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=232 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=240 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=248 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=256 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=264 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=272 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=280 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=288 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=296 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=304 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=312 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=320 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=328 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=336 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=344 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=352 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=360 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=368 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=376 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=384 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=392 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=400 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=408 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=416 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=424 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=432 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=440 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=448 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=456 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=464 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=472 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=480 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=488 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=496 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=504 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=512 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=520 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=528 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=536 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=544 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=552 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=560 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=568 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=576 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=584 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=592 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=600 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=608 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=616 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=624 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=632 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=640 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=648 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=656 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=664 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=672 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=680 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=688 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=696 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=704 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=712 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=720 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=728 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=736 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=744 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=752 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=760 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=768 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=776 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=784 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=792 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=800 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=808 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=816 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=824 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=832 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=840 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=848 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=856 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=864 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=872 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=880 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=888 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=896 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=904 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=912 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=920 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=928 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=936 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=944 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=952 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=960 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=968 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=976 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=984 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=992 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1000 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1008 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1016 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1024 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1032 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1040 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1048 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1056 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1064 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1072 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1080 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1088 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1096 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1104 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1112 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1120 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1128 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1136 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1144 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1152 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1160 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1168 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1176 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1184 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1192 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1200 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1208 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1216 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1224 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1232 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1240 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1248 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1256 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1264 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1272 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1280 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1288 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1296 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1304 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1312 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1320 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1328 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1336 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1344 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1352 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1360 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1368 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1376 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1384 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1392 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1400 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1408 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1416 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1424 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1432 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1440 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1448 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1456 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1464 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1472 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1480 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1488 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1496 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1504 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1512 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1520 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1528 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1536 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1544 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1552 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1560 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1568 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1576 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1584 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1592 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1600 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1608 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1616 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1624 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1632 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1640 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1648 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1656 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1664 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1672 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1680 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1688 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1696 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1704 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1712 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1720 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1728 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1736 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1744 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1752 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1760 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1768 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1776 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1784 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1792 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1800 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1808 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1816 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1824 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1832 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1840 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1848 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1856 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1864 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1872 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1880 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1888 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1896 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1904 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1912 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1920 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1928 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1936 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1944 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1952 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1960 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1968 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1976 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1984 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=1992 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=2000 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=2008 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=2016 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=2024 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=2032 (get_local 0))))))
  (set_local 1
   (i32.add (get_local 1)
    (i32.wrap/i64 (i64.popcnt (i64.load offset=2040 (get_local 0))))))
  (get_local 1))
 (func $gc--allocated-data-pages (param i32) (result i32) (local i32)
  (loop $loop (if (i32.eqz (get_local 0))
                  (return (get_local 1))) (set_local 1
                                           (i32.add (get_local 1)
                                            (call $gc--allocated-data-page
                                             (get_local 0)))) (set_local 0
                                                               (i32.load
                                                                offset=2048
                                                                (get_local
                                                                 0))) (br
                                                                       $loop))
  (unreachable))
 (func $gc--allocated-data (param i32) (result i32) (local i32)
  (set_local 1
   (i32.add (get_local 1)
    (call $gc--allocated-data-pages (i32.load offset=0 (get_local 0)))))
  (set_local 1
   (i32.add (get_local 1)
    (call $gc--allocated-data-pages (i32.load offset=4 (get_local 0)))))
  (set_local 1
   (i32.add (get_local 1)
    (call $gc--allocated-data-pages (i32.load offset=8 (get_local 0)))))
  (set_local 1
   (i32.add (get_local 1)
    (call $gc--allocated-data-pages (i32.load offset=12 (get_local 0)))))
  (set_local 1
   (i32.add (get_local 1)
    (call $gc--allocated-data-pages (i32.load offset=16 (get_local 0)))))
  (set_local 1
   (i32.add (get_local 1)
    (call $gc--allocated-data-pages (i32.load offset=20 (get_local 0)))))
  (set_local 1
   (i32.add (get_local 1)
    (call $gc--allocated-data-pages (i32.load offset=24 (get_local 0)))))
  (set_local 1
   (i32.add (get_local 1)
    (call $gc--allocated-data-pages (i32.load offset=28 (get_local 0)))))
  (set_local 1
   (i32.add (get_local 1)
    (call $gc--allocated-data-pages (i32.load offset=32 (get_local 0)))))
  (set_local 1
   (i32.add (get_local 1)
    (call $gc--allocated-data-pages (i32.load offset=36 (get_local 0)))))
  (set_local 1
   (i32.add (get_local 1)
    (call $gc--allocated-data-pages (i32.load offset=40 (get_local 0)))))
  (get_local 1))
 (func $main (local i32 i32) (set_local 0 (call $new-gc))
  (call $gc-init (get_local 0))
  (call $print (call $gc--allocated-data (get_local 0)))
  (set_local 1 (call $gc-save-state (get_local 0)))
  (call $gc-protect (get_local 0) (call $gc-alloc (get_local 0) (i32.const 4)))
  (call $gc-protect (get_local 0) (call $gc-alloc (get_local 0) (i32.const 4)))
  (call $gc-protect (get_local 0) (call $gc-alloc (get_local 0) (i32.const 4)))
  (call $print (call $gc--allocated-data (get_local 0)))
  (call $gc-run (get_local 0))
  (call $print (call $gc--allocated-data (get_local 0)))
  (call $gc-restore-state (get_local 0) (get_local 1))
  (call $gc-run (get_local 0))
  (call $print (call $gc--allocated-data (get_local 0))))
 (start $main) (memory 1 10)) </code></pre>
<p>/編集</p>
<div class="footnotes">

<hr />

<ol>
<li id="fn:1"><a href="https://dl.acm.org/citation.cfm?id=2034802">An efficient non-moving garbage collector for functional languages, K. Ueno, A. Ohori, T. Otomo, In Proc. ACM ICFP Conference, pp:196-208, 2011.</a>
 <a class="footnote-return" href="#fnref:1"><sup>[return]</sup></a></li>
<li id="fn:2"><a href="https://dl.acm.org/citation.cfm?id=2951944">A Fully Concurrent Garbage Collector for Functional Programs on Multicore Processors. Katsuhiro Ueno, Atsushi Ohori. To appear in Proc. ICFP, 2016.</a>
 <a class="footnote-return" href="#fnref:2"><sup>[return]</sup></a></li>
</ol>
</div>
                    </section>
                </article>
            </div>
        </div>

        <div class="row li-author">
    <div class="sixteen columns">
        Written by <strong>κeen</strong>
    </div>
</div>


        <div class="row li-pagination">
            <div class="eight columns">
                <div class="li-pagination-previous">
                    
                        Later article<br />
                        <a href="/blog/2017/12/12/rpythonnitsuitekaruku/"> RPythonについて軽く</a>
                    
                </div>
            </div>
            <div class="eight columns">
                <div class="li-pagination-next">
                    
                        Older article<br />
                        <a href="/blog/2017/12/03/kure_towokoukaisurumaeniumeteokubekimetade_ta/"> クレートを公開する前に埋めておくべきメタデータ</a>
                    
                </div>
            </div>
        </div>
    </div>

<footer class="li-page-footer">
    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <div class="li-page-footer-legal">
                    &copy; 2020. All rights reserved. 
                </div>
                <div class="li-page-footer-theme">
                    <span class=""><a href="https://github.com/eliasson/liquorice/">liquorice</a> is a theme for <a href="http://hugo.spf13.com">hugo</a></span>
                </div>
            </div>
        </div>
    </div>
</footer>

<script type="text/javascript">
 function toggle(id) {
     var e = document.getElementById(id);
     e.style.display == 'block' ? e.style.display = 'none' : e.style.display = 'block';
 }
</script>
<script src="https://unpkg.com/mermaid@7.0.4/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true
     });</script>

    </body>
</html>

