---
categories: [非同期, CPS, 継続, 限定継続]
date: 2015-04-25T23:44:46+09:00
draft: true
description: "特に発表予定はないけどなんとなく作ってみたスライド。<br>
非同期処理には(限定)継続が必要という話からCPS変換を導入し、なぜコールバック地獄が起きるのか
を説明します。これを見てコールバック地獄への理不尽さが少しでも柔らげばと思います。
"
title: 非同期処理の「その後」の話。goto、継続、限定継続、CPS、そしてコールバック地獄。
---

<section data-markdown
    data-separator="\n\n"
    data-vertical="\n\n"
    data-notes="^Note:">
<script type="text/template">
# 非同期処理の「その後」の話
----------------------
## goto、継続、限定継続、CPS、そしてコールバック地獄

<!-- .slide: class="center" -->

# About Me
---------
![κeenのアイコン](/images/icon.png) <!-- .element: style="position:absolute;right:0;z-index:-1" -->

 + κeen
 + [@blackenedgold](https://twitter.com/blackenedgold)
 + Github: [KeenS](https://github.com/KeenS)
 + 野生のLisper
 + Lisp, Ruby, OCaml, Shell Scriptあたりを書きます

# 同期処理とは
-------------
通常、プログラムが外部とやりとり(I/O)する時に待ち時間が発生する。  


# 非同期処理とは
---------------
待ち時間に別の処理をしようという発想。


# 非同期処理の裏側
-----------------
処理Aと処理Bの他にいつどっちを動かすかを決めるスケジューラが存在することが多い

# どうやって戻る問題
-------------------
処理Aを一時停止するにはどうしたらいいか。（保留）
また、一時停止した後「その後」の処理を再開するにはどうしたらいいか。


# 「その後」とは
-----------
```c
...
fputc(c); // ここの処理でI/Oが入る
// 再開する時にここに戻ってきたい
printf("Work done");
...
```

# GOTO
------
`goto` を使えば戻れる
```c
...
  fputc(c); // ここの処理でI/Oが入る
  // 再開する時にここに戻ってきたい
RESTART:
  printf("Work done");
...
```

# GOTOの問題
------------
こういうコードだとGOTOでは困る

```c
if ((c = fgetc(f)) != -1)
```


# GOTOの問題
------------

* 式の途中に入れない
* 値を返せない
* I/Oが終わった「その後」が思ったより複雑

# "継続"という概念
-----------------

* continuation
* ここで言ってる「その後」に名前をつけたもの
* その後に行なわれる全ての処理のこと
* 全ての言語に存在する


# (限定)継続を値として扱える言語
------------------------------

* Scheme
* OchaCaml
* SML/NJ
* (Ruby)
* etc.


## 正確には限定継続
------------------

* 細かい話だが継続と言うと処理Aとスケジューラ全てを含んでしまうので
今回欲しいのは処理Aの中に限定した限定継続
* 継続を値として扱えれば限定継続を[実装出来る]()ので今回はそこまで深く違いを気にする必要はない


# 限定継続を使った非同期処理の例
------------------------------
`reset`で切り取りたい部分を囲って`shift`で限定継続を値として取り出し、引数の`lambda`に渡す。  
`reset`、`shift`、`lambda`、`k`を無視すれば以前のコードと一致する。

```scheme
(reset
  (if (/= (shift (lambda (k)
                   (k (read-char f))))
          -1)))

```

# 限定継続を使った非同期処理の例
------------------------------
`reset`で切り取りたい部分を囲って`shift`で限定継続を値として取り出し、引数の`lambda`に渡す。  
`reset`、`shift`、`lambda`、`k`を無視すれば以前のコードと一致する。

```scheme

  (if (/= 
                      (read-char f)
          -1))

```

# 限定継続を使った非同期処理の例
------------------------------
`reset`で切り取りたい部分を囲って`shift`で限定継続を値として取り出し、引数の`lambda`に渡す。  
`reset`、`shift`、`lambda`、`k`を無視すれば以前のコードと一致する。

```scheme
(if (/= (read-char f) -1))
```

# 継続を値として扱えない言語での継続
----------------------------------

# CPS
# CPS変換
# コールバック地獄の正体
# 非同期処理の実装のまとめ
# まとめ: なぜコールバック"地獄"なのか

</script>
</section>
