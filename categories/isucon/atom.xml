<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: isucon | κeenのHappy Hacκing Blog]]></title>
  <link href="http://KeenS.github.io/categories/isucon/atom.xml" rel="self"/>
  <link href="http://KeenS.github.io/"/>
  <updated>2014-08-08T23:59:43+09:00</updated>
  <id>http://KeenS.github.io/</id>
  <author>
    <name><![CDATA[κeen]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[チーム「銀杏絶滅しろ」でisucon学生賞もらってきました]]></title>
    <link href="http://KeenS.github.io/blog/2013/11/11/isucon-final-stage/"/>
    <updated>2013-11-11T22:18:00+09:00</updated>
    <id>http://KeenS.github.io/blog/2013/11/11/isucon-final-stage</id>
    <content type="html"><![CDATA[<p>しばらく間が空きました。まあ、その間のことはいつかまとめて書きます。今回は <a href="http://isucon.net/">isucon#3</a>について。</p>

<p><a href="/blog/2013/10/09/isucon-qualifying-event/">先日</a>、isucon#3の予選を突破したと書きましたが、日曜にその決勝戦があったので報告です。</p>

<!-- more -->


<h2>準備</h2>

<p>とりあえずyokoteさんが予定が入って参加できないので@c0umeさんと二人で毎週会って予選の問題を解き直しつつSQLの勉強とかやってました。MariaDBを試したりもしましたが大して変んないねーとか。最終的に4万点くらいになったのかな？あとisucon#2で複数台構成の練習とか地味にデプロイツールCapistranoのお勉強とかもしてました。非常に便利です。</p>

<h1>当日</h1>

<p>サークルを休む許可も貰えたので何事も心配なく10時にヒカリエに集合。名札とかもらって本格的な感じ。 <img src="/images/isucon-name-strap.jpg" title="name-strap" alt="名札とチームの看板(?)" /></p>

<p>お題のアプリは画像版ツイッターで、処理的には投稿された画像を生/中/小にサイズ変更して返すのがほとんど。htmlはインデックスだけであとはjson APIですしDBまわりも画像のアクセスレベルとユーザーのフォロー関係程度で、必要最低限といった感じ。単純にファイスサイズで攻めてきましたね。</p>

<p>因みにこれ、ストーリーとしてはエンジニア二人で作って騒いでたら社長が聞き付けて「18時に大規模プロモーションかけるからそれまでに対策しといてね。あ、サーバーは4台増やしといたよ」ってなっててそれを見た瞬間のみんなの反応が</p>

<blockquote><p>社長を殺そう <a href="https://twitter.com/search?q=%23isucon&amp;src=hash">#isucon</a></p>

<p>— tagomoris (@tagomoris) <a href="https://twitter.com/tagomoris/statuses/398992801850875904">November 9, 2013</a><script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script></p></blockquote>

<p>とかでしたw</p>

<p>そうそう、そんなストーリーなもんでサーバー5台中1台にしかアプリがデプロイされてない状態でスタートです。</p>

<h2>やったこと</h2>

<p>@c0umeさんがサーバーセットアップしてる間に私がアプリを読んできになったところをスカイプに張っていきました。</p>

<p>何も考えずにとりあえずnginxを野良ビルドしてgzip配信を有効にしようとするも、なぜかnginx.confが上手く機能せずにハマる。結局conf.d以下を読んでた部分が悪さをしてたと判明。ようやくアプリ側にとりかかる。</p>

<p>とりあえずリクエストの度に画像を変換してるのでそれをどうにかしようということに。POSTされた時点で変換する方針だったのですが、私は変換した画像の「パスネーム」をDBに突っ込もうって思ってたのですが@c0umeさんは画像の「バイナリデータ」を突っ込もうとしてたらしく、意思疎通ができずに若干揉めました。</p>

<p>結局、1台リバースプロキシ、3台app、 1台DBの構成で、appで画像のPOSTを受けたら3サイズにコンバートしてDBに突っ込むことに。ですがとりあえず段階を踏もうということで第一段は画像をblobとしてMySQLにツッコみます。第二段でコンバートして突っ込む、第三段でさらにgzip圧縮して突っ込むことにしました。</p>

<p>私がapp側、@c0umeさんがDB側でやりました。</p>

<p>外部プロセスを呼んでると遅いと聞いたのでRMagickを使って変換するようにして、さらにファイルに書き出さずに<code>Magick::ImageList#from_blob</code>と<code>#to_blob</code>を使って書き換えました。</p>

<p>今回、RMagickを初めて使ったのですが、ハマることハマること。<code>Magick::ImageList#crop</code>非破壊的であったり、関連ブログに書いてあるメソッドがないとか言われたり。最終的にDBが終わった@c0umeさんにも手伝ってもらってバグ取りが完了し、ベンチマークが走るようになった時点でもう終わり近く。大きな変更はやめてキャッシュとかレスポンスだけ返して裏で処理を走らせるとかをやりましたがどれもベンチマークが巧妙に作られてて失敗に終りました。あとUnicornに謎のエラーが出続けてましたが特にベンチに影響はなかったので放置しました</p>

<p>それで初期スコアが1100だったのが5400程度になりました。最後20分くらいは<code>chkconfig</code>とかでfailしないよう確認作業をしてタイムアップ。暫定学生1位、全体で7位だったかと思います。</p>

<p>failしないことだけを祈って1時間後の結果発表を待ちます。本計測は3分ですし謎のエラーもありましたし不安要素はいっぱいありました。</p>

<h2>結果</h2>

<p>failしませんでした。よかった。上のチームがfailしたらしく、最終順位は学生1位、全体6位でした。まあ、failしなかったチームは7チームしかいなかったのでなんとも言い難いですが。</p>

<p><img src="/images/isucon-scores.jpg" title="scores-of-each-team" alt="最終スコア。一位のLINE選抜チームは2位に4倍差を付けて圧勝しました。" /></p>

<p>スコア的には3位と2倍差だったので案外良い線いってたのかもしれません。</p>

<p>それで、タイトルにあるように学生賞もらいました。</p>

<p><img src="/images/isucon-prize.jpg" title="prize" alt="中身は現生5万円。" /></p>

<p>この5万は2万ずつ二人で分けて、あとの1万でyokoteさんと3人で肉を食べに行きます。</p>

<p>因みに私はこういう風に使いました。</p>

<p><img src="/images/isucon-books.jpg" title="books" alt="欲しいものより普段買いそうにないけど気になるものを選びました。" /></p>

<p>その後懇親会ではGoとかnodeの人達がライブラリが若くてバグがあって苦しんだりしてた話を聞きました。fujiwara組長のところには行けませんでした。</p>

<h2>感想</h2>

<p>たのしかったです（小並感<br/>
ベンチマークツール自体がラウンドロビンでリクエスト飛ばしてくるのでリバースプロキシ不要でしたね。あとはあせりすぎて手汗でタッチパッドの誤反応が頻発したり挙句なぜかカーネルがCPU100%使い始めて作業できなくなったりして冷や冷やしました。@c0umeさんには多大な迷惑お掛けしました。そのPC寿命じゃね？とか言われたり。</p>

<p>来年は胸を張れるようなスコアを出したいですね。LINE、カヤック、データホテルのみなさんありがとうございました</p>

<h2>その他</h2>

<p>κeenは就活生です。RubyかLispでできる仕事探してます。</p>

<p>あとamazonほしいものリストも上げときますね。[[<a href="http://www.amazon.co.jp/registry/wishlist/TA077537OIUP">http://www.amazon.co.jp/registry/wishlist/TA077537OIUP</a>]]</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ISUCON#3予選に参加しました]]></title>
    <link href="http://KeenS.github.io/blog/2013/10/09/isucon-qualifying-event/"/>
    <updated>2013-10-09T15:49:00+09:00</updated>
    <id>http://KeenS.github.io/blog/2013/10/09/isucon-qualifying-event</id>
    <content type="html"><![CDATA[<p><a href="http://isucon.net/">ISUCON</a>#3の予選に参加してきた話です。</p>

<!-- more -->


<p>ISUCON(Iikanjini SpeedUp CONtest)とは椅子を投げないなどの一部のルールを除き、基本なんでもアリのWebアプリケーションチューニングコンテストです。</p>

<p>なんで私がこんなのに参加するかというと、サークルのOBさんから告知があり、8月に学生向けのISUCON夏期講習会に参加したからです。第３回となる今回は学生枠を作るとのことで事前に学生のレベルを上げておこうという方針だそうです。</p>

<p>その講習会でコテンパンにやられてめげつつも、もう一回チャレンジしようということで夏期講習会で知りあったasamiさんとその友達のyokoteさんでチームを組んで参戦しました。</p>

<p>ちなみにこのチーム、予選3日前にSkype会議で結成したもので、予選当日も各自自宅にいてSkypeで連絡を取ってたので私はyokoteさんとはまだ会ったことありません←</p>

<h2>準備</h2>

<p>事前の話しあいではasamiさんがAWSの準備からgit(bitbucket)、ssh鍵の設定までやってくれることになりました。私も本来ならISUCON#2で練習をしておくべきだったのですが、サークルとかを言い訳に、ISUCONの記事に目を通すだけに終りました。</p>

<h2>当日</h2>

<p>10時に開始しました。10時40分に起きました←</p>

<p>私が起きた頃にはasamiさんが色々設定を済ませていたので問題のアプリケーションを<code>git clone</code>して公開鍵をSkypeにペタっと貼って参戦。アプリを読むにMarkdownでメモを投稿できるもの。</p>

<p>フムフムってなってたらsslのバージョン問題でログインできてなかったyokoteさんも参戦し、asamiさんが<code>my.cnf</code>をいじってスコアが</p>

<p>900→2500</p>

<p>となりました。スゲー。あ、言語はasamiさんとyokoteさんが書けるperlを選択。私は1ミリも読めませんがサーバーをいじる気だったので気にしませんでした。</p>

<p>で、私がフロントサーバーをapacheからnginxに移行し、staticファイルをnginxから出すようにして、さらにキャッシュするようにし、ログを消したら</p>

<p>2500→2800</p>

<p>となりました。後で考えるとこのログを消したのまずかったですね。asamiさんがなんかpythonのツールを使ってトラフィック監視してたのでいっかなーって思ってたんですが。</p>

<p>その間asamiさんがslow queryのログを吐かせてボトルネックを見付けようとしますが、どれも平均的に重い。ソートに使われてる<code>created_at</code>にyokoteさんがインデックスを貼ってくれたりしましたが大した改善はみられず。後にこのインデックスはベンチマークが初期化するときに消されてるのではということが発覚しました。</p>

<p>あとは私がworker_connectionをいじったりasamiさんがmemcachedを使ってクエリの数を減らしたりyokoteさんがストレージエンジンをarchiveに変えたり色々しましたが努力虚しくスコアは改善しませんでした。</p>

<p>外部で<code>markdown</code>コマンドを呼んでるところを(それがperl製のスクリプトだったので)アプリに埋め込んでしまえばちょっとは速くなるかなと思いましたが私はperlをいじれませんし大差ないだろうからいっかと思って放置してたのですが、後で聞くと案外それでスコア伸びたそうです。nginxのログを見てれば気づいたことだったのに…</p>

<p>ということで大したこともできず予選敗退です。因みに1位とは10倍くらいの差がありました。</p>

<h2>振り返って</h2>

<p>後で他の方のブログとかを見るとそんな手があったのかとかそこに罠があったのかとか全然気づかなかったことがたくさんありました。とりあえず勉強しなきゃって思ったのは + redis + プロファイラ + デプロイツールですね。asamiさんがデプロイツールを用意してくれてたのですが私には使いこなせず、折角git管理してたのにその利点を生かせませんでした。(私は手動デプロイしてました)</p>

<p>あとはボトルネックから攻める、redisで書き換えるといったこをとほとんどの上位チームがやってたのでそこは勉強したいです。</p>

<p>来年も開催されるなら是非参加したいですね。</p>

<h2>追記</h2>

<p>まさか…まさかこんなことになるとは…</p>

<p><a href="http://isucon.net/archives/32951235.html">学生枠上位3チーム中2チームが動作検証で失格となり</a>、繰り上げで私達のチームakyが予選通過となりました。ビックリすね。終ったあとasamiさんがしっかり動作確認してからAMIを提出してくれたからでしょう。</p>

<p>6割くらい嬉しいのですが、失格となったチーム魔王は夏期講習会で一緒だったメンバーのチームで、内心お祝いしてたのにこんなことになって残念です。スコアも正常に動作していたら16000点だったそうです。</p>

<p>あと1ヶ月、精進して本戦で晒しものにならないよう頑張ります。</p>
]]></content>
  </entry>
  
</feed>
