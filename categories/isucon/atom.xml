<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: isucon | κeenのHappy Hacκing Blog]]></title>
  <link href="http://KeenS.github.io/categories/isucon/atom.xml" rel="self"/>
  <link href="http://KeenS.github.io/"/>
  <updated>2014-10-27T02:33:59+09:00</updated>
  <id>http://KeenS.github.io/</id>
  <author>
    <name><![CDATA[κeen]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[#ISUCON 4 予選に学生枠で参加してきました]]></title>
    <link href="http://KeenS.github.io/blog/2014/09/30/isucon4-q/"/>
    <updated>2014-09-30T00:51:30+09:00</updated>
    <id>http://KeenS.github.io/blog/2014/09/30/isucon4-q</id>
    <content type="html"><![CDATA[<p>κeenです。ISUCON 4 予選に学生枠で参加してきたのでレポートです。日曜、2日目の方に参加です。</p>

<!-- more -->


<h1>メンバー集めと準備</h1>

<p>一番苦労しました。去年と同じく、全く知らない人と組んでます。全然集らなくて、@941さんがメンバー集めの音頭をとってくれたりして、ようやく集りました。941++。</p>

<p>結局ISUCON夏期講習にいたPythonアイドルのくーむ(<a href="https://twitter.com/cocodrips">@cocodrips</a>)さんとその友達の友達のねむねむ(<a href="https://twitter.com/nemunemu3desu">@nemunemu3desu</a>)さんと出ることになりました。くーむさんは競技プログラミング系Pythonista、ねむねむさんはプログラマのためのWebサービス開発のバイトをやってるWeb系Rubyist。因みに私は去年もISUCONに出て<a href="/blog/2013/11/11/isucon-final-stage/">学生賞なんか貰ってる</a>のでISUCONで要求される技術は一通り、広く浅くといった感じのRubyist。普段はLisp書いてます。「Lispを書く」はダブルミーニングですよ。すごいどうでも良いけどくーむさんは情報系のM2、ねむねむさんは情報系のB4、私は数学科のB4です。</p>

<p>流石に初対面のメンバーでいきなり競技を始めても何も出来ないので一度3人で顔を合わせて打ち合わせをしました。簡単に書いてますけど待ち合わせとか苦労したんですよ。</p>

<ul>
<li>データ量とかアルゴリズムに対する感のあるくーむさんにはMySQLのチューニングを任せる</li>
<li>くーむさんは各社のインターンで実務経験があるのでデプロイとかのコードの流れ、ベンチマークの管理もやって貰う</li>
<li>その周辺のツールも作って貰う</li>
<li>Rubyでwebサービスの開発をやってるねむねむさんにはRubyのコードをがんがん弄ってもらう</li>
<li>Redisを使うことも視野に入れてもらう。Redisの経験はあるようなのでそんなに問題なさそう。</li>
<li>あとは余ったNginX、Varnishをκeenが担当する</li>
<li>恐らくNginX、Varnishは然程手間取らないのでアプリとMySQLで苦戦してる方にκeenが入る</li>
<li>最初のセットアップはAWSアカウントを作ったくーむさんにやって貰う</li>
<li>最初に計測することが大事なのでデフォルトのままログの設定だけ変えてベンチを走らせて作戦会議をする</li>
<li>チーム名は3人のアイデンティティを合わせて「(ρ_&ndash;)/超銀杏バスターズ(･ω･ o)」とする</li>
</ul>


<p>あたりを決めました。</p>

<p>くーむさんは完全に普段とドメインが違うのでちょっとつらそうでしたがSQLとかRedisとかの本を貸したらめっちゃ勉強してきたみたいでした。
流石、情報科ですね。地力が違いますね。あとはGithubの学生が使えるプライベートリポジトリを用意してくれたり。ベンチマークを走らせたら時刻とgitのコミットIDをセットにしてログ用のレポジトリに突っこむスクリプトの準備もしてくれました。</p>

<p>ねむねむさんはAWSアカウントを作って去年の予選の問題を予習してきたようでした。あとRedis使うかもって言っといたらRedis in ActionのPDFを見付けてたようなので読んできたんじゃないかなと思います。Rack用のプロファイラを試したようでした。去年も使おうとして結局使えなかったminiprofiler。ねむねむさんにも使えなかったようです。</p>

<p>私はApacheとかNginXのログフォーマットを整備してパス/メソッド毎の(合計)レスポンスタイムを出す集計スクリプトを用意。その他マスタリングNginXを一通り読み直したりOpenRestyでmemcachedやlua、Redisのプラグインがあることを確認してインストールスクリプトを書いたりしてました。Varnishは間に合いませんでした。</p>

<h1>当日</h1>

<h2>開始</h2>

<p>LINEカフェを使わせてもらうので9:20に集合。ちゃんと集まる。家の近いくーむさんがデカいディスプレイを持ってきてました。</p>

<p>LINEカフェではLINEインターンの経験のあるくーむさんが勝手が分かってるので机を勝手に動かして三人横並びに座る。真ん中にくーむさんの大きいディスプレイがきて良い感じでした。</p>

<p>10:00に号砲と共に競技開始。早速3人ともAWSの初心者でAMIの起動の仕方が分からず詰まります。ここクリックしてみて？とかいいながらログイン出来たのが10:20くらいですね。isuconユーザーにRSAのpubキーを突っ込むもパスワードを要求されてハマる。くーむさんはLinuxには不慣れなようだったので私がやるも<a href="/blog/2014/08/21/isucon-summer-2014/">夏期講習のとき</a>と同じく解決出来ず。うーん。結局パスワードのまま通しました。</p>

<p>gitの設定をするときにアプリとログはレポジトリを分けることは決まってましたがログを吐く場所を決めてなかったのでゴタゴタ。/var/logに吐こうとするもMySQLが吐いてくれない。権限の問題じゃね？とか言って777にするという邪悪なことをするとねむねむさんがsshを締め出される。MySQLが吐いてくれなかったのは再起動忘れ。sshを締め出されたのはsshdのログファイルの権限の問題。この辺解決したのが11時過ぎかな？</p>

<p>ごたごたしてる間はねむねむさんはアプリ読んでくーむさんはインテグレーション周りの準備してくれたり。私もちょっとアプリ読んだりエラーでググったり。</p>

<h2>作戦会議</h2>

<p>12時前なので昼御飯食べながら。</p>

<ul>
<li>ベンチマークを走らせると明かにMySQLが重いのでインデックスを張る(くーむ)</li>
<li>アプリはキャッシュ効きそうなのでガンガンRedis使う(ねむねむ)</li>
<li>とりあえずNginXの最適化とVarnishは入れる(κeen)</li>
</ul>


<p>な感じです。</p>

<h2>作業</h2>

<p>Typoがあった以外はNginXとVarnishはスムーズに。</p>

<p>実際にはくーむさんがログの自動プッシュ周りで苦戦してたのでけんちん汁を食べてる隙に私がインデックスを張ることにしました。ちまちまexplainしながらやるもどうもうまくいかない、と思ったらinit.shのヒアドキュメントが二重になってる…。そこを解消したら一気にスコア上がりました。でもWHERE狙いとORDER BY狙いってどうなんだっけとなって多少過剰なインデックスだったかもしれません。</p>

<p>それでもうMySQLはCPU使わなくなったのでワークロード上げてみたらスコア12,000くらいになりました。</p>

<p>なんか静的ファイルでベンチマークエラー出てるとくーむさんから報告がありました。Varnishの設定ミスったかなと思ったらエラーメッセージが無機質だったのでシステム関連っぽい。そこは全て独学でやってきた数学科生のググり力を発揮。調べるとローカルポートを使い果たしていた模様。システムの設定をコピペ。エラー出なくなる。</p>

<p>RubyがCPU使ってるのでNginXからのリダイレクトをunixドメインソケットに。あんまり効果無し。</p>

<p>ねむねむさんのRedisキャッシュ化が入って15,000とか。ねむねむさんを信じて「キャッシュして」とだけ言っといたので詳細は不明ですがユーザーはRedisに全部突っ込んだ模様。その後は脱MySQLを目指して黙々と作業してました。</p>

<p>私は/reportがN+1クエリなので直そうと2時間くらい奮闘。後にスコアには反映されてないことを知らされて絶望。よく見とけば良かった。しかもEmacsのバッファに残ってるものをコミットしてしまってねむねむさんのコミット上書きしてしまったりしました。</p>

<p>まだRubyがCPUを使ってるのてテンプレートエンジンを置き換えることを考えました。slimが速いと風の噂で訊いたのでくーむさんにお願いしてみるもスコアがた落ち。あれRuby製だったんですね。C製のテンプレートエンジン捜しとかなきゃ。</p>

<p>さらにくーむさんがCSSやpngのminifyを試みるもチェックサムをとられていたようで失敗。良く見たらMD5とるってレギュレーションに書いてありました。後にminifyでなくインライン化すれば良かったらしいと聞く。</p>

<h2>最終確認とか</h2>

<p>17時あたりで一旦chkconfigしてリブートしてもベンチが動くことを確認。よかった。一応AMIを作ります。その後でN+1クエリの解決が動くも当然スコアには変動なし。あとはミドルウェアのログを切って脱MySQLは間に合わなくてアプリの微改善が入りパラメータの微調整をし、17,700あたりで競技終了。</p>

<h1>終わってみて</h1>

<p>一応2日目の中では学生1位なものの、1日目10チーム、2日目4チームなので何とも言えないですね。一般枠は40,000でも本戦出場無理ポとか言ってるのに20,000にも全然届かないスコアで本戦出れるかもとか言ってるゆとりの学生です。</p>

<p>反省は</p>

<ul>
<li>レギュレーション良く読む</li>
<li>ベンチマークのスコアリングも確認する

<ul>
<li>静的ファイルは0.1点と思ってたら0.01点だった。この差大きい。</li>
</ul>
</li>
<li>権限管理は適切に</li>
<li>hangoutに思ったことを垂れ流す筈だったのに口頭で済ませてしまった

<ul>
<li>それだけならまだしもhangoutに貼ったものが無視されてしまった</li>
</ul>
</li>
<li>プロファイラ使えるようにならないとね。

<ul>
<li>RubyがCPU喰ってるのは分かってるのにどこがまずいか分かんなかったのは悔しい</li>
</ul>
</li>
<li>深みに嵌ったらあきらめる</li>
<li>ブランチ切るとミドルウェアの違いで問題が出る(varnishとnginxの80の取り合い)</li>
<li>互いのスキルを把握しておく</li>
<li>開発スタイルを決めておく</li>
<li>workload、workerprocessは最適値を捜す(コア数が4だったので4~8で決め打ちだったけど後に30くらいまで上げれると聞く)</li>
</ul>


<p>かな？私が普段Linuxを使ってるのでLinuxの設定くらいみんな出来ると思ってたら私以外Macerだったってのは予想外でした。本来なら私がAWSアカウント持ってれば問題なかったんですけどクレジットカード持ってないんですよね。つらい。</p>

<p>開発スタイルはねむねむさんがpull-reqスタイル、私が細かいコミットをマスターに入れるスタイルでした。設定ファイルとアプリの違いもありますがpull-reqスタイルの方がロールバックし易いしそっちに統一した方が良さげですね。</p>

<p>個人的に、いつも通りケアレスミスが多かったのは反省しなきゃなと思います。「あれ？動かない。あ！そうか！」みたいな。メンバーは「すげー。デバッグ速えー」って言ってましたけど違いますよ？世の中の不当評価はこうして産まれるんだと少し社会を知りました。</p>

<p>Varnishももうちょっと使い熟さないとなーってのとlua勉強しなきゃなーってのが個人的な本戦に向けた準備ですね。N+1のとこはSQLの練習が出来たので個人的には満足…って言ったらメンバーに怒られますかね。</p>

<p>全体として、チームは上手く動いてたんじゃないかなと思います。N+1のところで無駄に嵌らずにねむねむさんと2人でアプリの改修やってたら脱MySQLが間に合ったんじゃないかなってのが心残りです。インテグレーションはくーむさんのスクリプトで良い感じだったのでもうちょっと改良して本番にも使いたいですね。あとCapistranoかFabricも準備しないといけませんね。</p>

<p>本当、やらかしてばっかの私に怒ることなく一緒にやってくれたくーむさん、ねむねむさんには感謝してます。もし予選通ってたら本戦も宜しくお願いします。</p>

<p>そして忙しい中ISUCONを開催して下さったCOOKPADの方々、941さん、ありがとう御座います。ベンチマーカーの問題にも迅速に対応して下さってこちらは本当に楽しく競技出来ました。</p>

<p>P.S.<br/>
今回の作業レポジトリは<a href="https://github.com/cocodrips/isucon2014q">ここ</a>、ログレポジトリは<a href="https://github.com/tomoasleep/isucon2014qlog">ここ</a>にありますがまだ非公開です。そのうち公開されると思います。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[isucon夏期講習2014に参加してきた]]></title>
    <link href="http://KeenS.github.io/blog/2014/08/21/isucon-summer-2014/"/>
    <updated>2014-08-21T12:16:03+09:00</updated>
    <id>http://KeenS.github.io/blog/2014/08/21/isucon-summer-2014</id>
    <content type="html"><![CDATA[<p>レポート締切間近のκeenです。ISUCON夏期講習2014に参加してきたのでレポートです。とはいっても去年の夏期講習もISUCONも参加してるので目新しいことはないんですが。主な目的はメンバー集めです。</p>

<!-- more -->


<h1>流れ</h1>

<ul>
<li>LINEの採用情報:
 ISUCONがきっかけでLINEに内定貰った人がいるよう。因みに自分はLINE落ちた。</li>
<li><p>ISUCONの概要の説明:
うん。知ってる。</p>

<p> <iframe src="//www.slideshare.net/slideshow/embed_code/38160090" width="427" height="356" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" style="border:1px solid #CCC; border-width:1px; margin-bottom:5px; max-width: 100%;" allowfullscreen> </iframe> <div style="margin-bottom:5px"> <strong> <a href="https://www.slideshare.net/tagomoris/isucon2014" title="ISUCONの話(夏期講習2014)" target="_blank">ISUCONの話(夏期講習2014)</a> </strong> from <strong><a href="http://www.slideshare.net/tagomoris" target="_blank">SATOSHI TAGOMORI</a></strong> </div></p></li>
<li>過去問を解く:
 去年の予選の問題だった。うん。知ってる。</li>
<li>パフォーマンス向上に関しての解説:
 これもISUCON反省会とかそんなんでkazeburoさんが話してた気がする</li>
</ul>


<iframe src="//www.slideshare.net/slideshow/embed_code/38162132" width="427" height="356" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" style="border:1px solid #CCC; border-width:1px; margin-bottom:5px; max-width: 100%;" allowfullscreen> </iframe>


<p> <div style="margin-bottom:5px"> <strong> <a href="https://www.slideshare.net/kazeburo/isucon-summerclass2014action1" title=" Webアプリケーションの パフォーマンス向上のコツ 概要編" target="_blank"> Webアプリケーションの パフォーマンス向上のコツ 概要編</a> </strong> from <strong><a href="http://www.slideshare.net/kazeburo" target="_blank">Masahiro Nagano</a></strong> </div></p>

<iframe src="//www.slideshare.net/slideshow/embed_code/38163927" width="427" height="356" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" style="border:1px solid #CCC; border-width:1px; margin-bottom:5px; max-width: 100%;" allowfullscreen> </iframe>


<p> <div style="margin-bottom:5px"> <strong> <a href="https://www.slideshare.net/kazeburo/isucon-summerclass2014action2" title=" Webアプリケーションの パフォーマンス向上のコツ 実践編" target="_blank"> Webアプリケーションの パフォーマンス向上のコツ 実践編</a> </strong> from <strong><a href="http://www.slideshare.net/kazeburo" target="_blank">Masahiro Nagano</a></strong> </div></p>

<ul>
<li>morisさんによるライブチューニング:
 失敗してた</li>
<li>懇親会</li>
</ul>


<h1>自分の作業</h1>

<p>前年度参加者がハイパフォーマンス叩き出して俺TUEEEEEEしても意味がないので次回のISUCONで試したいことを試して地雷踏むことにした。</p>

<h2>sshのRSAAuthenticationの設定</h2>

<p>何故かハマる。</p>

<p>id_rsa.pubをauthorized_keysに突っ込んでUserPAMの設定まで確認して<code>sudo service sshd restart</code>したのにパスワードを求められる。確か色々確認してもう一回sshdリスタートしたら通った気がする。原因不明。</p>

<p>そういや</p>

<pre><code>curl https://github.com/KeenS.keys &gt;&gt; .ssh/authorized_keys
</code></pre>

<p>のワンライナー使えば良かった。</p>

<h2>アプリケーションをgitで管理する</h2>

<p>やらかす。</p>

<p>最初isucon/webapp/ruby/だけをgitで管理した。それだと足りないので次にisucon/全体をgitで管理しようとしたらisucon/webapp/ruby/がサブモジュール扱いされて困った。サブモジュール分かんね。色々試すもついぞisucon/のgitでisucon/webapp/ruby/を管理出来なかった。結局.git吹っ飛ばして再度<code>git init .</code>した。これは次回までの宿題ですね。</p>

<p>あと地味にisucon/init.shが.gitignoreされてて困った。</p>

<h2>サーバーマシンをgitサーバーにする</h2>

<p>前回はbitbucketで管理してたがしばらく使わない内にパスワードを忘れてしまったのと(もしかしたら以前のバイト先のメールアドレスで登録してた?)pingが400msのbitbucketサーバー使うのに気が引けたのでサーバーマシンをgitサーバーにしようと決意。ハマる。</p>

<p>gitのマニュアルを適当に読んでたのが悪かった。ローカルで<code>git clone iscon@machine:isucon</code>してもなんか怒られてしばらく悩む。正解は、先ずリモートで<code>git clone --bare isucon isucon.git</code>してから<code>git clone iscon@machine:isucon.git</code>だった。</p>

<p>次にリモートで</p>

<pre><code>mv isucon isucon.back
git clone isucon.git isucon
</code></pre>

<p>したら.gitignoreとかその辺の関係でベンチマークやら何やらが動かなくなる。自分でベンチマークをビルドする羽目に。</p>

<p>新たにcloneせずに</p>

<pre><code>cd isucon
git remote add origin ../isucon.git
</code></pre>

<p>すれば良かったのだろうか。要調査。</p>

<h2>細かなチューニング</h2>

<p>markdownのバックエンドをrdiscountにしたり。これもGemfileで困る。結局あれはローカルで<code>bundle install --no-deploy</code>してから<code>git push</code>したら良かったのだろうか。これも宿題。</p>

<h2>インデックスを張る</h2>

<p>isucon/config/init.sqlに</p>

<p><code>sql
CREATE INDEX users_idx_username ON users (username);
CREATE INDEX memos_idx_id_is_private_created_at_id ON memos (is_private, created_at, id);
CREATE INDEX memos_idx_id_user_created_at ON memos (`user`, created_at);
</code>
を書いてisucon/init.shに</p>

<p>```sh</p>

<h1>!/bin/sh</h1>

<p>set -e
mysql -u isu-user isucon &lt; ./config/init.sql > log 2>&amp;1</p>

<h1>データ投入後になにかしらの作業をしたい場合はこのシェルスクリプトに書いてください</h1>

<p>```
を書くもエラーが出る。結局絶対パスで書いて2〜3回実行したら通ったのでパスの問題だったかと。しかし1回で通らなかったのは謎。</p>

<p>あとデバッグ大変だった。ベンチマークツールさん、初期化スクリプトでエラー出したらエラーログ吐いて下さいよ。</p>

<p>そういやリダイレクト先のlogファイルは結局行方不明のままだった。</p>

<h2>N+1クエリの解決</h2>

<p>SQL書けなすぎてJOINとかFORCE INDEX書くのに戸惑った。一々書いてはmysqlのコンソールに貼ってエラーメッセージ読んでってやってた。すんなりやりたい。</p>

<h2>リバースプロキシをNginXにする</h2>

<p>まずは</p>

<pre><code>sudo yum install nginx
mv /etc/nginx/nginx.conf ./config/
git add ./config/nginx.conf
git commit -m 'add nignx.conf'
sudo ln -s /home/isu-user/isucon/config/nginx.conf /etc/nginx/
sudo service httpd stop
sudo service nginx start
</code></pre>

<p>だったかな?最初<code>ln</code>に絶対パスを使ってなくてエラー出たりしたけど。</p>

<p>んで
<code>
location / {
   proxy_pass   http://localhost:5000;
}
</code>
だけ書くも<code>404 http://localhost:5000/なんちゃら Not Found</code>が出る。そういや、とプロキシヘッダを追加。それでも画像などはとれない。多分rootをいじらなかったのが原因。次の手で静的ファイルをNginXでキャッシュするように設定したら直った。</p>

<p>あまり記録残してないけどこの辺で2900点くらいで首位だった気がする。因みに初期値は1700くらい。</p>

<h2>Varnishを噛ませる</h2>

<p>前回、ベンチマークツールのチェックが甘くてVarnishを使うだけでスコアが跳ね上がるというのを知っていたのでちょっとチート臭いけどどうせ本番でも必要だしということで練習もかねて使う。</p>

<pre><code>sudo yum install varnish
mv /etc/sysconfig/varnish ./config
git add ./config/varnish
git commit -m 'varnish'
sudo ln -s /home/isu-user/isucon/config/varnish /etc/sysconfig/varnish
mv /etc/varnish/default.vcl ./config
git add ./config/default.vcl
git commit -m 'default.vcl'
sudo ln -s /home/isu-user/isucon/config/default.vcl /etc/varnish/default.vcl
</code></pre>

<p>的なことをやった。あとはvarnishを80番にしてバックエンドを4000番にして、NginXを4000番にした。それだけでスコアが14000くらいになった。varinish簡単だし優秀。</p>

<h2>my.cnfのチューニング</h2>

<p>もはやvarnishが仕事してる所為でボトルネックはベンチマークツールなのだけど一応。</p>

<p>とはいってもinnodb_buffer_pool_sizeを2GBから6GBにしただけ。因みに与えられたマシンのメモリは8GB。スコアは一応微増。でもまあ誤差の範囲内。</p>

<p>この辺でタイムオーバー。</p>

<h1>懇親会</h1>

<p>目の前の人がClojure推しの人でだいたいそんな話してた。</p>

<p>チームメンバー捜しは席の周りの人が当日出れない人ばかりだったのと席替えがなかったので失敗に終わる。誰か学生枠で一緒に出ましょうよ。学生賞目指しましょうよ。</p>

<h1>やり残したこととか反省とか</h1>

<ul>
<li>ローカルで変更→commit→push→リモートでpull→再起動→ベンチマークのワークフローが結構面倒だったしpull忘れ、再起動忘れがあったのでpushより後を自動化したい。出来ればgitのコミットログとベンチマークのスコアをペアで保存しながら。hook使ったら割と出来そうな気はするんだけどなあ。</li>
<li>折角サーバー与えられたんだしMySQLのslow logを吐かせるの一回練習しとけば良かった。</li>
<li>結局capistrano使わなかった。複数台構成なら必須だし復習しておきたかったのに。</li>
<li>メンバー捜したかった。</li>
</ul>


<p>マジでメンバー捜してます。学生枠で出たい人@blackenedgoldまでお願いします。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[チーム「銀杏絶滅しろ」でisucon学生賞もらってきました]]></title>
    <link href="http://KeenS.github.io/blog/2013/11/11/isucon-final-stage/"/>
    <updated>2013-11-11T22:18:00+09:00</updated>
    <id>http://KeenS.github.io/blog/2013/11/11/isucon-final-stage</id>
    <content type="html"><![CDATA[<p>しばらく間が空きました。まあ、その間のことはいつかまとめて書きます。今回は <a href="http://isucon.net/">isucon#3</a>について。</p>

<p><a href="/blog/2013/10/09/isucon-qualifying-event/">先日</a>、isucon#3の予選を突破したと書きましたが、日曜にその決勝戦があったので報告です。</p>

<!-- more -->


<h2>準備</h2>

<p>とりあえずyokoteさんが予定が入って参加できないので@c0umeさんと二人で毎週会って予選の問題を解き直しつつSQLの勉強とかやってました。MariaDBを試したりもしましたが大して変んないねーとか。最終的に4万点くらいになったのかな？あとisucon#2で複数台構成の練習とか地味にデプロイツールCapistranoのお勉強とかもしてました。非常に便利です。</p>

<h1>当日</h1>

<p>サークルを休む許可も貰えたので何事も心配なく10時にヒカリエに集合。名札とかもらって本格的な感じ。 <img src="/images/isucon-name-strap.jpg" title="name-strap" alt="名札とチームの看板(?)" /></p>

<p>お題のアプリは画像版ツイッターで、処理的には投稿された画像を生/中/小にサイズ変更して返すのがほとんど。htmlはインデックスだけであとはjson APIですしDBまわりも画像のアクセスレベルとユーザーのフォロー関係程度で、必要最低限といった感じ。単純にファイスサイズで攻めてきましたね。</p>

<p>因みにこれ、ストーリーとしてはエンジニア二人で作って騒いでたら社長が聞き付けて「18時に大規模プロモーションかけるからそれまでに対策しといてね。あ、サーバーは4台増やしといたよ」ってなっててそれを見た瞬間のみんなの反応が</p>

<blockquote><p>社長を殺そう <a href="https://twitter.com/search?q=%23isucon&amp;src=hash">#isucon</a></p>

<p>— tagomoris (@tagomoris) <a href="https://twitter.com/tagomoris/statuses/398992801850875904">November 9, 2013</a><script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script></p></blockquote>

<p>とかでしたw</p>

<p>そうそう、そんなストーリーなもんでサーバー5台中1台にしかアプリがデプロイされてない状態でスタートです。</p>

<h2>やったこと</h2>

<p>@c0umeさんがサーバーセットアップしてる間に私がアプリを読んできになったところをスカイプに張っていきました。</p>

<p>何も考えずにとりあえずnginxを野良ビルドしてgzip配信を有効にしようとするも、なぜかnginx.confが上手く機能せずにハマる。結局conf.d以下を読んでた部分が悪さをしてたと判明。ようやくアプリ側にとりかかる。</p>

<p>とりあえずリクエストの度に画像を変換してるのでそれをどうにかしようということに。POSTされた時点で変換する方針だったのですが、私は変換した画像の「パスネーム」をDBに突っ込もうって思ってたのですが@c0umeさんは画像の「バイナリデータ」を突っ込もうとしてたらしく、意思疎通ができずに若干揉めました。</p>

<p>結局、1台リバースプロキシ、3台app、 1台DBの構成で、appで画像のPOSTを受けたら3サイズにコンバートしてDBに突っ込むことに。ですがとりあえず段階を踏もうということで第一段は画像をblobとしてMySQLにツッコみます。第二段でコンバートして突っ込む、第三段でさらにgzip圧縮して突っ込むことにしました。</p>

<p>私がapp側、@c0umeさんがDB側でやりました。</p>

<p>外部プロセスを呼んでると遅いと聞いたのでRMagickを使って変換するようにして、さらにファイルに書き出さずに<code>Magick::ImageList#from_blob</code>と<code>#to_blob</code>を使って書き換えました。</p>

<p>今回、RMagickを初めて使ったのですが、ハマることハマること。<code>Magick::ImageList#crop</code>非破壊的であったり、関連ブログに書いてあるメソッドがないとか言われたり。最終的にDBが終わった@c0umeさんにも手伝ってもらってバグ取りが完了し、ベンチマークが走るようになった時点でもう終わり近く。大きな変更はやめてキャッシュとかレスポンスだけ返して裏で処理を走らせるとかをやりましたがどれもベンチマークが巧妙に作られてて失敗に終りました。あとUnicornに謎のエラーが出続けてましたが特にベンチに影響はなかったので放置しました</p>

<p>それで初期スコアが1100だったのが5400程度になりました。最後20分くらいは<code>chkconfig</code>とかでfailしないよう確認作業をしてタイムアップ。暫定学生1位、全体で7位だったかと思います。</p>

<p>failしないことだけを祈って1時間後の結果発表を待ちます。本計測は3分ですし謎のエラーもありましたし不安要素はいっぱいありました。</p>

<h2>結果</h2>

<p>failしませんでした。よかった。上のチームがfailしたらしく、最終順位は学生1位、全体6位でした。まあ、failしなかったチームは7チームしかいなかったのでなんとも言い難いですが。</p>

<p><img src="/images/isucon-scores.jpg" title="scores-of-each-team" alt="最終スコア。一位のLINE選抜チームは2位に4倍差を付けて圧勝しました。" /></p>

<p>スコア的には3位と2倍差だったので案外良い線いってたのかもしれません。</p>

<p>それで、タイトルにあるように学生賞もらいました。</p>

<p><img src="/images/isucon-prize.jpg" title="prize" alt="中身は現生5万円。" /></p>

<p>この5万は2万ずつ二人で分けて、あとの1万でyokoteさんと3人で肉を食べに行きます。</p>

<p>因みに私はこういう風に使いました。</p>

<p><img src="/images/isucon-books.jpg" title="books" alt="欲しいものより普段買いそうにないけど気になるものを選びました。" /></p>

<p>その後懇親会ではGoとかnodeの人達がライブラリが若くてバグがあって苦しんだりしてた話を聞きました。fujiwara組長のところには行けませんでした。</p>

<h2>感想</h2>

<p>たのしかったです（小並感<br/>
ベンチマークツール自体がラウンドロビンでリクエスト飛ばしてくるのでリバースプロキシ不要でしたね。あとはあせりすぎて手汗でタッチパッドの誤反応が頻発したり挙句なぜかカーネルがCPU100%使い始めて作業できなくなったりして冷や冷やしました。@c0umeさんには多大な迷惑お掛けしました。そのPC寿命じゃね？とか言われたり。</p>

<p>来年は胸を張れるようなスコアを出したいですね。LINE、カヤック、データホテルのみなさんありがとうございました</p>

<h2>その他</h2>

<p>κeenは就活生です。RubyかLispでできる仕事探してます。</p>

<p>あとamazonほしいものリストも上げときますね。[[<a href="http://www.amazon.co.jp/registry/wishlist/TA077537OIUP">http://www.amazon.co.jp/registry/wishlist/TA077537OIUP</a>]]</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ISUCON#3予選に参加しました]]></title>
    <link href="http://KeenS.github.io/blog/2013/10/09/isucon-qualifying-event/"/>
    <updated>2013-10-09T15:49:00+09:00</updated>
    <id>http://KeenS.github.io/blog/2013/10/09/isucon-qualifying-event</id>
    <content type="html"><![CDATA[<p><a href="http://isucon.net/">ISUCON</a>#3の予選に参加してきた話です。</p>

<!-- more -->


<p>ISUCON(Iikanjini SpeedUp CONtest)とは椅子を投げないなどの一部のルールを除き、基本なんでもアリのWebアプリケーションチューニングコンテストです。</p>

<p>なんで私がこんなのに参加するかというと、サークルのOBさんから告知があり、8月に学生向けのISUCON夏期講習会に参加したからです。第３回となる今回は学生枠を作るとのことで事前に学生のレベルを上げておこうという方針だそうです。</p>

<p>その講習会でコテンパンにやられてめげつつも、もう一回チャレンジしようということで夏期講習会で知りあったasamiさんとその友達のyokoteさんでチームを組んで参戦しました。</p>

<p>ちなみにこのチーム、予選3日前にSkype会議で結成したもので、予選当日も各自自宅にいてSkypeで連絡を取ってたので私はyokoteさんとはまだ会ったことありません←</p>

<h2>準備</h2>

<p>事前の話しあいではasamiさんがAWSの準備からgit(bitbucket)、ssh鍵の設定までやってくれることになりました。私も本来ならISUCON#2で練習をしておくべきだったのですが、サークルとかを言い訳に、ISUCONの記事に目を通すだけに終りました。</p>

<h2>当日</h2>

<p>10時に開始しました。10時40分に起きました←</p>

<p>私が起きた頃にはasamiさんが色々設定を済ませていたので問題のアプリケーションを<code>git clone</code>して公開鍵をSkypeにペタっと貼って参戦。アプリを読むにMarkdownでメモを投稿できるもの。</p>

<p>フムフムってなってたらsslのバージョン問題でログインできてなかったyokoteさんも参戦し、asamiさんが<code>my.cnf</code>をいじってスコアが</p>

<p>900→2500</p>

<p>となりました。スゲー。あ、言語はasamiさんとyokoteさんが書けるperlを選択。私は1ミリも読めませんがサーバーをいじる気だったので気にしませんでした。</p>

<p>で、私がフロントサーバーをapacheからnginxに移行し、staticファイルをnginxから出すようにして、さらにキャッシュするようにし、ログを消したら</p>

<p>2500→2800</p>

<p>となりました。後で考えるとこのログを消したのまずかったですね。asamiさんがなんかpythonのツールを使ってトラフィック監視してたのでいっかなーって思ってたんですが。</p>

<p>その間asamiさんがslow queryのログを吐かせてボトルネックを見付けようとしますが、どれも平均的に重い。ソートに使われてる<code>created_at</code>にyokoteさんがインデックスを貼ってくれたりしましたが大した改善はみられず。後にこのインデックスはベンチマークが初期化するときに消されてるのではということが発覚しました。</p>

<p>あとは私がworker_connectionをいじったりasamiさんがmemcachedを使ってクエリの数を減らしたりyokoteさんがストレージエンジンをarchiveに変えたり色々しましたが努力虚しくスコアは改善しませんでした。</p>

<p>外部で<code>markdown</code>コマンドを呼んでるところを(それがperl製のスクリプトだったので)アプリに埋め込んでしまえばちょっとは速くなるかなと思いましたが私はperlをいじれませんし大差ないだろうからいっかと思って放置してたのですが、後で聞くと案外それでスコア伸びたそうです。nginxのログを見てれば気づいたことだったのに…</p>

<p>ということで大したこともできず予選敗退です。因みに1位とは10倍くらいの差がありました。</p>

<h2>振り返って</h2>

<p>後で他の方のブログとかを見るとそんな手があったのかとかそこに罠があったのかとか全然気づかなかったことがたくさんありました。とりあえず勉強しなきゃって思ったのは + redis + プロファイラ + デプロイツールですね。asamiさんがデプロイツールを用意してくれてたのですが私には使いこなせず、折角git管理してたのにその利点を生かせませんでした。(私は手動デプロイしてました)</p>

<p>あとはボトルネックから攻める、redisで書き換えるといったこをとほとんどの上位チームがやってたのでそこは勉強したいです。</p>

<p>来年も開催されるなら是非参加したいですね。</p>

<h2>追記</h2>

<p>まさか…まさかこんなことになるとは…</p>

<p><a href="http://isucon.net/archives/32951235.html">学生枠上位3チーム中2チームが動作検証で失格となり</a>、繰り上げで私達のチームakyが予選通過となりました。ビックリすね。終ったあとasamiさんがしっかり動作確認してからAMIを提出してくれたからでしょう。</p>

<p>6割くらい嬉しいのですが、失格となったチーム魔王は夏期講習会で一緒だったメンバーのチームで、内心お祝いしてたのにこんなことになって残念です。スコアも正常に動作していたら16000点だったそうです。</p>

<p>あと1ヶ月、精進して本戦で晒しものにならないよう頑張ります。</p>
]]></content>
  </entry>
  
</feed>
