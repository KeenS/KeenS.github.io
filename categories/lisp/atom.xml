<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: lisp | κeenのHappy Hacκing Blog]]></title>
  <link href="http://KeenS.github.io/categories/lisp/atom.xml" rel="self"/>
  <link href="http://KeenS.github.io/"/>
  <updated>2014-09-30T10:02:46+09:00</updated>
  <id>http://KeenS.github.io/</id>
  <author>
    <name><![CDATA[κeen]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[lisp meet up # 20]]></title>
    <link href="http://KeenS.github.io/blog/2014/09/30/lisp-meet-up-number-20/"/>
    <updated>2014-09-30T09:35:05+09:00</updated>
    <id>http://KeenS.github.io/blog/2014/09/30/lisp-meet-up-number-20</id>
    <content type="html"><![CDATA[<p>κeenです。lisp meet up # 20に参加したのでレポートです。</p>

<!-- more -->


<p>20人の募集に19人参加予定。会場は今回初めてのところでした。</p>

<h1>LT</h1>

<p>LTはTOYOZUMIさんが仕事で来れなくなったので私の1件のみ。内容はpicrinのチューニングの話と思わせてほとんどがその前振りのGCの話。</p>

<p>スライドはこちら。</p>

<p><a href="http://keens.github.io/slide/picrin-gc.html">Picrinのチューニングの話、もといGCの話 | κeenのHappy Hacκing Blog</a></p>

<p>TOYOZUMIさんのdocstringの話聞きたかった</p>

<h2>飛び入り</h2>

<ul>
<li>ブラウザ上でbiwa schemeの環境(REPLだけでなくオートインデントとか)を作ってる</li>
<li>関連して、websocketでswankと対話できるやつ作ってる</li>
<li>関連して、ブラウザ上で動くLispに似てそうなBlockyというヴィジュアル言語がある
なんかの話がありました。</li>
</ul>


<h1>余った時間</h1>

<p>chikuさんが前でGCの話してました。んで話が尽きたあたりで私がpicrinの宣伝しました。<code>(picrin control list)</code>の話です。非同期プロミス然りpicrinにはトリッキーな機能が多いですね。</p>

<p>結局ライブコーディングはしませんでしたね。</p>

<h1>懇親会</h1>

<p>Raspberry Piの話とかちょいとGCの話とかVarnishの話とか。ブログの話題が出たのでOctopress推しといたり。なんでみんなGithub Pages + Octopress使わないん？便利ですやん。</p>

<p>結構色々話してた気がするんですが覚えてないですね。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Picrinのチューニングの話、もといGCの話]]></title>
    <link href="http://KeenS.github.io/slide/picrin-gc.html"/>
    <updated>2014-09-29T14:37:00+09:00</updated>
    <id>http://KeenS.github.io/slide/picrin-gc.markdown</id>
    <content type="html"><![CDATA[<h1>Picrinのチューニングの話、もといGCの話</h1>

<hr />

<p>Lisp Meet Up presented by Shibuya.lisp #20<br/>
2014-09-29<br/>
κeen(@blackenedgold)</p>

<h1>自己紹介</h1>

<hr />

<ul>
<li>κeen</li>
<li>東大数学科の4年生</li>
<li>ソーシャルアカウントは上のアイコン達から。</li>
<li>Lisp, Ruby, OCaml, Shell Scriptあたりを書きます</li>
<li><a href="https://github.com/picrin-scheme/picrin">picrin</a>のコミッタです</li>
</ul>


<h1>picrin</h1>

<hr />

<p><img src="/images/picrin/picrin-logo-fin01-02.png" alt="picrin" /></p>

<h1>picrin</h1>

<hr />

<ul>
<li>R7RS compatibility</li>
<li>bytecode interpreter (based on stack VM)</li>
<li>internal representation by nan-boxing</li>
<li>conservative call/cc implementation (users can freely interleave native stack with VM stack)</li>
<li>exact GC (simple mark and sweep, partially reference count is used as well)</li>
<li>string representation by rope data structure</li>
</ul>


<h1>picrin</h1>

<hr />

<ul>
<li>R7RS compatibility</li>
<li><strong>bytecode interpreter (based on stack VM)</strong></li>
<li>internal representation by nan-boxing</li>
<li>conservative call/cc implementation (users can freely interleave native stack with VM stack)</li>
<li><strong>exact GC (simple mark and sweep, partially reference count is used as well)</strong></li>
<li><strong>string representation by rope data structure</strong></li>
</ul>


<h1>picrin開発者の不満</h1>

<hr />

<ul>
<li>picrinの起動が遅い<!-- .element: class="fragment" data-fragment-index="1" -->

<ul>
<li>2秒くらいかかる <!-- .element: class="fragment" data-fragment-index="1" --></li>
</ul>
</li>
<li>picrinのテストが遅い<!-- .element: class="fragment" data-fragment-index="2" -->

<ul>
<li>16秒くらいかかる <!-- .element: class="fragment" data-fragment-index="2" --></li>
</ul>
</li>
</ul>


<h1>少しGCの話</h1>

<hr />

<p>GC(ごみ集め)とは</p>

<ul>
<li>使われていないオブジェクトを自動的に解法する

<ul>
<li>メモリ管理に煩わせられないで済む</li>
<li>メモリーリークを防ぐ。</li>
</ul>
</li>
<li>「使われていないオブジェクト」を判定するのはいくつかアルゴリズムがある</li>
</ul>


<h1>GCのアルゴリズム</h1>

<hr />

<h2>主なGCのアルゴリズム</h2>

<ul>
<li>マーク&amp;スイープ</li>
<li>参照カウント</li>
<li>Copying GC</li>
</ul>


<h1>GCのアルゴリズム</h1>

<hr />

<h2>マーク&amp;スイープ</h2>

<ol>
<li>あらかじめ全てのオブジェクトはどこかで一元管理する<!-- .element: class="fragment" data-fragment-index="1" --></li>
<li>一元管理元(ヒープ(ページ))でメモリが足りなくなったらGCを開始<!-- .element: class="fragment" data-fragment-index="2" --></li>
<li>スタックに載っているオブジェクト、変数に格納されているオブジェクトにマークする<!-- .element: class="fragment" data-fragment-index="3" --></li>
<li>そこから辿れるオブジェクトも再帰的にマークする<!-- .element: class="fragment" data-fragment-index="4" --></li>
<li>ヒープからマークされていないオブジェクトを開放する<!-- .element: class="fragment" data-fragment-index="5" --></li>
<li>それでもメモリが足りなければ一ヒープのページを増やす<!-- .element: class="fragment" data-fragment-index="6" --></li>
<li>増やせなければメモリを使い果したのでabort<!-- .element: class="fragment" data-fragment-index="7" --></li>
</ol>


<h1>GCのアルゴリズム</h1>

<hr />

<h2>マーク&amp;スイープの特徴</h2>

<ul>
<li>そこそこ速い</li>
<li>正確に集められる</li>
<li>GC以外ではメモリ管理を考えなくて良い(≒プラグインは書き易い)</li>
<li>長生きのオブジェクトは何度もマークされる(=>世代別GC)</li>
<li>負荷は1点に集中する</li>
<li>メモリの断片化が起きる(=オブジェクトのアロケートが遅くなる)</li>
</ul>


<h1>GCのアルゴリズム</h1>

<hr />

<h2>参照カウント</h2>

<ol>
<li>オブジェクトに他から参照されている数(参照カウント)を記憶させる<!-- .element: class="fragment" data-fragment-index="1" --></li>
<li>オブジェクトの参照を変えるときはその都度参照カウントを変える<!-- .element: class="fragment" data-fragment-index="2" --></li>
<li>参照カウントが0になったら開放する<!-- .element: class="fragment" data-fragment-index="3" --></li>
</ol>


<h1>GCのアルゴリズム</h1>

<hr />

<h2>参照カウントの特徴</h2>

<ul>
<li>負荷は分散する</li>
<li>GCの実装は楽</li>
<li>少し遅い(必ずfreeする必要がある)</li>
<li>正確でない(循環参照に弱い)(cf. 大相撲の星の回しあい)</li>
<li>プラグインは面倒</li>
</ul>


<h1>GCのアルゴリズム</h1>

<hr />

<h2>Copying GC</h2>

<ol>
<li>オブジェクトプールを2つ用意する(1, 2)とする<!-- .element: class="fragment" data-fragment-index="1" --></li>
<li>オブジェクトを確保するときは必ず1に確保する<!-- .element: class="fragment" data-fragment-index="2" --></li>
<li>1のメモリが足りなくなったらgcを開始<!-- .element: class="fragment" data-fragment-index="3" --></li>
<li>1の生きているオブジェクトを再帰的に2に移動する<!-- .element: class="fragment" data-fragment-index="4" --></li>
<li>1に残っているものは全てゴミとして良い<!-- .element: class="fragment" data-fragment-index="5" --></li>
<li>1、2のラベルを付け換える<!-- .element: class="fragment" data-fragment-index="6" --></li>
</ol>


<h1>GCのアルゴリズム</h1>

<hr />

<h2>Copying GCの特徴</h2>

<ul>
<li>正確</li>
<li>メモリの断片化が起きない(Windowsのデフラグ)(=アロケートが速くなる)</li>
<li>負荷は1点に集中する</li>
<li>遅い(オブジェクトの移動が必要)</li>
<li>メモリ食う(オブジェクトプール2つ分)</li>
<li>ポインタも変わるため、ハッシュの再計算などが必要</li>
</ul>


<h1>GCのアルゴリズム</h1>

<hr />

<h2>GCの主な属性</h2>

<ul>
<li>世代別

<ul>
<li>新しいオブジェクトだけGCの対象にする<!-- .element: class="fragment" data-fragment-index="1" --></li>
</ul>
</li>
<li>正確

<ul>
<li>ゴミは必ず回収する<!-- .element: class="fragment" data-fragment-index="2" --></li>
</ul>
</li>
<li>インクリメンタル

<ul>
<li>一度にやらずに少しづつGCを進める<!-- .element: class="fragment" data-fragment-index="3" --></li>
</ul>
</li>
</ul>


<h1>picrinのGC</h1>

<hr />

<p><img src="/images/picrin/picrin-logo-fin01-02.png" alt="picrin" /></p>

<h1>picrinのGC</h1>

<hr />

<ul>
<li>基本は普通の正確なマーク&amp;スイープ

<ul>
<li>Copying GCはlightweightでない</li>
</ul>
</li>
<li>ropeには参照カウント

<ul>
<li>ropeには循環参照が起きない</li>
</ul>
</li>
</ul>


<h1>picrinのGC</h1>

<hr />

<ul>
<li>基本はマーク&amp;スイープ</li>
</ul>


<blockquote><ol>
<li>スタックに載っているオブジェクト、変数に格納されているオブジェクトにマークする</li>
</ol>
</blockquote>

<ul>
<li>schemeの変数はそのまま</li>
<li>Cの変数は読めないのでアリーナという場所を用意してC内ではそこに一時保管してもらう

<ul>
<li>スコープはFILOなのでスタックを用いればヒープより速くアロケート出来る</li>
</ul>
</li>
</ul>


<h1>picrinのチューニング</h1>

<h2>プロファイルをとってみる</h2>

<hr />

<p><code>
 % cumulative self self total
time seconds seconds calls s/call s/call name
37.14 0.78 0.78 13136494 0.00 0.00 XROPE_DECREF
23.81 1.28 0.50 1544 0.00 0.00 gc_sweep_phase
15.72 1.61 0.33 59344814 0.00 0.00 gc_mark_object
10.00 1.82 0.21 1544 0.00 0.00 gc_mark_phase
6.67 1.96 0.14 1544 0.00 0.00 gc_mark_trie
2.38 2.01 0.05 6523 0.00 0.00 pic_apply
</code></p>

<p><span style="font-size:200%">ほとんどGCですね。<br/>
本当にありがとう御座いました。</span></p>

<h1>解決案</h1>

<hr />

<ul>
<li>GCのアルゴリズムを変える</li>
<li>オブジェクトをアロケートしないようにする</li>
<li>パラメーターをいじる</li>
</ul>


<h1>解決案</h1>

<hr />

<ul>
<li>GCのアルゴリズムを変える</li>
<li>オブジェクトをアロケートしないようにする</li>
<li><strong>パラメーターをいじる</strong></li>
</ul>


<h1>GCに関連するパラメータ</h1>

<hr />

<p>元々tinyに設計されている
```C
/<em> アリーナのサイズ </em>/</p>

<h1>define PIC_ARENA_SIZE 1000</h1>

<p>/<em> ヒープページのサイズ </em>/</p>

<h1>define PIC_HEAP_PAGE_SIZE 10000</h1>

<p>/<em> シンボルプール(ハッシュ)のサイズ </em>/</p>

<h1>define PIC_SYM_POOL_SIZE 128</h1>

<p>```</p>

<h1>GCに関連するパラメータ</h1>

<hr />

<p>チューニング後
```C
/<em> アリーナのサイズ </em>/</p>

<h1>define PIC_ARENA_SIZE 8 * 1024</h1>

<p>/<em> ヒープページのサイズ </em>/</p>

<h1>define PIC_HEAP_PAGE_SIZE 2 * 1024 * 1024</h1>

<p>/<em> シンボルプール(ハッシュ)のサイズ </em>/</p>

<h1>define PIC_SYM_POOL_SIZE 2048</h1>

<p>```</p>

<h1>結果</h1>

<hr />

<ul>
<li><p>昔</p>

<blockquote><p>テストに16秒</p></blockquote></li>
<li><p>変更後</p>

<blockquote><p>time make test-r7rs<br/>
make test-r7rs  <strong>1.68s</strong> user 0.23s system 98% cpu 1.931 total
<!-- .element: class="fragment" data-fragment-index="1" --></p></blockquote></li>
</ul>


<h1>今後</h1>

<hr />

<ul>
<li>GCのアルゴリズムを変える</li>
<li>世代別GCにしたいよねー</li>
<li>そもそもマーク&amp;スイープの実装が適当すぎるだとか。協議中。</li>
<li>組み込み目指すならインクリメンタル性必要では？</li>
<li>オブジェクトをアロケートしないようにする

<ul>
<li>バイトコンパイルするときにもめちゃくちゃアロケートしてる。その辺どうにかする。</li>
<li><a href="https://github.com/picrin-scheme/picrin/pull/207">Fast Reader</a></li>
</ul>
</li>
</ul>


<h1>まとめ</h1>

<hr />

<ul>
<li>基本的なGCの解説をした</li>
<li>picrinのGCの戦略を話した</li>
<li>GCチューニング大事</li>
</ul>


<p><span style="font-size:600%">以上</span><br/>
何か質問あればどうぞ</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Shibuya.lisp Tech Talk #8を運営&amp;LTしてきました]]></title>
    <link href="http://KeenS.github.io/blog/2014/09/16/lisp-tech-talk-8/"/>
    <updated>2014-09-16T21:04:12+09:00</updated>
    <id>http://KeenS.github.io/blog/2014/09/16/lisp-tech-talk-8</id>
    <content type="html"><![CDATA[<p>κeenです。レポートに追われ試験があり合宿に行きで2週間以上空きましたが8/30にShibuya.lisp TT #8の運営をしつつLT枠での参加もしてきたので報告です。何かそこそこ大きなイベントの運営をされる方の参考になれば。</p>

<!-- more -->


<h1>キックオフミーティング</h1>

<p>キックオフミーティングが6月にありました。集まったのは5人。potix2(@potix2)さん、chikuさん、深町(@nitro_idiot)さんかにたん(@kazh98)、私。Shibuya.lispの運営はもうちょい居る筈なんですけど引く手数多のLisper達はきっと忙しいんでしょうね。</p>

<p>Shibuya.lisp TTを開催するかを含めて話し合いました。開催されるとなれば3年振りです。</p>

<p>一番の懸案事項はTTをする人がいるかでした。招待講演のアテを話し合ったりTT枠とLT枠のバランスを話し合ったりして開催可能だろうと判断しました。その場で予想参加人数、タイムテーブルや役割分担、TT枠やLT枠が応募多寡になったときの対応、懇親会をどうするかなどを話し合いました。</p>

<p>やっぱりその時点では会場が決まってないので不確定要素が多く、「会場次第」が多かったかと思います。そのときの予想や要求を元に会場の条件を絞った訳ですが。</p>

<p>必要と判断された役職は、</p>

<ul>
<li>懇親会</li>
<li>司会</li>
<li>誘導</li>
<li>照明</li>
<li>マイク</li>
<li>受付</li>
<li>会計</li>
<li>広報</li>
<li>動画</li>
<li>タイムキーパ</li>
<li>コーヒーのケータリングとかお茶とかお菓子の準備</li>
</ul>


<p>でした。5人だとどうしても人数が足りないので運営手伝いも募集することになりました。</p>

<h1>会場決定</h1>

<p>mixi様より(鈴木さん経由で)会場を提供頂きました。スクリーン2枚、飲食OK、懇親会もその場でOK、ハンディカムの貸し出しありの至れり尽せりです。鈴木さんありがとう御座います。</p>

<h1>広報</h1>

<p>広報担当のかにたんがTwitterやMeet Upで宣伝したりchikuさんがTokyo.cljに参加して宣伝したりで広報活動を行なってきました。結果、60人の枠がほぼ埋まる(キャンセル含めれば超過)程度の人数が集りました。かにたんありがとう。</p>

<p>懸案事項だったTTの発表者は早々に埋まり、むしろ応募多寡だろうと予想されたLT枠が半分しか埋まらなくて焦りました。</p>

<h1>ビデオ</h1>

<p>映像に詳しいTOYOZUMIさんに相談したところ、発表者の映像出力をキャプチャする手段があるとのことなので</p>

<ol>
<li>特殊機器による映像出力のキャプチャ</li>
<li>ハンディカムによる発表者の録画</li>
<li>WebカメラによるUstream配信</li>
</ol>


<p>の3つを行ない、3.はリアルタイムに、1.、2.を合成したものを録画映像として配信することになりました。一応私がビデオ担当でしたが一人では無理なのでchikuさんやかにたんと一緒に予行演習を行ないました。</p>

<p>扱いの分からぬ機器に悪戦苦闘し、一応動かすことは出来たものの不安が残るので、上手く動いたシナリオと動かなかったシナリオを用意しました。</p>

<h1>その他</h1>

<p>懇親会の手配やら会計やらがどうだったかは分かりません。何も気にすることが無い程スムーズに進んでたんでしょう。potix2さんと深町さんありがとうございます。</p>

<h1>当日</h1>

<h2>準備</h2>

<p>chikuさんと一緒に渋谷駅に集合し、ケータリングのコーヒーを持って会場入り。そのまま鈴木さんにお世話になりつつ会場設営。当初は私は会場設営はほどほどに、ビデオ関係の準備をしてる筈でしたが人が少ないのでそのまま設営をやってました。</p>

<p>さらにThunderboltケーブルが不足ということでビックカメラまでダッシュ。雪駄+合宿で痛めた足で走るんじゃなかった。結局Thunderboltを買ってきても機器を上手く扱うことが出来ず、失敗した方のシナリオでオペレーションしてました。</p>

<p>映像配信に関しては私のLinuxではUstream配信出来ないだとかWebカメラがスライドから遠くて見えないだとかがありましたが、全体は滞りなく進行。</p>

<h2>Talk</h2>

<p>TalkはLT枠は飛び入りが4人あり、結局良い感じに埋まりました。</p>

<ul>
<li>特別講演

<ol>
<li>笹川様 : 好きい夢の話 (<a href="https://drive.google.com/file/d/0B_H0_8eqWuVAY25lWGdiTGE5RmM/edit?usp=sharing">ビデオ</a>)</li>
</ol>
</li>
<li>TT

<ol>
<li>athosさん : genuine-hilighterの話 (<a href="https://drive.google.com/file/d/0B_H0_8eqWuVAZmJPaWpTMHZRUmc/edit?usp=sharing">ビデオ</a>)</li>
<li>深町さん : cl21の話 (<a href="https://drive.google.com/file/d/0B_H0_8eqWuVAcV91QXRzSC1JVXc/edit?usp=sharing">ビデオ</a>)</li>
<li>豊住さん : 自作画像処理ライブラリの話 (<a href="https://drive.google.com/file/d/0B_H0_8eqWuVATE5nZ0Z4V3Zwdms/edit?usp=sharing">ビデオ</a>)</li>
<li>横田さん : 型宣言と最適化の話 (<a href="https://drive.google.com/file/d/0B_H0_8eqWuVAYzhqZ2J5T0VKTXc/edit?usp=sharing">ビデオ</a>)</li>
</ol>
</li>
<li>LT (<a href="https://drive.google.com/file/d/0B_H0_8eqWuVAaGNLTGpTWWh0ZFU/edit?usp=sharing">ビデオ 1~4</a>、<a href="https://drive.google.com/file/d/0B_H0_8eqWuVAR21Pc2M4bmdpdlU/edit?usp=sharing">ビデオ 4~9</a>)

<ol>
<li>のぶかずさん : Shenの話</li>
<li>κeen : moclの話</li>
<li>かにたん : 床下LispとLisp Meet Upの話</li>
<li>すてぃべあさん : EROSの話</li>
<li>ねこはるさん : Clojureの型推論器の話</li>
<li>Takagiさん: cl-cudaの話</li>
<li>あんちべさん : Incanterの話</li>
<li>TAKUFUKUSHIMAさん : Omの話</li>
<li>zick_minohさん : 42の言語でLisp処理系を書いた話</li>
</ol>
</li>
</ul>


<p>と様々な内容に分かれて行われました。私の発表スライドは<a href="/slide/shibuya-dot-lisp-tt-number-8.html">ここ</a>にあります。</p>

<h2>懇親会</h2>

<p>箸が足りない、ケータリングのボットを返却し忘れるなどとトラブルはあったものの概ね問題なく進みました。出されたのはアルコール、ソフトドリンク、寿司、ピザです。</p>

<p>だいたい言語毎に島が出来てたようです。私は撮影したビデオを取り込みつつ色々な島に入っていきました。Common Lisperでcl21コミッタでScheme実装者でClojureワナビーなのでどこにも入れて良いですね。ただ、前日スライドの微調整などであまり寝てなかったのでちょいちょい居眠りしてました。</p>

<p>片付けが終って外に出るとみなさんが待ってて下さったのでぞろぞろ帰りました。TOYOZUMIさんが2次会にカラオケに行こうと皆さん誘ってました。私は行こうかと思ったのですがカラオケはジェネレーションギャップがあるとつらいので大人しく帰りました。</p>

<h1>後日</h1>

<p>返し忘れたケータリングのポットは後日chikuさんが返してくれました。</p>

<p>録画した動画はちょいと梃摺りました。まず、長い動画なので動画サイズが4GBのところで切れてます。なのでその2つを結合し、さらにあまりにサイズが大きいので画質を落とす作業が必要でした。</p>

<p>変換はavconv(ffmpegのフォーク。Ubuntuだとこれしか入らない)で行なったのですが、MPEG4をダイレクトには結合出来ないらしことに気付くまで何度も失敗しました(1つの動画の変換に4時間とか掛かるんですよ？しかもその間CPUは100%に張り付いてるのでPC使えない)。レポートやら試験やらの合間に行なったのでそれだけで数日使いました。最終的にはmpegtsなるフォーマットに変換してcatで結合すれば良いことが分かり、</p>

<pre><code>(MP4 + MP4) -&gt; (mpegts + mpegts) -&gt; mpegts -&gt; MP4 -&gt; MP4(low quality)
</code></pre>

<p>の手順を踏んで最終動画を得ました。それでも1トークあたり1GBくらいのサイズがあります。もうちょい画質落としても良かったのかな。</p>

<p>で、今アップロード中ですが私のポンコツWiMAXルータは高負荷に耐えられず1動画数時間掛かってます。その間全くネットが使えません。はぁ。</p>

<p>実は今回の運営は私も含めTech Talk初参加の人がそれなりに居たのですがなんとか乗り切れましたね。講演をして下さった笹川様、会場を提供して下さったmixi様と鈴木さん、運営の手伝いをして下さった方々、ありがとう御座いました。そして運営のみなさん、発表者のみなさんお疲れ様でした。</p>

<p>次回もTT開催出来ると良いですね。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Introduction to CIM]]></title>
    <link href="http://KeenS.github.io/slide/introduction-to-cim.html"/>
    <updated>2014-08-30T04:33:00+09:00</updated>
    <id>http://KeenS.github.io/slide/introduction-to-cim.markdown</id>
    <content type="html"><![CDATA[<h1>Introduction to CIM</h1>

<hr />


<p>κeen(@blackenedgold)</p>

<h2>突然ですが</h2>

<p>Common Lispのスクリプトファイルの実行方法知ってますか？</p>

<p>sbcl</p>

<pre><code>sbcl --script $file
</code></pre>

<p>ecl</p>

<pre><code>ecl -shell $file
</code></pre>

<p>ccl</p>

<pre><code>ccl -e $file -e '(quit)'
</code></pre>

<p>&hellip;</p>

<p><strong>シバン可搬性のあるスクリプトが書けない</strong></p>

<h2>そこで、こんなの書きました</h2>

<hr />


<p>```sh
case &ldquo;$LISP_IMPL&rdquo; in</p>

<pre><code>sbcl*)
    sbcl --script $1
    ;;
clisp*)
    clisp -on-error exit -i $1
    ;;
ecl*)
    ecl -shell $1
    ;;
ccl*)
</code></pre>

<p>&hellip;
```</p>

<h2>でも問題がある</h2>

<hr />


<ul>
<li>どの処理系をバックエンドに使うか</li>
<li>処理系のパスをどう捜すか</li>
<li>そもそもどうやって使ってもらうか</li>
</ul>


<h2>κeenの答え</h2>

<hr />


<blockquote><p>処理系の管理までやってしまおう。
そうしたら一緒に使ってもらえる。</p></blockquote>

<p>＿人人人人人人＿<br/>
＞　CIMの誕生　＜<br/>
￣Y<sup>Y</sup><sup>Y</sup><sup>Y</sup><sup>Y</sup>￣</p>

<h2>CIMとは</h2>

<hr />


<ul>
<li>Common Lisp Implementation Manager</li>
<li>ちむ</li>
<li>Rubyのrvmを強く意識</li>
<li>Common Lisp処理系のインストール、切り替え、コマンドラインインターフェースなど。</li>
<li><code>cim</code>、 <code>cl</code>、 <code>ql</code>コマンドから成る</li>
<li>B Shell スクリプト製(マルチプラットフォーム対応のため)</li>
<li>2013/10くらいからぼちぼち開発</li>
</ul>


<h2><code>cim</code>コマンドについて</h2>

<hr />


<p>インストール</p>

<pre><code>cim install sbcl
</code></pre>

<p>バックエンドの切り替え</p>

<pre><code>cim use sbcl
</code></pre>

<p>現在情報</p>

<pre><code>cim info
</code></pre>

<p>CIMのアップデート</p>

<pre><code>cim get
</code></pre>

<p>など。</p>

<h2><code>cl</code>コマンドについて</h2>

<hr />


<ul>
<li>最初に紹介したシェルスクリプトベース</li>
<li>コマンドラインからCommon Lispを使うことを重視</li>
<li>シバン対応も。</li>
<li>REPLは独自実装(デバッガを黙らせるのが主な目的)</li>
<li>オプションはrubyを意識</li>
</ul>


<h2>少しシバンの話</h2>

<hr \>


<h3>だめな例</h3>

<p>```lisp</p>

<h1>!cl</h1>

<p>(write-line &ldquo;ok&rdquo;)
<code>
</code>lisp</p>

<h1>!/home/kim/.cim/bin/cl</h1>

<p>(write-line &ldquo;ok&rdquo;)
<code>
</code>lisp</p>

<h1>!/usr/bin/env cl -q</h1>

<p>(write-line &ldquo;ok&rdquo;)
```</p>

<h3>推奨される例</h3>

<p>```lisp</p>

<h1>!/bin/sh</h1>

<h1>|</h1>

<p>exec cl &mdash;  &ldquo;$0&rdquo; &ldquo;$@&rdquo;
|#
(write-line &ldquo;ok&rdquo;)
```</p>

<h2><code>ql</code>コマンドについて</h2>

<hr />


<ul>
<li>quicklispのコマンドラインインターフェース</li>
<li>まだ未熟</li>
<li>rubyのgem的な。</li>
<li>最近<code>ql install</code>を高速化</li>
</ul>


<h2>その他の話</h2>

<hr />


<h3>対応処理系</h3>

<ul>
<li>処理系はabcl, alisp, ccl, clisp, ecl, sbcl対応</li>
<li>基本ビルドする</li>
<li>gclはANSIじゃないのでドロップ</li>
<li>lispworks他商用ははインストール出来ないのでドロップ</li>
<li>mkcl対応する？</li>
<li>CMU CLはつらい…</li>
</ul>


<h3>実装</h3>

<ul>
<li>B Shell スクリプトで書いたの失敗だった?</li>
<li>つらい</li>
<li>開発速度に影響</li>
<li>テスト（=品質）にも影響</li>
<li>sbclがじゃじゃ馬でつらい</li>
</ul>


<h3>方針</h3>

<ul>
<li>コマンドラインユーティリティである</li>
<li>基本POSIX以外に依存しない</li>
<li>極力環境に影響しない(rvmがひどいのを嫌って)</li>
<li>clコマンドはあくまで薄いラッパ</li>
<li>asdfも使わない</li>
</ul>


<h2><a href="http://www.slideshare.net/blackenedgold/cim-common-lisp-implementation-manager?ref=http://keens.github.io/blog/2014/01/24/lisp-meet-up-number-13/">半年前</a>から何が変わったか</h2>

<hr />


<ul>
<li>バグ潰し</li>
<li>その他細かな改善

<ul>
<li>ダンプされたコアを読み込む機能</li>
<li>SIGINTをハンドル</li>
<li>ビルド時のログ制御</li>
</ul>
</li>
<li>ぼちぼちテスト書き始めた</li>
</ul>


<h2>将来の話</h2>

<hr />


<ul>
<li>テストと品質の安定化</li>
<li>バイナリ配布の処理系は大人しくバイナリ使う？</li>
<li>最適なビルドオプション</li>
<li>コアダンプ機能</li>
<li>Lispスクリプト(実行可能ファイル)インストーラ</li>
<li>cl21との連携（バイナリ生成）</li>
<li>もうちょっとquicklispとの連携</li>
<li>ユーザー拡張</li>
</ul>


<h2>関連リソース</h2>

<hr />


<ul>
<li><a href="http://pupeno.com/2007/08/26/the-problem-with-lisp/">The problem with Lisp </a> : Lispはコマンドが作れないから流行らないという分析</li>
<li><a href="http://keens.github.io/blog/2014/01/27/cim-explanation/">CIMの解説をしてみる コマンド編 | κeenのHappy Hacκing Blog</a> : CIMの解説記事</li>
<li><a href="https://github.com/fukamachi/shelly">shelly</a> : CIMを使うCLのコマンドラインインターフェース</li>
<li><a href="https://github.com/snmsts/lsp">lsp</a> : CIMのC実装</li>
<li><a href="https://github.com/fukamachi/qlot">qlot</a> : <code>ql</code>よりリッチなquicklispラッパ</li>
</ul>


<p><span style="font-size:600%">以上</span><br/>
何か質問あればどうぞ</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[授業で半年間moclを使ってみた]]></title>
    <link href="http://KeenS.github.io/slide/shibuya-dot-lisp-tt-number-8.html"/>
    <updated>2014-08-28T17:05:00+09:00</updated>
    <id>http://KeenS.github.io/slide/shibuya-dot-lisp-tt-number-8.markdown</id>
    <content type="html"><![CDATA[<h1>授業で半年間moclを使ってみた</h1>

<hr />


<p>Shibuya.lisp TT #8</p>

<br>


<p>κeen(@blackenedgold)</p>

<h2>自己紹介</h2>

<hr />


<ul>
<li>κeen</li>
<li>東大数学科の4年生</li>
<li>ソーシャルアカウントは上のアイコン達から。</li>
<li>Lisp, Ruby, OCaml, Shell Scriptあたりを書きます</li>
</ul>


<p> 一年前</p>

<h2><a href="http://ks.ms.u-tokyo.ac.jp/">計算数学II</a></h2>

<p><img src="/images/shibuya_lisp_TT8/calculation_math.png" alt="計算数学IIのホームページ" /></p>

<p>自分でテーマを決めて半年間取り組む</p>

<p>チーム<a href="https://sites.google.com/site/2013ks2/home">人造エイリアン</a>
<img src="/images/shibuya_lisp_TT8/android_alien.png" alt="チーム人造エイリアン" /></p>

<h2>Common Lisp でAndroid?</h2>

<h2><a href="https://wukix.com/mocl">mocl</a></h2>

<p><img src="/images/shibuya_lisp_TT8/mocl.png" alt="mocl home" /></p>

<h2>What is mocl</h2>

<hr />


<ul>
<li>iOS, Androidで動くCommon Lisp処理系</li>
<li>LLVMをバックエンドに使う</li>
<li>Networking, Unicode, CLOS, and More. Run Countless CL Libraries.</li>
</ul>


<h2>買ってもらった(・ω・)v</h2>

<p><img src="/images/shibuya_lisp_TT8/mocl_ut.png" alt="mocl home" /></p>

<h2>注意</h2>

<hr />


<p>私が触ったのは1つ前のバージョンです。</p>

<p>一部5月のアップデートで改善されています。</p>

<h2>How it Works</h2>

<hr \>


<p><embed src="http://KeenS.github.io/images/shibuya_lisp_TT8/mocl_flowchart.svg" type="image/svg+xml" height="500px" /></p>

<h2>コードサンプル</h2>

<hr \>


<p>授業で私が作ったオセロのAIのコード
```java
public BoardCanvas(Context context,int width, int height,int color ){</p>

<pre><code>...
CL.cl_init();
CL.init_game(3 - color);
...
</code></pre>

<p>}</p>

<p>void nextHand(){</p>

<pre><code>String[] coord = CL.next().split(" ");
CL.jput(Integer.parseInt(coord[0]), Integer.parseInt(coord[1]) , color);
...
</code></pre>

<p>}
```</p>

<p>```lisp
(declaim (call-in next))
(defun next ()
  (let ((dummy (make-board))</p>

<pre><code>    (max most-negative-fixnum)
    (x) (y) (score))
...
))
</code></pre>

<p>(declaim (call-in init-game))
(defun init-game (color)
  (setf <em>board</em> (make-board))
  (setf <em>ai</em> color))
(declaim (call-in jput))
(defun jput (x y color)
  (put <em>board</em> x y color))
```</p>

<h2>ライブラリについて</h2>

<hr />


<ul>
<li>ASDFが使える</li>
<li><code>MOCL_HOME/systems/</code>以下に配置</li>
<li>quicklispでインストールしたやつは<code>MOCL_HOME/systems/</code>にひたすら<code>ln -s</code></li>
<li>大抵のライブラリは動かない</li>
</ul>


<p>例えば<code>cl-annot</code>を使って
<code>lisp
(declaim (call-in jput))
(defun jput (x y color)
  (put *board* x y color))
</code>
を
<code>lisp
@call-in
(defun jput (x y color)
  (put *board* x y color))
</code>
としたい</p>

<p>私のときはCFFIを始め、ironclad、cl-annotなど、<br/>
使おうとしたライブラリは全て動かなかった</p>

<p>現在の状態は不明</p>

<h2>作業フロー(Android)</h2>

<hr />




<ol>
<li>CLのコードを書いてSBCLで動かす</li>
<li>ある程度動いたらmoclでAndroid用のコードを生成</li>
<li>原因不明のエラーが出るので1に戻る</li>
<li>コンパイルが通れば生成されたCをコンパイル</li>
</ol>




<ol start="5">
<li>JavaからCLを呼び出すコードを書く</li>
<li>アプリをコンパイル</li>
<li>実機/エミュレータに転送</li>
</ol>




<ol start="8">
<li>動かす</li>
<li>動かない</li>
<li>ひたすらlogcat眺める</li>
<li>1に戻る</li>
</ol>


<h3>ここがつらい</h3>

<hr />


<ul>
<li>作業が煩雑</li>
<li>例外のスタックトレースがJNIのせいで追いづらい</li>
<li>logを出すには<code>rt:format</code>という関数のみ使える(ログレベルを設定出来ない)</li>
</ul>


<p>※ 今はREPLが端末で動くので環境は良くなっています。</p>

<h2>制限など</h2>

<hr />


<ul>
<li>Java/Obj-CからCLを呼ぶことしか出来ない

<ul>
<li>プラットフォームのライブラリも呼べない</li>
</ul>
</li>
<li>やりとり出来るのは文字列、数値、真偽値のみ

<ul>
<li>裏でタスクを回すworker的な役割or純粋関数的な役割のみ</li>
</ul>
</li>
</ul>


<p>※ 今はCLからObj-Cを呼ぶことが出来ます。</p>

<h2>成果物</h2>

<hr />


<ul>
<li><a href="https://gist.github.com/KeenS/15e7bb35519818c88c13">コード(抜粋)</a></li>
<li><a href="http://www.slideshare.net/blackenedgold/ss-30373688">最終発表スライド</a></li>
<li><a href="http://www.slideshare.net/blackenedgold/ss-30373688">デモ動画</a></li>
</ul>


<h2>おまけ</h2>

<h2>5月のアップデート内容</h2>

<hr />


<ul>
<li>OS Xアプリケーション対応</li>
<li>端末内でREPLが動く</li>
<li>FFI強化</li>
<li>Lisp内Obj-C構文</li>
<li>iOSとOS XでのネイティブSSL対応</li>
<li>ARM64サポート</li>
<li>ドキュメントの改善</li>
<li>多くのバグフィクス</li>
</ul>


<p><span style="font-size:600%">以上</span><br/>
何か質問あればどうぞ</p>
]]></content>
  </entry>
  
</feed>
