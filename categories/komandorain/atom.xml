<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: コマンドライン | κeenのHappy Hacκing Blog]]></title>
  <link href="http://KeenS.github.io/categories/komandorain/atom.xml" rel="self"/>
  <link href="http://KeenS.github.io/"/>
  <updated>2014-08-30T15:54:02+09:00</updated>
  <id>http://KeenS.github.io/</id>
  <author>
    <name><![CDATA[κeen]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Mpd 小ネタ]]></title>
    <link href="http://KeenS.github.io/blog/2014/01/21/mpd-something/"/>
    <updated>2014-01-21T02:29:00+09:00</updated>
    <id>http://KeenS.github.io/blog/2014/01/21/mpd-something</id>
    <content type="html"><![CDATA[<p>mpdのちょっとした便利な使い方。</p>

<!-- more -->


<p><code>at</code>がRSPiにインストールされてる前提で、RSPi上で</p>

<pre><code>$ at 7:00
at&gt; mpc toggle
^D
</code></pre>

<p>とすればRSPiを目覚ましや時報として使えます。停止にはsshログインして<code>mpc toggle</code>する必要があるのでそこまでする頃には起きてる筈。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Rsync小ネタ]]></title>
    <link href="http://KeenS.github.io/blog/2013/11/30/something-about-rsync/"/>
    <updated>2013-11-30T21:51:00+09:00</updated>
    <id>http://KeenS.github.io/blog/2013/11/30/something-about-rsync</id>
    <content type="html"><![CDATA[<p><a href="/blog/2013/11/13/what-recent/">mpdを導入したとき</a>にrsyncでパーミッションの問題が発生したと言ってましたが解決策がありました。</p>

<!-- more -->


<p>まず基本。</p>

<p><code>rsync</code>でバックアップをとるときは</p>

<pre><code>rsync -avz dir/ me@remote:backup
</code></pre>

<p>です。<code>dir</code>のあとの<code>/</code>は重要です。<code>dir</code>自体か<code>dir</code>の中身かを左右します。<code>zsh</code>はそこんとこイマイチ理解してないようで悲しいです。因みに<code>-a</code>は<code>-rltogpD</code>の略です。でも今回みたいにパーミッションを含めたくないときは</p>

<pre><code>rsync -rltogD -vz dir/ me@remote:backup
</code></pre>

<p>と<code>-p</code>を抜くかと思いきや、</p>

<pre><code>rsync -avz --no-p dir/ me@remote:backup
</code></pre>

<p>なる記法があるそうです。便利ですね。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ここ１ヶ月くらいの近況]]></title>
    <link href="http://KeenS.github.io/blog/2013/11/13/what-recent/"/>
    <updated>2013-11-13T21:20:00+09:00</updated>
    <id>http://KeenS.github.io/blog/2013/11/13/what-recent</id>
    <content type="html"><![CDATA[<p> #isucon 参戦記がフォロワーの多い@tagomorisさんとか@nitro_idiotさんとかにツイートされて普段の数十倍のアクセスが来てテンション上がったので近況書きますね。</p>

<!-- more -->


<h2>isuconの勉強</h2>

<p>件の記事でも書いてますけどMySQLとNginXとCapistranoの勉強しました。SQLって書けると案外楽しいですね。あとN+1問題を学んだり、<code>IF EXISTS TRRIGER</code>的な文がなくて殺そうかと思ったり。</p>

<p>NginXはキャッシュとかですね。キャッシュキーに<code>$cookie_isucon_session</code>とか入れてログインしてるユーザーが来ても対応できたので良かったです（小並感</p>

<p>Capistranoはどうせだからと3.0を使ったのですが調べても2.x時代の情報ばっかり引っ掛かって苦労しました。その代わり、isucon本戦では複数サーバーへのデプロイ機能を存分に使わせて頂きました。ほぼログインしなくても問題ないですね。</p>

<p>例えば</p>

<p><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr>
<td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
</pre></td>
<td class="code"><pre><code class="ruby"><span class="line"><span class="n">set</span> <span class="ss">:application</span><span class="p">,</span> <span class="s1">&lsquo;my app&rsquo;</span>
</span><span class="line"><span class="n">set</span> <span class="ss">:repo_url</span><span class="p">,</span> <span class="s1">&lsquo;git@bitbucket.org:me/myrepo.git&rsquo;</span>
</span><span class="line"><span class="n">set</span> <span class="ss">:deploy_to</span><span class="p">,</span> <span class="s1">&lsquo;/home/me/app&rsquo;</span>
</span><span class="line"><span class="n">set</span> <span class="ss">:scm</span><span class="p">,</span> <span class="ss">:git</span>
</span><span class="line"><span class="n">set</span> <span class="ss">:deploy_via</span><span class="p">,</span> <span class="ss">:remote_cache</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="n">namespace</span> <span class="ss">:nginx</span> <span class="k">do</span>
</span><span class="line"> <span class="n">task</span> <span class="ss">:reload</span> <span class="k">do</span>
</span><span class="line"> <span class="n">on</span> <span class="n">roles</span><span class="p">(</span><span class="ss">:web</span><span class="p">)</span> <span class="k">do</span>
</span><span class="line"> <span class="n">execute</span> <span class="ss">:sudo</span><span class="p">,</span> <span class="s1">&lsquo;service nginx reload&rsquo;</span>
</span><span class="line"> <span class="k">end</span>
</span><span class="line"> <span class="k">end</span>
</span><span class="line">
</span><span class="line"> <span class="n">task</span> <span class="ss">:restart</span> <span class="k">do</span>
</span><span class="line"> <span class="n">on</span> <span class="n">roles</span><span class="p">(</span><span class="ss">:web</span><span class="p">)</span> <span class="k">do</span>
</span><span class="line"> <span class="n">execute</span> <span class="ss">:sudo</span><span class="p">,</span> <span class="s1">&lsquo;service nginx restart&rsquo;</span>
</span><span class="line"> <span class="k">end</span>
</span><span class="line"> <span class="k">end</span>
</span><span class="line">
</span><span class="line"> <span class="n">task</span> <span class="ss">:start</span> <span class="k">do</span>
</span><span class="line"> <span class="n">on</span> <span class="n">roles</span><span class="p">(</span><span class="ss">:web</span><span class="p">)</span> <span class="k">do</span>
</span><span class="line"> <span class="n">execute</span> <span class="ss">:sudo</span><span class="p">,</span> <span class="s1">&lsquo;service nginx start&rsquo;</span>
</span><span class="line"> <span class="k">end</span>
</span><span class="line"> <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td>
</tr></table></div></figure></p>

<p>こんな感じです。で、もう一つ</p>

<p><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr>
<td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td>
<td class="code"><pre><code class="ruby"><span class="line"><span class="n">set</span> <span class="ss">:stage</span><span class="p">,</span> <span class="ss">:production</span>
</span><span class="line"><span class="n">server</span> <span class="s1">&lsquo;123.4.5.67&rsquo;</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="s1">&lsquo;me&rsquo;</span><span class="p">,</span> <span class="ss">roles</span><span class="p">:</span> <span class="s1">&lsquo;web&rsquo;</span>
</span><span class="line"><span class="n">server</span> <span class="s1">&lsquo;123.4.5.68&rsquo;</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="s1">&lsquo;me&rsquo;</span><span class="p">,</span> <span class="ss">roles</span><span class="p">:</span> <span class="s1">&lsquo;web&rsquo;</span>
</span><span class="line"><span class="n">server</span> <span class="s1">&lsquo;123.4.5.69&rsquo;</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="s1">&lsquo;me&rsquo;</span><span class="p">,</span> <span class="ss">roles</span><span class="p">:</span> <span class="s1">&lsquo;web&rsquo;</span>
</span><span class="line"><span class="n">set</span> <span class="ss">:ssh_options</span><span class="p">,</span> <span class="p">{</span>
</span><span class="line"> <span class="ss">keys</span><span class="p">:</span> <span class="sx">%w(~/.ssh/id_rsa)</span><span class="p">,</span>
</span><span class="line"> <span class="n">forward_agent</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span>
</span><span class="line"> <span class="n">auth_methods</span><span class="p">:</span> <span class="sx">%w(publickey)</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td>
</tr></table></div></figure></p>

<p>を書いておけばこの3台のサーバーに一斉にデプロイしてくれます。(上の例だとnginxですが、まあいいでしょう。)</p>

<h2>Shibuya.lisp</h2>

<p>Lisp Meet Up #10で発表してきました。内容は<code>fluentd</code>をCommon Lispから使う話。<br/>
スライド</p>

<iframe src="http://www.slideshare.net/slideshow/embed_code/27444839" width="427" height="356" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" style="border:1px solid #CCC;border-width:1px 1px 0;margin-bottom:5px" allowfullscreen> </iframe>


<p> <strong><a href="https://www.slideshare.net/blackenedgold/common-lisp-27444839" title="Common Lisp でビッグデータを作ろう">Common Lisp でビッグデータを作ろう</a></strong> from <strong><a href="http://www.slideshare.net/blackenedgold">blackenedgold</a></strong></p>

<p>Ustreamは見つかりませんでした。てへペロ</p>

<p>恐らく、<code>Log4CL</code>はやりたいことと目的が違いますね。全く別のロギングフレームワークを作るのが良さげな気がします。isuconの懇親会で開発者の@tagomorisさんにアドバイスも頂きましたし作るかもしれません。</p>

<h2>mpd</h2>

<p><a href="/blog/2013/09/29/mplayer/">以前、mplayer2が正常に動作しないとかぼやいて</a>ましたが、結局あきらめました。で、代わりに <a href="http://www.musicpd.org/">Music Player Daemon(MPD)</a>なるものを見付けて、しかもRaspberry Piで動き、iPod/Androidから操作できるとのことで、導入しました。</p>

<p>MPDはまさしくRaspberry Piのような機器向で、音楽を鳴らすサーバーと操作するクライアントが完全に分かれてます。</p>

<pre><code>$ sudo apg-get install mpd mpc
</code></pre>

<p>とかでRSPiに入れた気がします。クライアントはAndroidは<code>MPDroid</code>、iPodは<code>MPoD</code>っていうアプリです。</p>

<p><code>scp</code>で手元の曲をRSPiコピーし、iPodから繋ぐも曲が見えない。色々試した結果、<code>scp</code>でコピーしたときにパーミッションの問題が出てたようなのでそこを解決したらちゃんと動きました。</p>

<p>動画(iPod)</p>

<iframe width="560" height="315" src="//www.youtube.com/embed/x5CWtXbCkqo" frameborder="0" allowfullscreen></iframe>


<p>黒ばっかで見づらくて申し訳ありません。iPodからではなくスピーカから音が出てるのが分かりますかね？思ったより音が入ってないので分りづらいですね（汗</p>

<h2>CIM</h2>

<p><a href="https://github.com/fukamachi/shelly/">Shelly</a>を使って <a href="https://gist.github.com/KeenS/7059301">Common Lispスクリプトをexecutableにしよう</a>ってのをやってましたが少しshellyが求めているのと違うようだったので「シェルスクリプトでshelly的な物を実装しよう！ついでにrvmみたいにバージョン管理できたら嬉しいな！！」って思い付きで <a href="https://github.com/KeenS/CIM">Common Lisp Implementation Manager(CIM)</a>を作り始めました。まだCLISP, ECL, GCLのインストールぐらいしかできてません。</p>

<p>初めてシェルスクリプトを書き、初めてBourne Shellを触り(普段はzsh)、早くも挫折しそうです。今めっちゃシェルスクリプトの勉強してます。目的はImplementationの管理じゃなくて統一インターフェースの<code>cl</code>コマンドなのにそこが全然進んでないですね。<code>ql</code>に至っては1行も書いてない。まあ、<code>cl</code>を使って書くつもりなので<code>cl</code>が出来ないことにはどうしようもないんですが。</p>

<p><code>syset</code>とかネーミングセンスが無かったり(発音しずらい。シセット…サイセットって読もうかな)ダウンロードしたアーカイブのチェックサムとか全く見てなかったり色々ツッコみたくなりますが温かい目で見て下さい。気に入ったらpull-reqとかして下さい。</p>

<h2>Octomacs</h2>

<p>Octomacsに一回pull-req送ってからコミッタ気取りのκeenですが、<code>octomacs-preview</code>と<code>octomacs-deploy</code>を実装しました。<code>C-u</code>をつけると<code>generate</code>が付いてきます。テストをしてない（できない？）+サーバーを殺す(<code>octomacs-preview-quit</code>とかの名前かなあ。現状は<code>*octomacs preview*</code>バッファを<code>kill-buffer</code>すればいい)コマンドを実装してないのでpull-reqは投げてませんが使ってみたい方は <a href="https://github.com/KeenS/octomacs">こちら</a>をどうぞ。まあ、今からpushするんですがね。ちゃんとこの記事も<code>octomacs-new-post</code>から始まり、<code>octomacs-preview</code>で確認しつつ<code>octomacs-deploy</code>でデプロイしました。あとは過去の記事を編集する<code>octomacs-edit</code>を実装すれば完璧ですね。</p>

<p>こんなかんじです。<code>CIM</code>がんばります。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Shellyを使ってCommon LispファイルをExecutableにする]]></title>
    <link href="http://KeenS.github.io/blog/2013/09/26/shelly-script/"/>
    <updated>2013-09-26T21:25:00+09:00</updated>
    <id>http://KeenS.github.io/blog/2013/09/26/shelly-script</id>
    <content type="html"><![CDATA[<p>コマンドラインからCommon Lispの関数を実行できる <a href="https://github.com/fukamachi/shelly">Shelly</a>を使ってCommon Lispファイルを実行形式にしてみました。Shellyは</p>

<pre><code>$ shly + 1 2
3
</code></pre>

<p>みたいに関数を実行できます。</p>

<!-- more -->


<p>モチベーションとしては、 <a href="http://blog.8arrow.org/entry/20120521/1337596483">Shellyの作者深町さん</a>がTwitterで「Shellyでloadを使うとスクリプトみたいに実行できる」と発言していたのがきっかけで、Shebangを無視できればUNIX系ではExecutableにできるのでは？と思いついてやってみました。</p>

<p><code>read</code>して<code>eval</code>して…とか考えてましたが、<code>load</code>に<code>stream</code>を渡せるようなので案外簡単にできました。</p>

<script src="https://gist.github.com/KeenS/6688683.js?file=script.lisp"></script>


<p><noscript><pre><code>(in-package :shelly)
(export (defvar <em>argv</em> nil))
(in-package :cl-user)</p>

<p>(defun script (file argv)
  &ldquo;Execute a file as script ignoring shebang&rdquo;
  (setf shelly:<em>argv</em> argv)
  (let* ((in (open file :if-does-not-exist :error))</p>

<pre><code> (first-char (read-char in))
 (second-char (read-char in)))
(cond
  ((and (char= first-char #\#) (char= second-char #\!))
   (read-line in))
  (t (unread-char second-char in)
 (unread-char first-char in)))
(load in)
(values)))
</code></pre>

<p></code></pre></noscript></p>

<p>コマンドライン引数を受け取るために<code>*argv*</code>という変数を用意してます。</p>

<p>こんなことを<code>~/.shelly/Shellyfile</code>に書いておき、Lispの初期化ファイルに</p>

<pre><code>#+shelly
(load "~/.shelly/Shellyfile")
</code></pre>

<p>と書いてます。この<code>~/.shelly/Shellyfile</code>にはShelly向けの関数を溜め込んでいく予定です。</p>

<p>あとは</p>

<p><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr>
<td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td>
<td class="code"><pre><code class="common-lisp"><span class="line"><span class="err">#</span><span class="nv">!shly</span> <span class="nv">script</span>
</span><span class="line">
</span><span class="line"><span class="p">(</span><span class="nb">defun</span> <span class="nv">hello</span> <span class="p">()</span>
</span><span class="line"> <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&ldquo;Hello ~a~%&rdquo;</span> <span class="p">(</span><span class="nb">first</span> <span class="nv">shelly:<em>argv</em></span><span class="p">)))</span>
</span><span class="line"><span class="p">(</span><span class="nv">hello</span><span class="p">)</span>
</span></code></pre></td>
</tr></table></div></figure></p>

<p>を<code>foo.lisp</code>に書き込めば</p>

<pre><code>$ chmod u+x foo.lisp
$./foo.lisp κeen
Hello κeen
</code></pre>

<p>と実行できます。勿論、</p>

<pre><code>$shly script foo.lisp κeen
</code></pre>

<p>としても同じです。一部の処理系ではこのようなことが出来ますが、コマンドライン引数の渡し方とかも処理系依存なのでポータブルに書くなら一つ試してみてはいかがでしょうか。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[PDFユーティリティ]]></title>
    <link href="http://KeenS.github.io/blog/2013/09/03/pdftk/"/>
    <updated>2013-09-03T23:34:00+09:00</updated>
    <id>http://KeenS.github.io/blog/2013/09/03/pdftk</id>
    <content type="html"><![CDATA[<p>小ネタ。コマンドラインからPDFを編集した話の備忘録。</p>

<!-- more -->


<p><a href="http://www.seeds-std.co.jp/seedsblog/181.html">こちら</a>に紹介されてるように、pdftkというツールである程度のことはできる。</p>

<pre><code>$sudo apt-get install pdftk
</code></pre>

<p>でインストール可能。<br/>
今回は</p>

<pre><code>$for pdf in *.pdf
&gt;&gt;do
&gt;&gt; pdftk $pdf cat 1-endR output `basename $pdf .pdf`_rot.pdf
&gt;&gt;done
</code></pre>

<p>で全てのPDFの全てのページを右周りに回転し、名前に_rotを付けて保存した。</p>

<pre><code>pdftk *.pdf cat output all.pdf
</code></pre>

<p>とかで結合なんかもできて便利。</p>
]]></content>
  </entry>
  
</feed>
