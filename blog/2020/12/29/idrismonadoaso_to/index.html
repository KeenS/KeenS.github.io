<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
    <head>
        
        
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-43779888-1"></script>
        <script>
         window.dataLayer = window.dataLayer || [];
         function gtag(){dataLayer.push(arguments);}
         gtag('js', new Date());

         gtag('config', 'UA-43779888-1');
        </script>
        

        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

        <meta name="twitter:site" content="@blackenedgold" />
        <meta name="twitter:title" content="Idrisモナドアソート | κeenのHappy Hacκing Blog"/>
        <meta name="twitter:description" content="この記事は去年末に書いていた記事です。
執筆中にパソコンがクラッシュして修理に1ヶ月くらいかかったので公開が遅くなりました。
それを踏まえて記事をご覧下さい。
κeenです。 そろそろAdvent Calendarも終盤になってきましたね。
今回は前回の標準ライブラリ紹介であえて外したモナドについて紹介します。" />
        <meta property="og:title" content="Idrisモナドアソート | κeenのHappy Hacκing Blog" />
        <meta property="og:type" content="article" />
        <meta property="og:url" content="https://KeenS.github.io/blog/2020/12/29/idrismonadoaso_to/" />
        <meta property="og:description" content="この記事は去年末に書いていた記事です。
執筆中にパソコンがクラッシュして修理に1ヶ月くらいかかったので公開が遅くなりました。
それを踏まえて記事をご覧下さい。
κeenです。 そろそろAdvent Calendarも終盤になってきましたね。
今回は前回の標準ライブラリ紹介であえて外したモナドについて紹介します。" />
        <meta name="twitter:card" content="summary_large_image" />
        <meta property="og:image" content="https://KeenS.github.io/images/ogp/post/Idrismonadoaso_to.png" />
        <meta name="twitter:image" content="https://KeenS.github.io/images/ogp/post/Idrismonadoaso_to.png" />
        
        <meta property="og:article:published_time" content="2020-12-29 12:44:30 &#43;0900 JST" />
        <meta property="og:article:modified_time" content="2020-12-29 12:44:30 &#43;0900 JST" />
        
        <meta property="og:article:author" content="κeen" />

        <title>Idrisモナドアソート | κeenのHappy Hacκing Blog</title>
        <link rel="stylesheet" href='//fonts.googleapis.com/css?family=Open+Sans:400,300,600' type='text/css' />
        <link rel="stylesheet" href="https://KeenS.github.io/libraries/normalize.3.0.1.css" />
        <link rel="stylesheet" href="https://KeenS.github.io/css/liquorice.css" />
        <link rel="apple-touch-icon" sizes="180x180" href="https://KeenS.github.io/apple-touch-icon.png">
        <link rel="icon" type="image/png" href="https://KeenS.github.io/favicon-32x32.png" sizes="32x32">
        <link rel="icon" type="image/png" href="https://KeenS.github.io/favicon-16x16.png" sizes="16x16">
        <link rel="manifest" href="https://KeenS.github.io/manifest.json">
        <link rel="mask-icon" href="https://KeenS.github.io/safari-pinned-tab.svg" color="#5bbad5">
        <meta name="theme-color" content="#ffffff">
        <link rel="apple-touch-icon-precomposed" href="https://KeenS.github.io/apple-touch-icon-144-precomposed.png" sizes="144x144" />
        <link rel="stylesheet" href="https://KeenS.github.io/css/syntax-monokai.css" />
<script type="text/x-mathjax-config">
 MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ["\\(","\\)"]] } });
</script>
<script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_CHTML"></script>
</script>
<meta http-equiv="X-UA-Compatible" CONTENT="IE=EmulateIE7" />
<link rel="stylesheet" href="//unpkg.com/mermaid@7.0.4/dist/mermaid.forest.min.css">

    </head>
    <body class="li-body">

<header class="li-page-header" id="page-header">
    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <div class="li-brand li-left">
                <a href="https://KeenS.github.io/">κeenのHappy Hacκing Blog</a> | Lispエイリアンの狂想曲</div>
                <div class="li-menu li-right">
                    <span class="li-menu-icon" onclick="javascript:toggle('menu');">&#9776;</span>
                    <ul id="menu2" class="li-menu-items">
                        
                            <li><a href="https://KeenS.github.io/about/"> About </a></li>
                        
                            <li><a href="https://KeenS.github.io/post/"> Blog </a></li>
                        
                            <li><a href="https://KeenS.github.io/slide/"> Slide </a></li>
                        
                            <li><a href="https://KeenS.github.io/index.xml"> Atom </a></li>
                        
                            <li><a href="https://KeenS.github.io/search/"> Search </a></li>
                        
                    </ul>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="sixteen columns">
                <ul id="menu" class="li-menu-items li-menu-mobile">
                    
                        <li><a href="https://KeenS.github.io/about/"> About </a></li>
                    
                        <li><a href="https://KeenS.github.io/post/"> Blog </a></li>
                    
                        <li><a href="https://KeenS.github.io/slide/"> Slide </a></li>
                    
                        <li><a href="https://KeenS.github.io/index.xml"> Atom </a></li>
                    
                        <li><a href="https://KeenS.github.io/search/"> Search </a></li>
                    
                </ul>
            </div>
        </div>
    </div>
</header>






    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <article class="li-article">
                    <header class="li-article-header">
                        <h1 class="li-article-title">Idrisモナドアソート</h1>
                        <div class="li-article-meta">
    <time class="li-article-date">2020-12-29</time>
    <ul class="li-article-tag">
    
        <li>
            <a href="https://KeenS.github.io/categories/idris">Idris</a>
        </li>
    
</ul>

</div>

                    </header>
                    <section>
                        <p>この記事は去年末に書いていた記事です。
執筆中にパソコンがクラッシュして修理に1ヶ月くらいかかったので公開が遅くなりました。
それを踏まえて記事をご覧下さい。</p>
<p>κeenです。 そろそろAdvent Calendarも終盤になってきましたね。
今回は前回の標準ライブラリ紹介であえて外したモナドについて紹介します。</p>
<p><code>Monad</code>（ や <code>Applicative</code> ）には便利な記法が用意されているのである型がモナドを実装しているかどうかは大きな関心ごとになります。
また、「モナド」として提供されている型もあるのでそれらについて紹介していきます。
例によってpreludeとbaseの中から紹介していきます。</p>
<h2 id="preludelist"><code>Prelude.List</code></h2>
<p>おなじみですね。</p>
<p>以下のコードは九九の計算を全部やります。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl"><span class="kr">do</span>
</span></span><span class="line"><span class="cl">  x <span class="ow">&lt;-</span> <span class="ow">[</span><span class="mi">1</span><span class="ow">..</span><span class="mi">9</span><span class="ow">]</span>
</span></span><span class="line"><span class="cl">  y <span class="ow">&lt;-</span> <span class="ow">[</span><span class="mi">1</span><span class="ow">..</span><span class="mi">9</span><span class="ow">]</span>
</span></span><span class="line"><span class="cl">  pure <span class="ow">$</span> x <span class="ow">*</span> y
</span></span></code></pre></div><p>熟語括弧（idiom brackets）を思い出してもらうと、以下のコードでも同等です。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl"><span class="ow">[|</span> <span class="ow">[</span><span class="mi">1</span><span class="ow">..</span><span class="mi">9</span><span class="ow">]</span> <span class="ow">*</span> <span class="ow">[</span><span class="mi">1</span><span class="ow">..</span><span class="mi">9</span><span class="ow">]</span> <span class="ow">|]</span>
</span></span></code></pre></div><h2 id="preludemaybe"><code>Prelude.Maybe</code></h2>
<p><code>Just</code> 側の値を取り出します。1つでも <code>Nothing</code> があると即座に <code>Nothing</code> になります。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl"><span class="kr">do</span> <span class="ow">{</span> x <span class="ow">&lt;-</span> <span class="kt">Just</span> <span class="mi">1</span> ; y <span class="ow">&lt;-</span> <span class="kt">Just</span> <span class="mi">2</span> ; pure <span class="ow">$</span> x <span class="ow">+</span> y <span class="ow">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- Just 3 : Maybe Integer</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">do</span> <span class="ow">{</span> x <span class="ow">&lt;-</span> <span class="kt">Nothing</span> ; y <span class="ow">&lt;-</span> <span class="kt">Just</span> <span class="mi">2</span> ; pure <span class="ow">$</span> x <span class="ow">+</span> y <span class="ow">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- Nothing : Maybe Integer</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">do</span> <span class="ow">{</span> x <span class="ow">&lt;-</span> <span class="kt">Just</span> <span class="mi">1</span> ; y <span class="ow">&lt;-</span> <span class="kt">Nothing</span> ; pure <span class="ow">$</span> x <span class="ow">+</span> y <span class="ow">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- Nothing : Maybe Integer</span>
</span></span></code></pre></div><h2 id="preludeeither"><code>Prelude.Either</code></h2>
<p><code>Either</code> は本来なら左と右が対等な関係にあるのですが、Haskellからの伝統で左がエラーの値、右が正しい値として使われています。
右側を優先するという規約の下 <code>Either</code> はモナドを実装していて、右側の値を取り出せます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl"><span class="kr">do</span>
</span></span><span class="line"><span class="cl">  x <span class="ow">&lt;-</span> <span class="kt">Right</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">  y <span class="ow">&lt;-</span> <span class="kt">Right</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">  pure <span class="ow">$</span> x <span class="ow">+</span> y
</span></span><span class="line"><span class="cl"><span class="c1">-- Right 3 : Either String Int</span>
</span></span></code></pre></div><p>複数の <code>Left</code> があった場合は最初の <code>Left</code> のエラーが優先されます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl"><span class="kr">do</span>
</span></span><span class="line"><span class="cl">  x <span class="ow">&lt;-</span> <span class="kt">Left</span> <span class="s">&#34;First error&#34;</span>
</span></span><span class="line"><span class="cl">  y <span class="ow">&lt;-</span> <span class="kt">Left</span> <span class="s">&#34;Second error&#34;</span>
</span></span><span class="line"><span class="cl">  pure <span class="ow">$</span> x <span class="ow">+</span> y
</span></span><span class="line"><span class="cl"><span class="c1">-- Left &#34;First error&#34; : Either String Int</span>
</span></span></code></pre></div><h2 id="preludestream"><code>Prelude.Stream</code></h2>
<p><code>Stream</code> はちょっとトリッキーです。 <code>Stream</code> の前に <code>List</code> の動作を確認しておきましょう。</p>
<p><code>List</code> の場合は二重 <code>for</code> 文のように最初のリストの要素に対して次のリストの要素のリストを繰り返していきます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">Idris&gt; do { x &lt;- [0..3]; y &lt;- [0..3]; pure (x, y) }
</span></span><span class="line"><span class="cl">[(0, 0),
</span></span><span class="line"><span class="cl"> (0, 1),
</span></span><span class="line"><span class="cl"> (0, 2),
</span></span><span class="line"><span class="cl"> (0, 3),
</span></span><span class="line"><span class="cl"> (1, 0),
</span></span><span class="line"><span class="cl"> (1, 1),
</span></span><span class="line"><span class="cl"> (1, 2),
</span></span><span class="line"><span class="cl"> (1, 3),
</span></span><span class="line"><span class="cl"> (2, 0),
</span></span><span class="line"><span class="cl"> (2, 1),
</span></span><span class="line"><span class="cl"> (2, 2),
</span></span><span class="line"><span class="cl"> (2, 3),
</span></span><span class="line"><span class="cl"> (3, 0),
</span></span><span class="line"><span class="cl"> (3, 1),
</span></span><span class="line"><span class="cl"> (3, 2),
</span></span><span class="line"><span class="cl"> (3, 3)] : List (Integer, Integer)
</span></span></code></pre></div><p><code>Stream</code> ではこれはできません。
何故なら <code>Stream</code> は無限に続くことがあるので2番目の要素の繰り返しが終わらず、最初のリストの要素が1つしか取り出されないからです。</p>
<p>そこで <code>Stream</code> は全ての要素を同時に取り出します。
実例をみてみましょう。
<code>cycle</code> で <code>[0, 1, 2, 3, 0, 1, 2, ...]</code> と無限に続くストリームを2つ作り、
そこから <code>do</code> 記法で取り出したものをペアにして最初の10個取り出してみます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl"><span class="kt">Idris</span><span class="ow">&gt;</span> take <span class="mi">10</span> <span class="ow">$</span> <span class="kr">do</span> <span class="ow">{</span> x <span class="ow">&lt;-</span> cycle <span class="ow">[</span><span class="mi">0</span><span class="ow">..</span><span class="mi">3</span><span class="ow">]</span>; y <span class="ow">&lt;-</span> cycle <span class="ow">[</span><span class="mi">0</span><span class="ow">..</span><span class="mi">3</span><span class="ow">]</span>; pure <span class="ow">(</span>x, y<span class="ow">)</span> <span class="ow">}</span>
</span></span><span class="line"><span class="cl"><span class="ow">[(</span><span class="mi">0</span>, <span class="mi">0</span><span class="ow">)</span>,
</span></span><span class="line"><span class="cl"> <span class="ow">(</span><span class="mi">1</span>, <span class="mi">1</span><span class="ow">)</span>,
</span></span><span class="line"><span class="cl"> <span class="ow">(</span><span class="mi">2</span>, <span class="mi">2</span><span class="ow">)</span>,
</span></span><span class="line"><span class="cl"> <span class="ow">(</span><span class="mi">3</span>, <span class="mi">3</span><span class="ow">)</span>,
</span></span><span class="line"><span class="cl"> <span class="ow">(</span><span class="mi">0</span>, <span class="mi">0</span><span class="ow">)</span>,
</span></span><span class="line"><span class="cl"> <span class="ow">(</span><span class="mi">1</span>, <span class="mi">1</span><span class="ow">)</span>,
</span></span><span class="line"><span class="cl"> <span class="ow">(</span><span class="mi">2</span>, <span class="mi">2</span><span class="ow">)</span>,
</span></span><span class="line"><span class="cl"> <span class="ow">(</span><span class="mi">3</span>, <span class="mi">3</span><span class="ow">)</span>,
</span></span><span class="line"><span class="cl"> <span class="ow">(</span><span class="mi">0</span>, <span class="mi">0</span><span class="ow">)</span>,
</span></span><span class="line"><span class="cl"> <span class="ow">(</span><span class="mi">1</span>, <span class="mi">1</span><span class="ow">)]</span> <span class="ow">:</span> <span class="kt">List</span> <span class="ow">(</span><span class="kt">Integer</span>, <span class="kt">Integer</span><span class="ow">)</span>
</span></span></code></pre></div><p>すると <code>List</code> とは異なりそれぞれの要素が順番に取り出されています。
下の表でいう対角線上の要素が取り出されているのです。</p>
<table>
<thead>
<tr>
<th></th>
<th>0</th>
<th>1</th>
<th>2</th>
<th>3</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>(0, 0)</td>
<td>(0, 1)</td>
<td>(0, 2)</td>
<td>(0, 3)</td>
</tr>
<tr>
<td>1</td>
<td>(1, 0)</td>
<td>(1, 1)</td>
<td>(1, 2)</td>
<td>(1, 3)</td>
</tr>
<tr>
<td>2</td>
<td>(2, 0)</td>
<td>(2, 1)</td>
<td>(2, 2)</td>
<td>(2, 3)</td>
</tr>
<tr>
<td>3</td>
<td>(3, 0)</td>
<td>(3, 1)</td>
<td>(3, 2)</td>
<td>(3, 3)</td>
</tr>
</tbody>
</table>
<h1 id="datavect"><code>Data.Vect</code></h1>
<p><code>Stream</code> と同じく対角成分をとります。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl"><span class="kr">do</span>
</span></span><span class="line"><span class="cl">  x <span class="ow">&lt;-</span> <span class="ow">[</span><span class="mi">1</span>, <span class="mi">2</span>, <span class="mi">3</span><span class="ow">]</span>
</span></span><span class="line"><span class="cl">  y <span class="ow">&lt;-</span> <span class="ow">[</span><span class="mi">1</span>, <span class="mi">2</span>, <span class="mi">3</span><span class="ow">]</span>
</span></span><span class="line"><span class="cl">  pure <span class="ow">(</span>x, y<span class="ow">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- [(1, 1), (2, 2), (3, 3)] : Vect 3 (Integer, Integer)</span>
</span></span></code></pre></div><p>注意しないといけないのは <code>Vect k</code> がモナドになっている点です。
ベクタの長さ <code>k</code> まで含めているので、モナドとして扱っている途中で長さを変えられません。
つまり全て同じ長さのベクタでないと <code>do</code> 文で使えないのです。</p>
<h1 id="datamorphism-controlarrow"><code>Data.Morphism</code>, <code>Control.Arrow</code></h1>
<p>略。「Haskell Arrow」とかのワードで調べるとると色々出てきます。
ざっくりいうと関数を組み合わせるときに一時変数を使わずにパイプを繋ぎ合わせるようなやり方で合成するフレームワークです。</p>
<h1 id="controlmonadreader"><code>Control.Monad.Reader</code></h1>
<p>ようやくモナドらしいモナドがでてきました。
<code>Reader</code> は文脈から値が取り出せるモナドです。
以下の3つのAPIがキーになります。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl"><span class="nf">Reader</span> <span class="ow">:</span> <span class="kt">Type</span> <span class="ow">-&gt;</span> <span class="kt">Type</span> <span class="ow">-&gt;</span> <span class="kt">Type</span>
</span></span><span class="line"><span class="cl"><span class="nf">ask</span>   <span class="ow">:</span> <span class="kt">Reader</span> r r
</span></span><span class="line"><span class="cl"><span class="nf">asks</span>  <span class="ow">:</span> <span class="ow">(</span>r <span class="ow">-&gt;</span> a<span class="ow">)</span> <span class="ow">-&gt;</span> <span class="kt">Reader</span> r a
</span></span><span class="line"><span class="cl"><span class="nf">local</span> <span class="ow">:</span> <span class="ow">(</span>r <span class="ow">-&gt;</span> r<span class="ow">)</span> <span class="ow">-&gt;</span> <span class="kt">Reader</span> r a <span class="ow">-&gt;</span> <span class="kt">Reader</span> r a
</span></span></code></pre></div><p><code>Reader r a</code> と書いて 「文脈から <code>r</code> の値を取り出せる <code>a</code> の計算」です。
普通に計算しつつ、 <code>r</code> の値がほしくなったら <code>v &lt;- ask</code> と書くと文脈から値を取り出せます。
「文脈」ってなんだよって話ですが、まあ、感覚で理解して下さい。</p>
<p>四の五のいわずに実例を出しましょう。
<code>Reader</code> は任意の場所で値を取り出せるということで、Dependency Injectionや設定を渡すのに使われます。
ここでは設定を渡す例を挙げましょう。</p>
<p>まず設定を定義しておきます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Control.Monad.Reader</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">record</span> <span class="kt">Config</span> <span class="kr">where</span>
</span></span><span class="line"><span class="cl">  constructor <span class="kt">MkConfig</span>
</span></span><span class="line"><span class="cl">  <span class="nf">width</span> <span class="ow">:</span> <span class="kt">Nat</span>
</span></span></code></pre></div><p>設定に基いて指定された横幅にそろえる関数 <code>format: String -&gt; Reader Config String</code> を定義します。
<code>Reader Config String</code> になっているので <code>String</code> を返しつつ <code>Config</code> を読み出せます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl"><span class="nf">format</span><span class="ow">:</span> <span class="kt">String</span> <span class="ow">-&gt;</span> <span class="kt">Reader</span> <span class="kt">Config</span> <span class="kt">String</span>
</span></span><span class="line"><span class="cl">format s <span class="ow">=</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">  config <span class="ow">&lt;-</span> ask
</span></span><span class="line"><span class="cl">  <span class="kr">let</span> pad <span class="ow">=</span> pack <span class="ow">$</span> replicate <span class="ow">(</span>minus <span class="ow">(</span>width config<span class="ow">)</span> <span class="ow">(</span>length s<span class="ow">))</span> <span class="sc">&#39; &#39;</span>
</span></span><span class="line"><span class="cl">  pure <span class="ow">$</span> pad <span class="ow">++</span> s
</span></span></code></pre></div><p><code>config &lt;- ask</code> の部分ですね。<code>Reader</code> のAPIの <code>ask</code> の型が <code>Reader r r</code> なので <code>&lt;-</code> すると <code>Reader</code> のもっている <code>r</code> の値が読み出せるのが分かるかと思います。</p>
<p>この関数を使ってみたいのですが、その前に便利関数を定義しておきましょう。
後程説明しますが <code>Reader</code> はちょっと入り組んだ構造になってるのでAPIも複雑になってます。
それを緩和するコードです。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl"><span class="nf">runReader</span> <span class="ow">:</span> <span class="kt">Reader</span> r t <span class="ow">-&gt;</span> r <span class="ow">-&gt;</span> t
</span></span><span class="line"><span class="cl">runReader m r <span class="ow">=</span> runIdentity <span class="ow">$</span> runReaderT m r
</span></span></code></pre></div><p><code>Reader</code> モナドを走らせる関数です。モナドと <code>Reader</code> で読み出す値を渡して、モナドを走らせます。
ライブラリ側で提供してしかるべき関数なんですがなぜかないので自分で定義します。</p>
<p>それでは <code>format</code> を走らせてみましょう。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">Idris&gt; runReader (format &#34;Hello&#34;) (MkConfig 10)
</span></span><span class="line"><span class="cl">&#34;     Hello&#34; : String
</span></span></code></pre></div><p><code>runReader</code> での与えた <code>(MkConfig 10)</code> を読み出して横幅10にフォーマットしていますね。</p>
<p><code>ask</code> で読み出す値は最初に <code>runReader</code> で与えたもので固定されます。
これが文脈といってるやつですね。一時的にこの値を上書きするのが <code>local</code> です。</p>
<h1 id="controlmonadwriter"><code>Control.Monad.Writer</code></h1>
<p><code>Reader</code> の逆で文脈に値を書き出せます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl"><span class="nf">Writer</span> <span class="ow">:</span> <span class="kt">Type</span> <span class="ow">-&gt;</span> <span class="kt">Type</span> <span class="ow">-&gt;</span> <span class="kt">Type</span>
</span></span><span class="line"><span class="cl"><span class="nf">tell</span> <span class="ow">:</span> w <span class="ow">-&gt;</span> <span class="kt">Writer</span> w <span class="ow">()</span>
</span></span><span class="line"><span class="cl"><span class="nf">listen</span>  <span class="ow">:</span> <span class="kt">Writer</span> w a <span class="ow">-&gt;</span> <span class="kt">Writer</span> w <span class="ow">(</span>a, w<span class="ow">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">listens</span> <span class="ow">:</span> <span class="ow">(</span>w <span class="ow">-&gt;</span> b<span class="ow">)</span> <span class="ow">-&gt;</span> <span class="kt">Writer</span> w a <span class="ow">-&gt;</span> <span class="kt">Writer</span> w <span class="ow">(</span>a, b<span class="ow">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">pass</span>   <span class="ow">:</span> <span class="kt">Writer</span> w <span class="ow">(</span>a, w <span class="ow">-&gt;</span> w<span class="ow">)</span> <span class="ow">-&gt;</span> <span class="kt">Writer</span> w a
</span></span><span class="line"><span class="cl"><span class="nf">censor</span> <span class="ow">:</span> <span class="ow">(</span>w <span class="ow">-&gt;</span> w<span class="ow">)</span> <span class="ow">-&gt;</span> <span class="kt">Writer</span> w a <span class="ow">-&gt;</span> <span class="kt">Writer</span> w a
</span></span></code></pre></div><p>ただし <code>Writer</code> の <code>w</code> には <code>Monoid</code> の制約がついています。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl"><span class="kt">Monoid</span> w <span class="ow">=&gt;</span> <span class="kt">Monad</span> <span class="ow">(</span><span class="kt">Writer</span> w<span class="ow">)</span>
</span></span></code></pre></div><p>例えば <code>List String</code> から <code>List Integer</code> へ変換する関数を書くとしましょう。
中には変換に失敗する値もあります。
そういうときに <code>Writer</code> を使えば失敗した値を記録しつつ成功したものだけ集めることができます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Control.Monad.Writer</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Data.String</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">tryConvert</span> <span class="ow">:</span> <span class="kt">List</span> <span class="kt">String</span> <span class="ow">-&gt;</span> <span class="kt">Writer</span> <span class="ow">(</span><span class="kt">List</span> <span class="kt">String</span><span class="ow">)</span> <span class="ow">(</span><span class="kt">List</span> <span class="kt">Integer</span><span class="ow">)</span>
</span></span><span class="line"><span class="cl">tryConvert <span class="ow">[]</span>      <span class="ow">=</span> pure <span class="ow">[]</span>
</span></span><span class="line"><span class="cl">tryConvert <span class="ow">(</span>x<span class="ow">::</span>xs<span class="ow">)</span> <span class="ow">=</span>
</span></span><span class="line"><span class="cl">  <span class="kr">case</span> parseInteger x <span class="kr">of</span>
</span></span><span class="line"><span class="cl">    <span class="kt">Just</span> i <span class="ow">=&gt;</span> map <span class="ow">(</span>i<span class="ow">::)</span> <span class="ow">(</span>tryConvert xs<span class="ow">)</span>
</span></span><span class="line"><span class="cl">    <span class="kt">Nothing</span> <span class="ow">=&gt;</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">      <span class="c1">-- 失敗した値を書き出す</span>
</span></span><span class="line"><span class="cl">      tell <span class="ow">[</span>x<span class="ow">]</span>
</span></span><span class="line"><span class="cl">      tryConvert xs
</span></span></code></pre></div><p><code>tell</code> を使っている部分が <code>Writer</code> モナドに値を書き込んでいるところです。</p>
<p>実行してみましょう。 <code>Writer</code> には <code>runWriter</code> があります。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">Idris&gt; runWriter $ tryConvert [&#34;1&#34;, &#34;2&#34;, &#34;3&#34;]
</span></span><span class="line"><span class="cl">([1, 2, 3], []) : (List Integer, List String)
</span></span><span class="line"><span class="cl">Idris&gt; runWriter $ tryConvert [&#34;1&#34;, &#34;two&#34;, &#34;3&#34;]
</span></span><span class="line"><span class="cl">([1, 3], [&#34;two&#34;]) : (List Integer, List String)
</span></span></code></pre></div><p>タプルで成功した値と失敗した値が返ってきていますね。</p>
<h1 id="controlmonadstate"><code>Control.Monad.State</code></h1>
<p><code>State</code> は状態を持ち回るモナドです。 <code>get</code> で読み出し、 <code>put</code> で書き出しができます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl"><span class="nf">State</span> <span class="ow">:</span> <span class="ow">(</span>stateType <span class="ow">:</span> <span class="kt">Type</span><span class="ow">)</span> <span class="ow">-&gt;</span> <span class="ow">(</span>ty <span class="ow">:</span> <span class="kt">Type</span><span class="ow">)</span> <span class="ow">-&gt;</span> <span class="kt">Type</span>
</span></span><span class="line"><span class="cl"><span class="nf">get</span>  <span class="ow">:</span> <span class="kt">State</span> stateType stateType
</span></span><span class="line"><span class="cl"><span class="nf">gets</span> <span class="ow">:</span> <span class="ow">(</span>stateType <span class="ow">-&gt;</span> a<span class="ow">)</span> <span class="ow">-&gt;</span> <span class="kt">State</span> stateType a
</span></span><span class="line"><span class="cl"><span class="nf">put</span> <span class="ow">:</span> stateType <span class="ow">-&gt;</span> <span class="kt">State</span> stateType <span class="ow">()</span>
</span></span><span class="line"><span class="cl"><span class="nf">modify</span> <span class="ow">:</span> <span class="ow">(</span>stateType <span class="ow">-&gt;</span> stateType<span class="ow">)</span> <span class="ow">-&gt;</span> <span class="kt">State</span> stateType <span class="ow">()</span>
</span></span></code></pre></div><p>同じ <code>State s</code> を使い回してる限りにおいてグローバル変数のように使えます。</p>
<p>これも実例を出しましょう。
疑似乱数のコードです。
疑似乱数は乱数の状態を更新してまわる必要がありますね？</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Data.Bits</span>
</span></span><span class="line"><span class="cl"><span class="kr">data</span> <span class="kt">Rand</span> <span class="ow">=</span> <span class="kt">RandomState</span> <span class="kt">Bits64</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">seed</span> <span class="ow">:</span> <span class="kt">Rand</span>
</span></span><span class="line"><span class="cl">seed <span class="ow">=</span> <span class="kt">RandomState</span> <span class="mi">88172645463325252</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">infixl</span> <span class="mi">7</span> <span class="ow">^</span>, <span class="ow">&lt;&lt;</span>, <span class="ow">&gt;&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nf">nextRand</span><span class="ow">:</span> <span class="kt">Rand</span> <span class="ow">-&gt;</span> <span class="ow">(</span><span class="kt">Bits32</span>, <span class="kt">Rand</span><span class="ow">)</span>
</span></span><span class="line"><span class="cl">nextRand <span class="ow">(</span><span class="kt">RandomState</span> x<span class="ow">)</span> <span class="ow">=</span>
</span></span><span class="line"><span class="cl">  <span class="kr">let</span> x <span class="ow">=</span> x <span class="ow">^</span> <span class="ow">(</span>x <span class="ow">&gt;&gt;</span>  <span class="mi">13</span><span class="ow">)</span> <span class="kr">in</span>
</span></span><span class="line"><span class="cl">  <span class="kr">let</span> x <span class="ow">=</span> x <span class="ow">^</span> <span class="ow">(</span>x <span class="ow">&lt;&lt;</span> <span class="mi">7</span><span class="ow">)</span> <span class="kr">in</span>
</span></span><span class="line"><span class="cl">  <span class="kr">let</span> x <span class="ow">=</span> x <span class="ow">^</span> <span class="ow">(</span>x <span class="ow">&gt;&gt;</span>  <span class="mi">17</span><span class="ow">)</span> <span class="kr">in</span>
</span></span><span class="line"><span class="cl">  <span class="kr">let</span> ret <span class="ow">=</span> <span class="ow">(</span>x <span class="ow">&lt;&lt;</span> <span class="mi">32</span><span class="ow">)</span> <span class="ow">&gt;&gt;</span> <span class="mi">32</span> <span class="kr">in</span>
</span></span><span class="line"><span class="cl">  <span class="ow">(</span>prim__truncB64_B32 ret, <span class="kt">RandomState</span> x<span class="ow">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">where</span>
</span></span><span class="line"><span class="cl">  <span class="ow">(^):</span> <span class="kt">Bits64</span> <span class="ow">-&gt;</span> <span class="kt">Bits64</span> <span class="ow">-&gt;</span> <span class="kt">Bits64</span>
</span></span><span class="line"><span class="cl">  <span class="ow">(^)</span> <span class="ow">=</span> xor&#39; <span class="ow">{</span>n <span class="ow">=</span> <span class="mi">8</span><span class="ow">}</span>
</span></span><span class="line"><span class="cl">  <span class="ow">(&lt;&lt;):</span> <span class="kt">Bits64</span> <span class="ow">-&gt;</span> <span class="kt">Bits64</span> <span class="ow">-&gt;</span> <span class="kt">Bits64</span>
</span></span><span class="line"><span class="cl">  <span class="ow">(&lt;&lt;)</span> <span class="ow">=</span> shiftLeft&#39; <span class="ow">{</span>n <span class="ow">=</span> <span class="mi">64</span><span class="ow">}</span>
</span></span><span class="line"><span class="cl">  <span class="ow">(&gt;&gt;):</span> <span class="kt">Bits64</span> <span class="ow">-&gt;</span> <span class="kt">Bits64</span> <span class="ow">-&gt;</span> <span class="kt">Bits64</span>
</span></span><span class="line"><span class="cl">  <span class="ow">(&gt;&gt;)</span> <span class="ow">=</span> shiftRightLogical&#39; <span class="ow">{</span>n <span class="ow">=</span> <span class="mi">8</span><span class="ow">}</span>
</span></span></code></pre></div><p><code>nextRand: Rand -&gt; (Bits64, Rand)</code> の型がそれです。
<code>Rand</code> を受け取って <code>Rand</code> を返していますね。
<code>Rand</code> を受け取ったり次の関数に回したりは面倒です。
これは <code>State Rand</code> を使うと解決します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl"><span class="nf">getRandom</span><span class="ow">:</span> <span class="kt">State</span> <span class="kt">Rand</span> <span class="kt">Bits32</span>
</span></span><span class="line"><span class="cl">getRandom <span class="ow">=</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">  rand <span class="ow">&lt;-</span> get
</span></span><span class="line"><span class="cl">  <span class="kr">let</span> <span class="ow">(</span>i, rand<span class="ow">)</span> <span class="ow">=</span> nextRand rand
</span></span><span class="line"><span class="cl">  put rand
</span></span><span class="line"><span class="cl">  pure i
</span></span></code></pre></div><p>このAPIにしてしまえば乱数の状態を気にすることなく乱数を使う関数が書けます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl"><span class="nf">getRandomPair</span> <span class="ow">:</span> <span class="kt">State</span> <span class="kt">Rand</span> <span class="ow">(</span><span class="kt">Bits32</span>, <span class="kt">Bits32</span><span class="ow">)</span>
</span></span><span class="line"><span class="cl">getRandomPair <span class="ow">=</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">  x <span class="ow">&lt;-</span> getRandom
</span></span><span class="line"><span class="cl">  y <span class="ow">&lt;-</span> getRandom
</span></span><span class="line"><span class="cl">  pure <span class="ow">(</span>x, y<span class="ow">)</span>
</span></span></code></pre></div><p><code>State</code> には実行する関数が3つあります。実行の結果と持ち回った状態をそれぞれ返すか返さないかでの変種です。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl"><span class="nf">runState</span>  <span class="ow">:</span> <span class="kt">State</span> stateType a <span class="ow">-&gt;</span> stateType <span class="ow">-&gt;</span> <span class="ow">(</span>a, stateType<span class="ow">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">evalState</span> <span class="ow">:</span> <span class="kt">State</span> stateType a <span class="ow">-&gt;</span> stateType <span class="ow">-&gt;</span> a
</span></span><span class="line"><span class="cl"><span class="nf">execState</span> <span class="ow">:</span> <span class="kt">State</span> stateType a <span class="ow">-&gt;</span> stateType <span class="ow">-&gt;</span> stateType
</span></span></code></pre></div><p>今回は乱数の状態は捨てることにして <code>evalState</code> を使ってみましょう。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl">evalState getRandomPair seed
</span></span><span class="line"><span class="cl"><span class="c1">-- (D212EB9E, C7E45E25)</span>
</span></span></code></pre></div><p>となるはずです。</p>
<p>ところがREPLで試すと最後まで計算してくれず、巨大な式が表示されます。
これはIdrisのREPLがコンパイラではなくHaskellのインタプリタで実装されていることによる限界です。
仕方ないのでコンパイラにコンパイルしてもらって実行しましょう。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl"><span class="nf">Idris&gt;</span> <span class="ow">:</span>exec printLn <span class="ow">$</span> evalState getRandomPair seed
</span></span></code></pre></div><p>これならちゃんと <code>(D212EB9E, C7E45E25)</code> と表示されます。</p>
<h1 id="controlmonadtrans"><code>Control.Monad.Trans</code></h1>
<p>複数のモナドを組み合わせたいことがあります。
例えばIOでファイルを処理しつつその結果をWriterに記録するなど。
そういうときに愚直に書くととても大変なことになります。</p>
<p>実際のコードを見てみましょう。
標準入力から1行読んで <code>Writer</code> に記録するコードです。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl"><span class="nf">readLine</span> <span class="ow">:</span> <span class="kt">IO</span> <span class="ow">(</span><span class="kt">Writer</span> <span class="ow">(</span><span class="kt">List</span> <span class="kt">String</span><span class="ow">)</span> <span class="kt">Integer</span><span class="ow">)</span>
</span></span><span class="line"><span class="cl">readLine <span class="ow">=</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">  line <span class="ow">&lt;-</span> getLine
</span></span><span class="line"><span class="cl">  pure <span class="ow">$</span> <span class="kr">do</span> tell <span class="ow">[</span>line<span class="ow">]</span>
</span></span><span class="line"><span class="cl">            pure <span class="mi">1</span>
</span></span></code></pre></div><p>やりたいことは単純なのに <code>do</code> がネストしていてやっかいですね。
両方ともモナドなので1つの <code>do</code> で書けると嬉しいですよね。
そこで2つのモナドの合成っぽいことをしたくなります。</p>
<p>モナドの合成のようなことをするのがモナドトランスフォーマ（モナド変換子）です。
あるモナドAを、別のモナドBも混ぜた新しいモナドABに変換します。</p>
<p>先程のコードはモナドトランスフォーマを使うと楽に書けるようになります。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl"><span class="nf">readLine&#39;</span> <span class="ow">:</span> <span class="kt">WriterT</span> <span class="ow">(</span><span class="kt">List</span> <span class="kt">String</span><span class="ow">)</span> <span class="kt">IO</span> <span class="kt">Integer</span>
</span></span><span class="line"><span class="cl">readLine&#39; <span class="ow">=</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">  line <span class="ow">&lt;-</span> lift getLine
</span></span><span class="line"><span class="cl">  tell <span class="ow">[</span>line<span class="ow">]</span>
</span></span><span class="line"><span class="cl">  pure <span class="mi">1</span>
</span></span></code></pre></div><ul>
<li><code>WriterT</code> モナドトランスフォーマで <code>IO</code> モナドを変換する
<ul>
<li><code>WriterT (List String) IO</code> が新しいモナドになる</li>
</ul>
</li>
<li><code>IO</code> モナドのアクション <code>getLine</code> は <code>lift</code> することで <code>do</code> 内で使えるようになる</li>
</ul>
<p>モナドトランスフォーマはTで終わる名前をつけるのが慣習です。
いくつかモナドトランスフォーマに関連する話題を並べておきます。</p>
<ul>
<li>モナドトランスフォーマはモナドに適用され、結果モナドになるのでモナドトランスフォーマを重ね掛けすることができる
<ul>
<li>モナドトランスフォーマスタックとも呼ばれる</li>
</ul>
</li>
<li>全てのモナドがモナドトランスフォーマとしても実装できる訳ではない
<ul>
<li>できるなら勝手にやってしまえばいいのでトランスフォーマという概念を持ち出すまでもない</li>
</ul>
</li>
<li>モナドトランスフォーマスタックの底には（もし使うなら） <code>IO</code> モナドを置くのがベストプラクティス</li>
</ul>
<p>モナドトランスフォーマそのものについてはかなり深いトピックなのでここでは紹介するだけに留めて詳しい解説はWeb上にある記事に譲ることにします（私が詳しくないとも言う）。</p>
<h1 id="controlmonadidentity"><code>Control.Monad.Identity</code></h1>
<p>モナドトランスフォーマに関連する重要なモナドが <code>Control.Monad.Identity</code> で定義されている <code>Identity</code> モナドです。
<code>Identity a</code> は何も意味のあることをしません。
<code>a</code> を直接使うのとほとんど変わりません。</p>
<p><code>Identity</code> は何もしないのでモナドトランスフォーマと組み合わせて使うとモナドトランスフォーマの方の機能だけを使うことができます。
すなわち <code>WriterT w Identity a</code> と <code>Writer w a</code> が同じ機能になるのです。</p>
<p><code>Identity</code> があれば任意のモナドトランスフォーマをモナドにできるので、モナドでもモナドトランスフォーマでも実装できるものはモナドトランスフォーマで実装してしまえば、それを <code>Identity</code> に適用するとモナドも得られるのです。</p>
<p>実際、 <code>Reader</code> や <code>Writer</code> はまずモナドトランスフォーマとして定義されていて、それを <code>Identity</code> に適用したものになっています。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl"><span class="c1">-- Reader</span>
</span></span><span class="line"><span class="cl"><span class="nf">Reader</span> <span class="ow">:</span> <span class="kt">Type</span> <span class="ow">-&gt;</span> <span class="kt">Type</span> <span class="ow">-&gt;</span> <span class="kt">Type</span>
</span></span><span class="line"><span class="cl"><span class="kt">Reader</span> r a <span class="ow">=</span> <span class="kt">ReaderT</span> r <span class="kt">Identity</span> a
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">-- Writer</span>
</span></span><span class="line"><span class="cl"><span class="nf">Writer</span> <span class="ow">:</span> <span class="kt">Type</span> <span class="ow">-&gt;</span> <span class="kt">Type</span> <span class="ow">-&gt;</span> <span class="kt">Type</span>
</span></span><span class="line"><span class="cl"><span class="kt">Writer</span> w a <span class="ow">=</span> <span class="kt">WriterT</span> w <span class="kt">Identity</span> a
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">-- State</span>
</span></span><span class="line"><span class="cl"><span class="nf">State</span> <span class="ow">:</span> <span class="ow">(</span>stateType <span class="ow">:</span> <span class="kt">Type</span><span class="ow">)</span> <span class="ow">-&gt;</span> <span class="ow">(</span>ty <span class="ow">:</span> <span class="kt">Type</span><span class="ow">)</span> <span class="ow">-&gt;</span> <span class="kt">Type</span>
</span></span><span class="line"><span class="cl"><span class="kt">State</span> <span class="ow">=</span> <span class="ow">\</span>s, a <span class="ow">=&gt;</span> <span class="kt">StateT</span> s <span class="kt">Identity</span> a
</span></span></code></pre></div><h1 id="まとめ">まとめ</h1>
<p>Idrisの標準ライブラリにあるモナドを紹介しました。
これらは基本的な道具なのでみなさん道具箱の中に入れておいて下さい。</p>
                    </section>
                </article>
            </div>
        </div>

        <div class="row li-author">
    <div class="sixteen columns">
        Written by <strong>κeen</strong>
    </div>
</div>


        <div class="row li-pagination">
            <div class="eight columns">
                <div class="li-pagination-previous">
                    
                        Later article<br />
                        <a href="https://KeenS.github.io/blog/2020/12/31/2020nenfurikaeri/"> 2020年振り返り</a>
                    
                </div>
            </div>
            <div class="eight columns">
                <div class="li-pagination-next">
                    
                        Older article<br />
                        <a href="https://KeenS.github.io/blog/2020/12/28/smlnoshorikeikumikomireigaittenanda/"> SMLの処理系組み込み例外ってなーんだ</a>
                    
                </div>
            </div>
        </div>
    </div>

<footer class="li-page-footer">
    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <div class="li-page-footer-legal">
                    &copy; 2023. All rights reserved. 
                </div>
                <div class="li-page-footer-theme">
                    <span class=""><a href="https://github.com/eliasson/liquorice/">liquorice</a> is a theme for <a href="http://hugo.spf13.com">hugo</a></span>
                </div>
            </div>
        </div>
    </div>
</footer>

<script type="text/javascript">
 function toggle(id) {
     var e = document.getElementById(id);
     e.style.display == 'block' ? e.style.display = 'none' : e.style.display = 'block';
 }
</script>
<script src="https://unpkg.com/mermaid@7.0.4/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true
     });</script>

    </body>
</html>

