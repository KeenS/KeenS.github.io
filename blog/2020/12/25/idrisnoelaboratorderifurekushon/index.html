<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
    <head>
        
        
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-43779888-1"></script>
        <script>
         window.dataLayer = window.dataLayer || [];
         function gtag(){dataLayer.push(arguments);}
         gtag('js', new Date());

         gtag('config', 'UA-43779888-1');
        </script>
        

        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

        <meta name="twitter:site" content="@blackenedgold" />
        <meta name="twitter:title" content="IdrisのElaboratorリフレクションでメタプログラミング | κeenのHappy Hacκing Blog"/>
        <meta name="twitter:description" content="このエントリはIdris Advent Calendar 2020の25日目の記事です。

今回はIdrisの面白機能の1つElaboratorのリフレクションを利用したメタプログラミング紹介しようと思います。
かなりコアな部分に踏み込むので分からなかったら「へー、そんな機能もあるんだ」と思っておいて下さい。" />
        <meta property="og:title" content="IdrisのElaboratorリフレクションでメタプログラミング | κeenのHappy Hacκing Blog" />
        <meta property="og:type" content="article" />
        <meta property="og:url" content="https://KeenS.github.io/blog/2020/12/25/idrisnoelaboratorderifurekushon/" />
        <meta property="og:description" content="このエントリはIdris Advent Calendar 2020の25日目の記事です。

今回はIdrisの面白機能の1つElaboratorのリフレクションを利用したメタプログラミング紹介しようと思います。
かなりコアな部分に踏み込むので分からなかったら「へー、そんな機能もあるんだ」と思っておいて下さい。" />
        <meta name="twitter:card" content="summary_large_image" />
        <meta property="og:image" content="https://KeenS.github.io/images/ogp/post/IdrisnoElaboratorderifurekushon.png" />
        <meta name="twitter:image" content="https://KeenS.github.io/images/ogp/post/IdrisnoElaboratorderifurekushon.png" />
        
        <meta property="og:article:published_time" content="2020-12-25 20:40:02 &#43;0900 JST" />
        <meta property="og:article:modified_time" content="2020-12-25 20:40:02 &#43;0900 JST" />
        
        <meta property="og:article:author" content="κeen" />

        <title>IdrisのElaboratorリフレクションでメタプログラミング | κeenのHappy Hacκing Blog</title>
        <link rel="stylesheet" href='//fonts.googleapis.com/css?family=Open+Sans:400,300,600' type='text/css' />
        <link rel="stylesheet" href="https://KeenS.github.io/libraries/normalize.3.0.1.css" />
        <link rel="stylesheet" href="https://KeenS.github.io/css/liquorice.css" />
        <link rel="apple-touch-icon" sizes="180x180" href="https://KeenS.github.io/apple-touch-icon.png">
        <link rel="icon" type="image/png" href="https://KeenS.github.io/favicon-32x32.png" sizes="32x32">
        <link rel="icon" type="image/png" href="https://KeenS.github.io/favicon-16x16.png" sizes="16x16">
        <link rel="manifest" href="https://KeenS.github.io/manifest.json">
        <link rel="mask-icon" href="https://KeenS.github.io/safari-pinned-tab.svg" color="#5bbad5">
        <meta name="theme-color" content="#ffffff">
        <link rel="apple-touch-icon-precomposed" href="https://KeenS.github.io/apple-touch-icon-144-precomposed.png" sizes="144x144" />
        <link rel="stylesheet" href="https://KeenS.github.io/css/syntax-monokai.css" />
<script type="text/x-mathjax-config">
 MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ["\\(","\\)"]] } });
</script>
<script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_CHTML"></script>
</script>
<meta http-equiv="X-UA-Compatible" CONTENT="IE=EmulateIE7" />
<link rel="stylesheet" href="//unpkg.com/mermaid@7.0.4/dist/mermaid.forest.min.css">

    </head>
    <body class="li-body">

<header class="li-page-header" id="page-header">
    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <div class="li-brand li-left">
                <a href="https://KeenS.github.io/">κeenのHappy Hacκing Blog</a> | Lispエイリアンの狂想曲</div>
                <div class="li-menu li-right">
                    <span class="li-menu-icon" onclick="javascript:toggle('menu');">&#9776;</span>
                    <ul id="menu2" class="li-menu-items">
                        
                            <li><a href="https://KeenS.github.io/about/"> About </a></li>
                        
                            <li><a href="https://KeenS.github.io/post/"> Blog </a></li>
                        
                            <li><a href="https://KeenS.github.io/slide/"> Slide </a></li>
                        
                            <li><a href="https://KeenS.github.io/index.xml"> Atom </a></li>
                        
                            <li><a href="https://KeenS.github.io/search/"> Search </a></li>
                        
                    </ul>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="sixteen columns">
                <ul id="menu" class="li-menu-items li-menu-mobile">
                    
                        <li><a href="https://KeenS.github.io/about/"> About </a></li>
                    
                        <li><a href="https://KeenS.github.io/post/"> Blog </a></li>
                    
                        <li><a href="https://KeenS.github.io/slide/"> Slide </a></li>
                    
                        <li><a href="https://KeenS.github.io/index.xml"> Atom </a></li>
                    
                        <li><a href="https://KeenS.github.io/search/"> Search </a></li>
                    
                </ul>
            </div>
        </div>
    </div>
</header>






    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <article class="li-article">
                    <header class="li-article-header">
                        <h1 class="li-article-title">IdrisのElaboratorリフレクションでメタプログラミング</h1>
                        <div class="li-article-meta">
    <time class="li-article-date">2020-12-25</time>
    <ul class="li-article-tag">
    
        <li>
            <a href="https://KeenS.github.io/categories/idris">Idris</a>
        </li>
    
        <li>
            <a href="https://KeenS.github.io/categories/idris-advent-calendar">Idris Advent Calendar</a>
        </li>
    
        <li>
            <a href="https://KeenS.github.io/categories/advent-calendar-2020">Advent Calendar 2020</a>
        </li>
    
        <li>
            <a href="https://KeenS.github.io/categories/advent-calendar">Advent Calendar</a>
        </li>
    
</ul>

</div>

                    </header>
                    <section>
                        <p>このエントリは<a href="https://qiita.com/advent-calendar/2020/idris">Idris Advent Calendar 2020</a>の25日目の記事です。</p>

<p>今回はIdrisの面白機能の1つElaboratorのリフレクションを利用したメタプログラミング紹介しようと思います。
かなりコアな部分に踏み込むので分からなかったら「へー、そんな機能もあるんだ」と思っておいて下さい。</p>

<h1 id="elaboratorリフレクションとは">Elaboratorリフレクションとは</h1>

<p>Elaboratorリフレクションとは<a href="https://dl.acm.org/doi/10.1145/2951913.2951932">Elaborator reflection: extending Idris in Idris</a>で提案された機能です。
Elaboratorを何と訳すか難しいのですが、強いて訳すなら推敲器とかになりますかね？</p>

<p>Elaboratorとは多くの（関数型言語の）コンパイラの内部に存在する変換器です。
コンパイラはユーザにはリッチな表現を提供しつつ、内部で扱う言語はかなりシンプルに保っています。</p>

<p>ElaboratorリフレクションではそのElaboratorへのアクセスを提供します。
つまりユーザの書いたコードでコンパイルプロセスに割り込めるのです。</p>

<p>Elaboratorリフレクションの中ではIdrisそのものを対象にプログラムが書けるので、メタプログラミングができます。
すなわちIdrisのプログラムを生成するプログラムが書けるのです。</p>

<p>ここでユーザスクリプトで割り込むのがElaboratorというのが絶妙です。
Elaboratorで推敲した結果、小さなコア言語になります。
そしてそのコア言語で型推論が行われるのです。
つまりハチャメチャなElaboratorスクリプトを書いてもその後の型推論に通らなかったらコンパイルは通りません。
Idrisの担保する安全性を脅かすことなく自由にメタプログラミングができる訳です。</p>

<p>Elaboratorリフレクション難しい機能になるので公式ドキュメントなども参考にしながら読んで下さい。</p>

<p><a href="http://docs.idris-lang.org/en/latest/elaboratorReflection/elaborator-reflection.html">Elaborator Reflection Introduction — Idris 1.3.3 documentation</a></p>

<h1 id="elaboratorリフレクションの使い方">Elaboratorリフレクションの使い方</h1>

<p>4ステップで使えます。</p>

<ol>
<li><p>Elaboratorリフレクションの機能をonにする</p>
<div class="highlight"><pre class="chroma"><code class="language-idris" data-lang="idris"><span class="ow">%</span>language <span class="kt">ElabReflection</span></code></pre></div></li>

<li><p>エスパー能力に目覚める</p></li>

<li><p>エスパー能力を使ってElaboratorスクリプトを書く</p></li>

<li><p><code>%runElab</code> でElaboratorスクリプトを走らせる</p></li>
</ol>

<p>やってみましょう。</p>

<h2 id="id-関数を生成する"><code>id</code> 関数を生成する</h2>

<p>ドキュメントに載っている例です</p>

<p>まずはElaboratorリフレクションをonにします。</p>
<div class="highlight"><pre class="chroma"><code class="language-idris" data-lang="idris"><span class="ow">%</span>language <span class="kt">ElabReflection</span></code></pre></div>
<p>次にエスパー能力ですが、今回はドキュメントに載っているものを使うので使う必要はありません。</p>

<p>Elaboratorスクリプトを書きましょう。
Elaboratorスクリプトは <code>Elab</code> モナドで記述します。
こういう書き出しになります。</p>
<div class="highlight"><pre class="chroma"><code class="language-idris" data-lang="idris"><span class="nf">mkId</span> <span class="ow">:</span> <span class="kt">Elab</span> <span class="ow">()</span></code></pre></div>
<p>実装する前に使用例を出しておくと、以下のように使います。</p>
<div class="highlight"><pre class="chroma"><code class="language-idris" data-lang="idris"><span class="nf">idNat</span> <span class="ow">:</span> <span class="kt">Nat</span> <span class="ow">-&gt;</span> <span class="kt">Nat</span>
idNat <span class="ow">=</span> <span class="ow">%</span>runElab mkId</code></pre></div>
<p><code>\x =&gt; x</code> を生成するイメージですね。</p>

<p>この実装は以下のスクリプトで与えられます。</p>
<div class="highlight"><pre class="chroma"><code class="language-idris" data-lang="idris"><span class="nf">mkId</span> <span class="ow">:</span> <span class="kt">Elab</span> <span class="ow">()</span>
mkId <span class="ow">=</span> <span class="kr">do</span> <span class="kr">intro</span> `<span class="ow">{{</span>x<span class="ow">}}</span>
          fill <span class="ow">(</span><span class="kt">Var</span> `<span class="ow">{{</span>x<span class="ow">}})</span>
          solve</code></pre></div>
<p>軽く解説しておきましょう。
<code>`{{x}}</code> はリフレクションで使う機能で、変数名の内部表現を手軽に書く記法です。</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">Idris&gt; `{{x}}
UN &#34;x&#34; : TTName
Idris&gt; `{{Prelude.Basics.id}}
NS (UN &#34;id&#34;) [&#34;Basics&#34;, &#34;Prelude&#34;] : TTName</code></pre></div>
<p>それぞれのスクリプトは以下のような意味です。</p>

<ul>
<li><code>intro `{{x}}</code> は <code>\x =&gt; ...</code> 相当</li>
<li><code>fill (Var `{{x}})</code> は変数 <code>x</code> を返り値としていることに相当</li>
<li><code>solve</code> は （恐らく） 変数 <code>x</code> が <code>\x =&gt; ...</code> から取得できることを確認</li>
</ul>

<p>それでは先程紹介したとおり使ってみます。</p>
<div class="highlight"><pre class="chroma"><code class="language-idris" data-lang="idris"><span class="nf">idNat</span> <span class="ow">:</span> <span class="kt">Nat</span> <span class="ow">-&gt;</span> <span class="kt">Nat</span>
idNat <span class="ow">=</span> <span class="ow">%</span>runElab mkId</code></pre></div>
<p>今定義した <code>idNat</code> を軽く使ってみましょう。</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">Idris&gt; idNat 1
1 : Nat
Idris&gt; idNat 0
0 : Nat
Idris&gt; idNat 1000
1000 : Nat</code></pre></div>
<p>想定通り動いていますね。</p>

<p>REPLには <code>:core</code> という組み込みコマンドがあります。
任意の式のコア言語での表現を取得できます。
これで生成された <code>idNat</code> の中身を見てみましょう。</p>
<div class="highlight"><pre class="chroma"><code class="language-idris" data-lang="idris"><span class="nf">Idris&gt;</span> <span class="ow">:</span>core idNat
<span class="nf">Main.idNat</span> <span class="ow">:</span> <span class="ow">(</span>__pi_arg <span class="ow">:</span> <span class="kt">Prelude</span><span class="ow">.</span><span class="kt">Nat</span><span class="ow">.</span><span class="kt">Nat</span><span class="ow">)</span> → <span class="kt">Prelude</span><span class="ow">.</span><span class="kt">Nat</span><span class="ow">.</span><span class="kt">Nat</span>
<span class="kt">Main</span><span class="ow">.</span>idNat ↦ λ x <span class="ow">.</span> x</code></pre></div>
<p>これも想定通りの中身ですね。</p>

<p>使えるコマンドなどはAPIドキュメントを見ましょう。</p>

<ul>
<li><a href="https://www.idris-lang.org/docs/current/prelude_doc/docs/Language.Reflection.Elab.html">IdrisDoc: Language.Reflection.Elab</a></li>
<li><a href="https://www.idris-lang.org/docs/current/prelude_doc/docs/Language.Reflection.html">IdrisDoc: Language.Reflection</a></li>
</ul>

<h1 id="elaboratorリフレクションの使いどころ">Elaboratorリフレクションの使いどころ</h1>

<p>Elaboratorリフレクションにはいくつか使いどころがあります。</p>

<p>1つは証明です。
<code>intro</code> とか <code>fill</code> とかは証明を意識したネーミングになっています。</p>

<p>もう1つは穴（Hole）を埋めるためです。
Advent Calendar内で触れそびれたのですが、Idrisには部分的に未完成なプログラムをロードする機能があります。
そしてそのHoleの型や、利用できる型を表示できるので、難しい部分をひとまずHoleにしておき、あとで型をみながら埋めることができます。
そのときにElaboratorリフレクションを使ってインタラクティブにHoleの型を変化させながらプログラミングできるのです。
これは証明をするときに使うテクニックですね。</p>

<p>そして今回紹介するのがメタプログラミングです。
手で実装するのが面倒な関数の自動生成に挑戦したいと思います。</p>

<p>余談ですがElaboratorリフレクションのスクリプトはElabと呼んでしまうことが多いようです。
全然関係ないですが<a href="https://ja.wikipedia.org/wiki/イドリス・エルバ">Idris Elba</a>という俳優がいるらしいです。</p>

<h1 id="elabで関数生成">Elabで関数生成</h1>

<p>さきほどは関数の本体部分のみを生成しました。
ここでは型宣言や関数名への定義も含めた関数定義全体を生成します。</p>

<p>つまり、以下のコードで</p>
<div class="highlight"><pre class="chroma"><code class="language-idris" data-lang="idris"><span class="ow">%</span>runElab genMyId</code></pre></div>
<p>以下のコード相当のものが定義されるのを目指します。</p>
<div class="highlight"><pre class="chroma"><code class="language-idris" data-lang="idris"><span class="nf">myId</span> <span class="ow">:</span> a <span class="ow">-&gt;</span> a
myId <span class="ow">=</span> <span class="ow">\(</span>x<span class="ow">:</span> a<span class="ow">)</span> <span class="ow">=&gt;</span> x</code></pre></div>
<h2 id="elabかastか">ElabかASTか</h2>

<p>さきほどはドキュメントに載っているとおり <code>intro</code> や <code>fill</code> などの命令を使って関数を書きました。
関数を定義するにはもう1つ方法があって、ASTを直接書くこともできます。</p>

<p>ASTを直接書くのはかなり手間が掛かるので正直にいうとゴリラ向けの手法になります。</p>

<p>しかしここではElabを使ったコードは挙動が分かりづらいので、ゴリラになってASTを直接定義する方向で頑張ります。
エスパー能力はもっと難しいことをするために温存しておきましょう。</p>

<hr />

<p>それでは <code>genMyId</code> を書きはじめましょう。</p>
<div class="highlight"><pre class="chroma"><code class="language-idris" data-lang="idris"><span class="nf">genMyId</span> <span class="ow">:</span> <span class="kt">Elab</span> <span class="ow">()</span>
genMyId <span class="ow">=</span> <span class="kr">do</span>
  <span class="c1">-- ...</span></code></pre></div>
<p>使うAPIは <code>declareType</code> と <code>defineFunction</code> です。
ドキュメントから関連する型を辿ってみて下さい。</p>

<p>そしてエスパーして使い方を習得します。
するとこう使えるはずです。</p>
<div class="highlight"><pre class="chroma"><code class="language-idris" data-lang="idris"><span class="nf">genMyId</span> <span class="ow">:</span> <span class="kt">Elab</span> <span class="ow">()</span>
genMyId <span class="ow">=</span> <span class="kr">do</span>
  <span class="kr">let</span> name <span class="ow">=</span> `<span class="ow">{{</span>myId<span class="ow">}}</span>
  <span class="kr">let</span> x <span class="ow">=</span> `<span class="ow">{{</span>x<span class="ow">}}</span>
  <span class="kr">let</span> a <span class="ow">=</span> `<span class="ow">{{</span>a<span class="ow">}}</span>
  <span class="c1">-- myId : {a: Type} -&gt; a -&gt; a</span>
  <span class="kr">let</span> ty <span class="ow">=</span> <span class="kt">Declare</span> name <span class="ow">[</span><span class="kt">MkFunArg</span> a <span class="kt">RType</span> <span class="kt">Implicit</span> <span class="kt">Erased</span>, <span class="kt">MkFunArg</span> x <span class="ow">(</span><span class="kt">Var</span> a<span class="ow">)</span> <span class="kt">Explicit</span> <span class="kt">Erased</span><span class="ow">]</span> <span class="ow">(</span><span class="kt">Var</span> a<span class="ow">)</span>
  <span class="c1">-- myId = \{a: Type} =&gt; \(x: a) =&gt; x</span>
  <span class="kr">let</span> clause <span class="ow">=</span> <span class="kt">MkFunClause</span> <span class="ow">(</span><span class="kt">Var</span> name<span class="ow">)</span> <span class="ow">(</span><span class="kt">RBind</span> a <span class="ow">(</span><span class="kt">Lam</span> <span class="kt">RType</span><span class="ow">)</span> <span class="ow">(</span><span class="kt">RBind</span> x <span class="ow">(</span><span class="kt">Lam</span> <span class="ow">(</span><span class="kt">Var</span> a<span class="ow">))</span> <span class="ow">(</span><span class="kt">Var</span> x<span class="ow">)))</span>
  <span class="kr">let</span> f <span class="ow">=</span> <span class="kt">DefineFun</span> name <span class="ow">[</span>clause<span class="ow">]</span>
  declareType ty
  defineFunction f</code></pre></div>
<p>ちょっと分かりづらい部分だけ解説します。
解説とはいっても私がエスパーした結果なので合ってるか分かりませんが。</p>

<h2 id="コアでの構文">コアでの構文</h2>

<p>今回生成するのは <code>\x =&gt; x</code> ですが、ジェネリクスなので内部ではそのパラメータが増えてます。
<code>\{a: Type} =&gt; (\(x: a) =&gt; x)</code> 相当のものをASTで書いています。</p>

<h2 id="mkfunarg"><code>MkFunArg</code></h2>

<p><code>MkFunArg a RType Implicit Erased</code></p>

<p>と書かれている部分です。 <code>MkFunArg 名前 型 Plicity Erased?</code> です。</p>

<ul>
<li>名前：Idrisの型宣言では引数に名前を書くことができますが、ASTでは必須です。</li>
<li>型：型の名前を書きます。ただし <code>Type</code> 型だけは組込みなので <code>RType</code> を書きます。</li>
<li>Plicity： <code>{}</code> な引数は <code>Implicit</code> 、 <code>()</code> な引数はExplicitです。</li>
<li>Erased?：基本 <code>Erased</code> です。型を値として取り出すときだけ <code>NotErased</code> を使います</li>
</ul>

<h2 id="mkfunclause"><code>MkFunClause</code></h2>

<p>変数を導入する系の構文はすべて <code>RBind</code> にまとめられているようです。
関数は <code>RBind 変数名 (Lam 型) 本体</code> の構文で作ります。</p>

<hr />

<p>これで生成された関数のcore表現を見てみましょう。</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">Idris&gt; :core myId
myId : (a : Type) → (x : a) → a
myId ↦ λ a . λ x . x</code></pre></div>
<p>解説通りですね。</p>

<h1 id="elabで関数生成その2">Elabで関数生成その2</h1>

<p>先程は以下のような関数を生成しました。</p>
<div class="highlight"><pre class="chroma"><code class="language-idris" data-lang="idris"><span class="nf">myId</span> <span class="ow">:</span> a <span class="ow">-&gt;</span> a
myId <span class="ow">=</span> <span class="ow">\(</span>x<span class="ow">:</span> a<span class="ow">)</span> <span class="ow">=&gt;</span> x</code></pre></div>
<p>次は少しだけ構文を変えて、以下のように定義します。</p>
<div class="highlight"><pre class="chroma"><code class="language-idris" data-lang="idris"><span class="nf">myId</span> <span class="ow">:</span> a <span class="ow">-&gt;</span> a
myId x <span class="ow">=</span> x</code></pre></div>
<p>これは以下のようなスクリプトで生成できます。</p>
<div class="highlight"><pre class="chroma"><code class="language-idris" data-lang="idris"><span class="nf">genMyId2</span> <span class="ow">:</span> <span class="kt">Elab</span> <span class="ow">()</span>
genMyId2 <span class="ow">=</span> <span class="kr">do</span>
  <span class="kr">let</span> name <span class="ow">=</span> `<span class="ow">{{</span>myId2<span class="ow">}}</span>
  <span class="kr">let</span> a <span class="ow">=</span> `<span class="ow">{{</span>a<span class="ow">}}</span>
  <span class="kr">let</span> x <span class="ow">=</span> `<span class="ow">{{</span>x<span class="ow">}}</span>
  <span class="c1">-- myId2 : {a: Type} -&gt; a -&gt; a</span>
  <span class="kr">let</span> ty <span class="ow">=</span> <span class="kt">Declare</span> name <span class="ow">[</span><span class="kt">MkFunArg</span> a <span class="kt">RType</span> <span class="kt">Implicit</span> <span class="kt">Erased</span>, <span class="kt">MkFunArg</span> x <span class="ow">(</span><span class="kt">Var</span> a<span class="ow">)</span> <span class="kt">Explicit</span> <span class="kt">Erased</span><span class="ow">]</span> <span class="ow">(</span><span class="kt">Var</span> a<span class="ow">)</span>
  <span class="c1">-- myId2 x = x</span>
  <span class="kr">let</span> clause <span class="ow">=</span> <span class="kt">MkFunClause</span> <span class="ow">(</span><span class="kt">RBind</span> a <span class="ow">(</span><span class="kt">PVar</span> <span class="kt">RType</span><span class="ow">)</span> <span class="ow">(</span><span class="kt">RBind</span> x <span class="ow">(</span><span class="kt">PVar</span> <span class="ow">(</span><span class="kt">Var</span> a<span class="ow">))</span> <span class="ow">(</span><span class="kt">RApp</span> <span class="ow">(</span><span class="kt">RApp</span> <span class="ow">(</span><span class="kt">Var</span> name<span class="ow">)</span> <span class="ow">(</span><span class="kt">Var</span> a<span class="ow">))</span> <span class="ow">(</span><span class="kt">Var</span> x<span class="ow">))))</span> <span class="ow">(</span><span class="kt">RBind</span> a <span class="ow">(</span><span class="kt">PVar</span> <span class="kt">RType</span><span class="ow">)</span> <span class="ow">(</span><span class="kt">RBind</span> x <span class="ow">(</span><span class="kt">PVar</span> <span class="ow">(</span><span class="kt">Var</span> a<span class="ow">))</span> <span class="ow">(</span><span class="kt">Var</span> x<span class="ow">)))</span>
  <span class="kr">let</span> f <span class="ow">=</span> <span class="kt">DefineFun</span> name <span class="ow">[</span>clause<span class="ow">]</span>
  declareType ty
  defineFunction f</code></pre></div>
<p>これもややこしいところだけ解説しておきます。</p>

<h2 id="変数の導入">変数の導入</h2>

<p>新しい変数を導入するのにも <code>RBind</code> を使うようです。
新しい変数というのは <code>myId x =</code> の <code>x</code> のことです。
<code>(RBind x (PVar (Var a)) ...)</code> の構文になってますね。
そしてここで <code>a</code> という変数がでてきました。これも引数で受け取るので、こうなります。
<code>(RBind a (PVar RType) (RBind x (PVar (Var a)) ...))</code></p>

<p>さらに加えてややこしいのが、右辺、 <code>x</code> の方にも同時に変数の導入が必要です。
なので右辺もこうなってます。 <code>(RBind a (PVar RType) (RBind x (PVar (Var a)) ...))</code></p>

<h2 id="関数定義の構文">関数定義の構文</h2>
<div class="highlight"><pre class="chroma"><code class="language-idris" data-lang="idris">myId a <span class="ow">=</span></code></pre></div>
<p>は</p>
<div class="highlight"><pre class="chroma"><code class="language-idris" data-lang="idris"><span class="ow">(</span><span class="kt">RApp</span> <span class="ow">(</span><span class="kt">Var</span> name<span class="ow">)</span> <span class="ow">(</span><span class="kt">Var</span> x<span class="ow">))</span></code></pre></div>
<p>。 <code>App</code> 使うんだって驚きですね。</p>

<hr />

<p>これもコア表現を見てみましょう。</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">Idris&gt; :core myId2
myId2 : (a : Type) → (x : a) → a
var a : Type, x : a .
  myId2 a x ↦ x</code></pre></div>
<h1 id="パターンマッチ">パターンマッチ</h1>

<p>パターンマッチするコードを生成してみましょう。</p>
<div class="highlight"><pre class="chroma"><code class="language-idris" data-lang="idris"><span class="nf">myNot</span> <span class="ow">:</span> <span class="kt">Bool</span> <span class="ow">-&gt;</span> <span class="kt">Bool</span>
myNot <span class="kt">True</span> <span class="ow">=</span> <span class="kt">False</span>
myNot <span class="kt">False</span> <span class="ow">=</span> <span class="kt">True</span></code></pre></div>
<p>こうなります。</p>
<div class="highlight"><pre class="chroma"><code class="language-idris" data-lang="idris"><span class="nf">genNot</span> <span class="ow">:</span> <span class="kt">Elab</span> <span class="ow">()</span>
genNot <span class="ow">=</span> <span class="kr">do</span>
  <span class="kr">let</span> name <span class="ow">=</span> `<span class="ow">{{</span>myNot<span class="ow">}}</span>
  <span class="kr">let</span> bool <span class="ow">=</span> `<span class="ow">{{</span><span class="kt">Prelude</span><span class="ow">.</span><span class="kt">Bool</span><span class="ow">.</span><span class="kt">Bool</span><span class="ow">}}</span>
  <span class="kr">let</span> true <span class="ow">=</span> `<span class="ow">{{</span><span class="kt">Prelude</span><span class="ow">.</span><span class="kt">Bool</span><span class="ow">.</span><span class="kt">True</span><span class="ow">}}</span>
  <span class="kr">let</span> false <span class="ow">=</span> `<span class="ow">{{</span><span class="kt">Prelude</span><span class="ow">.</span><span class="kt">Bool</span><span class="ow">.</span><span class="kt">False</span><span class="ow">}}</span>
  b <span class="ow">&lt;-</span> gensym <span class="s">&#34;b&#34;</span>
  <span class="c1">-- myNot : Bool -&gt; Bool</span>
  <span class="kr">let</span> ty <span class="ow">=</span> <span class="kt">Declare</span> name <span class="ow">[</span><span class="kt">MkFunArg</span> b <span class="ow">(</span><span class="kt">Var</span> bool<span class="ow">)</span> <span class="kt">Explicit</span> <span class="kt">NotErased</span><span class="ow">]</span>  <span class="ow">(</span><span class="kt">Var</span> bool<span class="ow">)</span>
  <span class="c1">-- myNot True = False</span>
  <span class="kr">let</span> clauseTrue  <span class="ow">=</span> <span class="kt">MkFunClause</span> <span class="ow">(</span><span class="kt">RApp</span> <span class="ow">(</span><span class="kt">Var</span> name<span class="ow">)</span> <span class="ow">(</span><span class="kt">Var</span> true<span class="ow">))</span> <span class="ow">(</span><span class="kt">Var</span> false<span class="ow">)</span>
  <span class="c1">-- myNot False = True</span>
  <span class="kr">let</span> clauseFalse <span class="ow">=</span> <span class="kt">MkFunClause</span> <span class="ow">(</span><span class="kt">RApp</span> <span class="ow">(</span><span class="kt">Var</span> name<span class="ow">)</span> <span class="ow">(</span><span class="kt">Var</span> false<span class="ow">))</span> <span class="ow">(</span><span class="kt">Var</span> true<span class="ow">)</span>
  <span class="kr">let</span> f <span class="ow">=</span> <span class="kt">DefineFun</span> name <span class="ow">[</span>clauseTrue, clauseFalse<span class="ow">]</span>
  declareType ty
  defineFunction f

<span class="ow">%</span>runElab genNot</code></pre></div>
<p>以下のことを押えましょう。</p>

<ul>
<li>既存の名前は完全修飾名で指定する</li>
<li><code>gensym</code> がある</li>
<li>パターンマッチは節を複数にすればできる</li>
</ul>

<p>ジェネリクスがないので簡単ですね。</p>

<h1 id="deriving-の実装"><code>deriving</code> の実装</h1>

<p>IdrisにはHaskellにある <code>deriving Show, Eq</code> のような機能がありません。
しかしメタプログラミングを使えばこれも実装できるはずです。やってみましょう。</p>

<p>最終的には以下のコードを書くと</p>
<div class="highlight"><pre class="chroma"><code class="language-idris" data-lang="idris"><span class="kr">data</span> <span class="kt">Janken</span> <span class="ow">=</span> <span class="kt">Gu</span> <span class="ow">|</span> <span class="kt">Choki</span> <span class="ow">|</span> <span class="kt">Pa</span>

<span class="ow">%</span>runElab deriveShow `<span class="ow">{{</span><span class="kt">Main</span><span class="ow">.</span><span class="kt">Janken</span><span class="ow">}}</span></code></pre></div>
<p>以下が生成されるスクリプトを目指します。</p>
<div class="highlight"><pre class="chroma"><code class="language-idris" data-lang="idris"><span class="kt">Show</span> <span class="kt">Janken</span> <span class="kr">where</span>
  show <span class="kt">Gu</span>    <span class="ow">=</span> <span class="s">&#34;Gu&#34;</span>
  show <span class="kt">Choki</span> <span class="ow">=</span> <span class="s">&#34;Choki&#34;</span>
  show <span class="kt">Pa</span>    <span class="ow">=</span> <span class="s">&#34;Pa&#34;</span></code></pre></div>
<h2 id="myshow"><code>myShow</code></h2>

<p>まずは実験的にデータ型の型名を受け取ったら「そのデータ型を文字列にする関数 <code>myShow</code>」 を定義するスクリプトを書いてみましょう。</p>

<p>イメージとしては以下のコードを書くと</p>
<div class="highlight"><pre class="chroma"><code class="language-idris" data-lang="idris"><span class="kr">data</span> <span class="kt">Janken</span> <span class="ow">=</span> <span class="kt">Gu</span> <span class="ow">|</span> <span class="kt">Choki</span> <span class="ow">|</span> <span class="kt">Pa</span>

<span class="ow">%</span>runElab <span class="ow">(</span>genShow `<span class="ow">{{</span><span class="kt">Main</span><span class="ow">.</span><span class="kt">Janken</span><span class="ow">}})</span></code></pre></div>
<p>以下のコードを生成する感じです。</p>
<div class="highlight"><pre class="chroma"><code class="language-idris" data-lang="idris"><span class="nf">myShow</span> <span class="ow">:</span> <span class="kt">Janken</span> <span class="ow">-&gt;</span> <span class="kt">String</span>
myShow <span class="kt">Gu</span>    <span class="ow">=</span> <span class="s">&#34;Gu&#34;</span>
myShow <span class="kt">Choki</span> <span class="ow">=</span> <span class="s">&#34;Choki&#34;</span>
myShow <span class="kt">Pa</span>    <span class="ow">=</span> <span class="s">&#34;Pa&#34;</span></code></pre></div>
<p>あんまり難しくなっても訳がわからなくなるので、データ型に型引数はなく、コンストラクタも全て引数をとらないものとします。</p>

<p>実装を与えるとこうなります。</p>
<div class="highlight"><pre class="chroma"><code class="language-idris" data-lang="idris"><span class="nf">genShow</span> <span class="ow">:</span> <span class="kt">TTName</span> <span class="ow">-&gt;</span> <span class="kt">Elab</span> <span class="ow">()</span>
genShow name <span class="ow">=</span> <span class="kr">do</span>
  <span class="kr">let</span> fname <span class="ow">=</span> `<span class="ow">{{</span>myShow<span class="ow">}}</span>
  dt <span class="ow">&lt;-</span> lookupDatatypeExact name
  x <span class="ow">&lt;-</span> gensym <span class="s">&#34;x&#34;</span>
  <span class="kr">let</span> ty <span class="ow">=</span> <span class="kt">Declare</span> fname <span class="ow">[</span><span class="kt">MkFunArg</span> x <span class="ow">(</span><span class="kt">Var</span> name<span class="ow">)</span> <span class="kt">Explicit</span> <span class="kt">NotErased</span><span class="ow">]</span> <span class="ow">(</span><span class="kt">RConstant</span> <span class="kt">StrType</span><span class="ow">)</span>
  <span class="kr">let</span> clauses <span class="ow">=</span> map <span class="ow">(</span>genClause fname<span class="ow">)</span> <span class="ow">$</span> constructors dt
  <span class="kr">let</span> f <span class="ow">=</span> <span class="kt">DefineFun</span> fname clauses
  declareType ty
  defineFunction f
<span class="kr">where</span>
    <span class="nf">genClause</span> <span class="ow">:</span> <span class="kt">TTName</span> <span class="ow">-&gt;</span> <span class="ow">(</span><span class="kt">TTName</span>, <span class="kt">List</span> <span class="kt">CtorArg</span>, <span class="kt">Raw</span><span class="ow">)</span> <span class="ow">-&gt;</span> <span class="kt">FunClause</span> <span class="kt">Raw</span>
    genClause fname <span class="ow">(</span>cname, <span class="kr">_</span>, <span class="kr">_</span><span class="ow">)</span> <span class="ow">=</span>
      <span class="kr">let</span> <span class="kt">NS</span> <span class="ow">(</span><span class="kt">UN</span> cnameStr<span class="ow">)</span> <span class="kr">_</span> <span class="ow">=</span> cname <span class="kr">in</span>
      <span class="kt">MkFunClause</span> <span class="ow">(</span><span class="kt">RApp</span> <span class="ow">(</span><span class="kt">Var</span> fname<span class="ow">)</span> <span class="ow">(</span><span class="kt">Var</span> cname<span class="ow">))</span> <span class="ow">(</span><span class="kt">RConstant</span> <span class="ow">(</span><span class="kt">Str</span> cnameStr<span class="ow">))</span></code></pre></div>
<p><code>genClause</code> で <code>myShow Choki = &quot;Choki&quot;</code> などの節を生成しています。
落ち着いて読めば難しくないですね。</p>

<h2 id="show-インタフェースの実装"><code>Show</code> インタフェースの実装</h2>

<p>今日一番のエスパーの使いどころですよ。</p>

<p>Elabでインタフェース関連の機能はこれだけです。</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">Idris&gt; :doc addImplementation
Language.Reflection.Elab.Tactics.addImplementation : (ifaceName : TTName) -&gt;
    (implName : TTName) -&gt; Elab ()
    Register a new implementation for interface resolution.
    Arguments:
        ifaceName : TTName  -- the name of the interface for which an implementation is
        being registered
        
        implName : TTName  -- the name of the definition to use in implementation search
        
    The function is: Total &amp; export</code></pre></div>
<p>インタフェースの実装を追加するのですが、インタフェース名と実装名のみ引数にとります。
実装は…？</p>

<p>ちょっとよく分からないので <code>show</code> のコア表現をみてみましょう。</p>
<div class="highlight"><pre class="chroma"><code class="language-idris" data-lang="idris"><span class="nf">λΠ&gt;</span> <span class="ow">:</span>core show
<span class="nf">Prelude.Show.show</span> <span class="ow">:</span> <span class="ow">(</span>ty <span class="ow">:</span> <span class="kt">Type</span><span class="ow">)</span> →
                    <span class="ow">(</span>__interface <span class="ow">:</span> <span class="kt">Prelude</span><span class="ow">.</span><span class="kt">Show</span><span class="ow">.</span><span class="kt">Show</span> ty<span class="ow">)</span> → <span class="ow">(</span>x <span class="ow">:</span> ty<span class="ow">)</span> → <span class="kt">String</span>
var ty <span class="ow">:</span> <span class="kt">Type</span>,
    <span class="ow">{</span>meth_0<span class="ow">}</span> <span class="ow">:</span> <span class="ow">(</span>x <span class="ow">:</span> ty<span class="ow">)</span> → <span class="kt">String</span>,
    <span class="ow">{</span>meth_1<span class="ow">}</span> <span class="ow">:</span> <span class="ow">(</span>d <span class="ow">:</span> <span class="kt">Prelude</span><span class="ow">.</span><span class="kt">Show</span><span class="ow">.</span><span class="kt">Prec</span><span class="ow">)</span> → <span class="ow">(</span>x5 <span class="ow">:</span> ty<span class="ow">)</span> → <span class="kt">String</span> <span class="ow">.</span>
  <span class="kt">Prelude</span><span class="ow">.</span><span class="kt">Show</span><span class="ow">.</span>show ty
    <span class="ow">(</span>constructor <span class="kr">of</span> <span class="kt">Prelude</span><span class="ow">.</span><span class="kt">Show</span><span class="ow">.</span><span class="kt">Show</span> <span class="ow">&lt;&lt;&lt;</span>erased<span class="ow">&gt;&gt;&gt;</span> <span class="ow">{</span>meth_0<span class="ow">}</span> <span class="ow">{</span>meth_1<span class="ow">})</span>
  ↦
  <span class="ow">{</span>meth_0<span class="ow">}</span></code></pre></div>
<p>ふむふむ。ここで温存しておいたエスパー能力をフルに発揮します。
…はい。 <code>__interface : Prelude.Show.Show ty</code> や <code>constructor of Prelude.Show.Show</code> などからエスパーできましたね。
インタフェースの内部表現を作ればよいのです。</p>

<p>例えば以下のようなインタフェースを定義したとします。</p>
<div class="highlight"><pre class="chroma"><code class="language-idris" data-lang="idris">interface <span class="kt">Name</span> a <span class="kr">where</span>
  <span class="kr">name</span><span class="ow">:</span> a <span class="ow">-&gt;</span> <span class="kt">String</span></code></pre></div>
<p>するとコア的にはだいたい以下のような表現へと変換されます。</p>
<div class="highlight"><pre class="chroma"><code class="language-idris" data-lang="idris"><span class="kr">data</span> <span class="kt">Name</span> a <span class="ow">=</span> <span class="kt">MkName</span> <span class="ow">(</span>a <span class="ow">-&gt;</span> a<span class="ow">)</span>

<span class="kr">name</span> <span class="ow">:</span> <span class="ow">(</span>a <span class="ow">:</span> <span class="kt">Type</span><span class="ow">)</span> <span class="ow">-&gt;</span> <span class="kt">Name</span> a <span class="ow">-&gt;</span> a <span class="ow">-&gt;</span> a
<span class="kr">name</span> <span class="kr">_</span> <span class="ow">(</span><span class="kt">MkName</span> f<span class="ow">)</span> <span class="ow">=</span> f</code></pre></div>
<p>次にこれをStringに実装します。</p>
<div class="highlight"><pre class="chroma"><code class="language-idris" data-lang="idris"><span class="kt">Name</span> <span class="kt">String</span> <span class="kr">where</span>
  <span class="kr">name</span> x <span class="ow">=</span> x</code></pre></div>
<p>すると以下のようなコア表現へとなります。</p>
<div class="highlight"><pre class="chroma"><code class="language-idris" data-lang="idris"><span class="nf">strName</span> <span class="ow">:</span> <span class="kt">Name</span> <span class="kt">String</span>
strName <span class="ow">=</span> <span class="kt">MkName</span> name
<span class="kr">where</span>
  <span class="kr">name</span> <span class="ow">:</span> <span class="kt">String</span> <span class="ow">-&gt;</span> <span class="kt">String</span>
  <span class="kr">name</span> x <span class="ow">=</span> x</code></pre></div>
<p>そして <code>Name</code> を使うコードを書きましょう。</p>
<div class="highlight"><pre class="chroma"><code class="language-idris" data-lang="idris"><span class="nf">getName</span> <span class="ow">:</span> <span class="kt">String</span> <span class="ow">-&gt;</span> <span class="kt">String</span>
genName <span class="ow">=</span> name</code></pre></div>
<p>この関数にはコンパイラが型から <code>strName</code> が適切だとみつけ、暗黙に渡すのです。</p>
<div class="highlight"><pre class="chroma"><code class="language-idris" data-lang="idris"><span class="nf">getName</span> <span class="ow">:</span> <span class="kt">String</span> <span class="ow">-&gt;</span> <span class="kt">String</span>
genName <span class="ow">=</span> name <span class="kt">Strig</span> strName</code></pre></div>
<p>ここまでくればもう分かりましたね。
「コンパイラが型から <code>strName</code> が適切だとみつけ」るために、コンパイラ内のDBに実装を登録する関数が <code>addImplementation</code> な訳です。</p>

<p>これで <code>Show</code> の実装方法が分かりました。 <code>deriveShow</code> 関数を書いていきましょう。</p>
<div class="highlight"><pre class="chroma"><code class="language-idris" data-lang="idris"><span class="nf">deriveShow</span> <span class="ow">:</span> <span class="kt">TTName</span> <span class="ow">-&gt;</span> <span class="kt">Elab</span> <span class="ow">()</span>
deriveShow name <span class="ow">=</span> <span class="ow">...</span></code></pre></div>
<p>ところで、上記の <code>MkName</code> に相当する <code>Show</code> のコンストラクタ名はなんでしょう。
コア言語では <code>constructor of Prelude.Show.Show</code> と表示されているので名前がなさそうですね。
名前がものを在らしめるなんて言葉がありますが、名前のないものを使うことはできません。
どうしたもんでしょう。</p>

<p>でも大丈夫。Elabならデータ型さえ分かればリフレクションでコンストラクタを取り出せます。
そしてデータ型は <code>Prelude.Show.Show</code> です。これで完璧！</p>

<p><code>Show</code> の定義には2つのメソッドがあります。</p>
<div class="highlight"><pre class="chroma"><code class="language-idris" data-lang="idris">interface <span class="kt">Show</span> ty <span class="kr">where</span>
  <span class="nf">show</span> <span class="ow">:</span> <span class="ow">(</span>x <span class="ow">:</span> ty<span class="ow">)</span> <span class="ow">-&gt;</span> <span class="kt">String</span>
  show x <span class="ow">=</span> showPrec <span class="kt">Open</span> x <span class="c1">-- Eta expand to help totality checker</span>

  <span class="nf">showPrec</span> <span class="ow">:</span> <span class="ow">(</span>d <span class="ow">:</span> <span class="kt">Prec</span><span class="ow">)</span> <span class="ow">-&gt;</span> <span class="ow">(</span>x <span class="ow">:</span> ty<span class="ow">)</span> <span class="ow">-&gt;</span> <span class="kt">String</span>
  showPrec <span class="kr">_</span> x <span class="ow">=</span> show x</code></pre></div>
<p><code>Show</code> のコンストラクタを仮に <code>MkShow</code> とすると、 <code>MkShow myShow myShowPrec</code> という呼び出しになるはずです。
あとは <code>myShow</code> と <code>myShowPrec</code> を定義するだけですね。
ここでデフォルト実装が与えられているのでそれを使いたいのですが、どこにあるか分からなかったのであきらめました。
<code>myShow</code> と <code>myShowPrec</code> 両方を定義します。</p>

<p><code>myShow</code> と <code>myShowPrec</code> をそれぞれ定義する関数が書けたとして、 <code>implement Show name</code> は以下のように書けます。</p>
<div class="highlight"><pre class="chroma"><code class="language-idris" data-lang="idris"><span class="nf">deriveShow</span> <span class="ow">:</span> <span class="kt">TTName</span> <span class="ow">-&gt;</span> <span class="kt">Elab</span> <span class="ow">()</span>
deriveShow name <span class="ow">=</span> <span class="kr">do</span>
  dt <span class="ow">&lt;-</span> lookupDatatypeExact name

  fshow <span class="ow">&lt;-</span> genShow dt
  fshowPrec <span class="ow">&lt;-</span> genShowPrec fshow dt

  <span class="kr">let</span> ifc <span class="ow">=</span> `<span class="ow">{{</span><span class="kt">Prelude</span><span class="ow">.</span><span class="kt">Show</span><span class="ow">.</span><span class="kt">Show</span><span class="ow">}}</span>
  inst <span class="ow">&lt;-</span> gensym <span class="s">&#34;showInst&#34;</span>
  ifcData <span class="ow">&lt;-</span> lookupDatatypeExact ifc
  <span class="kr">let</span> <span class="ow">[(</span>ctor, <span class="kr">_</span>, <span class="kr">_</span><span class="ow">)]</span> <span class="ow">=</span> constructors ifcData
  <span class="kr">let</span> instTy <span class="ow">=</span> <span class="kt">Declare</span> inst <span class="ow">[]</span> <span class="ow">(</span><span class="kt">RApp</span> <span class="ow">(</span><span class="kt">Var</span> ifc<span class="ow">)</span> <span class="ow">(</span><span class="kt">Var</span> name<span class="ow">))</span>
  <span class="kr">let</span> instClause <span class="ow">=</span> <span class="kt">MkFunClause</span> <span class="ow">(</span><span class="kt">Var</span> inst<span class="ow">)</span> <span class="ow">(</span><span class="kt">RApp</span> <span class="ow">(</span><span class="kt">RApp</span> <span class="ow">(</span><span class="kt">RApp</span> <span class="ow">(</span><span class="kt">Var</span> ctor<span class="ow">)</span> <span class="ow">(</span><span class="kt">Var</span> name<span class="ow">))</span> <span class="ow">(</span><span class="kt">Var</span> fshow<span class="ow">))</span> <span class="ow">(</span><span class="kt">Var</span> fshowPrec<span class="ow">))</span>
  <span class="kr">let</span> instF <span class="ow">=</span> <span class="kt">DefineFun</span> inst <span class="ow">[</span>instClause<span class="ow">]</span>
  declareType instTy
  defineFunction instF

  addImplementation ifc inst
<span class="kr">where</span>
  <span class="nf">genShow</span> <span class="ow">:</span> <span class="kt">Datatype</span> <span class="ow">-&gt;</span> <span class="kt">Elab</span> <span class="kt">TTName</span>
  <span class="ow">...</span>
  <span class="nf">genShowPrec</span> <span class="ow">:</span> <span class="kt">TTName</span> <span class="ow">-&gt;</span> <span class="kt">Datatype</span> <span class="ow">-&gt;</span> <span class="kt">Elab</span> <span class="kt">TTName</span>
  <span class="ow">...</span></code></pre></div>
<p><code>genShow</code> はほぼさっき定義したものとおなじです。</p>
<div class="highlight"><pre class="chroma"><code class="language-idris" data-lang="idris">  <span class="nf">genClause</span> <span class="ow">:</span> <span class="kt">TTName</span> <span class="ow">-&gt;</span> <span class="ow">(</span><span class="kt">TTName</span>, <span class="kt">List</span> <span class="kt">CtorArg</span>, <span class="kt">Raw</span><span class="ow">)</span> <span class="ow">-&gt;</span> <span class="kt">FunClause</span> <span class="kt">Raw</span>
  genClause fname <span class="ow">(</span>cname, <span class="kr">_</span>, <span class="kr">_</span><span class="ow">)</span> <span class="ow">=</span>
    <span class="kr">let</span> <span class="kt">NS</span> <span class="ow">(</span><span class="kt">UN</span> cnameStr<span class="ow">)</span> <span class="kr">_</span> <span class="ow">=</span> cname <span class="kr">in</span>
    <span class="kt">MkFunClause</span> <span class="ow">(</span><span class="kt">RApp</span> <span class="ow">(</span><span class="kt">Var</span> fname<span class="ow">)</span> <span class="ow">(</span><span class="kt">Var</span> cname<span class="ow">))</span> <span class="ow">(</span><span class="kt">RConstant</span> <span class="ow">(</span><span class="kt">Str</span> cnameStr<span class="ow">))</span>
  <span class="nf">genShow</span> <span class="ow">:</span> <span class="kt">Datatype</span> <span class="ow">-&gt;</span> <span class="kt">Elab</span> <span class="kt">TTName</span>
  genShow dt <span class="ow">=</span> <span class="kr">do</span>
    fshow <span class="ow">&lt;-</span> gensym <span class="s">&#34;show&#34;</span>
    x <span class="ow">&lt;-</span> gensym <span class="s">&#34;x&#34;</span>
    <span class="kr">let</span> ty <span class="ow">=</span> <span class="kt">Declare</span> fshow <span class="ow">[</span><span class="kt">MkFunArg</span> x <span class="ow">(</span><span class="kt">Var</span> name<span class="ow">)</span> <span class="kt">Explicit</span> <span class="kt">NotErased</span><span class="ow">]</span> <span class="ow">(</span><span class="kt">RConstant</span> <span class="kt">StrType</span><span class="ow">)</span>
    <span class="kr">let</span> clauses <span class="ow">=</span> map <span class="ow">(</span>genClause fshow<span class="ow">)</span> <span class="ow">$</span> constructors dt
    <span class="kr">let</span> f <span class="ow">=</span> <span class="kt">DefineFun</span> fshow clauses
    declareType ty
    defineFunction f
    pure fshow</code></pre></div>
<p><code>genShowPrec</code> は新規コードですが、 <code>show</code> を呼び出すだけなのでそこまで難しくないでしょう。</p>
<div class="highlight"><pre class="chroma"><code class="language-idris" data-lang="idris">  genShowPrec fshow dt <span class="ow">=</span> <span class="kr">do</span>
    fshowPrec <span class="ow">&lt;-</span> gensym <span class="s">&#34;showPrec&#34;</span>
    <span class="kr">let</span> prec <span class="ow">=</span> `<span class="ow">{{</span><span class="kt">Prelude</span><span class="ow">.</span><span class="kt">Show</span><span class="ow">.</span><span class="kt">Prec</span><span class="ow">}}</span>
    a <span class="ow">&lt;-</span> gensym <span class="s">&#34;a&#34;</span>
    x <span class="ow">&lt;-</span> gensym <span class="s">&#34;x&#34;</span>
    ign <span class="ow">&lt;-</span> gensym <span class="s">&#34;ignore&#34;</span>
    <span class="c1">-- showPrec : Prec -&gt; name -&gt; String</span>
    <span class="kr">let</span> ty <span class="ow">=</span> <span class="kt">Declare</span> fshowPrec <span class="ow">[</span><span class="kt">MkFunArg</span> `<span class="ow">{{</span>_er<span class="ow">}}</span> <span class="ow">(</span><span class="kt">Var</span> prec<span class="ow">)</span> <span class="kt">Explicit</span> <span class="kt">Erased</span>, <span class="kt">MkFunArg</span> `<span class="ow">{{</span>y<span class="ow">}}</span> <span class="ow">(</span><span class="kt">Var</span> name<span class="ow">)</span> <span class="kt">Explicit</span> <span class="kt">Erased</span><span class="ow">]</span> <span class="ow">(</span><span class="kt">RConstant</span> <span class="kt">StrType</span><span class="ow">)</span>
    <span class="kr">let</span> clauseArg  <span class="ow">=</span> <span class="ow">(</span><span class="kt">RApp</span> <span class="ow">(</span><span class="kt">RApp</span> <span class="ow">(</span><span class="kt">Var</span> fshowPrec<span class="ow">)</span> <span class="ow">(</span><span class="kt">Var</span> ign<span class="ow">))</span> <span class="ow">(</span><span class="kt">Var</span> x<span class="ow">))</span>
    <span class="kr">let</span> clauseBody <span class="ow">=</span> <span class="ow">(</span><span class="kt">RBind</span> ign <span class="ow">(</span><span class="kt">PVar</span> <span class="ow">(</span><span class="kt">Var</span> prec<span class="ow">))</span> <span class="ow">(</span><span class="kt">RBind</span> x <span class="ow">(</span><span class="kt">PVar</span> <span class="ow">(</span><span class="kt">Var</span> name<span class="ow">))</span> <span class="ow">(</span><span class="kt">RApp</span> <span class="ow">(</span><span class="kt">Var</span> fshow<span class="ow">)</span> <span class="ow">(</span><span class="kt">Var</span> x<span class="ow">))))</span>
    <span class="c1">-- showPrec _ x = show x</span>
    <span class="kr">let</span> clause <span class="ow">=</span> <span class="kt">MkFunClause</span> <span class="ow">(</span><span class="kt">RBind</span> ign <span class="ow">(</span><span class="kt">PVar</span> <span class="ow">(</span><span class="kt">Var</span> prec<span class="ow">))</span> <span class="ow">(</span><span class="kt">RBind</span> x <span class="ow">(</span><span class="kt">PVar</span> <span class="ow">(</span><span class="kt">Var</span> name<span class="ow">))</span> clauseArg<span class="ow">))</span> clauseBody
    <span class="kr">let</span> f <span class="ow">=</span> <span class="kt">DefineFun</span> fshowPrec <span class="ow">[</span>clause<span class="ow">]</span>
    declareType ty
    defineFunction f
    pure fshowPrec</code></pre></div>
<p>これで完成しました。全体を再掲するとこうです。</p>
<div class="highlight"><pre class="chroma"><code class="language-idris" data-lang="idris"><span class="nf">deriveShow</span> <span class="ow">:</span> <span class="kt">TTName</span> <span class="ow">-&gt;</span> <span class="kt">Elab</span> <span class="ow">()</span>
deriveShow name <span class="ow">=</span> <span class="kr">do</span>
  dt <span class="ow">&lt;-</span> lookupDatatypeExact name

  fshow <span class="ow">&lt;-</span> genShow dt
  fshowPrec <span class="ow">&lt;-</span> genShowPrec fshow dt

  <span class="kr">let</span> ifc <span class="ow">=</span> `<span class="ow">{{</span><span class="kt">Prelude</span><span class="ow">.</span><span class="kt">Show</span><span class="ow">.</span><span class="kt">Show</span><span class="ow">}}</span>
  inst <span class="ow">&lt;-</span> gensym <span class="s">&#34;showInst&#34;</span>
  ifcData <span class="ow">&lt;-</span> lookupDatatypeExact ifc
  <span class="kr">let</span> <span class="ow">[(</span>ctor, <span class="kr">_</span>, <span class="kr">_</span><span class="ow">)]</span> <span class="ow">=</span> constructors ifcData
  <span class="kr">let</span> instTy <span class="ow">=</span> <span class="kt">Declare</span> inst <span class="ow">[]</span> <span class="ow">(</span><span class="kt">RApp</span> <span class="ow">(</span><span class="kt">Var</span> ifc<span class="ow">)</span> <span class="ow">(</span><span class="kt">Var</span> name<span class="ow">))</span>
  <span class="kr">let</span> instClause <span class="ow">=</span> <span class="kt">MkFunClause</span> <span class="ow">(</span><span class="kt">Var</span> inst<span class="ow">)</span> <span class="ow">(</span><span class="kt">RApp</span> <span class="ow">(</span><span class="kt">RApp</span> <span class="ow">(</span><span class="kt">RApp</span> <span class="ow">(</span><span class="kt">Var</span> ctor<span class="ow">)</span> <span class="ow">(</span><span class="kt">Var</span> name<span class="ow">))</span> <span class="ow">(</span><span class="kt">Var</span> fshow<span class="ow">))</span> <span class="ow">(</span><span class="kt">Var</span> fshowPrec<span class="ow">))</span>
  <span class="kr">let</span> instF <span class="ow">=</span> <span class="kt">DefineFun</span> inst <span class="ow">[</span>instClause<span class="ow">]</span>
  declareType instTy
  defineFunction instF

  addImplementation ifc inst
<span class="kr">where</span>
  <span class="nf">genClause</span> <span class="ow">:</span> <span class="kt">TTName</span> <span class="ow">-&gt;</span> <span class="ow">(</span><span class="kt">TTName</span>, <span class="kt">List</span> <span class="kt">CtorArg</span>, <span class="kt">Raw</span><span class="ow">)</span> <span class="ow">-&gt;</span> <span class="kt">FunClause</span> <span class="kt">Raw</span>
  genClause fname <span class="ow">(</span>cname, <span class="kr">_</span>, <span class="kr">_</span><span class="ow">)</span> <span class="ow">=</span>
    <span class="kr">let</span> <span class="kt">NS</span> <span class="ow">(</span><span class="kt">UN</span> cnameStr<span class="ow">)</span> <span class="kr">_</span> <span class="ow">=</span> cname <span class="kr">in</span>
    <span class="kt">MkFunClause</span> <span class="ow">(</span><span class="kt">RApp</span> <span class="ow">(</span><span class="kt">Var</span> fname<span class="ow">)</span> <span class="ow">(</span><span class="kt">Var</span> cname<span class="ow">))</span> <span class="ow">(</span><span class="kt">RConstant</span> <span class="ow">(</span><span class="kt">Str</span> cnameStr<span class="ow">))</span>
  <span class="nf">genShow</span> <span class="ow">:</span> <span class="kt">Datatype</span> <span class="ow">-&gt;</span> <span class="kt">Elab</span> <span class="kt">TTName</span>
  genShow dt <span class="ow">=</span> <span class="kr">do</span>
    fshow <span class="ow">&lt;-</span> gensym <span class="s">&#34;show&#34;</span>
    x <span class="ow">&lt;-</span> gensym <span class="s">&#34;x&#34;</span>
    <span class="kr">let</span> ty <span class="ow">=</span> <span class="kt">Declare</span> fshow <span class="ow">[</span><span class="kt">MkFunArg</span> x <span class="ow">(</span><span class="kt">Var</span> name<span class="ow">)</span> <span class="kt">Explicit</span> <span class="kt">NotErased</span><span class="ow">]</span> <span class="ow">(</span><span class="kt">RConstant</span> <span class="kt">StrType</span><span class="ow">)</span>
    <span class="kr">let</span> clauses <span class="ow">=</span> map <span class="ow">(</span>genClause fshow<span class="ow">)</span> <span class="ow">$</span> constructors dt
    <span class="kr">let</span> f <span class="ow">=</span> <span class="kt">DefineFun</span> fshow clauses
    declareType ty
    defineFunction f
    pure fshow

  <span class="nf">genShowPrec</span> <span class="ow">:</span> <span class="kt">TTName</span> <span class="ow">-&gt;</span> <span class="kt">Datatype</span> <span class="ow">-&gt;</span> <span class="kt">Elab</span> <span class="kt">TTName</span>
  genShowPrec fshow dt <span class="ow">=</span> <span class="kr">do</span>
    fshowPrec <span class="ow">&lt;-</span> gensym <span class="s">&#34;showPrec&#34;</span>
    <span class="kr">let</span> prec <span class="ow">=</span> `<span class="ow">{{</span><span class="kt">Prelude</span><span class="ow">.</span><span class="kt">Show</span><span class="ow">.</span><span class="kt">Prec</span><span class="ow">}}</span>
    a <span class="ow">&lt;-</span> gensym <span class="s">&#34;a&#34;</span>
    x <span class="ow">&lt;-</span> gensym <span class="s">&#34;x&#34;</span>
    ign <span class="ow">&lt;-</span> gensym <span class="s">&#34;ignore&#34;</span>
    <span class="c1">-- showPrec : Prec -&gt; name -&gt; String</span>
    <span class="kr">let</span> ty <span class="ow">=</span> <span class="kt">Declare</span> fshowPrec <span class="ow">[</span><span class="kt">MkFunArg</span> `<span class="ow">{{</span>_er<span class="ow">}}</span> <span class="ow">(</span><span class="kt">Var</span> prec<span class="ow">)</span> <span class="kt">Explicit</span> <span class="kt">Erased</span>, <span class="kt">MkFunArg</span> `<span class="ow">{{</span>y<span class="ow">}}</span> <span class="ow">(</span><span class="kt">Var</span> name<span class="ow">)</span> <span class="kt">Explicit</span> <span class="kt">Erased</span><span class="ow">]</span> <span class="ow">(</span><span class="kt">RConstant</span> <span class="kt">StrType</span><span class="ow">)</span>
    <span class="kr">let</span> clauseArg  <span class="ow">=</span> <span class="ow">(</span><span class="kt">RApp</span> <span class="ow">(</span><span class="kt">RApp</span> <span class="ow">(</span><span class="kt">Var</span> fshowPrec<span class="ow">)</span> <span class="ow">(</span><span class="kt">Var</span> ign<span class="ow">))</span> <span class="ow">(</span><span class="kt">Var</span> x<span class="ow">))</span>
    <span class="kr">let</span> clauseBody <span class="ow">=</span> <span class="ow">(</span><span class="kt">RBind</span> ign <span class="ow">(</span><span class="kt">PVar</span> <span class="ow">(</span><span class="kt">Var</span> prec<span class="ow">))</span> <span class="ow">(</span><span class="kt">RBind</span> x <span class="ow">(</span><span class="kt">PVar</span> <span class="ow">(</span><span class="kt">Var</span> name<span class="ow">))</span> <span class="ow">(</span><span class="kt">RApp</span> <span class="ow">(</span><span class="kt">Var</span> fshow<span class="ow">)</span> <span class="ow">(</span><span class="kt">Var</span> x<span class="ow">))))</span>
    <span class="c1">-- showPrec _ x = show x</span>
    <span class="kr">let</span> clause <span class="ow">=</span> <span class="kt">MkFunClause</span> <span class="ow">(</span><span class="kt">RBind</span> ign <span class="ow">(</span><span class="kt">PVar</span> <span class="ow">(</span><span class="kt">Var</span> prec<span class="ow">))</span> <span class="ow">(</span><span class="kt">RBind</span> x <span class="ow">(</span><span class="kt">PVar</span> <span class="ow">(</span><span class="kt">Var</span> name<span class="ow">))</span> clauseArg<span class="ow">))</span> clauseBody
    <span class="kr">let</span> f <span class="ow">=</span> <span class="kt">DefineFun</span> fshowPrec <span class="ow">[</span>clause<span class="ow">]</span>
    declareType ty
    defineFunction f
    pure fshowPrec</code></pre></div>
<p>それでは使ってみましょう。</p>
<div class="highlight"><pre class="chroma"><code class="language-idris" data-lang="idris"><span class="kr">data</span> <span class="kt">Janken</span> <span class="ow">=</span> <span class="kt">Gu</span> <span class="ow">|</span> <span class="kt">Choki</span> <span class="ow">|</span> <span class="kt">Pa</span>
<span class="ow">%</span>runElab deriveShow `<span class="ow">{{</span><span class="kt">Main</span><span class="ow">.</span><span class="kt">Janken</span><span class="ow">}}</span></code></pre></div>
<p>これを動かしてみます。</p>
<div class="highlight"><pre class="chroma"><code class="language-idris" data-lang="idris"><span class="kt">Idris</span><span class="ow">&gt;</span> show <span class="kt">Gu</span>
<span class="nf">&#34;Gu&#34;</span> <span class="ow">:</span> <span class="kt">String</span>
<span class="kt">Idris</span><span class="ow">&gt;</span> show <span class="kt">Choki</span>
<span class="nf">&#34;Choki&#34;</span> <span class="ow">:</span> <span class="kt">String</span>
<span class="kt">Idris</span><span class="ow">&gt;</span> show <span class="kt">Pa</span>
<span class="nf">&#34;Pa&#34;</span> <span class="ow">:</span> <span class="kt">String</span>
<span class="nf">Idris&gt;</span> <span class="ow">:</span>t show
<span class="nf">show</span> <span class="ow">:</span> <span class="kt">Show</span> ty <span class="ow">=&gt;</span> ty <span class="ow">-&gt;</span> <span class="kt">String</span></code></pre></div>
<p>ただしく動いていますね。
Idrisのpain pointであったderivingがないという問題を克服できました。</p>

<h1 id="まとめ">まとめ</h1>

<p>Idrisのかなりユニークな機能であるElaboratorリフレクションを紹介しました。
そしてElabを使ったメタプログラミングのデモとして複雑でないデータ型に対して <code>Show</code> を生成できるスクリプトも示しました。</p>
                    </section>
                </article>
            </div>
        </div>

        <div class="row li-author">
    <div class="sixteen columns">
        Written by <strong>κeen</strong>
    </div>
</div>


        <div class="row li-pagination">
            <div class="eight columns">
                <div class="li-pagination-previous">
                    
                        Later article<br />
                        <a href="https://KeenS.github.io/blog/2020/12/25/rustnomutexnopoisoning/"> RustのMutexのPoisoning</a>
                    
                </div>
            </div>
            <div class="eight columns">
                <div class="li-pagination-next">
                    
                        Older article<br />
                        <a href="https://KeenS.github.io/blog/2020/12/24/idrisnoffitocodegen_c_javascript_/"> IdrisのFFIとCodegen（C、JavaScript）</a>
                    
                </div>
            </div>
        </div>
    </div>

<footer class="li-page-footer">
    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <div class="li-page-footer-legal">
                    &copy; 2021. All rights reserved. 
                </div>
                <div class="li-page-footer-theme">
                    <span class=""><a href="https://github.com/eliasson/liquorice/">liquorice</a> is a theme for <a href="http://hugo.spf13.com">hugo</a></span>
                </div>
            </div>
        </div>
    </div>
</footer>

<script type="text/javascript">
 function toggle(id) {
     var e = document.getElementById(id);
     e.style.display == 'block' ? e.style.display = 'none' : e.style.display = 'block';
 }
</script>
<script src="https://unpkg.com/mermaid@7.0.4/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true
     });</script>

    </body>
</html>

