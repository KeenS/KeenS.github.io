<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
    <head>
        
        
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-43779888-1"></script>
        <script>
         window.dataLayer = window.dataLayer || [];
         function gtag(){dataLayer.push(arguments);}
         gtag('js', new Date());

         gtag('config', 'UA-43779888-1');
        </script>
        

        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

        <meta name="twitter:site" content="@blackenedgold" />
        <meta name="twitter:title" content="Idrisのパッケージとipkg | κeenのHappy Hacκing Blog"/>
        <meta name="twitter:description" content="このエントリはIdris Advent Calendar 2020の14日目の記事です。
κeenです。今回はIdrisのパッケージ機能とipkgについて説明します。" />
        <meta property="og:title" content="Idrisのパッケージとipkg | κeenのHappy Hacκing Blog" />
        <meta property="og:type" content="article" />
        <meta property="og:url" content="https://KeenS.github.io/blog/2020/12/17/idrisnopakke_jitoipkg/" />
        <meta property="og:description" content="このエントリはIdris Advent Calendar 2020の14日目の記事です。
κeenです。今回はIdrisのパッケージ機能とipkgについて説明します。" />
        <meta name="twitter:card" content="summary_large_image" />
        <meta property="og:image" content="https://KeenS.github.io/images/ogp/post/Idrisnopakke_jitoipkg.png" />
        <meta name="twitter:image" content="https://KeenS.github.io/images/ogp/post/Idrisnopakke_jitoipkg.png" />
        
        <meta property="og:article:published_time" content="2020-12-17 06:45:33 &#43;0900 JST" />
        <meta property="og:article:modified_time" content="2020-12-17 06:45:33 &#43;0900 JST" />
        
        <meta property="og:article:author" content="κeen" />

        <title>Idrisのパッケージとipkg | κeenのHappy Hacκing Blog</title>
        <link rel="stylesheet" href='//fonts.googleapis.com/css?family=Open+Sans:400,300,600' type='text/css' />
        <link rel="stylesheet" href="https://KeenS.github.io/libraries/normalize.3.0.1.css" />
        <link rel="stylesheet" href="https://KeenS.github.io/css/liquorice.css" />
        <link rel="apple-touch-icon" sizes="180x180" href="https://KeenS.github.io/apple-touch-icon.png">
        <link rel="icon" type="image/png" href="https://KeenS.github.io/favicon-32x32.png" sizes="32x32">
        <link rel="icon" type="image/png" href="https://KeenS.github.io/favicon-16x16.png" sizes="16x16">
        <link rel="manifest" href="https://KeenS.github.io/manifest.json">
        <link rel="mask-icon" href="https://KeenS.github.io/safari-pinned-tab.svg" color="#5bbad5">
        <meta name="theme-color" content="#ffffff">
        <link rel="apple-touch-icon-precomposed" href="https://KeenS.github.io/apple-touch-icon-144-precomposed.png" sizes="144x144" />
        <link rel="stylesheet" href="https://KeenS.github.io/css/syntax-monokai.css" />
<script type="text/x-mathjax-config">
 MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ["\\(","\\)"]] } });
</script>
<script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_CHTML"></script>
</script>
<meta http-equiv="X-UA-Compatible" CONTENT="IE=EmulateIE7" />
<link rel="stylesheet" href="//unpkg.com/mermaid@7.0.4/dist/mermaid.forest.min.css">

    </head>
    <body class="li-body">

<header class="li-page-header" id="page-header">
    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <div class="li-brand li-left">
                <a href="https://KeenS.github.io/">κeenのHappy Hacκing Blog</a> | Lispエイリアンの狂想曲</div>
                <div class="li-menu li-right">
                    <span class="li-menu-icon" onclick="javascript:toggle('menu');">&#9776;</span>
                    <ul id="menu2" class="li-menu-items">
                        
                            <li><a href="https://KeenS.github.io/about/"> About </a></li>
                        
                            <li><a href="https://KeenS.github.io/post/"> Blog </a></li>
                        
                            <li><a href="https://KeenS.github.io/slide/"> Slide </a></li>
                        
                            <li><a href="https://KeenS.github.io/index.xml"> Atom </a></li>
                        
                            <li><a href="https://KeenS.github.io/search/"> Search </a></li>
                        
                    </ul>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="sixteen columns">
                <ul id="menu" class="li-menu-items li-menu-mobile">
                    
                        <li><a href="https://KeenS.github.io/about/"> About </a></li>
                    
                        <li><a href="https://KeenS.github.io/post/"> Blog </a></li>
                    
                        <li><a href="https://KeenS.github.io/slide/"> Slide </a></li>
                    
                        <li><a href="https://KeenS.github.io/index.xml"> Atom </a></li>
                    
                        <li><a href="https://KeenS.github.io/search/"> Search </a></li>
                    
                </ul>
            </div>
        </div>
    </div>
</header>






    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <article class="li-article">
                    <header class="li-article-header">
                        <h1 class="li-article-title">Idrisのパッケージとipkg</h1>
                        <div class="li-article-meta">
    <time class="li-article-date">2020-12-17</time>
    <ul class="li-article-tag">
    
        <li>
            <a href="https://KeenS.github.io/categories/idris">Idris</a>
        </li>
    
        <li>
            <a href="https://KeenS.github.io/categories/idris-advent-calendar">Idris Advent Calendar</a>
        </li>
    
        <li>
            <a href="https://KeenS.github.io/categories/advent-calendar-2020">Advent Calendar 2020</a>
        </li>
    
        <li>
            <a href="https://KeenS.github.io/categories/advent-calendar">Advent Calendar</a>
        </li>
    
</ul>

</div>

                    </header>
                    <section>
                        <p>このエントリは<a href="https://qiita.com/advent-calendar/2020/idris">Idris Advent Calendar 2020</a>の14日目の記事です。</p>
<p>κeenです。今回はIdrisのパッケージ機能とipkgについて説明します。</p>
<p><code>idris</code> コマンドは単体でかなり高機能で、パッケージシステムも内包します。</p>
<p>標準ライブラリにpreludeとbaseがあるのは既に説明したとおりですが、他にもcontrib、effects、pruvilojというパッケージも添付されています。これらはパッケージシステムを使ってリンクしないと使えないようになっています。</p>
<p>これらの中でも<a href="https://www.idris-lang.org/docs/current/contrib_doc/">contrib</a>は重要です。
Idrisは標準ライブラリへの貢献に対してかなり保守的な態度を取っており、大抵のライブラリ強化の提案はcontribへとマージされることになっています。結果としてcontribがないとライブラリが貧弱な言語になってしまいます。</p>
<h1 id="contribを使うアナグラム">contribを使う：アナグラム</h1>
<p>まずはパッケージを使ってみましょう。<a href="https://ja.wikipedia.org/wiki/%E3%82%A2%E3%83%8A%E3%82%B0%E3%83%A9%E3%83%A0">アナグラム</a>を検知するプログラムです。例えば&quot;eat&quot;と&quot;ate&quot;は文字を並べ替えると互いに変換できるのでアナグラムの関係にあります。</p>
<p>実装方針としてはアナグラムの正規形、文字をアルファベット順に整列したものをキーとしてアナグラムの集合をバリューにもつマップを作ればよさそうです。上の例だと <code>&quot;aet&quot; -&gt; [&quot;eat&quot;, &quot;ate&quot;]</code> の関係を保持します。</p>
<p>キーバリューペアはcontribの <a href="https://www.idris-lang.org/docs/current/contrib_doc/docs/Data.SortedMap.html"><code>Data.SortedMap</code></a> にあり、集合は <a href="https://www.idris-lang.org/docs/current/contrib_doc/docs/Data.SortedSet.html"><code>Data.SortedSet</code></a>にあります。早速使っていきましょう。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl"><span class="kr">module</span> <span class="nn">Anagram</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Data.SortedMap</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Data.SortedSet</span>
</span></span></code></pre></div><p>まずは <code>SortedMap</code> をインポートしました。</p>
<h2 id="最初の値">最初の値</h2>
<p>空のDBも定義しておきましょう。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl">export
</span></span><span class="line"><span class="cl"><span class="nf">AnagramDB</span> <span class="ow">:</span> <span class="kt">Type</span>
</span></span><span class="line"><span class="cl"><span class="kt">AnagramDB</span> <span class="ow">=</span> <span class="kt">SortedMap</span> <span class="kt">String</span> <span class="ow">(</span><span class="kt">SortedSet</span> <span class="kt">String</span><span class="ow">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">export
</span></span><span class="line"><span class="cl"><span class="nf">emptyDB</span> <span class="ow">:</span> <span class="kt">AnagramDB</span>
</span></span><span class="line"><span class="cl">emptyDB <span class="ow">=</span> empty
</span></span></code></pre></div><h2 id="単語の登録">単語の登録</h2>
<p>新しい値を登録する処理 <code>register</code> は、まずは登録する単語の正規形を計算して、それをキーにDBにエントリがあればリストにデータを加え、なければ新たにデータを登録すればよさそうです。</p>
<p>まずは正規形を計算する関数を。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl"><span class="nf">normalize</span> <span class="ow">:</span> <span class="kt">String</span> <span class="ow">-&gt;</span> <span class="kt">String</span>
</span></span><span class="line"><span class="cl">normalize <span class="ow">=</span> pack <span class="ow">.</span> sort <span class="ow">.</span> unpack
</span></span></code></pre></div><p><code>normalize</code> は少し説明が必要でしょうか。ここで使っている <code>.</code> は関数の合成です。
そして <code>unpack: String -&gt; List Char</code> と <code>pack: List Char -&gt; String</code> はそれぞれ <code>String</code> &lt;-&gt; <code>List Char</code> の変換を担当します。</p>
<p>合成の様子を順番に見ると、以下のような動きをします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">Idris&gt; unpack &#34;eat&#34;
</span></span><span class="line"><span class="cl">[&#39;e&#39;, &#39;a&#39;, &#39;t&#39;] : List Char
</span></span><span class="line"><span class="cl">Idris&gt; (sort . unpack) &#34;eat&#34;
</span></span><span class="line"><span class="cl">[&#39;a&#39;, &#39;e&#39;, &#39;t&#39;] : List Char
</span></span><span class="line"><span class="cl">Idris&gt; (pack . sort . unpack) &#34;eat&#34;
</span></span><span class="line"><span class="cl">&#34;aet&#34; : String
</span></span></code></pre></div><p>あとの <code>register</code> は簡単に書けます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl">export
</span></span><span class="line"><span class="cl"><span class="nf">register</span><span class="ow">:</span> <span class="kt">AnagramDB</span> <span class="ow">-&gt;</span> <span class="kt">String</span> <span class="ow">-&gt;</span> <span class="kt">AnagramDB</span>
</span></span><span class="line"><span class="cl">register db word <span class="ow">=</span>
</span></span><span class="line"><span class="cl">  <span class="kr">let</span> key <span class="ow">=</span> normalize word <span class="kr">in</span>
</span></span><span class="line"><span class="cl">  <span class="kr">case</span> lookup key db <span class="kr">of</span>
</span></span><span class="line"><span class="cl">    <span class="kt">Just</span> set <span class="ow">=&gt;</span> insert key <span class="ow">(</span>insert word set<span class="ow">)</span> db
</span></span><span class="line"><span class="cl">    <span class="kt">Nothing</span>   <span class="ow">=&gt;</span> insert key <span class="ow">(</span>insert word empty<span class="ow">)</span> db
</span></span></code></pre></div><p><code>insert word set</code> と <code>insert word empty</code> をみてどうにか頑張れば1つにまとめられるのではと気付いた方、勘がいいです。 <code>SortedMap</code> と <code>union</code> 演算は（自由）半群なので多少楽に書けるAPIもありますが、今回はパッケージ以外はあんまり変なことをしない方針なので一旦スルーします。興味があればドキュメントを読んで別の実装を与えてみて下さい。</p>
<h2 id="単語のクエリ">単語のクエリ</h2>
<p>ある単語のアナグラムを検索する関数 <code>query</code> も作っておきましょう。
1つ注意しないといけないのが、その単語は自身のアナグラムなので必ずアナグラムは1つ以上あるということです。
さらに、その単語自体は登録されてなくてもアナグラムが登録されていれば返す値に検索ワードも入れないといけない点です。
それに注意して実装すると以下のようになります。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl">export
</span></span><span class="line"><span class="cl"><span class="nf">query</span> <span class="ow">:</span> <span class="kt">AnagramDB</span> <span class="ow">-&gt;</span> <span class="kt">String</span> <span class="ow">-&gt;</span> <span class="kt">SortedSet</span> <span class="kt">String</span>
</span></span><span class="line"><span class="cl">query db word <span class="ow">=</span>
</span></span><span class="line"><span class="cl">  <span class="kr">let</span> key <span class="ow">=</span> normalize word <span class="kr">in</span>
</span></span><span class="line"><span class="cl">  <span class="kr">case</span> lookup key db <span class="kr">of</span>
</span></span><span class="line"><span class="cl">    <span class="kt">Just</span> set <span class="ow">=&gt;</span> insert word set
</span></span><span class="line"><span class="cl">    <span class="kt">Nothing</span>   <span class="ow">=&gt;</span> insert word empty
</span></span></code></pre></div><h2 id="パッケージのリンク">パッケージのリンク</h2>
<p>一旦REPLで様子を見たいんですが、REPLでcontribを使えるようにしないといけませんね。
<code>-p パッケージ名</code> でパッケージをロードした状態でREPLをはじめられます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ idris -p contrib Anagram.idr
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">Anagram*&gt; 
</span></span></code></pre></div><p>型チェックまで通ったら試してみましょう。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">*Anagram&gt; :let db = register (register emptyDB &#34;eat&#34;) &#34;ate&#34;
</span></span><span class="line"><span class="cl">*Anagram&gt; query db &#34;tea&#34;
</span></span><span class="line"><span class="cl">SetWrapper (M 1 (Branch3 (Leaf &#34;ate&#34; ()) &#34;ate&#34; (Leaf &#34;eat&#34; ()) &#34;eat&#34; (Leaf &#34;tea&#34; ()))) : SortedSet String
</span></span></code></pre></div><p>ちょっとみづらいですが  &ldquo;ate&rdquo; 、 &ldquo;eat&rdquo; 、 &ldquo;tea&rdquo; が含まれているのでよさそうです。</p>
<h2 id="ファイルからの読み込み">ファイルからの読み込み</h2>
<p>さっきまでの内容はライブラリとして、 <code>Main</code> を作っていきましょう</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl"><span class="kr">module</span> <span class="nn">Main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Anagram</span>
</span></span></code></pre></div><p>さて、単語が沢山書かれているファイルから読み込んで、DBに登録してみましょう。
UNIX系OSを使っているなら <code>/usr/share/dict/words</code> というファイルがあるはずです。ここに10万くらいの単語が入っています。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ wc -l /usr/share/dict/words
</span></span><span class="line"><span class="cl">102774 /usr/share/dict/words
</span></span></code></pre></div><p>1/5000くらいランダムサンプリングしてみましょう。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ cat  /usr/share/dict/words | awk &#39;int(rand()*5000) == 1 { print $0 }&#39;
</span></span><span class="line"><span class="cl">Chengdu&#39;s
</span></span><span class="line"><span class="cl">Edinburgh
</span></span><span class="line"><span class="cl">Poitier
</span></span><span class="line"><span class="cl">aforementioned
</span></span><span class="line"><span class="cl">ambulatory
</span></span><span class="line"><span class="cl">busbies
</span></span><span class="line"><span class="cl">confetti
</span></span><span class="line"><span class="cl">courier&#39;s
</span></span><span class="line"><span class="cl">cowslip
</span></span><span class="line"><span class="cl">decorous
</span></span><span class="line"><span class="cl">demurred
</span></span><span class="line"><span class="cl">deviants
</span></span><span class="line"><span class="cl">dotcom&#39;s
</span></span><span class="line"><span class="cl">fabricates
</span></span><span class="line"><span class="cl">freebasing
</span></span><span class="line"><span class="cl">glorification
</span></span><span class="line"><span class="cl">libellers
</span></span><span class="line"><span class="cl">male
</span></span><span class="line"><span class="cl">neocolonialism
</span></span><span class="line"><span class="cl">plasticity&#39;s
</span></span><span class="line"><span class="cl">reduces
</span></span><span class="line"><span class="cl">sough
</span></span><span class="line"><span class="cl">temptation&#39;s
</span></span><span class="line"><span class="cl">wrapping&#39;s
</span></span></code></pre></div><p>このように本当に単語が改行で並べられているだけのファイルです。
ここからアナグラムDBを作りましょう。
<code>/usr/share/dict/words</code> がなかった方は適当にファイルを用意して下さい。</p>
<p>もうそろそろ解説がなくても読めるようになった頃ですかね。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl"><span class="nf">importFromFile</span> <span class="ow">:</span> <span class="ow">(</span>filename<span class="ow">:</span> <span class="kt">String</span><span class="ow">)</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="ow">(</span><span class="kt">Either</span> <span class="kt">FileError</span> <span class="kt">AnagramDB</span><span class="ow">)</span>
</span></span><span class="line"><span class="cl">importFromFile filename <span class="ow">=</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">  <span class="kt">Right</span> file <span class="ow">&lt;-</span> openFile filename <span class="kt">Read</span>
</span></span><span class="line"><span class="cl">    <span class="ow">|</span> <span class="kt">Left</span> e <span class="ow">=&gt;</span> pure <span class="ow">(</span><span class="kt">Left</span> e<span class="ow">)</span>
</span></span><span class="line"><span class="cl">  loop file emptyDB
</span></span><span class="line"><span class="cl"><span class="kr">where</span>
</span></span><span class="line"><span class="cl">  <span class="nf">loop</span> <span class="ow">:</span> <span class="kt">File</span> <span class="ow">-&gt;</span> <span class="kt">AnagramDB</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="ow">(</span><span class="kt">Either</span> <span class="kt">FileError</span> <span class="kt">AnagramDB</span><span class="ow">)</span>
</span></span><span class="line"><span class="cl">  loop file db <span class="ow">=</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">    isEOF <span class="ow">&lt;-</span> fEOF file
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> isEOF
</span></span><span class="line"><span class="cl">    <span class="kr">then</span> pure <span class="ow">$</span> <span class="kt">Right</span> db
</span></span><span class="line"><span class="cl">    <span class="kr">else</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">      <span class="kt">Right</span> word <span class="ow">&lt;-</span> fGetLine file
</span></span><span class="line"><span class="cl">        <span class="ow">|</span> <span class="kt">Left</span> e <span class="ow">=&gt;</span> pure <span class="ow">(</span><span class="kt">Left</span> e<span class="ow">)</span>
</span></span><span class="line"><span class="cl">      <span class="kr">let</span> db <span class="ow">=</span> register db <span class="ow">(</span>trim word<span class="ow">)</span>
</span></span><span class="line"><span class="cl">      loop file db
</span></span></code></pre></div><p>これも一旦REPLにロードして実行してみましょう。
<code>-p contrib</code> を忘れずに。</p>
<p>ここで <code>/usr/share/dict/words</code> をロードしたいところですが問題があります。
今まで説明してませんでしたがREPLだとコンパイラを通さずインタプリタで実行するので遅いです。
そのREPLで10万語を読み込むのには不安があります。</p>
<p>ということで一旦100語くらいの辞書を作りましょう。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ cat  /usr/share/dict/words <span class="p">|</span> awk <span class="s1">&#39;int(rand()*1000) == 1 { print $0 }&#39;</span> &gt; smalldict.txt
</span></span></code></pre></div><p>これくらいだったらブログにも載るので付録に置いておきます。</p>
<p>では、これを実行してみましょう。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">*AnagramMain&gt; :x (importFromFile &#34;smalldict.txt&#34;)
</span></span><span class="line"><span class="cl">Can&#39;t convert handles back to TT after execution.
</span></span></code></pre></div><p>成功したか分かりづらいですがエラーは出てないので大丈夫でしょう。</p>
<h2 id="表示実行">表示、実行</h2>
<p>そろそろパッケージから離れてきたのでサクっといきましょう。</p>
<p><code>SortedSet</code> はそのままだと表示できないので加工する必要があります。 <code>Data.SortedSet</code> をいインポートしておきましょう。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Data.SortedSet</span>
</span></span></code></pre></div><p>表示、 <code>main</code> は以下です。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl"><span class="nf">showResult</span><span class="ow">:</span> <span class="kt">AnagramDB</span> <span class="ow">-&gt;</span> <span class="kt">String</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="ow">()</span>
</span></span><span class="line"><span class="cl">showResult db word <span class="ow">=</span>
</span></span><span class="line"><span class="cl">  <span class="kr">let</span> anagrams <span class="ow">=</span> <span class="kt">Anagram</span><span class="ow">.</span>query db word <span class="kr">in</span>
</span></span><span class="line"><span class="cl">  printLn <span class="ow">$</span> <span class="kt">SortedSet</span><span class="ow">.</span>toList anagrams
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">main</span> <span class="ow">:</span> <span class="kt">IO</span> <span class="ow">()</span>
</span></span><span class="line"><span class="cl">main <span class="ow">=</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">  <span class="ow">[</span><span class="kr">_</span>, key<span class="ow">]</span> <span class="ow">&lt;-</span> getArgs
</span></span><span class="line"><span class="cl">  <span class="kt">Right</span> db <span class="ow">&lt;-</span> importFromFile <span class="s">&#34;/usr/share/dict/words&#34;</span>
</span></span><span class="line"><span class="cl">  showResult db key
</span></span></code></pre></div><p>今回はコンパイルして実行するので <code>/usr/share/dict/words</code> を読み込んでます。</p>
<p>以下のコマンドでコンパイル/実行します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl"><span class="ow">$</span> idris <span class="ow">-</span>o <span class="kt">AnagramMain</span> <span class="ow">-</span>p contrib <span class="kt">AnagramMain</span><span class="ow">.</span>idr
</span></span><span class="line"><span class="cl"><span class="ow">$</span> <span class="ow">./</span><span class="kt">AnagramMain</span> tea
</span></span><span class="line"><span class="cl"><span class="ow">[</span><span class="s">&#34;ate&#34;</span>, <span class="s">&#34;eat&#34;</span>, <span class="s">&#34;eta&#34;</span>, <span class="s">&#34;tea&#34;</span><span class="ow">]</span>
</span></span></code></pre></div><p>多少時間がかかりますが、正しく動いています。</p>
<h1 id="パッケージを作る">パッケージを作る</h1>
<p>さきほどのアナグラムをパッケージにしてみましょう。
パッケージにすることでビルドが楽になります。</p>
<p>新しくディレクトリを作り、さらにその下に <code>src/</code> を作ります。
そして先程の <code>Anagram.idr</code> と <code>AnagramMain.idr</code> を <code>src</code> に入れます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ mkdir -p anagram/src
</span></span><span class="line"><span class="cl">$ mv Anagram.idr anagram/src
</span></span><span class="line"><span class="cl">$ mv AnagramMain.idr anagram/src
</span></span><span class="line"><span class="cl">$ cd anagram
</span></span></code></pre></div><h2 id="ipkg">ipkg</h2>
<p>Idrisにはパッケージ機構があるのは説明した通りです。そのためのファイルを書きましょう。
<code>anagram.ipkg</code> に以下の内容を書きます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">package anagram
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">version = &#34;0.1.0&#34;
</span></span><span class="line"><span class="cl">author = your name
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sourcedir = src
</span></span><span class="line"><span class="cl">modules = Anagram
</span></span><span class="line"><span class="cl">        , AnagramMain
</span></span><span class="line"><span class="cl">main = AnagramMain
</span></span><span class="line"><span class="cl">executable = anagram
</span></span><span class="line"><span class="cl">pkgs = contrib
</span></span></code></pre></div><p>少し解説しましょう。
ipkgはIdrisの独自フォーマットで、パッケージのメタデータやビルド情報などを記述します。</p>
<p>中身は <code>package</code> から始まります。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">package anagram
</span></span></code></pre></div><p>そして <code>version</code> 、 <code>author</code> などのメタ情報を書きます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">version = &#34;0.1.0&#34;
</span></span><span class="line"><span class="cl">author = your name
</span></span></code></pre></div><p>ソースコード情報として <code>sourcedir</code> や <code>modules</code> も書きます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">sourcedir = src
</span></span><span class="line"><span class="cl">modules = Anagram
</span></span><span class="line"><span class="cl">        , AnagramMain
</span></span></code></pre></div><p><code>main</code> のあるファイルや作成する実行可能ファイルも書きます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">main = AnagramMain
</span></span><span class="line"><span class="cl">executable = anagram
</span></span></code></pre></div><p>ビルドするときにリンクするパッケージを書きます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">pkgs = contrib
</span></span></code></pre></div><p>詳細は<a href="http://docs.idris-lang.org/en/latest/reference/packages.html#ref-sect-packages">ドキュメント</a>を読んで下さい。</p>
<p>これをビルドしてみましょう。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ idris --build anagram.ipkg
</span></span><span class="line"><span class="cl">$ ls
</span></span><span class="line"><span class="cl">anagram  anagram.ipkg  src
</span></span></code></pre></div><p>カレントディレクトリに <code>anagram</code> ができました。実行してみましょう。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ ./anagram ocean
</span></span><span class="line"><span class="cl">[&#34;canoe&#34;, &#34;ocean&#34;]
</span></span></code></pre></div><p>正しく動いていますね。</p>
<p>このようにパッケージを作るとコマンド一発でビルドできるようになります。</p>
<h1 id="パッケージをインストールする">パッケージをインストールする</h1>
<p><code>idris --install IPKG</code> でライブラリをインストールすることもできます。
IdrisのWikiにはサードパーティのライブラリが載っていて、それをダウンロードしてインストールできる仕組みになっています。</p>
<p><a href="https://github.com/idris-lang/Idris-dev/wiki/Libraries">Libraries · idris-lang/Idris-dev Wiki</a></p>
<p>ライブラリを使わないまでも、インストールだけでも試してみましょう。<a href="https://github.com/ziman/lightyear">lightyear</a>をインストールしてみます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ git clone https://github.com/ziman/lightyear.git
</span></span><span class="line"><span class="cl">$ cd lightyear
</span></span><span class="line"><span class="cl">$ idris --install lightyear.ipkg
</span></span><span class="line"><span class="cl">Type checking ./Lightyear/Position.idr
</span></span><span class="line"><span class="cl">Type checking ./Lightyear/Core.idr
</span></span><span class="line"><span class="cl">Type checking ./Lightyear/Combinators.idr
</span></span><span class="line"><span class="cl">Type checking ./Lightyear.idr
</span></span><span class="line"><span class="cl">Type checking ./Lightyear/Char.idr
</span></span><span class="line"><span class="cl">Type checking ./Lightyear/Strings.idr
</span></span><span class="line"><span class="cl">Type checking ./Lightyear/StringFile.idr
</span></span><span class="line"><span class="cl">Type checking ./Lightyear/Testing.idr
</span></span><span class="line"><span class="cl">Installing Lightyear.ibc to /home/shun/.cabal/store/ghc-8.8.3/idris-1.3.3-0851a67ad4b1dcdc142d91174b2e9b6104a6df9b6243943de3f9ab0e56756b9a/share/libs/lightyear
</span></span><span class="line"><span class="cl">Installing Lightyear/Position.ibc to /home/shun/.cabal/store/ghc-8.8.3/idris-1.3.3-0851a67ad4b1dcdc142d91174b2e9b6104a6df9b6243943de3f9ab0e56756b9a/share/libs/lightyear/Lightyear
</span></span><span class="line"><span class="cl">Installing Lightyear/Core.ibc to /home/shun/.cabal/store/ghc-8.8.3/idris-1.3.3-0851a67ad4b1dcdc142d91174b2e9b6104a6df9b6243943de3f9ab0e56756b9a/share/libs/lightyear/Lightyear
</span></span><span class="line"><span class="cl">Installing Lightyear/Combinators.ibc to /home/shun/.cabal/store/ghc-8.8.3/idris-1.3.3-0851a67ad4b1dcdc142d91174b2e9b6104a6df9b6243943de3f9ab0e56756b9a/share/libs/lightyear/Lightyear
</span></span><span class="line"><span class="cl">Installing Lightyear/StringFile.ibc to /home/shun/.cabal/store/ghc-8.8.3/idris-1.3.3-0851a67ad4b1dcdc142d91174b2e9b6104a6df9b6243943de3f9ab0e56756b9a/share/libs/lightyear/Lightyear
</span></span><span class="line"><span class="cl">Installing Lightyear/Strings.ibc to /home/shun/.cabal/store/ghc-8.8.3/idris-1.3.3-0851a67ad4b1dcdc142d91174b2e9b6104a6df9b6243943de3f9ab0e56756b9a/share/libs/lightyear/Lightyear
</span></span><span class="line"><span class="cl">Installing Lightyear/Char.ibc to /home/shun/.cabal/store/ghc-8.8.3/idris-1.3.3-0851a67ad4b1dcdc142d91174b2e9b6104a6df9b6243943de3f9ab0e56756b9a/share/libs/lightyear/Lightyear
</span></span><span class="line"><span class="cl">Installing Lightyear/Testing.ibc to /home/shun/.cabal/store/ghc-8.8.3/idris-1.3.3-0851a67ad4b1dcdc142d91174b2e9b6104a6df9b6243943de3f9ab0e56756b9a/share/libs/lightyear/Lightyear
</span></span><span class="line"><span class="cl">Installing 00lightyear-idx.ibc to /home/shun/.cabal/store/ghc-8.8.3/idris-1.3.3-0851a67ad4b1dcdc142d91174b2e9b6104a6df9b6243943de3f9ab0e56756b9a/share/libs/lightyear
</span></span></code></pre></div><p>このようにインストールできます。インストールが済んでしまえば <code>idris -p lightyear</code> やipkgの <code>pkgs</code> に書くと使えるようになります。
シンプルながらも簡単に使えていいですね。</p>
<h1 id="ipkgの他の機能">ipkgの他の機能</h1>
<p><code>--build</code> や <code>--install</code> を紹介しましたが、REPLに読み込む <code>--repl</code> やドキュメントの作成などがあります。
<code>idris --help</code> などで確認してみて下さい。</p>
<h1 id="まとめ">まとめ</h1>
<p>Idrisのパッケージやipkgの紹介をしました。</p>
<p>ipkgは便利ですが、コマンドが長いのといつも <code>.ipkg</code> の書き方を忘れるので私は便利コマンドを作っていたりします。</p>
<p><a href="https://gitlab.com/blackenedgold/ipkg">blackenedgold/ipkg</a></p>
<p>もし興味があれば使ってみて下さい。</p>
<h1 id="付録">付録</h1>
<p>100語の辞書</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">Alba&#39;s
</span></span><span class="line"><span class="cl">Ceylon
</span></span><span class="line"><span class="cl">Goddard&#39;s
</span></span><span class="line"><span class="cl">Guggenheim
</span></span><span class="line"><span class="cl">Ines
</span></span><span class="line"><span class="cl">Kubrick&#39;s
</span></span><span class="line"><span class="cl">Muslims
</span></span><span class="line"><span class="cl">Paderewski&#39;s
</span></span><span class="line"><span class="cl">Phillipa&#39;s
</span></span><span class="line"><span class="cl">Reinhardt
</span></span><span class="line"><span class="cl">Rumsfeld&#39;s
</span></span><span class="line"><span class="cl">Salome&#39;s
</span></span><span class="line"><span class="cl">Saudi&#39;s
</span></span><span class="line"><span class="cl">Schlitz
</span></span><span class="line"><span class="cl">Titanic
</span></span><span class="line"><span class="cl">Waldheim&#39;s
</span></span><span class="line"><span class="cl">Xi&#39;an&#39;s
</span></span><span class="line"><span class="cl">abide
</span></span><span class="line"><span class="cl">aborted
</span></span><span class="line"><span class="cl">acceded
</span></span><span class="line"><span class="cl">adaptability
</span></span><span class="line"><span class="cl">affirm
</span></span><span class="line"><span class="cl">amiability
</span></span><span class="line"><span class="cl">asphalting
</span></span><span class="line"><span class="cl">belligerency
</span></span><span class="line"><span class="cl">blasphemed
</span></span><span class="line"><span class="cl">boars
</span></span><span class="line"><span class="cl">bowl
</span></span><span class="line"><span class="cl">caldrons
</span></span><span class="line"><span class="cl">carefullest
</span></span><span class="line"><span class="cl">cesarian
</span></span><span class="line"><span class="cl">commissioner
</span></span><span class="line"><span class="cl">conciliators
</span></span><span class="line"><span class="cl">conclusion&#39;s
</span></span><span class="line"><span class="cl">constituents
</span></span><span class="line"><span class="cl">cowardly
</span></span><span class="line"><span class="cl">crush&#39;s
</span></span><span class="line"><span class="cl">defender
</span></span><span class="line"><span class="cl">dewy
</span></span><span class="line"><span class="cl">downers
</span></span><span class="line"><span class="cl">drabs
</span></span><span class="line"><span class="cl">drouthes
</span></span><span class="line"><span class="cl">finality&#39;s
</span></span><span class="line"><span class="cl">gaskets
</span></span><span class="line"><span class="cl">giggle
</span></span><span class="line"><span class="cl">glamour&#39;s
</span></span><span class="line"><span class="cl">greasy
</span></span><span class="line"><span class="cl">grouting
</span></span><span class="line"><span class="cl">headgear
</span></span><span class="line"><span class="cl">hied
</span></span><span class="line"><span class="cl">hookworm&#39;s
</span></span><span class="line"><span class="cl">hurry
</span></span><span class="line"><span class="cl">knot
</span></span><span class="line"><span class="cl">lab
</span></span><span class="line"><span class="cl">lavishest
</span></span><span class="line"><span class="cl">louvered
</span></span><span class="line"><span class="cl">mallet
</span></span><span class="line"><span class="cl">markdown
</span></span><span class="line"><span class="cl">minuscule
</span></span><span class="line"><span class="cl">misdeals
</span></span><span class="line"><span class="cl">misquote&#39;s
</span></span><span class="line"><span class="cl">mitosis
</span></span><span class="line"><span class="cl">mountaineers
</span></span><span class="line"><span class="cl">objectionably
</span></span><span class="line"><span class="cl">overawing
</span></span><span class="line"><span class="cl">ovule
</span></span><span class="line"><span class="cl">pertinacious
</span></span><span class="line"><span class="cl">phototypesetting
</span></span><span class="line"><span class="cl">phrased
</span></span><span class="line"><span class="cl">polliwog
</span></span><span class="line"><span class="cl">promiscuity
</span></span><span class="line"><span class="cl">quadruplet
</span></span><span class="line"><span class="cl">replete
</span></span><span class="line"><span class="cl">repugnance&#39;s
</span></span><span class="line"><span class="cl">safekeeping
</span></span><span class="line"><span class="cl">salt&#39;s
</span></span><span class="line"><span class="cl">spanks
</span></span><span class="line"><span class="cl">spun
</span></span><span class="line"><span class="cl">steamship&#39;s
</span></span><span class="line"><span class="cl">supermen
</span></span><span class="line"><span class="cl">suspenseful
</span></span><span class="line"><span class="cl">suspicion&#39;s
</span></span><span class="line"><span class="cl">taxidermists
</span></span><span class="line"><span class="cl">teetotaller
</span></span><span class="line"><span class="cl">testosterone&#39;s
</span></span><span class="line"><span class="cl">tints
</span></span><span class="line"><span class="cl">totalitarians
</span></span><span class="line"><span class="cl">tramming
</span></span><span class="line"><span class="cl">typography
</span></span><span class="line"><span class="cl">wafers
</span></span><span class="line"><span class="cl">wear
</span></span><span class="line"><span class="cl">weasel
</span></span><span class="line"><span class="cl">whined
</span></span><span class="line"><span class="cl">workingman
</span></span></code></pre></div>
                    </section>
                </article>
            </div>
        </div>

        <div class="row li-author">
    <div class="sixteen columns">
        Written by <strong>κeen</strong>
    </div>
</div>


        <div class="row li-pagination">
            <div class="eight columns">
                <div class="li-pagination-previous">
                    
                        Later article<br />
                        <a href="https://KeenS.github.io/blog/2020/12/19/idrisdocnotsukaikata/"> Idrisdocの使い方</a>
                    
                </div>
            </div>
            <div class="eight columns">
                <div class="li-pagination-next">
                    
                        Older article<br />
                        <a href="https://KeenS.github.io/blog/2020/12/16/idrisnonamaetsukiparame_tatogadt/"> Idrisの名前つきパラメータとGADT</a>
                    
                </div>
            </div>
        </div>
    </div>

<footer class="li-page-footer">
    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <div class="li-page-footer-legal">
                    &copy; 2024. All rights reserved. 
                </div>
                <div class="li-page-footer-theme">
                    <span class=""><a href="https://github.com/eliasson/liquorice/">liquorice</a> is a theme for <a href="http://hugo.spf13.com">hugo</a></span>
                </div>
            </div>
        </div>
    </div>
</footer>

<script type="text/javascript">
 function toggle(id) {
     var e = document.getElementById(id);
     e.style.display == 'block' ? e.style.display = 'none' : e.style.display = 'block';
 }
</script>
<script src="https://unpkg.com/mermaid@7.0.4/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true
     });</script>

    </body>
</html>

