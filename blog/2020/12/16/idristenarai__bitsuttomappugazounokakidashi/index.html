<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
    <head>
        
        
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-43779888-1"></script>
        <script>
         window.dataLayer = window.dataLayer || [];
         function gtag(){dataLayer.push(arguments);}
         gtag('js', new Date());

         gtag('config', 'UA-43779888-1');
        </script>
        

        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

        <meta name="twitter:site" content="@blackenedgold" />
        <meta name="twitter:title" content="Idris手習い: ビッットマップ画像の書き出し | κeenのHappy Hacκing Blog"/>
        <meta name="twitter:description" content="このエントリはIdris Advent Calendar 2020 の12日目の記事です。
κeenです。今回は手を動かすパートとしてビットマップ画像の書き出しをIdrisでやってみます。
依存型やIdrisの標準ライブラリ、ファイルの扱いなどの練習になればなと思ってます。" />
        <meta property="og:title" content="Idris手習い: ビッットマップ画像の書き出し | κeenのHappy Hacκing Blog" />
        <meta property="og:type" content="article" />
        <meta property="og:url" content="https://KeenS.github.io/blog/2020/12/16/idristenarai__bitsuttomappugazounokakidashi/" />
        <meta property="og:description" content="このエントリはIdris Advent Calendar 2020 の12日目の記事です。
κeenです。今回は手を動かすパートとしてビットマップ画像の書き出しをIdrisでやってみます。
依存型やIdrisの標準ライブラリ、ファイルの扱いなどの練習になればなと思ってます。" />
        <meta name="twitter:card" content="summary_large_image" />
        <meta property="og:image" content="https://KeenS.github.io/images/ogp/post/Idristenarai__bitsuttomappugazounokakidashi.png" />
        <meta name="twitter:image" content="https://KeenS.github.io/images/ogp/post/Idristenarai__bitsuttomappugazounokakidashi.png" />
        
        <meta property="og:article:published_time" content="2020-12-16 02:40:32 &#43;0900 JST" />
        <meta property="og:article:modified_time" content="2020-12-16 02:40:32 &#43;0900 JST" />
        
        <meta property="og:article:author" content="κeen" />

        <title>Idris手習い: ビッットマップ画像の書き出し | κeenのHappy Hacκing Blog</title>
        <link rel="stylesheet" href='//fonts.googleapis.com/css?family=Open+Sans:400,300,600' type='text/css' />
        <link rel="stylesheet" href="https://KeenS.github.io/libraries/normalize.3.0.1.css" />
        <link rel="stylesheet" href="https://KeenS.github.io/css/liquorice.css" />
        <link rel="apple-touch-icon" sizes="180x180" href="https://KeenS.github.io/apple-touch-icon.png">
        <link rel="icon" type="image/png" href="https://KeenS.github.io/favicon-32x32.png" sizes="32x32">
        <link rel="icon" type="image/png" href="https://KeenS.github.io/favicon-16x16.png" sizes="16x16">
        <link rel="manifest" href="https://KeenS.github.io/manifest.json">
        <link rel="mask-icon" href="https://KeenS.github.io/safari-pinned-tab.svg" color="#5bbad5">
        <meta name="theme-color" content="#ffffff">
        <link rel="apple-touch-icon-precomposed" href="https://KeenS.github.io/apple-touch-icon-144-precomposed.png" sizes="144x144" />
        <link rel="stylesheet" href="https://KeenS.github.io/css/syntax-monokai.css" />
<script type="text/x-mathjax-config">
 MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ["\\(","\\)"]] } });
</script>
<script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_CHTML"></script>
</script>
<meta http-equiv="X-UA-Compatible" CONTENT="IE=EmulateIE7" />
<link rel="stylesheet" href="//unpkg.com/mermaid@7.0.4/dist/mermaid.forest.min.css">

    </head>
    <body class="li-body">

<header class="li-page-header" id="page-header">
    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <div class="li-brand li-left">
                <a href="https://KeenS.github.io/">κeenのHappy Hacκing Blog</a> | Lispエイリアンの狂想曲</div>
                <div class="li-menu li-right">
                    <span class="li-menu-icon" onclick="javascript:toggle('menu');">&#9776;</span>
                    <ul id="menu2" class="li-menu-items">
                        
                            <li><a href="https://KeenS.github.io/about/"> About </a></li>
                        
                            <li><a href="https://KeenS.github.io/post/"> Blog </a></li>
                        
                            <li><a href="https://KeenS.github.io/slide/"> Slide </a></li>
                        
                            <li><a href="https://KeenS.github.io/index.xml"> Atom </a></li>
                        
                            <li><a href="https://KeenS.github.io/search/"> Search </a></li>
                        
                    </ul>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="sixteen columns">
                <ul id="menu" class="li-menu-items li-menu-mobile">
                    
                        <li><a href="https://KeenS.github.io/about/"> About </a></li>
                    
                        <li><a href="https://KeenS.github.io/post/"> Blog </a></li>
                    
                        <li><a href="https://KeenS.github.io/slide/"> Slide </a></li>
                    
                        <li><a href="https://KeenS.github.io/index.xml"> Atom </a></li>
                    
                        <li><a href="https://KeenS.github.io/search/"> Search </a></li>
                    
                </ul>
            </div>
        </div>
    </div>
</header>






    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <article class="li-article">
                    <header class="li-article-header">
                        <h1 class="li-article-title">Idris手習い: ビッットマップ画像の書き出し</h1>
                        <div class="li-article-meta">
    <time class="li-article-date">2020-12-16</time>
    <ul class="li-article-tag">
    
        <li>
            <a href="https://KeenS.github.io/categories/%e4%be%9d%e5%ad%98%e5%9e%8b">依存型</a>
        </li>
    
        <li>
            <a href="https://KeenS.github.io/categories/idris">Idris</a>
        </li>
    
        <li>
            <a href="https://KeenS.github.io/categories/idris-advent-calendar">Idris Advent Calendar</a>
        </li>
    
        <li>
            <a href="https://KeenS.github.io/categories/advent-calendar-2020">Advent Calendar 2020</a>
        </li>
    
        <li>
            <a href="https://KeenS.github.io/categories/advent-calendar">Advent Calendar</a>
        </li>
    
</ul>

</div>

                    </header>
                    <section>
                        <p>このエントリは<a href="https://qiita.com/advent-calendar/2020/idris">Idris Advent Calendar 2020</a> の12日目の記事です。</p>
<p>κeenです。今回は手を動かすパートとしてビットマップ画像の書き出しをIdrisでやってみます。
依存型やIdrisの標準ライブラリ、ファイルの扱いなどの練習になればなと思ってます。</p>
<h1 id="ビットマップ画像とは">ビットマップ画像とは</h1>
<p>ビットマップ画像（正確にはBMP、Windows bitmap）とはほぼ色のデータをそのまま持っていることで有名なシンプルな画像フォーマットですね。<a href="https://ja.wikipedia.org/wiki/Windows_bitmap">Wikipedia</a>なんかに画像フォーマットが載っています。</p>
<p>フォーマットにはいくつか変種があるのですが、その中で一番簡単なフォーマットを書き出してみようと思います。
具体的には画像フォーマットにはいくつかパラメータがあるのですが、以下の設定に固定して書き出します。</p>
<ul>
<li>1ピクセルあたりのビット数：24
<ul>
<li>こうすることでカラーパレットが不要になる</li>
</ul>
</li>
<li>圧縮形式：0
<ul>
<li>無圧縮</li>
</ul>
</li>
</ul>
<p>一番簡単なデータの場合はBMPは以下のような構造をしています。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">+-------------------+
</span></span><span class="line"><span class="cl">| ファイルヘッダ     | (BITMAPFILEHEADER)
</span></span><span class="line"><span class="cl">+-------------------+
</span></span><span class="line"><span class="cl">| 情報ヘッダ        | (BITMAPINFOHEADER)
</span></span><span class="line"><span class="cl">+-------------------+
</span></span><span class="line"><span class="cl">| ビットマップデータ |
</span></span><span class="line"><span class="cl">+-------------------+
</span></span></code></pre></div><p>特筆すべきはカラーパレットが不要になる点です。</p>
<p>それぞれ見ていきましょう。</p>
<h2 id="bitmapfileheader">BITMAPFILEHEADER</h2>
<table>
<thead>
<tr>
<th>オフセット</th>
<th>サイズ</th>
<th>格納する情報</th>
<th>値・備考</th>
</tr>
</thead>
<tbody>
<tr>
<td>0x0000</td>
<td>2バイト</td>
<td>ファイルタイプ</td>
<td>常にBM (0x42, 0x4d)（マジックナンバー）</td>
</tr>
<tr>
<td>0x0002</td>
<td>4バイト</td>
<td>ファイルサイズ</td>
<td>ビットマップファイルのサイズを格納する（単位はバイト）。</td>
</tr>
<tr>
<td>0x0006</td>
<td>2バイト</td>
<td>予約領域1</td>
<td>常に0</td>
</tr>
<tr>
<td>0x0008</td>
<td>2バイト</td>
<td>予約領域2</td>
<td>常に0</td>
</tr>
<tr>
<td>0x000a</td>
<td>4バイト</td>
<td>オフセット</td>
<td>ファイルヘッダの先頭アドレスからビットマップデータの先頭アドレスまでのオフセット（単位はバイト）。</td>
</tr>
</tbody>
</table>
<p>引用元: <a href="https://ja.wikipedia.org/wiki/Windows_bitmap">Windows bitmap - Wikipedia</a></p>
<p>今回の形式だとカラーパレットがないのでオフセットが固定値になります。</p>
<h2 id="bitmapinfoheader">BITMAPINFOHEADER</h2>
<table>
<thead>
<tr>
<th>オフセット</th>
<th>サイズ</th>
<th>格納する情報</th>
<th>値・備考</th>
</tr>
</thead>
<tbody>
<tr>
<td>0x000e</td>
<td>4バイト</td>
<td>ヘッダサイズ</td>
<td>40</td>
</tr>
<tr>
<td>0x0012</td>
<td>4バイト</td>
<td>ビットマップの横幅</td>
<td>単位はピクセル</td>
</tr>
<tr>
<td>0x0016</td>
<td>4バイト</td>
<td>ビットマップの縦幅</td>
<td>単位はピクセル。値が負の場合はトップダウン画像となる</td>
</tr>
<tr>
<td>0x001a</td>
<td>2バイト</td>
<td>プレーン数</td>
<td>常に1</td>
</tr>
<tr>
<td>0x001c</td>
<td>2バイト</td>
<td>1ピクセルあたりのビット数</td>
<td>0,1,4,8,16,24,32</td>
</tr>
<tr>
<td>0x001e</td>
<td>4バイト</td>
<td>圧縮形式</td>
<td>0,1,2,3,4,5 ※1</td>
</tr>
<tr>
<td>0x0022</td>
<td>4バイト</td>
<td>画像データサイズ</td>
<td>単位はバイト</td>
</tr>
<tr>
<td>0x0026</td>
<td>4バイト</td>
<td>水平方向の解像度</td>
<td>単位はピクセル/m</td>
</tr>
<tr>
<td>0x002a</td>
<td>4バイト</td>
<td>垂直方向の解像度</td>
<td>単位はピクセル/m</td>
</tr>
<tr>
<td>0x002e</td>
<td>4バイト</td>
<td>使用する色数</td>
<td>ビットマップで実際に使用するカラーパレット内のカラーインデックスの数。</td>
</tr>
<tr>
<td>0x0032</td>
<td>4バイト</td>
<td>重要な色数</td>
<td>ビットマップを表示するために必要なカラーインデックスの数。</td>
</tr>
</tbody>
</table>
<p>引用元: <a href="https://ja.wikipedia.org/wiki/Windows_bitmap">Windows bitmap - Wikipedia</a></p>
<p>1ピクセルあたりのビット数は24bit、圧縮形式は0にするとしました。
水平方向の解像度と垂直方向の解像度はよくわからない（設定しても表示に変わりがない）ので0にします。
今回カラーパレットがないので使用する色数と重要な色数は0にできます。</p>
<p>すると残るパラメータはビットマップの横幅、ビットマップの縦幅、画像データサイズです。</p>
<h2 id="ビットマップデータ">ビットマップデータ</h2>
<p>1ピクセルあたり24bitならばBGR形式でデータを置いていきます。
ただし1行のデータが4の倍数でない場合は4の倍数になるように末尾に <code>0x00</code> を詰めてあげます。</p>
<p>例えば3x3の画像だとこんな感じですかね。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl"> 0123456789ab
</span></span><span class="line"><span class="cl">+------------+
</span></span><span class="line"><span class="cl">|BGRBGRBGR000|
</span></span><span class="line"><span class="cl">+------------+
</span></span><span class="line"><span class="cl">|BGRBGRBGR000|
</span></span><span class="line"><span class="cl">+------------+
</span></span><span class="line"><span class="cl">|BGRBGRBGR000|
</span></span><span class="line"><span class="cl">+------------+
</span></span></code></pre></div><p>因みにBMPは座標系が数学と一緒で0行目が一番下、最終行が一番上です。
他のよくある画像フォーマットと天地が逆になってるので注意して下さい。</p>
<p>イメージ掴めましたか？</p>
<h1 id="やってみよう">やってみよう</h1>
<p>ビットマップデータを受け取ってそれをBMP形式として書き出すプログラムを書いてみます。
ほとんどのパラメータは固定なので、ビットマップデータから以下の4つのパラメータさえ計算できればあとは簡単に書き出せます。</p>
<ul>
<li>ファイルサイズ</li>
<li>ビットマップの横幅</li>
<li>ビットマップの縦幅</li>
<li>画像データサイズ</li>
</ul>
<h2 id="vect"><code>Vect</code></h2>
<p>今回は依存型に触れてみるというテーマもあるので <code>Vect</code> 型を使います。
アドベントカレンダー初日でも紹介しましたが、<code>Vect</code> は長さ情報を型に持つリストです。
baseの <a href="https://www.idris-lang.org/docs/current/base_doc/docs/Data.Vect.html"><code>Data.Vect</code></a> に定義されています。</p>
<p>少しだけREPLで <code>Vect</code> を使ってみましょう。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">Idris&gt; :module Data.Vect
</span></span><span class="line"><span class="cl">*Data/Vect&gt; the (Vect _ _) [1, 2, 3]
</span></span><span class="line"><span class="cl">[1, 2, 3] : Vect 3 Integer
</span></span><span class="line"><span class="cl">*Data/Vect&gt; the (Vect _ _) [1, 2, 3, 4]
</span></span><span class="line"><span class="cl">[1, 2, 3, 4] : Vect 4 Integer
</span></span><span class="line"><span class="cl">*Data/Vect&gt; the (Vect _ _) ([1, 2, 3, 4] ++ [1, 2, 3])
</span></span><span class="line"><span class="cl">[1, 2, 3, 4, 1, 2, 3] : Vect 7 Integer
</span></span></code></pre></div><p>このようにちゃんと要素数と型の <code>Vect n Integer</code> の <code>n</code> の部分が対応しています。
しかも <code>(++)</code> で結合しても正しく要素数が保持されています。</p>
<p>これを使えば入力画像のデータを表現できそうです。</p>
<h2 id="画像のデータ型">画像のデータ型</h2>
<p>画像のデータ型 <code>BitMap</code> を定義しましょう。</p>
<p>…とその前に色を表わす型、 <code>Color</code> を定義しておきます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl"><span class="kr">public</span> export
</span></span><span class="line"><span class="cl"><span class="nf">Color</span> <span class="ow">:</span> <span class="kt">Type</span>
</span></span><span class="line"><span class="cl"><span class="kt">Color</span> <span class="ow">=</span> <span class="ow">(</span><span class="kt">Bits8</span>, <span class="kt">Bits8</span>, <span class="kt">Bits8</span><span class="ow">)</span>
</span></span></code></pre></div><p>復習するとIdrisでは型も値として扱えるので、グローバル変数の定義でもって型エイリアスが作れるのでした。
ここで登場する <code>Bits8</code> は（あんまりドキュメントに載っていない）Idrisのプリミティブで、8bitの数を表わします。符号があるかないかは分かりません。</p>
<p>可視性に <code>public export</code> がついています。
外部とのやりとりにも <code>Color</code> を使いたいので <code>export</code> が、中身が <code>(Bits8, Bits8, Bits8)</code> であることも公開したいので <code>public</code> がついています。</p>
<p>さて、色も定義し終わって <code>BitMap</code> レコードを定義します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Data.Vect</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">export
</span></span><span class="line"><span class="cl"><span class="kr">record</span> <span class="kt">BitMap</span> <span class="ow">(</span>x <span class="ow">:</span> <span class="kt">Nat</span><span class="ow">)</span> <span class="ow">(</span>y <span class="ow">:</span> <span class="kt">Nat</span><span class="ow">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">where</span>
</span></span><span class="line"><span class="cl">  constructor <span class="kt">MkBitMap</span>
</span></span><span class="line"><span class="cl">  <span class="nf">imgData</span><span class="ow">:</span> <span class="kt">Vect</span> y <span class="ow">(</span><span class="kt">Vect</span> x <span class="kt">Color</span><span class="ow">)</span>
</span></span></code></pre></div><p>画像データは <code>Vect y (Vect x Color)</code> と表現しています。シンプルで分かりやすいですね。</p>
<p>レコードの定義部分が <code>record BitMap (x : Nat) (y : Nat)</code> と、パラメータ <code>x</code> 、 <code>y</code> が <code>(x : Nat)</code> の形になっています。レコードのパラメータは無言でパラメータを書くと型として扱われるのですが、今回は <code>Vect</code> に渡す数値をパラメータとしたいのでその宣言です。</p>
<p>画像データの定義に <code>Vect</code> を使っているので入力は正確に横幅 <code>x</code> 高さ <code>y</code> であることが保証できます。
リストのリストや可変長ベクトルの可変長ベクトルのようなデータ型だとサイズを正確に表現することができません。こういったところで正確になれるのは依存型の利点かなと思います。</p>
<p><code>BitMap</code> の定義から直ちに <code>fromData</code> のような関数は書けますね。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl">export
</span></span><span class="line"><span class="cl"><span class="nf">fromData</span> <span class="ow">:</span> <span class="kt">Vect</span> y <span class="ow">(</span><span class="kt">Vect</span> x <span class="kt">Color</span><span class="ow">)</span> <span class="ow">-&gt;</span> <span class="kt">BitMap</span> x y
</span></span><span class="line"><span class="cl">fromData img <span class="ow">=</span> <span class="kt">MkBitMap</span> img
</span></span></code></pre></div><p><code>MkBitMap</code> そのまま公開するよりもあとで他の操作を加える余地が残ります。
実際、BitMapの複雑なフォーマットに対応しようと思ったらカラーパレットの計算などの処理が挟まります。</p>
<p>因みに、Idrisは関数型言語なので関数は一級市民です。
上記の関数は仮引数を取らずに以下のようにも書けます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl">export
</span></span><span class="line"><span class="cl"><span class="nf">fromData</span> <span class="ow">:</span> <span class="kt">Vect</span> y <span class="ow">(</span><span class="kt">Vect</span> x <span class="kt">Color</span><span class="ow">)</span> <span class="ow">-&gt;</span> <span class="kt">BitMap</span> x y
</span></span><span class="line"><span class="cl">fromData <span class="ow">=</span> <span class="kt">MkBitMap</span>
</span></span></code></pre></div><p>好きな方で定義してみて下さい。上級者ほど仮引数を取らない書き方を好むようです。</p>
<h2 id="パラメータの計算">パラメータの計算</h2>
<p>復習すると、必要なパラメータは以下の4つでした。</p>
<ul>
<li>ファイルサイズ</li>
<li>ビットマップの横幅</li>
<li>ビットマップの縦幅</li>
<li>画像データサイズ</li>
</ul>
<p>まずは簡単なビットマップの縦横幅を計算しましょう。</p>
<h3 id="type-reification">Type reification</h3>
<p>正確な用語は分からないのですが、Idrisでは型を実行時に取り出すことができます。これをひとまずtype reificationと呼ぶことにします。
どういうことかというと、普通の言語で上記 <code>BitMap x y</code> から <code>y</code> を取り出そうとすると以下のようなコードを書くことになるかと思います。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl"><span class="nf">getY</span> <span class="ow">:</span> <span class="kt">BitMap</span> x y <span class="ow">-&gt;</span> <span class="kt">Int</span>
</span></span><span class="line"><span class="cl">getY b <span class="ow">=</span> cast <span class="ow">$</span> length <span class="ow">$</span> imgData b
</span></span></code></pre></div><p><code>Vect</code> のデータの長さを計算していますね。これが普通です。</p>
<p>ですが、Idrisは <code>Vect y _</code> のようにデータの長さを型に持っています。
これを取り出せないでしょうか。結論を言うと取り出せます。</p>
<p>以下のようなコードで取り出せます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl"><span class="nf">getY</span> <span class="ow">:</span> <span class="kt">BitMap</span> x y <span class="ow">-&gt;</span> <span class="kt">Int</span>
</span></span><span class="line"><span class="cl">getY <span class="ow">{</span>y<span class="ow">}</span> <span class="kr">_</span> <span class="ow">=</span> cast y
</span></span></code></pre></div><p><code>getY</code> の仮引数の前に <code>{y}</code> を置くことで型にある <code>y</code> を取り出せるのです。
すごいですね。</p>
<p>この記法はいくつかの機能が混ざってるのでちょっとほぐしましょう。</p>
<p>まず、 <code>{y}</code> と書いてあるのは <code>{y = y}</code> の省略形です。 <code>{パラメータ名 = 変数名}</code> の構文です。
型にある変数 <code>y</code> を値にある変数 <code>length</code> に束縛するには以下のように書きます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl"><span class="nf">getY</span> <span class="ow">:</span> <span class="kt">BitMap</span> x y <span class="ow">-&gt;</span> <span class="kt">Int</span>
</span></span><span class="line"><span class="cl">getY <span class="ow">{</span>y <span class="ow">=</span> length<span class="ow">}</span> <span class="kr">_</span> <span class="ow">=</span> cast length
</span></span></code></pre></div><p>さらに、 <code>{y = ...}</code> で取り出せるのは暗黙のパラメータ（implicit parameter）という機能のおかげです。
<code>BitMap x y</code> と無言で書くと <code>x</code> 、 <code>y</code> が自然数の型パラメータであることが宣言されるのが不思議に思った方はいませんか？これはコンパイラが裏でパラメータを追加しているからです。</p>
<p>暗黙のパラメータを省略せずに書くとこうなります。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl"><span class="nf">getY</span> <span class="ow">:</span> <span class="ow">{</span>x<span class="ow">:</span> <span class="kt">Nat</span><span class="ow">}</span> <span class="ow">-&gt;</span> <span class="ow">{</span>y<span class="ow">:</span> <span class="kt">Nat</span><span class="ow">}</span> <span class="ow">-&gt;</span> <span class="kt">BitMap</span> x y <span class="ow">-&gt;</span> <span class="kt">Int</span>
</span></span><span class="line"><span class="cl">getY <span class="ow">{</span>y <span class="ow">=</span> length<span class="ow">}</span> <span class="kr">_</span> <span class="ow">=</span> cast length
</span></span></code></pre></div><p>暗黙のパラメータは <code>{変数名: 型}</code> の構文で定義します。複数ある場合は上記のように1つづつ書くか、
型が同じなら <code>{変数名1, 変数名2...: 型}</code> とカンマで区切って書いてもよいです。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl"><span class="nf">getY</span> <span class="ow">:</span> <span class="ow">{</span>x, y<span class="ow">:</span> <span class="kt">Nat</span><span class="ow">}</span> <span class="ow">-&gt;</span> <span class="kt">BitMap</span> x y <span class="ow">-&gt;</span> <span class="kt">Int</span>
</span></span><span class="line"><span class="cl">getY <span class="ow">{</span>y <span class="ow">=</span> length<span class="ow">}</span> <span class="kr">_</span> <span class="ow">=</span> cast length
</span></span></code></pre></div><p>暗黙のパラメータは普段はコンパイラが勝手に埋めてくれるので気にしなくていいんですが、手で与えることもできます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">Idris&gt; :t getY
</span></span><span class="line"><span class="cl">getY : BitMap x y -&gt; Int
</span></span><span class="line"><span class="cl">Idris&gt; :t getY {x = 1} {y = 1}
</span></span><span class="line"><span class="cl">getY : BitMap 1 1 -&gt; Int
</span></span></code></pre></div><p>さて、ちょっと色々情報を詰め込みすぎましたかね。
さしあたっては <code>getX</code> と <code>getY</code> は以下のように定義できるとだけ了解しておいて下さい。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl"><span class="nf">getX</span> <span class="ow">:</span> <span class="ow">{</span>x<span class="ow">:</span> <span class="kt">Nat</span><span class="ow">}</span> <span class="ow">-&gt;</span> <span class="kt">BitMap</span> x y <span class="ow">-&gt;</span> <span class="kt">Int</span>
</span></span><span class="line"><span class="cl">getX <span class="ow">{</span>x<span class="ow">}</span> <span class="kr">_</span> <span class="ow">=</span> cast x
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">getY</span> <span class="ow">:</span> <span class="ow">{</span>y<span class="ow">:</span> <span class="kt">Nat</span><span class="ow">}</span> <span class="ow">-&gt;</span> <span class="kt">BitMap</span> x y <span class="ow">-&gt;</span> <span class="kt">Int</span>
</span></span><span class="line"><span class="cl">getY <span class="ow">{</span>y<span class="ow">}</span> <span class="kr">_</span> <span class="ow">=</span> cast y
</span></span></code></pre></div><p>計算せずにサイズがとれる！ついでにいうと <code>getX</code> 行のサイズを計算するために1行目の要素を取り出すけど値がなかったら場合は…とかを考えなくてすみます。</p>
<p>Idris2からは暗黙のパラメータは <code>{...} -&gt;</code> で明示的に書かないと取り出せないようになってるらしいので今のうちにその書き方をすることにします。</p>
<h3 id="ファイルサイズとデータサイズ">ファイルサイズとデータサイズ</h3>
<p>続けてファイルサイズとデータサイズを計算しましょう。こっちは地道に計算するだけです。</p>
<p>データサイズを計算しましょう。1ピクセル3バイトなので $x \times y \times 3$ かと思いきや、1行を4バイトの倍数に切り上げるという仕様なのでちょっとだけ計算が必要です。</p>
<p>まず、切り上げるときのパディングサイズの計算はこうできますね。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl"><span class="nf">padSize</span><span class="ow">:</span> <span class="kt">Nat</span> <span class="ow">-&gt;</span> <span class="kt">Int</span>
</span></span><span class="line"><span class="cl">padSize x <span class="ow">=</span> <span class="ow">(</span><span class="mi">4</span> <span class="ow">-</span> <span class="ow">((</span>cast <span class="ow">$</span> x <span class="ow">*</span> <span class="mi">3</span><span class="ow">)</span> `mod` <span class="mi">4</span><span class="ow">))</span> `mod` <span class="mi">4</span>
</span></span></code></pre></div><p><code> `mod` 4</code> が2回挟まってますが、2回目の <code> `mod` 4</code> は4を0にするための計算です。</p>
<p>これを使って <code>BitMap x y</code> からデータサイズを計算する関数は以下のように書けます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl"><span class="nf">dataSize</span> <span class="ow">:</span> <span class="ow">{</span>x, y<span class="ow">:</span> <span class="kt">Nat</span><span class="ow">}</span> <span class="ow">-&gt;</span> <span class="kt">BitMap</span> x y<span class="ow">-&gt;</span> <span class="kt">Int</span>
</span></span><span class="line"><span class="cl">dataSize <span class="ow">{</span>x<span class="ow">}</span> <span class="ow">{</span>y<span class="ow">}</span> <span class="kr">_</span> <span class="ow">=</span>
</span></span><span class="line"><span class="cl">  <span class="kr">let</span> rowSize <span class="ow">=</span> <span class="ow">(</span>cast <span class="ow">$</span> x <span class="ow">*</span> <span class="mi">3</span><span class="ow">)</span> <span class="ow">+</span> <span class="ow">(</span>padSize x<span class="ow">)</span> <span class="kr">in</span>
</span></span><span class="line"><span class="cl">  rowSize <span class="ow">*</span> <span class="ow">(</span>cast y<span class="ow">)</span>
</span></span></code></pre></div><p>ここでもtype reification（？）を使ってます。</p>
<p>ヘッダサイズが54でそれ以外にはビットマップデータしかないのでファイルサイズは簡単に計算できます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl"><span class="nf">offset</span> <span class="ow">:</span> <span class="kt">Int</span>
</span></span><span class="line"><span class="cl">offset <span class="ow">=</span> <span class="mi">14</span> <span class="ow">+</span> <span class="mi">40</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">fileSize</span> <span class="ow">:</span> <span class="kt">BitMap</span> x y <span class="ow">-&gt;</span> <span class="kt">Int</span>
</span></span><span class="line"><span class="cl">fileSize bitmap <span class="ow">=</span> offset <span class="ow">+</span> <span class="ow">(</span>dataSize bitmap<span class="ow">)</span>
</span></span></code></pre></div><p>これで必要なパラメータが揃ったのでデータを書き出していきます。</p>
<h2 id="ファイルとバッファ">ファイルとバッファ</h2>
<p>これからBMPフォーマットのファイルを作ります。
最終的にはファイルに書き出すんですが、プログラム内では一旦バッファに書き出して、それをあとでまとめてファイルに書き出しましょう。
その方がファイル関連のエラーを1まとめにできますからね。（あとIdrisのファイルAPIに欠陥があってバイトを書き出す手段がないというのもあります。）</p>
<p>ファイルに書き出せるバッファは <a href="https://www.idris-lang.org/docs/current/base_doc/docs/Data.Buffer.html"><code>Data.Buffer</code></a> に定義されているのでインポートします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Data.Buffer</span>
</span></span></code></pre></div><p><code>import</code> 文はファイルの先頭の方で書かないといけないので注意して下さいね。</p>
<p>さて、 <code>Buffer</code> のAPIなんですが、主に使うのは <code>setByte : Buffer -&gt; (loc : Int) -&gt; (val : Bits8) -&gt; IO ()</code> と <code>setInt : Buffer -&gt; (loc : Int) -&gt; (val : Int) -&gt; IO ()</code> です。
これらは書き込む場所を引数にとりますね。
我々の用途では1バイトずつずらしながら書き込んでいくので <code>loc</code> を持って回らないといけません。
それはちょっと面倒なので <code>Buffer</code> と <code>loc</code> をまとめたデータ型を定義しておきましょう。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl"><span class="kr">data</span> <span class="kt">Output</span> <span class="ow">=</span> <span class="kt">MkOutput</span> <span class="kt">Buffer</span> <span class="kt">Int</span>
</span></span></code></pre></div><p>もうちょっとユーティリティ関数を定義します。</p>
<p>まずは <code>Output</code> に <code>Int</code> を書き込んでくれる関数 <code>writeInt</code> です。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl"><span class="c1">||| Write int in little endian</span>
</span></span><span class="line"><span class="cl"><span class="nf">writeInt</span> <span class="ow">:</span> <span class="kt">Output</span> <span class="ow">-&gt;</span> <span class="kt">Int</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="kt">Output</span>
</span></span><span class="line"><span class="cl">writeInt <span class="ow">(</span><span class="kt">MkOutput</span> buffer loc<span class="ow">)</span> int <span class="ow">=</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">  setInt buffer loc int
</span></span><span class="line"><span class="cl">  pure <span class="ow">$</span> <span class="kt">MkOutput</span> buffer <span class="ow">(</span>loc <span class="ow">+</span> <span class="mi">4</span><span class="ow">)</span>
</span></span></code></pre></div><p>返り値に <code>loc</code> が更新された <code>Output</code> を返します。
<code>|||</code> ではじまる行はドキュメントコメントです。いつか解説します。
ドキュメントでは明示されてませんが実装を読む限り <code>setInt</code> はリトルエンディアンで4バイト書くAPIのようです。
今回の目的に適ってるのでそれを使います。</p>
<p>複数のバイトを受け取って書き出す <code>writeBytes</code> も定義しましょう。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl"><span class="nf">writeBytes</span> <span class="ow">:</span> <span class="kt">Output</span> <span class="ow">-&gt;</span> <span class="kt">List</span> <span class="kt">Bits8</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="kt">Output</span>
</span></span><span class="line"><span class="cl">writeBytes o <span class="ow">[]</span>            <span class="ow">=</span> pure o
</span></span><span class="line"><span class="cl">writeBytes <span class="ow">(</span><span class="kt">MkOutput</span> buffer loc<span class="ow">)</span> <span class="ow">(</span>b<span class="ow">::</span>bs<span class="ow">)</span> <span class="ow">=</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">  setByte buffer loc b
</span></span><span class="line"><span class="cl">  writeBytes <span class="ow">(</span><span class="kt">MkOutput</span> buffer <span class="ow">(</span>loc <span class="ow">+</span> <span class="mi">1</span><span class="ow">))</span> bs
</span></span></code></pre></div><p>これで準備OKです。</p>
<h2 id="イメージフォーマットの書き出し">イメージフォーマットの書き出し</h2>
<p>復習するとBMPフォーマットは以下の形をしているのでした。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">+-------------------+
</span></span><span class="line"><span class="cl">| ファイルヘッダ     | (BITMAPFILEHEADER)
</span></span><span class="line"><span class="cl">+-------------------+
</span></span><span class="line"><span class="cl">| 情報ヘッダ        | (BITMAPINFOHEADER)
</span></span><span class="line"><span class="cl">+-------------------+
</span></span><span class="line"><span class="cl">| ビットマップデータ |
</span></span><span class="line"><span class="cl">+-------------------+
</span></span></code></pre></div><p>これに対応して、画像フォーマットを書き出すAPIは以下のような見た目になります。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl">export
</span></span><span class="line"><span class="cl"><span class="nf">writeBitMap</span> <span class="ow">:</span> <span class="kt">File</span> <span class="ow">-&gt;</span> <span class="kt">BitMap</span> x y <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="ow">()</span>
</span></span><span class="line"><span class="cl">writeBitMap f bitmap <span class="ow">=</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- ...</span>
</span></span><span class="line"><span class="cl">  <span class="kr">let</span> o <span class="ow">=</span> <span class="kt">MkOutput</span> buf <span class="mi">0</span>
</span></span><span class="line"><span class="cl">  o <span class="ow">&lt;-</span> writeHeader o bitmap
</span></span><span class="line"><span class="cl">  o <span class="ow">&lt;-</span> writeInfoHeader o bitmap
</span></span><span class="line"><span class="cl">  o <span class="ow">&lt;-</span> writeImgData o bitmap
</span></span><span class="line"><span class="cl">  <span class="c1">-- ...</span>
</span></span></code></pre></div><p>前後にバッファを用意する作業やファイルに書き出す作業が挟まりますがイメージは掴めるでしょう。
こうやって使うことを想定して、 <code>writeHeader</code> 、 <code>writeInfoHeader</code> 、 <code>writeImgData</code> を定義します。</p>
<h3 id="writeheader">writeHeader</h3>
<p><code>writeHeader</code> はパラメータはファイルサイズしかなかったので直線的なコードになります。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl"><span class="nf">writeHeader</span> <span class="ow">:</span> <span class="kt">Output</span> <span class="ow">-&gt;</span> <span class="kt">BitMap</span> x y <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="kt">Output</span>
</span></span><span class="line"><span class="cl">writeHeader o bitmap <span class="ow">=</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- file type</span>
</span></span><span class="line"><span class="cl">  o <span class="ow">&lt;-</span> writeBytes o <span class="ow">[</span><span class="mh">0x42</span>, <span class="mh">0x4d</span><span class="ow">]</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- file size</span>
</span></span><span class="line"><span class="cl">  o <span class="ow">&lt;-</span> writeInt o <span class="ow">(</span>fileSize bitmap<span class="ow">)</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- reserved 1</span>
</span></span><span class="line"><span class="cl">  o <span class="ow">&lt;-</span> writeBytes o <span class="ow">[</span><span class="mh">0x00</span>, <span class="mh">0x00</span><span class="ow">]</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- reserved 2</span>
</span></span><span class="line"><span class="cl">  o <span class="ow">&lt;-</span> writeBytes o <span class="ow">[</span><span class="mh">0x00</span>, <span class="mh">0x00</span><span class="ow">]</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- offset</span>
</span></span><span class="line"><span class="cl">  o <span class="ow">&lt;-</span> writeInt o offset
</span></span><span class="line"><span class="cl">  pure o
</span></span></code></pre></div><p><code>offset</code> は「ファイルサイズとデータサイズ」のところで定義した変数です。</p>
<h3 id="writeinfoheader">writeInfoHeader</h3>
<p><code>writeInfoHeader</code> も <code>writeHeader</code> に続いて直線的なコードです。
パラメータが横幅、高さ、データサイズだけです。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl"><span class="nf">writeInfoHeader</span> <span class="ow">:</span> <span class="kt">Output</span> <span class="ow">-&gt;</span> <span class="kt">BitMap</span> x y <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="kt">Output</span>
</span></span><span class="line"><span class="cl">writeInfoHeader o bitmap <span class="ow">=</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- header size</span>
</span></span><span class="line"><span class="cl">  o <span class="ow">&lt;-</span> writeInt o <span class="mi">40</span> <span class="c1">-- windows format</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- width</span>
</span></span><span class="line"><span class="cl">  o <span class="ow">&lt;-</span> writeInt o <span class="ow">(</span>getX bitmap<span class="ow">)</span>
</span></span><span class="line"><span class="cl">  <span class="c1">--  height</span>
</span></span><span class="line"><span class="cl">  o <span class="ow">&lt;-</span> writeInt o <span class="ow">(</span>getY bitmap<span class="ow">)</span>
</span></span><span class="line"><span class="cl">  <span class="c1">--  # of plane</span>
</span></span><span class="line"><span class="cl">  o <span class="ow">&lt;-</span> writeBytes o <span class="ow">[</span><span class="mh">0x01</span>, <span class="mh">0x00</span><span class="ow">]</span>
</span></span><span class="line"><span class="cl">  <span class="c1">--  # of bits of the colors</span>
</span></span><span class="line"><span class="cl">  o <span class="ow">&lt;-</span> writeBytes o <span class="ow">[</span><span class="mi">24</span>, <span class="mi">0</span><span class="ow">]</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- compression format</span>
</span></span><span class="line"><span class="cl">  o <span class="ow">&lt;-</span> writeBytes o <span class="ow">[</span><span class="mh">0x00</span>, <span class="mh">0x00</span>, <span class="mh">0x00</span>, <span class="mh">0x00</span><span class="ow">]</span> <span class="c1">-- no compression</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- image data size</span>
</span></span><span class="line"><span class="cl">  o <span class="ow">&lt;-</span> writeInt o <span class="ow">(</span>dataSize bitmap<span class="ow">)</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- TODO: horizontal resolution (px/m)</span>
</span></span><span class="line"><span class="cl">  o <span class="ow">&lt;-</span> writeInt o <span class="mi">0</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- TODO: vertical resolution (px/m)</span>
</span></span><span class="line"><span class="cl">  o <span class="ow">&lt;-</span> writeInt o <span class="mi">0</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- # of colors in the pallet</span>
</span></span><span class="line"><span class="cl">  o <span class="ow">&lt;-</span> writeInt o <span class="mi">0</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- # of important colors</span>
</span></span><span class="line"><span class="cl">  o <span class="ow">&lt;-</span> writeInt o <span class="mi">0</span>
</span></span><span class="line"><span class="cl">  pure o
</span></span></code></pre></div><h3 id="writeimgdata">writeImgData</h3>
<p><code>writeImgData</code> だけはちょびっとだけ複雑です。
画像を書き出す処理は2重ループになるからです。
とはいえ、ループを分けて書けばそんなに難しくありません。</p>
<p>1行を（パディングをせずに）書き出す処理はこう書けます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl"><span class="nf">writeRow</span> <span class="ow">:</span> <span class="kt">Output</span> <span class="ow">-&gt;</span> <span class="kt">Vect</span> m <span class="kt">Color</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="kt">Output</span>
</span></span><span class="line"><span class="cl">writeRow o <span class="ow">[]</span>      <span class="ow">=</span> pure o
</span></span><span class="line"><span class="cl">writeRow o <span class="ow">((</span>r, g, b<span class="ow">)::</span>ds<span class="ow">)</span> <span class="ow">=</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">  o <span class="ow">&lt;-</span> writeBytes o <span class="ow">[</span>b, g, r<span class="ow">]</span>
</span></span><span class="line"><span class="cl">  writeRow o ds
</span></span></code></pre></div><p>BMPが画像をRGBではなくBGRで期待することを思い出して下さい。</p>
<p><code>writeRow</code> を使って全ての画像データを書き出す処理はこう書けます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl"><span class="nf">writeImgData</span> <span class="ow">:</span> <span class="kt">Output</span> <span class="ow">-&gt;</span> <span class="kt">BitMap</span> x y <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="kt">Output</span>
</span></span><span class="line"><span class="cl">writeImgData o bitmap <span class="ow">=</span> loop o <span class="ow">$</span> imgData bitmap
</span></span><span class="line"><span class="cl"><span class="kr">where</span>
</span></span><span class="line"><span class="cl">  <span class="nf">loop</span> <span class="ow">:</span> <span class="ow">{</span>m<span class="ow">:</span> <span class="kt">Nat</span><span class="ow">}</span> <span class="ow">-&gt;</span> <span class="kt">Output</span> <span class="ow">-&gt;</span> <span class="kt">Vect</span> n <span class="ow">(</span><span class="kt">Vect</span> m <span class="kt">Color</span><span class="ow">)</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="kt">Output</span>
</span></span><span class="line"><span class="cl">  loop <span class="ow">{</span>m<span class="ow">}</span> o <span class="ow">[]</span>      <span class="ow">=</span> pure o
</span></span><span class="line"><span class="cl">  loop <span class="ow">{</span>m<span class="ow">}</span> o <span class="ow">(</span>r<span class="ow">::</span>rs<span class="ow">)</span> <span class="ow">=</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">    o <span class="ow">&lt;-</span> writeRow o r
</span></span><span class="line"><span class="cl">    o <span class="ow">&lt;-</span> writeBytes o <span class="ow">(</span>replicate <span class="ow">(</span>cast <span class="ow">(</span>padSize m<span class="ow">))</span> <span class="mh">0x00</span><span class="ow">)</span>
</span></span><span class="line"><span class="cl">    loop o rs
</span></span></code></pre></div><p>普通にループを回しているだけですね。
1行書き出したあとでパディングをする処理が入っている程度です。</p>
<p>ここで使った <code>replicate: Nat -&gt; a -&gt; List a</code> は <a href="https://www.idris-lang.org/docs/current/base_doc/docs/Prelude.List.html"><code>Prelude.List</code></a>で定義されている関数で、<code>x</code> が <code>n</code> 個あるリストを作ります。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">Idris&gt; :t replicate
</span></span><span class="line"><span class="cl">replicate : Nat -&gt; a -&gt; List a
</span></span><span class="line"><span class="cl">Idris&gt; :doc replicate
</span></span><span class="line"><span class="cl">Prelude.List.replicate : (n : Nat) -&gt; (x : a) -&gt; List a
</span></span><span class="line"><span class="cl">    Construct a list with n copies of x
</span></span><span class="line"><span class="cl">    Arguments:
</span></span><span class="line"><span class="cl">        n : Nat  -- how many copies
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        x : a  -- the element to replicate
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    The function is: Total &amp; public export
</span></span><span class="line"><span class="cl">Idris&gt; replicate 3 &#34;hoge&#34;
</span></span><span class="line"><span class="cl">[&#34;hoge&#34;, &#34;hoge&#34;, &#34;hoge&#34;] : List String
</span></span></code></pre></div><h3 id="writebitmap">writeBitMap</h3>
<p>必要な役者が揃ったので <code>writeBitMap</code> を作ってみましょう。</p>
<p>一気に全体を載せてしまうとこうなります。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl">export
</span></span><span class="line"><span class="cl"><span class="nf">writeBitMap</span> <span class="ow">:</span> <span class="kt">File</span> <span class="ow">-&gt;</span> <span class="kt">BitMap</span> x y <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="ow">()</span>
</span></span><span class="line"><span class="cl">writeBitMap f bitmap <span class="ow">=</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">  <span class="kt">Just</span> buf <span class="ow">&lt;-</span> newBuffer <span class="ow">(</span>fileSize bitmap<span class="ow">)</span>
</span></span><span class="line"><span class="cl">    <span class="ow">|</span> <span class="kt">Nothing</span> <span class="ow">=&gt;</span> putStrLn <span class="s">&#34;memory allocation failed&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="kr">let</span> o <span class="ow">=</span> <span class="kt">MkOutput</span> buf <span class="mi">0</span>
</span></span><span class="line"><span class="cl">  o <span class="ow">&lt;-</span> writeHeader o bitmap
</span></span><span class="line"><span class="cl">  o <span class="ow">&lt;-</span> writeInfoHeader o bitmap
</span></span><span class="line"><span class="cl">  o <span class="ow">&lt;-</span> writeImgData o bitmap
</span></span><span class="line"><span class="cl">  <span class="kr">let</span> <span class="kt">MkOutput</span> buffer <span class="kr">_</span> <span class="ow">=</span> o
</span></span><span class="line"><span class="cl">  buffer <span class="ow">&lt;-</span> writeBufferToFile f buffer <span class="ow">(</span>fileSize bitmap<span class="ow">)</span>
</span></span><span class="line"><span class="cl">  pure <span class="ow">()</span>
</span></span></code></pre></div><p><code>Buffer</code> は <code>newBuffer</code> で作成します。そしてファイルに書き出すのは <code>writeBufferToFile</code> を使います。
ここまで読んできた方には解説は不要でしょう。</p>
<h1 id="使ってみよう">使ってみよう</h1>
<p>先程のコードを <code>EasyBitMap.idr</code> に保存していたとします。
<code>EasyBitMapMain.idr</code> を作成して呼び出してみましょう。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl"><span class="kr">module</span> <span class="nn">Main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Data.Vect</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">EasyBitMap</span>
</span></span></code></pre></div><p>ひとまず必要なものをインポートします。</p>
<p>画像データは手書きします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl"><span class="nf">bitMapData</span> <span class="ow">:</span> <span class="kt">Vect</span> <span class="mi">16</span> <span class="ow">(</span><span class="kt">Vect</span> <span class="mi">16</span> <span class="kt">Color</span><span class="ow">)</span>
</span></span><span class="line"><span class="cl">bitMapData <span class="ow">=</span> <span class="ow">[</span>
</span></span><span class="line"><span class="cl">    <span class="ow">[</span>w, w, w, w, w, w, w, w, w, w, w, w, w, w, w, w<span class="ow">]</span>,
</span></span><span class="line"><span class="cl">    <span class="ow">[</span>w, b, b, b, b, b, b, b, b, b, b, b, b, b, b, w<span class="ow">]</span>,
</span></span><span class="line"><span class="cl">    <span class="ow">[</span>w, b, w, w, w, w, w, w, w, w, w, w, w, w, b, w<span class="ow">]</span>,
</span></span><span class="line"><span class="cl">    <span class="ow">[</span>w, b, w, w, w, w, w, w, w, w, w, w, w, w, b, w<span class="ow">]</span>,
</span></span><span class="line"><span class="cl">    <span class="ow">[</span>w, b, w, w, w, w, w, w, w, w, w, w, w, w, b, w<span class="ow">]</span>,
</span></span><span class="line"><span class="cl">    <span class="ow">[</span>w, b, w, w, w, w, w, w, w, w, w, w, w, w, b, w<span class="ow">]</span>,
</span></span><span class="line"><span class="cl">    <span class="ow">[</span>w, b, w, w, w, w, w, w, w, w, w, w, w, w, b, w<span class="ow">]</span>,
</span></span><span class="line"><span class="cl">    <span class="ow">[</span>w, b, w, w, w, w, w, w, w, w, w, w, w, w, b, w<span class="ow">]</span>,
</span></span><span class="line"><span class="cl">    <span class="ow">[</span>w, b, w, w, w, w, w, w, w, w, w, w, w, w, b, w<span class="ow">]</span>,
</span></span><span class="line"><span class="cl">    <span class="ow">[</span>w, b, w, w, w, w, w, w, w, w, w, w, w, w, b, w<span class="ow">]</span>,
</span></span><span class="line"><span class="cl">    <span class="ow">[</span>w, b, w, w, w, w, w, w, w, w, w, w, w, w, b, w<span class="ow">]</span>,
</span></span><span class="line"><span class="cl">    <span class="ow">[</span>w, b, w, w, w, w, w, w, w, w, w, w, w, w, b, w<span class="ow">]</span>,
</span></span><span class="line"><span class="cl">    <span class="ow">[</span>w, b, w, w, w, w, w, w, w, w, w, w, w, w, b, w<span class="ow">]</span>,
</span></span><span class="line"><span class="cl">    <span class="ow">[</span>w, b, w, w, w, w, w, w, w, w, w, w, w, w, b, w<span class="ow">]</span>,
</span></span><span class="line"><span class="cl">    <span class="ow">[</span>w, b, b, b, b, b, b, b, b, b, b, b, b, b, b, w<span class="ow">]</span>,
</span></span><span class="line"><span class="cl">    <span class="ow">[</span>w, w, w, w, w, w, w, w, w, w, w, w, w, w, w, w<span class="ow">]</span>
</span></span><span class="line"><span class="cl">  <span class="ow">]</span>
</span></span><span class="line"><span class="cl"><span class="kr">where</span>
</span></span><span class="line"><span class="cl">  <span class="nf">w</span> <span class="ow">:</span> <span class="kt">Color</span>
</span></span><span class="line"><span class="cl">  w <span class="ow">=</span> <span class="ow">(</span><span class="mi">255</span>, <span class="mi">255</span>, <span class="mi">255</span><span class="ow">)</span>
</span></span><span class="line"><span class="cl">  <span class="nf">b</span> <span class="ow">:</span> <span class="kt">Color</span>
</span></span><span class="line"><span class="cl">  b <span class="ow">=</span> <span class="ow">(</span><span class="mi">0</span>, <span class="mi">0</span>, <span class="mi">0</span><span class="ow">)</span>
</span></span></code></pre></div><p>今回のデータは上下対称ですが、BMPフォーマットでは天地逆さになるので他の画像を試す方は注意して下さい。</p>
<p>さて、データはこれを使うとして、 <code>main</code> はこう書きます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl"><span class="nf">main</span> <span class="ow">:</span> <span class="kt">IO</span> <span class="ow">()</span>
</span></span><span class="line"><span class="cl">main <span class="ow">=</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">  <span class="ow">[</span><span class="kr">_</span>, file<span class="ow">]</span> <span class="ow">&lt;-</span> getArgs
</span></span><span class="line"><span class="cl">    <span class="ow">|</span> <span class="kr">_</span> <span class="ow">=&gt;</span> putStrLn <span class="s">&#34;Usage: FILENAME&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">Right</span> file <span class="ow">&lt;-</span> openFile file <span class="kt">WriteTruncate</span>
</span></span><span class="line"><span class="cl">    <span class="ow">|</span> <span class="kt">Left</span> <span class="ow">=&gt;</span> putStrLn <span class="ow">(</span><span class="s">&#34;failed to open file: &#34;</span> <span class="ow">++</span> file<span class="ow">)</span>
</span></span><span class="line"><span class="cl">  writeBitMap file <span class="ow">(</span>fromData bitMapData<span class="ow">)</span>
</span></span><span class="line"><span class="cl">  fflush file
</span></span><span class="line"><span class="cl">  closeFile file
</span></span></code></pre></div><p><code>openFile</code> 、 <code>WriteTruncate</code> 、 <code>fflush</code> 、 <code>closeFile</code> などは <a href="https://www.idris-lang.org/docs/current/prelude_doc/docs/Prelude.File.html"><code>Prelude.File</code></a>で定義されたAPIです。
<code>getArgs</code> は <a href="https://www.idris-lang.org/docs/current/prelude_doc/docs/Prelude.Interactive.html"><code>Prelude.Interactive</code></a>で定義されています。</p>
<p>それではこれをコンパイル・実行してみましょう。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ idris -o EasyBitMapMain EasyBitMapMain.idr
</span></span><span class="line"><span class="cl">$ ./EasyBitMapMain test.bmp
</span></span></code></pre></div><p>私は <code>test.bmp</code> にBMP形式のデータが書き出されました。
適当に開いてみて下さい。Linuxなら <code>eog test.bmp</code> とかで開けます。macOSだと <code>open test.bmp</code> かな？あるいはファイラーでディレクトリを開いてダブルクリックしてみて下さい。
こんな感じの画像が見れるはずです。</p>
<img src="data:image/bmp;base64,Qk02AwAAAAAAADYAAAAoAAAAEAAAABAAAAABABgAAAAAAAADAAAAAAAAAAAAAAAAAAAAAAAA////////////////////////////////////////////////////////////////////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA////////AAAA////////////////////////////////////////////////AAAA////////AAAA////////////////////////////////////////////////AAAA////////AAAA////////////////////////////////////////////////AAAA////////AAAA////////////////////////////////////////////////AAAA////////AAAA////////////////////////////////////////////////AAAA////////AAAA////////////////////////////////////////////////AAAA////////AAAA////////////////////////////////////////////////AAAA////////AAAA////////////////////////////////////////////////AAAA////////AAAA////////////////////////////////////////////////AAAA////////AAAA////////////////////////////////////////////////AAAA////////AAAA////////////////////////////////////////////////AAAA////////AAAA////////////////////////////////////////////////AAAA////////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA////////////////////////////////////////////////////////////////////">
<p>サイズが小さいので豆粒みたいですが、白地に黒い正方形が描かれています。これが表示されたら成功です。</p>
<h1 id="まとめ">まとめ</h1>
<p>IdrisでBMP画像を書き出してみました。
その過程で依存型やType Reification、BufferやFileなどの操作を学びました。</p>
<p>実はColor Bitsを24に限定すると実装を簡略化できるというのに気付かず、一度任意のColor Bitsに対応したプログラムも作っています。そちらは今回のものよりも踏み込んだ依存型の使い方をしているのでいつか紹介できたらなと思ってます。</p>
<h1 id="参考文献">参考文献</h1>
<p>今回の記事は一度以下の記事を参考にBMPフォーマットを書き出すプログラムを書いてみたのがベースになっています。</p>
<p><a href="https://qiita.com/chooyan_eng/items/151e67684e5ef8d1a695">【バイナリファイル入門】Bitmapファイルを手書きで作って遊んでみる - Qiita</a></p>
<p>詳しいフォーマットは記事中でも触れましたがWikipediaを参考にしました。</p>
<p><a href="https://ja.wikipedia.org/wiki/Windows_bitmap">Windows bitmap - Wikipedia</a></p>
<h1 id="付録a-今回のコード">付録A: 今回のコード</h1>
<script src="https://gitlab.com/-/snippets/2050741.js"></script>
<h1 id="付録b-生成されるbmp画像のバイナリデータ">付録B: 生成されるBMP画像のバイナリデータ</h1>
<p>デバッグ用途にどうぞ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">00000000: 424d 3603 0000 0000 0000 3600 0000 2800  BM6.......6...(.
</span></span><span class="line"><span class="cl">00000010: 0000 1000 0000 1000 0000 0100 1800 0000  ................
</span></span><span class="line"><span class="cl">00000020: 0000 0003 0000 0000 0000 0000 0000 0000  ................
</span></span><span class="line"><span class="cl">00000030: 0000 0000 0000 ffff ffff ffff ffff ffff  ................
</span></span><span class="line"><span class="cl">00000040: ffff ffff ffff ffff ffff ffff ffff ffff  ................
</span></span><span class="line"><span class="cl">00000050: ffff ffff ffff ffff ffff ffff ffff ffff  ................
</span></span><span class="line"><span class="cl">00000060: ffff ffff ffff ffff ff00 0000 0000 0000  ................
</span></span><span class="line"><span class="cl">00000070: 0000 0000 0000 0000 0000 0000 0000 0000  ................
</span></span><span class="line"><span class="cl">00000080: 0000 0000 0000 0000 0000 0000 0000 0000  ................
</span></span><span class="line"><span class="cl">00000090: 0000 00ff ffff ffff ff00 0000 ffff ffff  ................
</span></span><span class="line"><span class="cl">000000a0: ffff ffff ffff ffff ffff ffff ffff ffff  ................
</span></span><span class="line"><span class="cl">000000b0: ffff ffff ffff ffff ffff ffff ffff ffff  ................
</span></span><span class="line"><span class="cl">000000c0: 0000 00ff ffff ffff ff00 0000 ffff ffff  ................
</span></span><span class="line"><span class="cl">000000d0: ffff ffff ffff ffff ffff ffff ffff ffff  ................
</span></span><span class="line"><span class="cl">000000e0: ffff ffff ffff ffff ffff ffff ffff ffff  ................
</span></span><span class="line"><span class="cl">000000f0: 0000 00ff ffff ffff ff00 0000 ffff ffff  ................
</span></span><span class="line"><span class="cl">00000100: ffff ffff ffff ffff ffff ffff ffff ffff  ................
</span></span><span class="line"><span class="cl">00000110: ffff ffff ffff ffff ffff ffff ffff ffff  ................
</span></span><span class="line"><span class="cl">00000120: 0000 00ff ffff ffff ff00 0000 ffff ffff  ................
</span></span><span class="line"><span class="cl">00000130: ffff ffff ffff ffff ffff ffff ffff ffff  ................
</span></span><span class="line"><span class="cl">00000140: ffff ffff ffff ffff ffff ffff ffff ffff  ................
</span></span><span class="line"><span class="cl">00000150: 0000 00ff ffff ffff ff00 0000 ffff ffff  ................
</span></span><span class="line"><span class="cl">00000160: ffff ffff ffff ffff ffff ffff ffff ffff  ................
</span></span><span class="line"><span class="cl">00000170: ffff ffff ffff ffff ffff ffff ffff ffff  ................
</span></span><span class="line"><span class="cl">00000180: 0000 00ff ffff ffff ff00 0000 ffff ffff  ................
</span></span><span class="line"><span class="cl">00000190: ffff ffff ffff ffff ffff ffff ffff ffff  ................
</span></span><span class="line"><span class="cl">000001a0: ffff ffff ffff ffff ffff ffff ffff ffff  ................
</span></span><span class="line"><span class="cl">000001b0: 0000 00ff ffff ffff ff00 0000 ffff ffff  ................
</span></span><span class="line"><span class="cl">000001c0: ffff ffff ffff ffff ffff ffff ffff ffff  ................
</span></span><span class="line"><span class="cl">000001d0: ffff ffff ffff ffff ffff ffff ffff ffff  ................
</span></span><span class="line"><span class="cl">000001e0: 0000 00ff ffff ffff ff00 0000 ffff ffff  ................
</span></span><span class="line"><span class="cl">000001f0: ffff ffff ffff ffff ffff ffff ffff ffff  ................
</span></span><span class="line"><span class="cl">00000200: ffff ffff ffff ffff ffff ffff ffff ffff  ................
</span></span><span class="line"><span class="cl">00000210: 0000 00ff ffff ffff ff00 0000 ffff ffff  ................
</span></span><span class="line"><span class="cl">00000220: ffff ffff ffff ffff ffff ffff ffff ffff  ................
</span></span><span class="line"><span class="cl">00000230: ffff ffff ffff ffff ffff ffff ffff ffff  ................
</span></span><span class="line"><span class="cl">00000240: 0000 00ff ffff ffff ff00 0000 ffff ffff  ................
</span></span><span class="line"><span class="cl">00000250: ffff ffff ffff ffff ffff ffff ffff ffff  ................
</span></span><span class="line"><span class="cl">00000260: ffff ffff ffff ffff ffff ffff ffff ffff  ................
</span></span><span class="line"><span class="cl">00000270: 0000 00ff ffff ffff ff00 0000 ffff ffff  ................
</span></span><span class="line"><span class="cl">00000280: ffff ffff ffff ffff ffff ffff ffff ffff  ................
</span></span><span class="line"><span class="cl">00000290: ffff ffff ffff ffff ffff ffff ffff ffff  ................
</span></span><span class="line"><span class="cl">000002a0: 0000 00ff ffff ffff ff00 0000 ffff ffff  ................
</span></span><span class="line"><span class="cl">000002b0: ffff ffff ffff ffff ffff ffff ffff ffff  ................
</span></span><span class="line"><span class="cl">000002c0: ffff ffff ffff ffff ffff ffff ffff ffff  ................
</span></span><span class="line"><span class="cl">000002d0: 0000 00ff ffff ffff ff00 0000 0000 0000  ................
</span></span><span class="line"><span class="cl">000002e0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
</span></span><span class="line"><span class="cl">000002f0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
</span></span><span class="line"><span class="cl">00000300: 0000 00ff ffff ffff ffff ffff ffff ffff  ................
</span></span><span class="line"><span class="cl">00000310: ffff ffff ffff ffff ffff ffff ffff ffff  ................
</span></span><span class="line"><span class="cl">00000320: ffff ffff ffff ffff ffff ffff ffff ffff  ................
</span></span><span class="line"><span class="cl">00000330: ffff ffff ffff                           ......
</span></span></code></pre></div>
                    </section>
                </article>
            </div>
        </div>

        <div class="row li-author">
    <div class="sixteen columns">
        Written by <strong>κeen</strong>
    </div>
</div>


        <div class="row li-pagination">
            <div class="eight columns">
                <div class="li-pagination-previous">
                    
                        Later article<br />
                        <a href="https://KeenS.github.io/blog/2020/12/16/idrisnonamaetsukiparame_tatogadt/"> Idrisの名前つきパラメータとGADT</a>
                    
                </div>
            </div>
            <div class="eight columns">
                <div class="li-pagination-next">
                    
                        Older article<br />
                        <a href="https://KeenS.github.io/blog/2020/12/15/idrisnomoju_rutopureryu_do_hyoujunraiburari/"> Idrisのモジュールとプレリュード、標準ライブラリ</a>
                    
                </div>
            </div>
        </div>
    </div>

<footer class="li-page-footer">
    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <div class="li-page-footer-legal">
                    &copy; 2024. All rights reserved. 
                </div>
                <div class="li-page-footer-theme">
                    <span class=""><a href="https://github.com/eliasson/liquorice/">liquorice</a> is a theme for <a href="http://hugo.spf13.com">hugo</a></span>
                </div>
            </div>
        </div>
    </div>
</footer>

<script type="text/javascript">
 function toggle(id) {
     var e = document.getElementById(id);
     e.style.display == 'block' ? e.style.display = 'none' : e.style.display = 'block';
 }
</script>
<script src="https://unpkg.com/mermaid@7.0.4/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true
     });</script>

    </body>
</html>

