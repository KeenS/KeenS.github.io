<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
    <head>
        
        
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-43779888-1"></script>
        <script>
         window.dataLayer = window.dataLayer || [];
         function gtag(){dataLayer.push(arguments);}
         gtag('js', new Date());

         gtag('config', 'UA-43779888-1');
        </script>
        

        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

        <meta name="twitter:site" content="@blackenedgold" />
        <meta name="twitter:title" content="ブラウザ上で音楽を演奏する | κeenのHappy Hacκing Blog"/>
        <meta name="twitter:description" content="κeenです。めずらしくWebの話題でも。ブラウザ上で音出したいときってどうすればいいんだっけとなって調べた結果です。" />
        <meta property="og:title" content="ブラウザ上で音楽を演奏する | κeenのHappy Hacκing Blog" />
        <meta property="og:type" content="article" />
        <meta property="og:url" content="https://KeenS.github.io/blog/2020/11/14/burauzauedeongakuwoensousuru/" />
        <meta property="og:description" content="κeenです。めずらしくWebの話題でも。ブラウザ上で音出したいときってどうすればいいんだっけとなって調べた結果です。" />
        <meta name="twitter:card" content="summary_large_image" />
        <meta property="og:image" content="https://KeenS.github.io/images/ogp/post/burauzauedeongakuwoensousuru.png" />
        <meta name="twitter:image" content="https://KeenS.github.io/images/ogp/post/burauzauedeongakuwoensousuru.png" />
        
        <meta property="og:article:published_time" content="2020-11-14 10:23:27 &#43;0900 JST" />
        <meta property="og:article:modified_time" content="2020-11-14 10:23:27 &#43;0900 JST" />
        
        <meta property="og:article:author" content="κeen" />

        <title>ブラウザ上で音楽を演奏する | κeenのHappy Hacκing Blog</title>
        <link rel="stylesheet" href='//fonts.googleapis.com/css?family=Open+Sans:400,300,600' type='text/css' />
        <link rel="stylesheet" href="https://KeenS.github.io/libraries/normalize.3.0.1.css" />
        <link rel="stylesheet" href="https://KeenS.github.io/css/liquorice.css" />
        <link rel="apple-touch-icon" sizes="180x180" href="https://KeenS.github.io/apple-touch-icon.png">
        <link rel="icon" type="image/png" href="https://KeenS.github.io/favicon-32x32.png" sizes="32x32">
        <link rel="icon" type="image/png" href="https://KeenS.github.io/favicon-16x16.png" sizes="16x16">
        <link rel="manifest" href="https://KeenS.github.io/manifest.json">
        <link rel="mask-icon" href="https://KeenS.github.io/safari-pinned-tab.svg" color="#5bbad5">
        <meta name="theme-color" content="#ffffff">
        <link rel="apple-touch-icon-precomposed" href="https://KeenS.github.io/apple-touch-icon-144-precomposed.png" sizes="144x144" />
        <link rel="stylesheet" href="https://KeenS.github.io/css/syntax-monokai.css" />
<script type="text/x-mathjax-config">
 MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ["\\(","\\)"]] } });
</script>
<script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_CHTML"></script>
</script>
<meta http-equiv="X-UA-Compatible" CONTENT="IE=EmulateIE7" />
<link rel="stylesheet" href="//unpkg.com/mermaid@7.0.4/dist/mermaid.forest.min.css">

    </head>
    <body class="li-body">

<header class="li-page-header" id="page-header">
    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <div class="li-brand li-left">
                <a href="https://KeenS.github.io/">κeenのHappy Hacκing Blog</a> | Lispエイリアンの狂想曲</div>
                <div class="li-menu li-right">
                    <span class="li-menu-icon" onclick="javascript:toggle('menu');">&#9776;</span>
                    <ul id="menu2" class="li-menu-items">
                        
                            <li><a href="https://KeenS.github.io/about/"> About </a></li>
                        
                            <li><a href="https://KeenS.github.io/post/"> Blog </a></li>
                        
                            <li><a href="https://KeenS.github.io/slide/"> Slide </a></li>
                        
                            <li><a href="https://KeenS.github.io/index.xml"> Atom </a></li>
                        
                            <li><a href="https://KeenS.github.io/search/"> Search </a></li>
                        
                    </ul>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="sixteen columns">
                <ul id="menu" class="li-menu-items li-menu-mobile">
                    
                        <li><a href="https://KeenS.github.io/about/"> About </a></li>
                    
                        <li><a href="https://KeenS.github.io/post/"> Blog </a></li>
                    
                        <li><a href="https://KeenS.github.io/slide/"> Slide </a></li>
                    
                        <li><a href="https://KeenS.github.io/index.xml"> Atom </a></li>
                    
                        <li><a href="https://KeenS.github.io/search/"> Search </a></li>
                    
                </ul>
            </div>
        </div>
    </div>
</header>






    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <article class="li-article">
                    <header class="li-article-header">
                        <h1 class="li-article-title">ブラウザ上で音楽を演奏する</h1>
                        <div class="li-article-meta">
    <time class="li-article-date">2020-11-14</time>
    <ul class="li-article-tag">
    
        <li>
            <a href="https://KeenS.github.io/categories/javascript">JavaScript</a>
        </li>
    
        <li>
            <a href="https://KeenS.github.io/categories/web-audio-api">Web Audio API</a>
        </li>
    
</ul>

</div>

                    </header>
                    <section>
                        <p>κeenです。めずらしくWebの話題でも。ブラウザ上で音出したいときってどうすればいいんだっけとなって調べた結果です。</p>

<h1 id="web-audio-api">Web Audio API</h1>

<p>個人的にはSVGのオーディオ版の、楽譜っぽいものをテキストで入力したら勝手に音が鳴ってくれるフォーマットをさがしてたのですがみつかりませんでした（辛うじて<a href="https://ja.wikipedia.org/wiki/MusicXML">MusicXML</a>が近いくらい？）。MIDIとかにも期待したんですがあれはバイナリ</p>

<p>代わりに、Web Audio APIというのを使えばブラウザ上で音が出せそうというのがみつかりました。</p>

<ul>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Audio_API">Web Audio API - Web APIs | MDN</a></li>
</ul>

<p>この中の <a href="https://developer.mozilla.org/en-US/docs/Web/API/OscillatorNode"><code>OscillatorNode</code></a> を使えば手で音が出せそうです。</p>

<h2 id="oscillatornode">OscillatorNode</h2>

<p><code>OscillatorNode</code> を使ったサンプルを実装してみたのがこれ（クリックすると大きめの音が鳴ります）。</p>

<div id="oscPlayer">▶️ Play</div>

<script><!--
(function() {
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let oscillator = null;
    const playButton = document.getElementById("oscPlayer");

    playButton.addEventListener("mousedown", function(event) {
      if (oscillator === null) {
          playButton.innerHTML = "⏸ Stop";
          oscillator = audioCtx.createOscillator();
          oscillator.type = 'square';
          oscillator.frequency.setValueAtTime(440, audioCtx.currentTime); // value in hertz
          oscillator.connect(audioCtx.destination);
          oscillator.start();
      } else {
          playButton.innerHTML = "▶️ Play";
          oscillator.stop();
          oscillator.disconnect(audioCtx.destination);
          oscillator = null
      }
    }, false);
})()
-->
</script>

<p>コードは以下。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;oscPlayer&#34;</span><span class="p">&gt;</span>▶<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="kr">const</span> <span class="nx">audioCtx</span> <span class="o">=</span> <span class="k">new</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">AudioContext</span> <span class="o">||</span> <span class="nb">window</span><span class="p">.</span><span class="nx">webkitAudioContext</span><span class="p">)();</span>
<span class="kd">let</span> <span class="nx">oscillator</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">playButton</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&#34;oscPlayer&#34;</span><span class="p">);</span>

<span class="nx">playButton</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&#34;mousedown&#34;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">oscillator</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">playButton</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">&#34;⏸ Stop&#34;</span><span class="p">;</span>
      <span class="nx">oscillator</span> <span class="o">=</span> <span class="nx">audioCtx</span><span class="p">.</span><span class="nx">createOscillator</span><span class="p">();</span>
      <span class="nx">oscillator</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s1">&#39;square&#39;</span><span class="p">;</span>
      <span class="nx">oscillator</span><span class="p">.</span><span class="nx">frequency</span><span class="p">.</span><span class="nx">setValueAtTime</span><span class="p">(</span><span class="mi">440</span><span class="p">,</span> <span class="nx">audioCtx</span><span class="p">.</span><span class="nx">currentTime</span><span class="p">);</span> <span class="c1">// value in hertz
</span><span class="c1"></span>      <span class="nx">oscillator</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">audioCtx</span><span class="p">.</span><span class="nx">destination</span><span class="p">);</span>
      <span class="nx">oscillator</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">playButton</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">&#34;▶️ Play&#34;</span><span class="p">;</span>
      <span class="nx">oscillator</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>
      <span class="nx">oscillator</span><span class="p">.</span><span class="nx">disconnect</span><span class="p">(</span><span class="nx">audioCtx</span><span class="p">.</span><span class="nx">destination</span><span class="p">);</span>
      <span class="nx">oscillator</span> <span class="o">=</span> <span class="kc">null</span>
  <span class="p">}</span>
<span class="p">},</span> <span class="kc">false</span><span class="p">);</span>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span></code></pre></div>
<p>ノードをコネクトしていって有向グラフを作り、音源から <code>audioCtx.destination</code> まで到達できたら音が鳴る仕組みです。
その音源にあたるのが <code>OscillatorNode</code> で、コード中のこの部分で作って実行してます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript">      <span class="nx">oscillator</span> <span class="o">=</span> <span class="nx">audioCtx</span><span class="p">.</span><span class="nx">createOscillator</span><span class="p">();</span>
      <span class="nx">oscillator</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s1">&#39;square&#39;</span><span class="p">;</span>
      <span class="nx">oscillator</span><span class="p">.</span><span class="nx">frequency</span><span class="p">.</span><span class="nx">setValueAtTime</span><span class="p">(</span><span class="mi">440</span><span class="p">,</span> <span class="nx">audioCtx</span><span class="p">.</span><span class="nx">currentTime</span><span class="p">);</span> <span class="c1">// value in hertz
</span><span class="c1"></span>      <span class="nx">oscillator</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">audioCtx</span><span class="p">.</span><span class="nx">destination</span><span class="p">);</span>
      <span class="nx">oscillator</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span></code></pre></div>
<p>440Hzの矩形波を鳴らしています。440Hzというのはおなじみラの音です。</p>

<p>音源をstopする手段はあるのですが、一度stopすると再開できないのでこういう再生/停止を繰り返す場合は音源を削除、disconnectするのが常套手段のようです。</p>

<p>今回は使ってませんが、 <code>OscillatorNode</code> には <code>frequency</code> の他に <code>detune</code> というパラメータがあります。
これは<a href="https://ja.wikipedia.org/wiki/平均律">平均律</a>での<a href="https://ja.wikipedia.org/wiki/セント_(音楽)">セント</a>を指定します。
12音階での隣の音がちょうど100セントで、1オクターブ上がるとちょうど1200セントです。
上記のラが440Hzなのでこれに100セントずつ+-していけば音階を表現できるという仕組みです。</p>

<h2 id="演奏時間を指定する">演奏時間を指定する</h2>

<p>周波数と演奏する長さがあればひとまず演奏できそうですね。
上記のAPIで周波数は指定できるようになったので演奏時間を指定するのが目標です。</p>

<p><code>OscillatorNode</code> などの <a href="https://developer.mozilla.org/en-US/docs/Web/API/AudioScheduledSourceNode"><code>AudioScheduledSourceNode</code></a> の <a href="https://developer.mozilla.org/en-US/docs/Web/API/AudioScheduledSourceNode/start"><code>start</code></a> （と呼応する <a href="https://developer.mozilla.org/en-US/docs/Web/API/AudioScheduledSourceNode/stop"><code>stop</code></a>）はオプショナルな引数 <code>when</code> でいつ操作をするか選べるのでそれを使います。
すなわち、1秒演奏するなら <code>start(startTime)</code> と <code>stop(startTime + 1)</code> を呼んであげればいい訳です。
ただし演奏が終わったら <code>disconnect</code> したり <code>null</code> を代入したりする処理が必要になります。そういうのは <code>onended</code> にコールバックで指定できるのでそうします。</p>

<p>それを実装したのが以下。</p>

<div id="oscPlayer2">▶️ Play</div>

<script><!--
(function() {
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let oscillator = null;
    const playButton = document.getElementById("oscPlayer2");

    playButton.addEventListener("mousedown", function(event) {
      if (oscillator === null) {
          playButton.innerHTML = "⏸ Stop";
          oscillator = audioCtx.createOscillator();
          oscillator.type = 'square';
          oscillator.frequency.setValueAtTime(440, audioCtx.currentTime); // value in hertz
          oscillator.connect(audioCtx.destination);

          // 1秒だけ鳴らしたあとお片付けする
          let currentTime = audioCtx.currentTime;
          oscillator.onended = function() {
              oscillator.disconnect(audioCtx.destination);
              oscillator = null
          }
          oscillator.start(currentTime);
          oscillator.stop(currentTime + 1);
      } else {
          playButton.innerHTML = "▶️ Play";
          oscillator.stop();
          oscillator.disconnect(audioCtx.destination);
          oscillator = null
      }
    }, false);
})()
-->
</script>

<p>コードは以下。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;oscPlayer&#34;</span><span class="p">&gt;</span>▶<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="kr">const</span> <span class="nx">audioCtx</span> <span class="o">=</span> <span class="k">new</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">AudioContext</span> <span class="o">||</span> <span class="nb">window</span><span class="p">.</span><span class="nx">webkitAudioContext</span><span class="p">)();</span>
<span class="kd">let</span> <span class="nx">oscillator</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">playButton</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&#34;oscPlayer2&#34;</span><span class="p">);</span>

<span class="nx">playButton</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&#34;mousedown&#34;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">oscillator</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">playButton</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">&#34;⏸ Stop&#34;</span><span class="p">;</span>
      <span class="nx">oscillator</span> <span class="o">=</span> <span class="nx">audioCtx</span><span class="p">.</span><span class="nx">createOscillator</span><span class="p">();</span>
      <span class="nx">oscillator</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s1">&#39;square&#39;</span><span class="p">;</span>
      <span class="nx">oscillator</span><span class="p">.</span><span class="nx">frequency</span><span class="p">.</span><span class="nx">setValueAtTime</span><span class="p">(</span><span class="mi">440</span><span class="p">,</span> <span class="nx">audioCtx</span><span class="p">.</span><span class="nx">currentTime</span><span class="p">);</span> <span class="c1">// value in hertz
</span><span class="c1"></span>      <span class="nx">oscillator</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">audioCtx</span><span class="p">.</span><span class="nx">destination</span><span class="p">);</span>

      <span class="c1">// 1秒だけ鳴らしたあとお片付けする
</span><span class="c1"></span>      <span class="kd">let</span> <span class="nx">currentTime</span> <span class="o">=</span> <span class="nx">audioCtx</span><span class="p">.</span><span class="nx">currentTime</span><span class="p">;</span>
      <span class="nx">oscillator</span><span class="p">.</span><span class="nx">onended</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">oscillator</span><span class="p">.</span><span class="nx">disconnect</span><span class="p">(</span><span class="nx">audioCtx</span><span class="p">.</span><span class="nx">destination</span><span class="p">);</span>
          <span class="nx">oscillator</span> <span class="o">=</span> <span class="kc">null</span>
      <span class="p">}</span>
      <span class="nx">oscillator</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="nx">currentTime</span><span class="p">);</span>
      <span class="nx">oscillator</span><span class="p">.</span><span class="nx">stop</span><span class="p">(</span><span class="nx">currentTime</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">playButton</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">&#34;▶️ Play&#34;</span><span class="p">;</span>
      <span class="nx">oscillator</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>
      <span class="nx">oscillator</span><span class="p">.</span><span class="nx">disconnect</span><span class="p">(</span><span class="nx">audioCtx</span><span class="p">.</span><span class="nx">destination</span><span class="p">);</span>
      <span class="nx">oscillator</span> <span class="o">=</span> <span class="kc">null</span>
  <span class="p">}</span>
<span class="p">},</span> <span class="kc">false</span><span class="p">);</span>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span></code></pre></div>
<h2 id="音量を調整する">音量を調整する</h2>

<p><a href="https://developer.mozilla.org/en-US/docs/Web/API/GainNode"><code>GainNode</code></a> というのでできます。
音源とスピーカの間に挟まるエフェクト扱いです。</p>

<p>こんな感じ（動作例略）</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kr">const</span> <span class="nx">gainNode</span> <span class="o">=</span> <span class="nx">audioCtx</span><span class="p">.</span><span class="nx">createGain</span><span class="p">();</span>
<span class="nx">gainNode</span><span class="p">.</span><span class="nx">gain</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="mf">0.025</span><span class="p">;</span>
<span class="nx">gain</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">audioCtx</span><span class="p">.</span><span class="nx">destination</span><span class="p">);</span>
<span class="nx">osc</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">gain</span><span class="p">)</span></code></pre></div>
<h2 id="演奏する">演奏する</h2>

<p>まあ、あとはプログラマなら適当にコード書けば演奏できるようになるでしょう。</p>

<p>実装したのがこちら。今度はボリュームが調整できます。</p>

<div class="controls">
    <div class="left">
        <div id="playButton" class="button">
            ▶️ play
        </div>
    </div>
    <div class="right">
        <span>Volume: </span>
        <input type="range" min="0.0" max="1.0" step="0.01"
               value="0.8" name="volume" id="volumeControl">
    </div>
</div>

<script><!--

 class Note {
     constructor(step, octave, duration) {
         const noteTable = {
             "C" : -9,
             "C#": -8, "Cs": -8, "Df": -8,
             "D" : -7,
             "D#": -6, "Ds": -6, "Ef": -6,
             "E" : -5,
             "F" : -4,
             "F#": -3, "Fs": -3, "Gf": -3,
             "G" : -2,
             "G#": -1, "Gs": -1, "Af": -1,
             "A" :  0,
             "A#":  1, "As":  1, "Bf":  1,
             "B" :  2
         };
         this.detune = noteTable[step] * 100 + (octave - 4) * 1200;
         this.duration = duration;
     }

     realDuration(bpm) {
         bpm = bpm || 60;
         return 1  * (60 / bpm) / this.duration * 4;
     }
 }

 class Tone {
     ctx
     concertPitch
 }

 class SimpleTone extends Tone {
     type = 'sine';
     constructor(type) {
         super()
         this.type = type;
         this.osc = null;
     }

     play(detune, start, duration, output) {
         const osc = this.ctx.createOscillator();
         osc.type = this.type;
         osc.frequency.value = this.concertPitch;
         osc.detune.value = detune;
         osc.connect(output);
         osc.onended = function() {
             osc.disconnect(output)
         };
         osc.start(start);
         osc.stop(start + duration * 0.9);
         return osc;
     }
 }

 class PianoTone extends Tone {
     createOsc(detune, gain, start, duration, output) {
         const attack = 0.2;
         const decay = 0.1;
         const sustain = gain * 0.7;
         const release = 0.3;

         const osc = this.ctx.createOscillator();
         osc.frequency.value = this.concertPitch;
         osc.detune.value = detune;
         osc.type = 'sine';

         const gainNode = this.ctx.createGain();
         const t0 = start;
         const t1 = t0 + attack;
         const t2 = t1 + decay;
         const t3 = t0 + duration;
         const t4 = t3 + release;
         gainNode.gain.linearRampToValueAtTime(gain, t1);
         gainNode.gain.setTargetAtTime(sustain, t1, decay)
         gainNode.gain.setTargetAtTime(0, t3, release);

         osc.connect(gainNode);
         gainNode.connect(output);
         osc.onended = function() {
             osc.disconnect(gainNode);
             gainNode.disconnect(output);
         }

         osc.start(t0);
         osc.stop(t4);
         return osc;
     }

     play(detune, start, duration, output) {
         let o1 = this.createOsc(detune - 3600, 0.512, start, duration * 0.064, output);
         let o2 = this.createOsc(detune - 2400, 0.64 , start, duration * 0.16 , output);
         let o3 = this.createOsc(detune - 1200, 0.8  , start, duration * 0.4  , output);
         let o4 = this.createOsc(detune       ,   1  , start, duration        , output);
         let o5 = this.createOsc(detune + 1200, 0.4  , start, duration * 0.8  , output);
         let o6 = this.createOsc(detune + 2400, 0.16 , start, duration * 0.64 , output);
         let o7 = this.createOsc(detune + 3600, 0.064, start, duration * 0.512, output);
         return {
             oscs: [o1, o2, o3, o4, o5, o6, o7],
             stop: function(when) {
                 for(let osc of this.oscs) {
                     osc.stop(when)
                 }
             }
         };
     }
 }

 class Music {
     constructor(notes) {
         this.notes = notes;
     }

     [Symbol.iterator]() {
         return this.notes[Symbol.iterator]();
     }

     static parse(input) {
         const notes = [];

         let octave = 4;
         let duration = 4;
         for(let c of input.split(' ')) {
             if (c === '|' || c === "" || c === "\n" ) {
                 continue;
             }

             let ret = c.match(/([A-G][#sf]?)([-+]*)(16|8|4|2|1)?/);
             if (ret) {
                 let step = ret[1];
                 for(let o of ret[2]) {
                     switch (o) {
                         case "+": octave++;
                         case "-": octave--;
                     }
                 }
                 if(ret[3]) {
                     duration = parseInt(ret[3]);
                 }
                 notes.push(new Note(step, octave, duration));
             } else {
                 throw "parse error";
             }
         }
         return new this(notes);
     }
 }

 class Player {
     constructor(bpm, tone, concertPitch) {
         this.ctx = new (window.AudioContext || window.webkitAudioContext)();

         const gain = this.ctx.createConstantSource();
         const gainNode = this.ctx.createGain();
         gainNode.gain.value = 0.025;
         gain.connect(gainNode.gain);
         gain.start();
         gain.offset.value = 0.25;
         gainNode.connect(this.ctx.destination);

         this.output = gainNode;
         this._gain = gain;
         this.bpm = bpm;
         this.tone = tone || new SimpleTone('square');
         this.tone.ctx = this.ctx;
         this.tone.concertPitch = concertPitch || 440;
         this.playingNotes = [];
         this.isPlaying = false;
     }

     get gain() {
         this._gain.offset.value;
     }

     set gain(gain) {
         this._gain.offset.value = gain;

     }

     playNote(note, at) {
         at = at || 0;
         const duration = note.realDuration(this.bpm);
         let playingNote = this.tone.play(note.detune, at, duration, this.output);
         return playingNote;
     }

     playMusic(music) {
         this.isPlaying = true;
         let start = this.ctx.currentTime;
         for (let note of music) {
             let playingNote = this.playNote(note, start);
             start += note.realDuration(this.bpm);
             this.playingNotes.push(playingNote);
         }
     }

     cancel() {
         this.isPlaying = false;
         for(let note of this.playingNotes) {
             note.stop()
         }
     }
 }

 function setup() {

     const music = Music.parse("\
     C  C  G  G  | A  A  G2 |\
     F4 F  E  E  | D  D  C2 |\
     G4 G  F  F  | E  E  D2 |\
     G4 G  F  F  | E  E  D2 |\
     C4 C  G  G  | A  A  G2 |\
     F4 F  E  E  | D  D  C2 |");
     const player = new Player(90, new SimpleTone('sine'));
     function togglePlay(event) {
         if (player.isPlaying) {
             playButton.innerHTML = "▶️ play";
             player.cancel();
         } else {
             playButton.innerHTML = "◼ cancel";
             player.playMusic(music);
         }
     }

     function changeVolume(event) {
         player.gain = volumeControl.value;
     }

     const playButton = document.querySelector("#playButton");
     const volumeControl = document.querySelector("#volumeControl");
     volumeControl.value = player.gain;

     playButton.addEventListener("click", togglePlay, false);
     volumeControl.addEventListener("input", changeVolume, false);

 }

 setup();

-->
</script>

<p>コードは後程gistを貼りますが、だいたい以下のようなコードを書いたら演奏できるようになってます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kr">const</span> <span class="nx">music</span> <span class="o">=</span> <span class="nx">Music</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="s2">&#34;\
</span><span class="s2">    C  C  G  G  | A  A  G2 |\
</span><span class="s2">    F4 F  E  E  | D  D  C2 |\
</span><span class="s2">    G4 G  F  F  | E  E  D2 |\
</span><span class="s2">    G4 G  F  F  | E  E  D2 |\
</span><span class="s2">    C4 C  G  G  | A  A  G2 |\
</span><span class="s2">    F4 F  E  E  | D  D  C2 |&#34;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">player</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Player</span><span class="p">(</span><span class="mi">90</span><span class="p">,</span> <span class="k">new</span> <span class="nx">SimpleTone</span><span class="p">(</span><span class="s1">&#39;sine&#39;</span><span class="p">));</span>
<span class="nx">player</span><span class="p">.</span><span class="nx">playMusic</span><span class="p">(</span><span class="nx">music</span><span class="p">)</span></code></pre></div>
<p>ひとまずやりたいことができました。</p>

<h2 id="ピアノの音色">ピアノの音色？</h2>

<p>ところで、演奏したときの音色気になりませんでしたか？
正弦波なのでちょっと機械っぽい音色になります。</p>

<p>しかしあらゆる波は正弦波の組み合わせで表現できますし、ピアノの鍵盤を叩いたときの音の起伏もプログラムで表現できるので今までにでてきた道具でピアノの音色っぽいものも作れます。ちょっと挑戦してみましょう。</p>

<p>やってみたのがこれです。</p>

<div class="controls">
    <div class="left">
        <div id="playButton2" class="button">
            ▶️ play
        </div>
    </div>
    <div class="right">
        <span>Volume: </span>
        <input type="range" min="0.0" max="1.0" step="0.01"
               value="0.8" name="volume" id="volumeControl2">
    </div>
</div>

<script><!--
 function setup2() {

     const music = Music.parse("\
     C  C  G  G  | A  A  G2 |\
     F4 F  E  E  | D  D  C2 |\
     G4 G  F  F  | E  E  D2 |\
     G4 G  F  F  | E  E  D2 |\
     C4 C  G  G  | A  A  G2 |\
     F4 F  E  E  | D  D  C2 |");
     const player = new Player(90, new PianoTone());
     function togglePlay(event) {
         if (player.isPlaying) {
             playButton.innerHTML = "▶️ play";
             player.cancel();
         } else {
             playButton.innerHTML = "◼ cancel";
             player.playMusic(music);
         }
     }

     function changeVolume(event) {
         player.gain = volumeControl.value;
     }

     const playButton = document.querySelector("#playButton2");
     const volumeControl = document.querySelector("#volumeControl2");
     volumeControl.value = player.gain;

     playButton.addEventListener("click", togglePlay, false);
     volumeControl.addEventListener("input", changeVolume, false);

 }

 setup2();

-->
</script>

<p>どうですか？少なくとも先程の正弦波よりは楽器っぽくきこえないですか？</p>

<p>実装は以下のようなコードです。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kr">class</span> <span class="nx">PianoTone</span> <span class="kr">extends</span> <span class="nx">Tone</span> <span class="p">{</span>
    <span class="nx">createOsc</span><span class="p">(</span><span class="nx">detune</span><span class="p">,</span> <span class="nx">gain</span><span class="p">,</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">duration</span><span class="p">,</span> <span class="nx">output</span><span class="p">)</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">attack</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">;</span>
        <span class="kr">const</span> <span class="nx">decay</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">;</span>
        <span class="kr">const</span> <span class="nx">sustain</span> <span class="o">=</span> <span class="nx">gain</span> <span class="o">*</span> <span class="mf">0.7</span><span class="p">;</span>
        <span class="kr">const</span> <span class="nx">release</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">;</span>

        <span class="kr">const</span> <span class="nx">osc</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">createOscillator</span><span class="p">();</span>
        <span class="nx">osc</span><span class="p">.</span><span class="nx">frequency</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">concertPitch</span><span class="p">;</span>
        <span class="nx">osc</span><span class="p">.</span><span class="nx">detune</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">detune</span><span class="p">;</span>
        <span class="nx">osc</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s1">&#39;sine&#39;</span><span class="p">;</span>

        <span class="kr">const</span> <span class="nx">gainNode</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">createGain</span><span class="p">();</span>
        <span class="kr">const</span> <span class="nx">t0</span> <span class="o">=</span> <span class="nx">start</span><span class="p">;</span>
        <span class="kr">const</span> <span class="nx">t1</span> <span class="o">=</span> <span class="nx">t0</span> <span class="o">+</span> <span class="nx">attack</span><span class="p">;</span>
        <span class="kr">const</span> <span class="nx">t2</span> <span class="o">=</span> <span class="nx">t1</span> <span class="o">+</span> <span class="nx">decay</span><span class="p">;</span>
        <span class="kr">const</span> <span class="nx">t3</span> <span class="o">=</span> <span class="nx">t0</span> <span class="o">+</span> <span class="nx">duration</span><span class="p">;</span>
        <span class="kr">const</span> <span class="nx">t4</span> <span class="o">=</span> <span class="nx">t3</span> <span class="o">+</span> <span class="nx">release</span><span class="p">;</span>
        <span class="nx">gainNode</span><span class="p">.</span><span class="nx">gain</span><span class="p">.</span><span class="nx">linearRampToValueAtTime</span><span class="p">(</span><span class="nx">gain</span><span class="p">,</span> <span class="nx">t1</span><span class="p">);</span>
        <span class="nx">gainNode</span><span class="p">.</span><span class="nx">gain</span><span class="p">.</span><span class="nx">setTargetAtTime</span><span class="p">(</span><span class="nx">sustain</span><span class="p">,</span> <span class="nx">t1</span><span class="p">,</span> <span class="nx">decay</span><span class="p">)</span>
        <span class="nx">gainNode</span><span class="p">.</span><span class="nx">gain</span><span class="p">.</span><span class="nx">setTargetAtTime</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">t3</span><span class="p">,</span> <span class="nx">release</span><span class="p">);</span>

        <span class="nx">osc</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">gainNode</span><span class="p">);</span>
        <span class="nx">gainNode</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">output</span><span class="p">);</span>
        <span class="nx">osc</span><span class="p">.</span><span class="nx">onended</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">osc</span><span class="p">.</span><span class="nx">disconnect</span><span class="p">(</span><span class="nx">gainNode</span><span class="p">);</span>
            <span class="nx">gainNode</span><span class="p">.</span><span class="nx">disconnect</span><span class="p">(</span><span class="nx">output</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nx">osc</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="nx">t0</span><span class="p">);</span>
        <span class="nx">osc</span><span class="p">.</span><span class="nx">stop</span><span class="p">(</span><span class="nx">t4</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">osc</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">play</span><span class="p">(</span><span class="nx">detune</span><span class="p">,</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">duration</span><span class="p">,</span> <span class="nx">output</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nx">o1</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">createOsc</span><span class="p">(</span><span class="nx">detune</span> <span class="o">-</span> <span class="mi">3600</span><span class="p">,</span> <span class="mf">0.512</span><span class="p">,</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">duration</span> <span class="o">*</span> <span class="mf">0.064</span><span class="p">,</span> <span class="nx">output</span><span class="p">);</span>
        <span class="kd">let</span> <span class="nx">o2</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">createOsc</span><span class="p">(</span><span class="nx">detune</span> <span class="o">-</span> <span class="mi">2400</span><span class="p">,</span> <span class="mf">0.64</span> <span class="p">,</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">duration</span> <span class="o">*</span> <span class="mf">0.16</span> <span class="p">,</span> <span class="nx">output</span><span class="p">);</span>
        <span class="kd">let</span> <span class="nx">o3</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">createOsc</span><span class="p">(</span><span class="nx">detune</span> <span class="o">-</span> <span class="mi">1200</span><span class="p">,</span> <span class="mf">0.8</span>  <span class="p">,</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">duration</span> <span class="o">*</span> <span class="mf">0.4</span>  <span class="p">,</span> <span class="nx">output</span><span class="p">);</span>
        <span class="kd">let</span> <span class="nx">o4</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">createOsc</span><span class="p">(</span><span class="nx">detune</span>       <span class="p">,</span>   <span class="mi">1</span>  <span class="p">,</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">duration</span>        <span class="p">,</span> <span class="nx">output</span><span class="p">);</span>
        <span class="kd">let</span> <span class="nx">o5</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">createOsc</span><span class="p">(</span><span class="nx">detune</span> <span class="o">+</span> <span class="mi">1200</span><span class="p">,</span> <span class="mf">0.4</span>  <span class="p">,</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">duration</span> <span class="o">*</span> <span class="mf">0.8</span>  <span class="p">,</span> <span class="nx">output</span><span class="p">);</span>
        <span class="kd">let</span> <span class="nx">o6</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">createOsc</span><span class="p">(</span><span class="nx">detune</span> <span class="o">+</span> <span class="mi">2400</span><span class="p">,</span> <span class="mf">0.16</span> <span class="p">,</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">duration</span> <span class="o">*</span> <span class="mf">0.64</span> <span class="p">,</span> <span class="nx">output</span><span class="p">);</span>
        <span class="kd">let</span> <span class="nx">o7</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">createOsc</span><span class="p">(</span><span class="nx">detune</span> <span class="o">+</span> <span class="mi">3600</span><span class="p">,</span> <span class="mf">0.064</span><span class="p">,</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">duration</span> <span class="o">*</span> <span class="mf">0.512</span><span class="p">,</span> <span class="nx">output</span><span class="p">);</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="nx">oscs</span><span class="o">:</span> <span class="p">[</span><span class="nx">o1</span><span class="p">,</span> <span class="nx">o2</span><span class="p">,</span> <span class="nx">o3</span><span class="p">,</span> <span class="nx">o4</span><span class="p">,</span> <span class="nx">o5</span><span class="p">,</span> <span class="nx">o6</span><span class="p">,</span> <span class="nx">o7</span><span class="p">],</span>
            <span class="nx">stop</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">when</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">for</span><span class="p">(</span><span class="kd">let</span> <span class="nx">osc</span> <span class="k">of</span> <span class="k">this</span><span class="p">.</span><span class="nx">oscs</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">osc</span><span class="p">.</span><span class="nx">stop</span><span class="p">(</span><span class="nx">when</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">};</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div>
<p>ポイントは2つ。1つは<a href="https://ja.wikipedia.org/wiki/ADSR">ADSR</a>で、もう1つは複数の波の組み合わせです。
どっちも私は詳しい訳じゃないんですがちょっと解説してみます。</p>

<h3 id="adsr">ADSR</h3>

<p>ADSRはAttack、Decay、Sustain、Releaseの略でそれぞれ立ち上がり、減衰、減衰後の保持、余韻と訳されるようです。</p>

<p>ピアノ的に解釈すると鍵盤に触れてからを叩き終わるまでがAttack、叩いた瞬間から音が落ち着くまでがDecay、鍵盤を押しっぱなしの時間がSustain、鍵盤を離したあとにも鳴ってる時間がReleaseですかね？</p>

<p>音を作る人はこういうパラメータで音（エンベロープ）を作るらしいです。</p>

<p>上記のコードでは以下の部分ですね。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kr">const</span> <span class="nx">attack</span> <span class="o">=</span> <span class="mf">0.35</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">decay</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">sustain</span> <span class="o">=</span> <span class="nx">gain</span> <span class="o">*</span> <span class="mf">0.7</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">release</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">;</span>

<span class="c1">// ...
</span><span class="c1"></span>
<span class="kr">const</span> <span class="nx">gainNode</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">createGain</span><span class="p">();</span>
<span class="kr">const</span> <span class="nx">t0</span> <span class="o">=</span> <span class="nx">start</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">t1</span> <span class="o">=</span> <span class="nx">t0</span> <span class="o">+</span> <span class="nx">attack</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">t2</span> <span class="o">=</span> <span class="nx">t1</span> <span class="o">+</span> <span class="nx">decay</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">t3</span> <span class="o">=</span> <span class="nx">t0</span> <span class="o">+</span> <span class="nx">duration</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">t4</span> <span class="o">=</span> <span class="nx">t3</span> <span class="o">+</span> <span class="nx">release</span><span class="p">;</span>
<span class="nx">gainNode</span><span class="p">.</span><span class="nx">gain</span><span class="p">.</span><span class="nx">linearRampToValueAtTime</span><span class="p">(</span><span class="nx">gain</span><span class="p">,</span> <span class="nx">t1</span><span class="p">);</span>
<span class="nx">gainNode</span><span class="p">.</span><span class="nx">gain</span><span class="p">.</span><span class="nx">setTargetAtTime</span><span class="p">(</span><span class="nx">sustain</span><span class="p">,</span> <span class="nx">t1</span><span class="p">,</span> <span class="nx">decay</span><span class="p">)</span>
<span class="nx">gainNode</span><span class="p">.</span><span class="nx">gain</span><span class="p">.</span><span class="nx">setTargetAtTime</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">t3</span><span class="p">,</span> <span class="nx">release</span><span class="p">);</span></code></pre></div>
<p><code>duration</code> が全体の演奏時間（鍵盤に触れてから離すまで）で、そのうち物理特性で <code>attack</code> と <code>decay</code> に使われる時間が決まります。
本当は鍵盤の叩き方で <code>attack</code> の方は変わると思いますがこの人は同じ強さで叩く人と思いましょう。</p>

<h3 id="波の組み合わせ">波の組み合わせ</h3>

<p>コードでいうとこの部分です。 <code>detune</code> が1200で1オクターブなので、対象の音の3オクターブ下から3オクターブ上までの音を合成しています。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kd">let</span> <span class="nx">o1</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">createOsc</span><span class="p">(</span><span class="nx">detune</span> <span class="o">-</span> <span class="mi">3600</span><span class="p">,</span> <span class="mf">0.512</span><span class="p">,</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">duration</span> <span class="o">*</span> <span class="mf">0.064</span><span class="p">,</span> <span class="nx">output</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">o2</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">createOsc</span><span class="p">(</span><span class="nx">detune</span> <span class="o">-</span> <span class="mi">2400</span><span class="p">,</span> <span class="mf">0.64</span> <span class="p">,</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">duration</span> <span class="o">*</span> <span class="mf">0.16</span> <span class="p">,</span> <span class="nx">output</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">o3</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">createOsc</span><span class="p">(</span><span class="nx">detune</span> <span class="o">-</span> <span class="mi">1200</span><span class="p">,</span> <span class="mf">0.8</span>  <span class="p">,</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">duration</span> <span class="o">*</span> <span class="mf">0.4</span>  <span class="p">,</span> <span class="nx">output</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">o4</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">createOsc</span><span class="p">(</span><span class="nx">detune</span>       <span class="p">,</span>   <span class="mi">1</span>  <span class="p">,</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">duration</span>        <span class="p">,</span> <span class="nx">output</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">o5</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">createOsc</span><span class="p">(</span><span class="nx">detune</span> <span class="o">+</span> <span class="mi">1200</span><span class="p">,</span> <span class="mf">0.4</span>  <span class="p">,</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">duration</span> <span class="o">*</span> <span class="mf">0.8</span>  <span class="p">,</span> <span class="nx">output</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">o6</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">createOsc</span><span class="p">(</span><span class="nx">detune</span> <span class="o">+</span> <span class="mi">2400</span><span class="p">,</span> <span class="mf">0.16</span> <span class="p">,</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">duration</span> <span class="o">*</span> <span class="mf">0.64</span> <span class="p">,</span> <span class="nx">output</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">o7</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">createOsc</span><span class="p">(</span><span class="nx">detune</span> <span class="o">+</span> <span class="mi">3600</span><span class="p">,</span> <span class="mf">0.064</span><span class="p">,</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">duration</span> <span class="o">*</span> <span class="mf">0.512</span><span class="p">,</span> <span class="nx">output</span><span class="p">);</span></code></pre></div>
<p>これは数学的に解釈すればフーリエ変換的に複数の周波数の正弦波を組み合わせてピアノの音色を再現しようとしています。
物理的に解釈すれば固有振動数が倍数関係にあるピアノ線が共鳴するはずなので、それを表現しています。
本当はピアノ線の長さ（音の高さ）で物理特性が変わるはずなのでADSRも変わるはずですが面倒なので無視しましょう。</p>

<h1 id="まとめ">まとめ</h1>

<p>Web Audio APIを使って音を鳴らしてみました。
Web Audio APIは周波数を指定して定音を鳴らす機能しかないので、自分で演奏機能や音色などを再現してみる試みをしました。その過程でADSRや波の合成などを知りました。</p>

<h1 id="参考文献">参考文献</h1>

<ul>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Audio_API/Simple_synth">Example and tutorial: Simple synth keyboard - Web APIs | MDN</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Audio_API/Controlling_multiple_parameters_with_ConstantSourceNode">Controlling multiple parameters with ConstantSourceNode - Web APIs | MDN</a></li>
<li><a href="https://weblike-curtaincall.ssl-lolipop.jp/portfolio-web-sounder/webaudioapi-basic/envelope-generator">エンベロープジェネレータ | Web Audio APIの基本処理 | WEB SOUNDER - Web Audio API 解説 -</a></li>
<li><a href="https://q-az.net/web-audio-api-piano-sound/">Web Audio API でピアノの音色に近づけたい | q-Az</a></li>
</ul>

<h1 id="付録-コード">付録: コード</h1>

<p>今回実装したPlayerのコードはこちらに置いておきます。
楽譜部分を書き換えたら他の楽曲も演奏できるので気に入った方は試してみて下さい。</p>

<script src="https://gist.github.com/KeenS/d5935e69e7b96275de469aa3283e1cb2.js"></script>

<p>ライセンスはMIT/Apache-2.0のデュアルライセンスとします。</p>
                    </section>
                </article>
            </div>
        </div>

        <div class="row li-author">
    <div class="sixteen columns">
        Written by <strong>κeen</strong>
    </div>
</div>


        <div class="row li-pagination">
            <div class="eight columns">
                <div class="li-pagination-previous">
                    
                        Later article<br />
                        <a href="https://KeenS.github.io/slide/rust_with_fearless_concurrency/"> Rust with Fearless Concurrency</a>
                    
                </div>
            </div>
            <div class="eight columns">
                <div class="li-pagination-next">
                    
                        Older article<br />
                        <a href="https://KeenS.github.io/blog/2020/11/09/inkscapewotsukattesvgkaraogpime_jiwohanjidouseiseisuru/"> Inkscapeを使ってSVGからOGPイメージを半自動生成する</a>
                    
                </div>
            </div>
        </div>
    </div>

<footer class="li-page-footer">
    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <div class="li-page-footer-legal">
                    &copy; 2022. All rights reserved. 
                </div>
                <div class="li-page-footer-theme">
                    <span class=""><a href="https://github.com/eliasson/liquorice/">liquorice</a> is a theme for <a href="http://hugo.spf13.com">hugo</a></span>
                </div>
            </div>
        </div>
    </div>
</footer>

<script type="text/javascript">
 function toggle(id) {
     var e = document.getElementById(id);
     e.style.display == 'block' ? e.style.display = 'none' : e.style.display = 'block';
 }
</script>
<script src="https://unpkg.com/mermaid@7.0.4/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true
     });</script>

    </body>
</html>

