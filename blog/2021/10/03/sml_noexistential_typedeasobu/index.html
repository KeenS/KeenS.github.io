<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
    <head>
        
        
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-43779888-1"></script>
        <script>
         window.dataLayer = window.dataLayer || [];
         function gtag(){dataLayer.push(arguments);}
         gtag('js', new Date());

         gtag('config', 'UA-43779888-1');
        </script>
        

        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

        <meta name="twitter:site" content="@blackenedgold" />
        <meta name="twitter:title" content="SML#のexistential typeで遊ぶ | κeenのHappy Hacκing Blog"/>
        <meta name="twitter:description" content="κeenです。SML# 3.7.0から実験的機能として _dynamiccase に存在型のサポートが入ったので試してみます。 本記事はSML# 4.0.0 with LLVM 12.0.0で動作確" />
        <meta property="og:title" content="SML#のexistential typeで遊ぶ | κeenのHappy Hacκing Blog" />
        <meta property="og:type" content="article" />
        <meta property="og:url" content="https://KeenS.github.io/blog/2021/10/03/sml_noexistential_typedeasobu/" />
        <meta property="og:description" content="κeenです。SML# 3.7.0から実験的機能として _dynamiccase に存在型のサポートが入ったので試してみます。 本記事はSML# 4.0.0 with LLVM 12.0.0で動作確" />
        <meta name="twitter:card" content="summary_large_image" />
        <meta property="og:image" content="https://KeenS.github.io/images/ogp/post/SML_noexistential_typedeasobu.png" />
        <meta name="twitter:image" content="https://KeenS.github.io/images/ogp/post/SML_noexistential_typedeasobu.png" />
        
        <meta property="og:article:published_time" content="2021-10-03 17:17:23 &#43;0900 JST" />
        <meta property="og:article:modified_time" content="2021-10-03 17:17:23 &#43;0900 JST" />
        
        <meta property="og:article:author" content="κeen" />

        <title>SML#のexistential typeで遊ぶ | κeenのHappy Hacκing Blog</title>
        <link rel="stylesheet" href='//fonts.googleapis.com/css?family=Open+Sans:400,300,600' type='text/css' />
        <link rel="stylesheet" href="https://KeenS.github.io/libraries/normalize.3.0.1.css" />
        <link rel="stylesheet" href="https://KeenS.github.io/css/liquorice.css" />
        <link rel="apple-touch-icon" sizes="180x180" href="https://KeenS.github.io/apple-touch-icon.png">
        <link rel="icon" type="image/png" href="https://KeenS.github.io/favicon-32x32.png" sizes="32x32">
        <link rel="icon" type="image/png" href="https://KeenS.github.io/favicon-16x16.png" sizes="16x16">
        <link rel="manifest" href="https://KeenS.github.io/manifest.json">
        <link rel="mask-icon" href="https://KeenS.github.io/safari-pinned-tab.svg" color="#5bbad5">
        <meta name="theme-color" content="#ffffff">
        <link rel="apple-touch-icon-precomposed" href="https://KeenS.github.io/apple-touch-icon-144-precomposed.png" sizes="144x144" />
        <link rel="stylesheet" href="https://KeenS.github.io/css/syntax-monokai.css" />
<script type="text/x-mathjax-config">
 MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ["\\(","\\)"]] } });
</script>
<script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_CHTML"></script>
</script>
<meta http-equiv="X-UA-Compatible" CONTENT="IE=EmulateIE7" />
<link rel="stylesheet" href="//unpkg.com/mermaid@7.0.4/dist/mermaid.forest.min.css">

    </head>
    <body class="li-body">

<header class="li-page-header" id="page-header">
    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <div class="li-brand li-left">
                <a href="https://KeenS.github.io/">κeenのHappy Hacκing Blog</a> | Lispエイリアンの狂想曲</div>
                <div class="li-menu li-right">
                    <span class="li-menu-icon" onclick="javascript:toggle('menu');">&#9776;</span>
                    <ul id="menu2" class="li-menu-items">
                        
                            <li><a href="https://KeenS.github.io/about/"> About </a></li>
                        
                            <li><a href="https://KeenS.github.io/post/"> Blog </a></li>
                        
                            <li><a href="https://KeenS.github.io/slide/"> Slide </a></li>
                        
                            <li><a href="https://KeenS.github.io/index.xml"> Atom </a></li>
                        
                            <li><a href="https://KeenS.github.io/search/"> Search </a></li>
                        
                    </ul>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="sixteen columns">
                <ul id="menu" class="li-menu-items li-menu-mobile">
                    
                        <li><a href="https://KeenS.github.io/about/"> About </a></li>
                    
                        <li><a href="https://KeenS.github.io/post/"> Blog </a></li>
                    
                        <li><a href="https://KeenS.github.io/slide/"> Slide </a></li>
                    
                        <li><a href="https://KeenS.github.io/index.xml"> Atom </a></li>
                    
                        <li><a href="https://KeenS.github.io/search/"> Search </a></li>
                    
                </ul>
            </div>
        </div>
    </div>
</header>






    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <article class="li-article">
                    <header class="li-article-header">
                        <h1 class="li-article-title">SML#のexistential typeで遊ぶ</h1>
                        <div class="li-article-meta">
    <time class="li-article-date">2021-10-03</time>
    <ul class="li-article-tag">
    
        <li>
            <a href="https://KeenS.github.io/categories/sml">SML#</a>
        </li>
    
        <li>
            <a href="https://KeenS.github.io/categories/sml">SML</a>
        </li>
    
</ul>

</div>

                    </header>
                    <section>
                        

<p>κeenです。SML# 3.7.0から実験的機能として <code>_dynamiccase</code> に存在型のサポートが入ったので試してみます。</p>

<!-- more -->

<p>本記事はSML# 4.0.0 with LLVM 12.0.0で動作確認を行っています。</p>

<h2 id="dynamicについて">Dynamicについて</h2>

<p><code>_dynamiccase</code> 以前にDynamicの説明から入りましょう。
DynamicはSML# 3.5.0から入った機能です。
型を消して代わりにデータに埋め込んでおき、使うときにその型を復元して使えるものです。</p>

<p>型を消す（型をデータに埋め込む）のは <code>Dynamic.dynamic</code> などのプリミティブを、型を復元するのは <code>_dynamic</code> などの制御構造を使います。</p>
<div class="highlight"><pre class="chroma"><code class="language-sml" data-lang="sml"><span class="kr">val</span> <span class="nv">x</span> <span class="p">=</span> <span class="nn">Dynamic.</span><span class="n">dynamic</span> <span class="p">{</span><span class="n">a</span> <span class="n">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">b</span> <span class="n">=</span> <span class="s2">&#34;c&#34;</span><span class="p">}</span>
<span class="cm">(* val x = _ : Dynamic.void Dynamic.dyn *)</span>

<span class="kr">val</span> <span class="nv">y</span> <span class="p">=</span> <span class="p">_</span><span class="n">dynamic</span> <span class="n">x</span> <span class="kr">as</span> <span class="p">{</span><span class="n">a</span><span class="kr">:</span><span class="n">int</span><span class="p">,</span> <span class="n">b</span><span class="kr">:</span><span class="n">string</span><span class="p">}</span>
<span class="cm">(* val y = {a = 1, b = &#34;c&#34;} : {a : int, b : string} *)</span></code></pre></div>
<p>Dynamicは色々面白い使い方ができます。一旦型情報をデータにしてしまえばリフレクションが可能なのでどんな型にも使えるpretty printも実装可能になります。</p>
<div class="highlight"><pre class="chroma"><code class="language-sml" data-lang="sml"><span class="nn">Dynamic.</span><span class="n">pp</span> <span class="p">{</span><span class="n">a</span> <span class="n">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">b</span> <span class="n">=</span> <span class="s2">&#34;c&#34;</span><span class="p">}</span>
<span class="cm">(* =&gt; {a = 1, b = &#34;c&#34;} *)</span></code></pre></div>
<p>他にも面白い話題はありますが、今回のトピックは <code>_dynamiccase</code> なのでそれに触れます。
<code>_dynamiccase</code> は <code>_dynamic</code> のパターンマッチ版で、マッチした型を復元します。</p>
<div class="highlight"><pre class="chroma"><code class="language-sml" data-lang="sml"><span class="kr">val</span> <span class="nv">x</span> <span class="p">=</span> <span class="nn">Dynamic.</span><span class="n">dynamic</span> <span class="p">{</span><span class="n">a</span> <span class="n">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">b</span> <span class="n">=</span> <span class="s2">&#34;c&#34;</span><span class="p">}</span>
<span class="p">_</span><span class="n">dynamiccase</span> <span class="n">x</span> <span class="kr">of</span>
    <span class="p">{</span><span class="n">a:</span> <span class="n">int</span><span class="p">,</span> <span class="n">b:</span> <span class="n">int</span><span class="p">}</span>    <span class="n">=&gt;</span> <span class="s2">&#34;first&#34;</span> <span class="cm">(* 変数aとbが使える *)</span>
  <span class="n">|</span> <span class="p">{</span><span class="n">a:</span> <span class="n">int</span><span class="p">,</span> <span class="n">b:</span> <span class="n">string</span><span class="p">}</span> <span class="n">=&gt;</span> <span class="s2">&#34;second&#34;</span>
<span class="cm">(* &#34;second&#34; *)</span></code></pre></div>
<p>ここまで、Dynamicと <code>_dynamiccase</code> の紹介でした。</p>

<h2 id="dynamiccase-のexistential-typeサポート"><code>_dynamiccase</code> のexistential typeサポート</h2>

<p>SML# 3.7.0から入った実験的なexistential typeサポートでは <code>_dynamiccase</code> で存在型が使えます。
節の冒頭で <code>{'a}</code> の形で型変数を導入し、パターン内でその <code>'a</code> が使えます。
パターンの腕では <code>{'a}</code> の中身は分からりません。
<code>'a</code> 型がついた値はパターンの腕からは脱出できないので関数を値に適用するなどして型を潰す必要があります。</p>
<div class="highlight"><pre class="chroma"><code class="language-sml" data-lang="sml"><span class="kr">fun</span> <span class="nf">apply</span> <span class="n">x</span> <span class="n">=</span> <span class="p">_</span><span class="n">dynamiccase</span> <span class="n">x</span> <span class="kr">of</span> <span class="p">{</span><span class="nd">&#39;a</span><span class="p">}</span> <span class="p">(</span><span class="n">f:</span><span class="nd">&#39;a</span> <span class="n">-&gt;</span> <span class="n">int</span><span class="p">,</span> <span class="n">x:</span><span class="nd">&#39;a</span><span class="p">)</span> <span class="n">=&gt;</span> <span class="n">f</span> <span class="n">x</span><span class="p">;</span>

<span class="n">apply</span> <span class="p">(</span><span class="nn">Dynamic.</span><span class="n">dynamic</span> <span class="p">(</span><span class="n">foldl</span> <span class="p">(</span><span class="kr">op</span> <span class="n">+</span><span class="p">)</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]));</span>
<span class="n">apply</span> <span class="p">(</span><span class="nn">Dynamic.</span><span class="n">dynamic</span> <span class="p">(</span><span class="n">trunc</span><span class="p">,</span> <span class="mf">2.34</span><span class="p">));</span></code></pre></div>
<p>上記の例では <code>'a</code> にそれぞれ <code>int</code> 、 <code>real</code> が代入されますが、最終的には <code>int</code> を返しています。
ちょっと使い道が分かりづらいかもしれませんが、いくつか面白いことができます。</p>

<h2 id="ダックタイピング">ダックタイピング</h2>

<p>存在型を使うとダックタイピングができます。
ダックタイピングは「アヒルのように鳴きアヒルのように歩くならそれはアヒルだ」という例えに表されるようにデータの型ではなくメッセージを受け取れるかに着目します。
これからデータの型は異なるが同じ振る舞いをするオブジェクトを作っていきます。</p>

<p>まずは準備からはじめましょう。必須ではないですが、分かりやすいようDynamicをラップした型を定義しておきます。</p>
<div class="highlight"><pre class="chroma"><code class="language-sml" data-lang="sml"><span class="kr">datatype</span> <span class="kt">obj</span> <span class="p">=</span> <span class="nc">Obj</span> <span class="kr">of</span> <span class="nn">Dynamic.</span><span class="n">dynamic</span></code></pre></div>
<p><code>toString</code> を呼べるオブジェクトを作りたいのでそのオブジェクトを表わす型を作っておきます。データとメソッドのレコードです。</p>
<div class="highlight"><pre class="chroma"><code class="language-sml" data-lang="sml"><span class="kr">type</span> <span class="nd">&#39;self</span> <span class="kt">objRec</span> <span class="p">=</span> <span class="p">{</span><span class="n">data:</span> <span class="nd">&#39;self</span><span class="p">,</span> <span class="n">toString:</span> <span class="nd">&#39;self</span> <span class="n">-&gt;</span> <span class="n">string</span><span class="p">}</span></code></pre></div>
<p>型パラメータに <code>'self</code> と名付けているように、<code>data</code> がいわゆるselfのつもりです。ユーザがこの型を用意したらオブジェクトが作れます。</p>

<p>雰囲気を出すために <code>new</code> 関数も用意しておきましょう。</p>
<div class="highlight"><pre class="chroma"><code class="language-sml" data-lang="sml"><span class="kr">fun</span> <span class="nd">&#39;self</span><span class="nf">#</span><span class="n">reify</span> <span class="n">new</span> <span class="p">(</span><span class="n">obj:</span> <span class="nd">&#39;self</span> <span class="n">objRec</span><span class="p">)</span> <span class="n">=</span> <span class="n">Obj</span> <span class="p">(</span><span class="nn">Dynamic.</span><span class="n">dynamic</span> <span class="n">obj</span><span class="p">)</span></code></pre></div>
<p><code>'self</code> に <code>#reify</code> という修飾がついているのはSML# 独自の拡張です。
型をデータとして書き込むために（=Dynamic.dynamicを呼ぶために）型情報を取り出せる必要があるのでついています。ここはあまり深くは踏み込まずに次に進みます。</p>

<p>この <code>new</code> で作ったデータ型に対して <code>toString</code> を呼べるようにしてみます。
<code>dynamic</code> を <code>_dynamiccase</code> にかけてデータを復元します。このとき多相になっていた <code>'self</code> を存在型で表現してあげるとうまくいきます。</p>
<div class="highlight"><pre class="chroma"><code class="language-sml" data-lang="sml"><span class="kr">fun</span> <span class="nf">toString</span> <span class="p">(</span><span class="n">Obj</span> <span class="n">obj</span><span class="p">)</span> <span class="n">=</span>
    <span class="p">_</span><span class="n">dynamiccase</span> <span class="n">obj</span> <span class="kr">of</span>
      <span class="p">{</span><span class="nd">&#39;self</span><span class="p">}</span> <span class="p">{</span><span class="n">data:</span> <span class="nd">&#39;self</span><span class="p">,</span> <span class="n">toString:</span> <span class="nd">&#39;self</span> <span class="n">-&gt;</span> <span class="n">string</span><span class="p">}</span> <span class="n">=&gt;</span> <span class="n">toString</span> <span class="n">data</span></code></pre></div>
<p>selfとselfを第一引数に取るメソッドがあればそれっぽくなる、というのはある程度ダックタイピングに慣れた人なら理解頂けると思います。</p>

<p>これで役者が揃ったのでREPLで使ってみましょう。まずは <code>new</code> を使ってオブジェクトをいくつか作ってみます。</p>
<div class="highlight"><pre class="chroma"><code class="language-sml" data-lang="sml"><span class="nl"># val</span> <span class="n">intObj</span>  <span class="n">=</span> <span class="n">new</span> <span class="p">{</span><span class="n">data</span> <span class="n">=</span> <span class="mi">1</span><span class="p">,</span>   <span class="n">toString</span> <span class="n">=</span> <span class="nn">Int.</span><span class="n">toString</span><span class="p">};</span>
<span class="kr">val</span> <span class="nv">intObj</span> <span class="p">=</span> <span class="n">Obj</span> <span class="p">_</span> <span class="n">:</span> <span class="n">obj</span>
<span class="nl"># val</span> <span class="n">realObj</span> <span class="n">=</span> <span class="n">new</span> <span class="p">{</span><span class="n">data</span> <span class="n">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">toString</span> <span class="n">=</span> <span class="nn">Real.</span><span class="n">toString</span><span class="p">};</span>
<span class="kr">val</span> <span class="nv">realObj</span> <span class="p">=</span> <span class="n">Obj</span> <span class="p">_</span> <span class="n">:</span> <span class="n">obj</span></code></pre></div>
<p><code>intObj</code> と <code>realObj</code> はそれぞれ型が異なりますが、どちらも <code>obj</code> になっています。これらの <code>obj</code> に <code>toString</code> を呼んでみましょう。</p>
<div class="highlight"><pre class="chroma"><code class="language-sml" data-lang="sml"><span class="nl"># toString</span> <span class="n">intObj</span><span class="p">;</span>
<span class="kr">val</span> <span class="nv">it</span> <span class="p">=</span> <span class="s2">&#34;1&#34;</span> <span class="n">:</span> <span class="n">string</span>
<span class="nl"># toString</span> <span class="n">realObj</span><span class="p">;</span>
<span class="kr">val</span> <span class="nv">it</span> <span class="p">=</span> <span class="s2">&#34;0.1&#34;</span> <span class="n">:</span> <span class="n">string</span></code></pre></div>
<p>元の型は異なるのに1つの関数で双方を扱えました。<code>intObj</code> と <code>realObj</code> は同じ <code>obj</code> 型なのでリストに共存させることも可能です。</p>
<div class="highlight"><pre class="chroma"><code class="language-sml" data-lang="sml"><span class="nl"># map</span> <span class="n">toString</span> <span class="p">[</span><span class="n">intObj</span><span class="p">,</span> <span class="n">realObj</span><span class="p">];</span>
<span class="kr">val</span> <span class="nv">it</span> <span class="p">=</span> <span class="p">[</span><span class="s2">&#34;1&#34;</span><span class="p">,</span> <span class="s2">&#34;0.1&#34;</span><span class="p">]</span> <span class="n">:</span> <span class="n">string</span> <span class="n">list</span></code></pre></div>
<p>こうしてSMLでダックタイピングができるようになりました。</p>

<h3 id="拡張可能なオブジェクト">拡張可能なオブジェクト</h3>

<p>上記のオブジェクトは面白いんですが、フィールドが増えたときに <code>_dynamiccase</code> に失敗するという問題があります。</p>

<p>例えばメソッド <code>toInt</code> を増やした場合にオブジェクトの実体はこうなります。</p>
<div class="highlight"><pre class="chroma"><code class="language-sml" data-lang="sml"><span class="kr">type</span> <span class="nd">&#39;self</span> <span class="kt">objRec</span> <span class="p">=</span> <span class="p">{</span><span class="n">data:</span> <span class="nd">&#39;self</span><span class="p">,</span> <span class="n">toString:</span> <span class="nd">&#39;self</span> <span class="n">-&gt;</span> <span class="n">string</span><span class="p">,</span> <span class="n">toInt:</span> <span class="nd">&#39;self</span> <span class="n">-&gt;</span> <span class="n">int</span><span class="p">}</span></code></pre></div>
<p>しかし <code>toString</code> がそのままだと <code>toInt</code> フィールドがないのでマッチせずに呼出に失敗してしまいます。
必要なフィールドは揃っているはずなのにもどかしいですよね。そこで、必要なオブジェクトだけを取り出すようにしてみます。</p>

<p><code>_dynamiccase</code> には余計なフィールドを無視する機能はなさそうでした。例えばレコードのパターンマッチに <code>...</code> を使うとICEになります。</p>
<div class="highlight"><pre class="chroma"><code class="language-sml" data-lang="sml"><span class="kr">fun</span> <span class="nf">toString</span> <span class="p">(</span><span class="n">Obj</span> <span class="n">obj</span><span class="p">)</span> <span class="n">=</span>
    <span class="p">_</span><span class="n">dynamiccase</span> <span class="n">obj</span> <span class="kr">of</span>
      <span class="p">{</span><span class="nd">&#39;self</span><span class="p">}</span> <span class="p">{</span><span class="n">data:</span> <span class="nd">&#39;self</span><span class="p">,</span> <span class="n">toString:</span> <span class="nd">&#39;self</span> <span class="n">-&gt;</span> <span class="n">string</span><span class="p">,</span> <span class="p">...}</span> <span class="n">=&gt;</span> <span class="n">toString</span> <span class="n">data</span>

<span class="cm">(* Bug.Bug: PolyTyElimination: compileTy: BOUNDVARty at src/compiler/compilePhases/polytyelimination/main/PolyTyElimination.sml:17.14(302) *)</span></code></pre></div>
<p>そこでDynamic側をいじって必要なデータだけを持つDynamicを作ることにします。
このあたりはSML#のリフレクションAPIに踏み込むので深くは触れませんが、以下のようなキャスト関数を定義すると上手くいきそうでした。</p>
<div class="highlight"><pre class="chroma"><code class="language-sml" data-lang="sml"><span class="kr">fun</span> <span class="nf">cast</span> <span class="n">dyn</span> <span class="n">labels</span> <span class="n">=</span> <span class="kr">let</span>
    <span class="kr">val</span> <span class="nv">terms</span> <span class="p">=</span> <span class="n">map</span> <span class="p">(</span><span class="kr">fn</span> <span class="n">label</span> <span class="n">=&gt;</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="nn">Dynamic.</span><span class="n">dynamicToTerm</span> <span class="p">(</span><span class="nn">Dynamic.</span><span class="n">##</span> <span class="n">label</span> <span class="n">dyn</span><span class="p">)))</span> <span class="n">labels</span>
<span class="kr">in</span>
    <span class="nn">Dynamic.</span><span class="n">termToDynamic</span> <span class="p">(</span><span class="nn">Dynamic.</span><span class="n">Record</span> <span class="n">terms</span><span class="p">)</span>
<span class="kr">end</span></code></pre></div>
<p>このキャストを使って <code>obj</code> と <code>toString</code> フィールドだけを抜き出すようにした <code>toString</code> を定義してみます。</p>
<div class="highlight"><pre class="chroma"><code class="language-sml" data-lang="sml"><span class="kr">fun</span> <span class="nf">toString</span> <span class="p">(</span><span class="n">Obj</span> <span class="n">obj</span><span class="p">)</span> <span class="n">=</span>
    <span class="p">_</span><span class="n">dynamiccase</span> <span class="p">(</span><span class="n">cast</span> <span class="n">obj</span> <span class="p">[</span><span class="s2">&#34;data&#34;</span><span class="p">,</span> <span class="s2">&#34;toString&#34;</span><span class="p">])</span> <span class="kr">of</span>
      <span class="p">{</span><span class="nd">&#39;self</span><span class="p">}</span> <span class="p">{</span><span class="n">data:</span> <span class="nd">&#39;self</span><span class="p">,</span> <span class="n">toString:</span> <span class="nd">&#39;self</span> <span class="n">-&gt;</span> <span class="n">string</span><span class="p">}</span> <span class="n">=&gt;</span> <span class="n">toString</span> <span class="n">data</span></code></pre></div>
<p><code>_dynamiccase</code> にかける前に <code>cast</code> を呼ぶことで必要なフィールドのみ取り出しています。
同様に <code>toInt</code> も定義可能なので定義しておきます。</p>
<div class="highlight"><pre class="chroma"><code class="language-sml" data-lang="sml"><span class="kr">fun</span> <span class="nf">toInt</span> <span class="p">(</span><span class="n">Obj</span> <span class="n">obj</span><span class="p">)</span> <span class="n">=</span>
    <span class="p">_</span><span class="n">dynamiccase</span> <span class="p">(</span><span class="n">cast</span> <span class="n">obj</span> <span class="p">[</span><span class="s2">&#34;data&#34;</span><span class="p">,</span> <span class="s2">&#34;toInt&#34;</span><span class="p">])</span> <span class="kr">of</span>
      <span class="p">{</span><span class="nd">&#39;self</span><span class="p">}</span> <span class="p">{</span><span class="n">data:</span> <span class="nd">&#39;self</span><span class="p">,</span> <span class="n">toInt:</span> <span class="nd">&#39;self</span> <span class="n">-&gt;</span> <span class="n">int</span><span class="p">}</span> <span class="n">=&gt;</span> <span class="n">toInt</span> <span class="n">data</span></code></pre></div>
<p>これでREPLで試しましょう。 <code>intObj</code> と <code>realObj</code> を再定義して <code>toInt</code> も持つようにします。</p>
<div class="highlight"><pre class="chroma"><code class="language-sml" data-lang="sml"><span class="nl"># type</span> <span class="nd">&#39;self</span> <span class="n">objRec</span> <span class="n">=</span> <span class="p">{</span><span class="n">data:</span> <span class="nd">&#39;self</span><span class="p">,</span> <span class="n">toString:</span> <span class="nd">&#39;self</span> <span class="n">-&gt;</span> <span class="n">string</span><span class="p">,</span> <span class="n">toInt:</span> <span class="nd">&#39;self</span> <span class="n">-&gt;</span> <span class="n">int</span><span class="p">};</span>
<span class="nl"># fun</span> <span class="nd">&#39;self</span><span class="nl">#reify</span> <span class="n">new</span> <span class="p">(</span><span class="n">obj:</span> <span class="nd">&#39;self</span> <span class="n">objRec</span><span class="p">)</span> <span class="n">=</span> <span class="n">Obj</span> <span class="p">(</span><span class="nn">Dynamic.</span><span class="n">dynamic</span> <span class="n">obj</span><span class="p">);</span>
<span class="nl"># val</span> <span class="n">intObj</span>  <span class="n">=</span> <span class="n">new</span> <span class="p">{</span><span class="n">data</span> <span class="n">=</span> <span class="mi">1</span><span class="p">,</span>   <span class="n">toString</span> <span class="n">=</span> <span class="nn">Int.</span><span class="n">toString</span><span class="p">,</span>  <span class="n">toInt</span> <span class="n">=</span> <span class="kr">fn</span> <span class="n">x</span> <span class="n">=&gt;</span> <span class="n">x</span><span class="p">};</span>
<span class="nl"># val</span> <span class="n">realObj</span> <span class="n">=</span> <span class="n">new</span> <span class="p">{</span><span class="n">data</span> <span class="n">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">toString</span> <span class="n">=</span> <span class="nn">Real.</span><span class="n">toString</span><span class="p">,</span> <span class="n">toInt</span> <span class="n">=</span> <span class="nn">Real.</span><span class="n">round</span><span class="p">};</span></code></pre></div>
<p>Dynamicを使って既存のオブジェクトを拡張することもできますが、ちょっとややこしいので素直に再度定義します。</p>

<p>これらの拡張したオブジェクトを <code>toString</code> や <code>toInt</code> に適用します。</p>
<div class="highlight"><pre class="chroma"><code class="language-sml" data-lang="sml"><span class="nl"># toString</span> <span class="n">intObj</span><span class="p">;</span>
<span class="kr">val</span> <span class="nv">it</span> <span class="p">=</span> <span class="s2">&#34;1&#34;</span> <span class="n">:</span> <span class="n">string</span>
<span class="nl"># toInt</span> <span class="n">realObj</span><span class="p">;</span>
<span class="kr">val</span> <span class="nv">it</span> <span class="p">=</span> <span class="mi">0</span> <span class="n">:</span> <span class="n">int</span></code></pre></div>
<p>呼べていますね。ということでSML#でダックタイピングでした。</p>

<p>このあと真面目にオブジェクト指向っぽくやるなら作り込み要素はいっぱいありますが、遊ぶだけならこれで十分でしょう。</p>

<h2 id="第一級モジュールっぽいやつ">第一級モジュールっぽいやつ</h2>

<p>思ったよりダックタイピングで疲れたのでこっちは雑にいきます。</p>

<p>第一級モジュールはモジュールを値として扱えるやつです（雑）。
OCamlとかにはありますが、SMLにはありません。</p>

<p>モジュールを値として扱うときはほとんどレコードのようなものにエンコードできます。
<code>val</code> がそのままレコードにエンコードされるのですが、 <code>type</code> は存在型へエンコードすることになります。
そこで <code>_dynamiccase</code> の存在型を使うとそれっぽくなるんじゃないかという趣旨です。
第一級モジュールの存在型周りはかなりややこしかった気がしますが疲れたのでそれっぽければ良いことにします。</p>

<p>まずはエンコードする前のモジュールのシグネチャと構造を提示します。</p>
<div class="highlight"><pre class="chroma"><code class="language-sml" data-lang="sml"><span class="kr">signature</span> <span class="nn">Color</span> <span class="n">=</span> <span class="kr">sig</span>
    <span class="kr">type</span> <span class="kt">t</span>
    <span class="kr">val</span> <span class="nv">toCode</span><span class="n">:</span> <span class="n">t</span> <span class="n">-&gt;</span> <span class="n">string</span>
<span class="kr">end</span>

<span class="kr">structure</span> <span class="nn">RGBColor</span><span class="n">:</span> <span class="n">Color</span> <span class="n">=</span> <span class="kr">struct</span>
<span class="kr">datatype</span> <span class="kt">t</span> <span class="p">=</span> <span class="nc">RGB</span> <span class="kr">of</span> <span class="n">word8</span> <span class="n">*</span> <span class="n">word8</span> <span class="n">*</span> <span class="n">word8</span>
<span class="kr">fun</span> <span class="nf">toCode</span> <span class="p">(</span><span class="n">RGB</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span> <span class="n">=</span>
    <span class="kr">let</span> <span class="kr">fun</span> <span class="nf">to</span> <span class="n">c</span> <span class="n">=</span> <span class="kr">if</span> <span class="n">c</span> <span class="n">&lt;=</span> <span class="mh">0wxff</span>
                   <span class="kr">then</span> <span class="s2">&#34;0&#34;</span> <span class="n">^</span> <span class="p">(</span><span class="nn">Word8.</span><span class="n">toString</span> <span class="n">c</span><span class="p">)</span>
                   <span class="kr">else</span> <span class="nn">Word8.</span><span class="n">toString</span> <span class="n">c</span>
    <span class="kr">in</span> <span class="s2">&#34;#&#34;</span> <span class="n">^</span> <span class="p">(</span><span class="n">to</span> <span class="n">r</span><span class="p">)</span> <span class="n">^</span> <span class="p">(</span><span class="n">to</span> <span class="n">g</span><span class="p">)</span> <span class="n">^</span> <span class="p">(</span><span class="n">to</span> <span class="n">b</span><span class="p">)</span> <span class="kr">end</span>
<span class="kr">end</span></code></pre></div>
<p>はい。これをレコード（など）にエンコードしていきましょう。
初っ端からインチキですが、モジュールのレコードと、<code>t</code> の値の両方をデータに持つことにします。</p>
<div class="highlight"><pre class="chroma"><code class="language-sml" data-lang="sml"><span class="kr">type</span> <span class="nd">&#39;a</span> <span class="kt">fstColor</span> <span class="p">=</span> <span class="p">{</span><span class="n">color:</span> <span class="nd">&#39;a</span><span class="p">,</span> <span class="n">toCode:</span> <span class="nd">&#39;a</span> <span class="n">-&gt;</span> <span class="n">string</span><span class="p">}</span></code></pre></div>
<p>例によって雰囲気出すためにpackを関数を作っておきます。</p>
<div class="highlight"><pre class="chroma"><code class="language-sml" data-lang="sml"><span class="kr">fun</span> <span class="nd">&#39;a</span><span class="nf">#</span><span class="n">reify</span> <span class="n">packColor</span> <span class="p">(</span><span class="n">m:</span> <span class="nd">&#39;a</span> <span class="n">fstColor</span><span class="p">)</span> <span class="n">=</span> <span class="nn">Dynamic.</span><span class="n">dynamic</span> <span class="n">m</span></code></pre></div>
<p>あとはなんか <code>_dynamiccase</code> でunpackするだけ！</p>
<div class="highlight"><pre class="chroma"><code class="language-sml" data-lang="sml"><span class="kr">fun</span> <span class="nf">toCode</span> <span class="n">d</span> <span class="n">=</span> <span class="p">_</span><span class="n">dynamiccase</span> <span class="n">d</span> <span class="kr">of</span> <span class="p">{</span><span class="nd">&#39;a</span><span class="p">}</span> <span class="p">{</span><span class="n">color:</span> <span class="nd">&#39;a</span><span class="p">,</span> <span class="n">toCode:</span> <span class="nd">&#39;a</span> <span class="n">-&gt;</span> <span class="n">string</span><span class="p">}</span> <span class="n">=&gt;</span> <span class="n">toCode</span> <span class="n">color</span></code></pre></div>
<p>… <code>M.t</code> とかの型を書けないのでダックタイピングと一緒ですね。ダメだったよ…</p>

<h2 id="まとめ">まとめ</h2>

<p>SML# 3.7.0で入った <code>_dynamiccase</code> の存在型のサポートを使ってダックタイピングをやってみました。
試してないですが、reificationで型情報を取り出せるのでクラスやプロトタイプの仕組みを知っている人なら自分でオブジェクト指向っぽい枠組みを作れるんじゃないかと思います。</p>

                    </section>
                </article>
            </div>
        </div>

        <div class="row li-author">
    <div class="sixteen columns">
        Written by <strong>κeen</strong>
    </div>
</div>


        <div class="row li-pagination">
            <div class="eight columns">
                <div class="li-pagination-previous">
                    
                        &nbsp;
                    
                </div>
            </div>
            <div class="eight columns">
                <div class="li-pagination-next">
                    
                        Older article<br />
                        <a href="https://KeenS.github.io/slide/idris_2nosuuryoutekikatagakaiketsushitamondai_dounyuushitamondai/"> Idris 2の数量的型が解決した問題、導入した問題</a>
                    
                </div>
            </div>
        </div>
    </div>

<footer class="li-page-footer">
    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <div class="li-page-footer-legal">
                    &copy; 2021. All rights reserved. 
                </div>
                <div class="li-page-footer-theme">
                    <span class=""><a href="https://github.com/eliasson/liquorice/">liquorice</a> is a theme for <a href="http://hugo.spf13.com">hugo</a></span>
                </div>
            </div>
        </div>
    </div>
</footer>

<script type="text/javascript">
 function toggle(id) {
     var e = document.getElementById(id);
     e.style.display == 'block' ? e.style.display = 'none' : e.style.display = 'block';
 }
</script>
<script src="https://unpkg.com/mermaid@7.0.4/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true
     });</script>

    </body>
</html>

