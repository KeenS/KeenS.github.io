<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
    <head>
        
        
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-43779888-1"></script>
        <script>
         window.dataLayer = window.dataLayer || [];
         function gtag(){dataLayer.push(arguments);}
         gtag('js', new Date());

         gtag('config', 'UA-43779888-1');
        </script>
        

        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

        <meta name="twitter:site" content="@blackenedgold" />
        <meta name="twitter:title" content="YubiKeyをLinuxの「鍵」にする | κeenのHappy Hacκing Blog"/>
        <meta name="twitter:description" content="κeenです。最近YubiKeyを買ったので色々試しています。今回はそのうちのLinuxログイン回です。" />
        <meta property="og:title" content="YubiKeyをLinuxの「鍵」にする | κeenのHappy Hacκing Blog" />
        <meta property="og:type" content="article" />
        <meta property="og:url" content="https://KeenS.github.io/blog/2021/03/28/yubikeywolinuxno_kagi_nisuru/" />
        <meta property="og:description" content="κeenです。最近YubiKeyを買ったので色々試しています。今回はそのうちのLinuxログイン回です。" />
        <meta name="twitter:card" content="summary_large_image" />
        <meta property="og:image" content="https://KeenS.github.io/images/ogp/post/YubiKeywoLinuxno_kagi_nisuru.png" />
        <meta name="twitter:image" content="https://KeenS.github.io/images/ogp/post/YubiKeywoLinuxno_kagi_nisuru.png" />
        
        <meta property="og:article:published_time" content="2021-03-28 07:52:48 &#43;0900 JST" />
        <meta property="og:article:modified_time" content="2021-03-28 07:52:48 &#43;0900 JST" />
        
        <meta property="og:article:author" content="κeen" />

        <title>YubiKeyをLinuxの「鍵」にする | κeenのHappy Hacκing Blog</title>
        <link rel="stylesheet" href='//fonts.googleapis.com/css?family=Open+Sans:400,300,600' type='text/css' />
        <link rel="stylesheet" href="https://KeenS.github.io/libraries/normalize.3.0.1.css" />
        <link rel="stylesheet" href="https://KeenS.github.io/css/liquorice.css" />
        <link rel="apple-touch-icon" sizes="180x180" href="https://KeenS.github.io/apple-touch-icon.png">
        <link rel="icon" type="image/png" href="https://KeenS.github.io/favicon-32x32.png" sizes="32x32">
        <link rel="icon" type="image/png" href="https://KeenS.github.io/favicon-16x16.png" sizes="16x16">
        <link rel="manifest" href="https://KeenS.github.io/manifest.json">
        <link rel="mask-icon" href="https://KeenS.github.io/safari-pinned-tab.svg" color="#5bbad5">
        <meta name="theme-color" content="#ffffff">
        <link rel="apple-touch-icon-precomposed" href="https://KeenS.github.io/apple-touch-icon-144-precomposed.png" sizes="144x144" />
        <link rel="stylesheet" href="https://KeenS.github.io/css/syntax-monokai.css" />
<script type="text/x-mathjax-config">
 MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ["\\(","\\)"]] } });
</script>
<script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_CHTML"></script>
</script>
<meta http-equiv="X-UA-Compatible" CONTENT="IE=EmulateIE7" />
<link rel="stylesheet" href="//unpkg.com/mermaid@7.0.4/dist/mermaid.forest.min.css">

    </head>
    <body class="li-body">

<header class="li-page-header" id="page-header">
    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <div class="li-brand li-left">
                <a href="https://KeenS.github.io/">κeenのHappy Hacκing Blog</a> | Lispエイリアンの狂想曲</div>
                <div class="li-menu li-right">
                    <span class="li-menu-icon" onclick="javascript:toggle('menu');">&#9776;</span>
                    <ul id="menu2" class="li-menu-items">
                        
                            <li><a href="https://KeenS.github.io/about/"> About </a></li>
                        
                            <li><a href="https://KeenS.github.io/post/"> Blog </a></li>
                        
                            <li><a href="https://KeenS.github.io/slide/"> Slide </a></li>
                        
                            <li><a href="https://KeenS.github.io/index.xml"> Atom </a></li>
                        
                            <li><a href="https://KeenS.github.io/search/"> Search </a></li>
                        
                    </ul>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="sixteen columns">
                <ul id="menu" class="li-menu-items li-menu-mobile">
                    
                        <li><a href="https://KeenS.github.io/about/"> About </a></li>
                    
                        <li><a href="https://KeenS.github.io/post/"> Blog </a></li>
                    
                        <li><a href="https://KeenS.github.io/slide/"> Slide </a></li>
                    
                        <li><a href="https://KeenS.github.io/index.xml"> Atom </a></li>
                    
                        <li><a href="https://KeenS.github.io/search/"> Search </a></li>
                    
                </ul>
            </div>
        </div>
    </div>
</header>






    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <article class="li-article">
                    <header class="li-article-header">
                        <h1 class="li-article-title">YubiKeyをLinuxの「鍵」にする</h1>
                        <div class="li-article-meta">
    <time class="li-article-date">2021-03-28</time>
    <ul class="li-article-tag">
    
        <li>
            <a href="https://KeenS.github.io/categories/yubikey">YubiKey</a>
        </li>
    
        <li>
            <a href="https://KeenS.github.io/categories/linux">Linux</a>
        </li>
    
        <li>
            <a href="https://KeenS.github.io/categories/pam">PAM</a>
        </li>
    
</ul>

</div>

                    </header>
                    <section>
                        <p>κeenです。最近YubiKeyを買ったので色々試しています。今回はそのうちのLinuxログイン回です。</p>

<h1 id="yubikeyについて">YubiKeyについて</h1>

<p><a href="https://securitykey.yubion.com">YubiKey</a>は米瑞企業のYubico社が販売している認証デバイスです。FIDOやらWebAuthnやらの文脈で耳にした方も多いんじゃないしょうか。YubiKeyは日本ではソフト技研社が販売代理店をしています。</p>

<p>YubiKeyはラインナップがいくつかありますが私が買ったのはYubiKey 5 NFCです。</p>

<p>YubiKeyでできることは色々あります。</p>

<ul>
<li>FIDO U2F</li>
<li>FIDO2 / WebAuthn</li>
<li>Challenge and Response</li>
<li>OATH-TOTP / OATH-HOTP</li>
<li>Yubico OTP</li>
<li>PIV</li>
<li>OpenPGP</li>
<li>静的パスワード</li>
</ul>

<p>参考：<a href="https://qiita.com/onokatio/items/15108b9c199ccf378f91">Yubikey 5をArchLinuxで使う - Qiita</a></p>

<p>このうち今回はFIDO U2F、Challenge and Responseの機能を使います。</p>

<h1 id="今回やること">今回やること</h1>

<p>以下のことをやろうと思ってます。</p>

<ul>
<li>YubiKeyでLinuxにログイン</li>
<li>sudoの認証もYubiKeyで</li>
<li>YubiKeyを引っこ抜くと画面ロック</li>
</ul>

<p>ロックとロック解除をYubiKeyで行えるのでまさしく「鍵」っぽいですね。これはお遊びというか、実用性はあと一歩といったところなので「へー、面白い」と思いながら眺めて下さい。</p>

<h1 id="pamを使ったyubikey認証">PAMを使ったYubiKey認証</h1>

<p><a href="http://www.linux-pam.org/index.html">Linux Pluggable Authentication Modules (PAM) </a>はその名の通りLinuxのログインやsudoなどの認証を担当するフレームワークです。PAMで認証方法を色々カスタマイズできるので、YubiKeyで認証できるようにしていこうという趣旨です。先立って参考リンクをいくつか挙げておきます。</p>

<ul>
<li><a href="https://wiki.archlinux.jp/index.php/PAM">PAM - ArchWiki</a></li>
<li><a href="https://qiita.com/satken2/items/9a0604e1d4a78217897c">PAM設定ファイルの意味と書き方メモ - Qiita</a></li>
<li><a href="https://support.yubico.com/hc/en-us/articles/360016649099-Ubuntu-Linux-Login-Guide-U2F">Ubuntu Linux Login Guide - U2F – Yubico</a></li>
<li><a href="https://support.yubico.com/hc/en-us/articles/360018695819-Ubuntu-Linux-20-Login-Guide-Challenge-Response">Ubuntu Linux 20+ Login Guide - Challenge Response – Yubico</a></li>
</ul>

<h2 id="challenge-response-fido-u2f">Challenge Response / FIDO U2F</h2>

<p>PAMでYubiKey認証ができるようにするには2つの手段があるようです。Challenge ResponseかFIDO U2Fかです。Challenge Responseの方を試してないので推測ですが、Challenge Responseはユーザの操作不要、FIDO U2FはYubiKeyに触れるプロセスが必要っぽいです。</p>

<p>それぞれでインストールするモジュールが異なります。私は今回FIDO U2Fを選択します。Challenge Responseを設定する場合は公式ドキュメントを読んで下さい。FIDO U2Fなら <code>libpam-u2f</code> をインストールします。</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">$ sudo apt install libpam-u2f</code></pre></div>
<p>あとなんか初期設定を吐く必要があるっぽいです。</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">$ mkdir -p ~/.config/Yubico
$ pamu2fcfg &gt; ~/.config/Yubico/u2f_keys</code></pre></div>
<h2 id="pamの設定">PAMの設定</h2>

<p>以後FIDO U2Fを設定するものとします。</p>

<p>今回私はパスワードなしでYubiKeyを挿してYに触れたらログインできるように設定します。U2Fはその名の通り2要素認証のためのものなので、変則的な使い方であることを了承下さい。</p>

<p>さて、まずは <code>/etc/pam.d/</code> に <code>u2f-sufficient</code> というファイルを作って以下の内容を書きます。</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">auth sufficient pam_u2f.so debug_file=/var/log/pam_u2f.log</code></pre></div>
<p><code>sufficient</code> を設定しているとその認証が成功したらそれだけでログイン成功します。2段階認証にしたければ <code>required</code> を設定します。</p>

<p>ログファイルを作っておきます。</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">$ sudo touch /var/log/pam_u2f.log</code></pre></div>
<p>それでは各種認証方法にYubiKeyを追加しましょう。</p>

<p>まずは安全な <code>sudo</code> から。ログインの設定を最初にやってしまうと失敗したときにログインできなくなりますからね。 <code>/etc/pam.d/sudo</code> を編集して <code>@include common-auth</code> の行の上に <code>@include u2f-sufficient</code> を追加します。</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">$ sudo vi /etc/pam.d/sudo
$ tail -n <span class="m">5</span> /etc/pam.d/sudo
session    required   pam_env.so <span class="nv">readenv</span><span class="o">=</span><span class="m">1</span> <span class="nv">envfile</span><span class="o">=</span>/etc/default/locale <span class="nv">user_readenv</span><span class="o">=</span><span class="m">0</span>
@include u2f-sufficient
@include common-auth
@include common-account
@include common-session-noninteractive</code></pre></div>
<p>今作業したターミナルは閉じないで下さい。大事な <code>sudo</code> セッションが残ってるので失敗したときのリカバリに使います。別ターミナルを開いてYubiKeyが挿さった状態で <code>sudo echo test</code> とかを打ちます。YubiKeyがピコピコ光って、触ると <code>sudo</code> が通って <code>test</code> がechoされるのを確認します。さらに別ターミナルを開いて、今度はYubiKeyを抜いて <code>sudo echo test</code> と打ち、パスワード入力が促されるのを確認します。</p>

<p>以上2つの確認が通れば <code>sudo</code> の設定は大丈夫そうです。ログインの設定に進みましょう。</p>

<p>ログインの設定は使っているディストリビューションやフレーバーによって異りそうですが、私は素のUbuntuを使っているのでGDMのパスワードのところを上書きすればよいようです。 <code>/etc/pam.d/gdm-password</code> を開いて <code>@include common-auth</code> の行の上に <code>@include u2f-sufficient</code> を追加します。</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">$ sudo vi /etc/pam.d/gdm-password
$ head -n6 /etc/pam.d/gdm-password
<span class="c1">#%PAM-1.0</span>
auth    requisite       pam_nologin.so
auth    required        pam_succeed_if.so user !<span class="o">=</span> root quiet_success
@include u2f-sufficient
@include common-auth
auth    optional        pam_gnome_keyring.so</code></pre></div>
<p>一旦ロックしてみてYubiKeyを挿した状態でパスワード入力画面に入ったらYubiKeyがピコピコ光って触るとロック解除できるようになっていればよし。次はYubiKeyを抜いてロックしてみて、パスワードでそのままログインできればよし。</p>

<p>以上2つの確認が通ればPAMの設定は終了です。</p>

<h1 id="udevを使った自動ロック">udevを使った自動ロック</h1>

<p>udevはLinuxのデバイス管理ツールで、デバイスを抜き差ししたときにフックしてコマンドを実行できます。普通はマウントとかに使っているようですが今回はそれを画面のロックに使います。こちらも先立って参考リンクを挙げておきます。</p>

<ul>
<li><a href="https://wiki.archlinux.jp/index.php/Udev">udev - ArchWiki</a></li>
<li><a href="https://adl1995.github.io/passwordless-logins-with-yubikey.html">Passwordless logins with Yubikey</a></li>
<li><a href="https://koka831.github.io/2019/08/08/autolock-with-yubikey/#monitoring-u2f-key-by-udev">Linux: Login/sudo with Yubikey</a></li>
</ul>

<p>作業は2ステップです。</p>

<ol>
<li>YubiKeyのデバイスID（とか）を調べる</li>
<li>調べたデバイスIDにフックしてロックコマンドを走らせる設定をする</li>
</ol>

<p>まずはデバイスIDを調べます。以下のコマンドでデバイスの動向をモニタします。</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">$ udevadm monitor --environment --udev</code></pre></div>
<p>その間にYubiKeyを抜くと色々情報が出てきます。その中からYubiKeyの情報をさがし、<code>ID_VENDOR_ID</code> と <code>ID_MODEL_ID</code> の値を調べます。YubiKeyの情報はだいたい一番上にあるようです。</p>

<p>それでは調べたIDにフックして画面のロックが走るようにします。因みに私のデバイスでは <code>ID_VENDOR_ID</code> が 1050、 <code>ID_MODEL_ID</code> が0407だったので以下ではそれを使います。画面のロックをする方法はいくつかあるようですが、GNOMEのセッション外にあるudevからキックしてもちゃんとロックしてくれるのは <code>loginctl lock-sessions</code> でした。それをふまえて <code>/etc/udev/rules.d/40-u2fkey.rules</code> に以下の設定を書きます。</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">ACTION==&#34;remove&#34;, ENV{ID_VENDOR_ID}==&#34;1050&#34;, ENV{ID_MODEL_ID}==&#34;0407&#34;, RUN+=&#34;/usr/bin/loginctl lock-sessions&#34;</code></pre></div>
<p>これを書いたらudevに今書いたルールを反映させます。</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">sudo udevadm control --reload-rules</code></pre></div>
<p>これでYubiKeyを抜いて画面がロックされれば成功です。失敗したらそもそも <code>/usr/bin/loginctl lock-sessions</code> でログインできるかやデバイスのIDがあってるかを確認して下さい。ログは適当に <code>/var/log/syslog</code> を <code>grep udev</code> するとかして取得して下さい。</p>

<h1 id="既知の問題">既知の問題</h1>

<p>紹介しといてなんですが、この方法は色々と問題が残ってます。</p>

<h2 id="セキュリティは向上しない">セキュリティは向上しない</h2>

<p>パスワードに加えて認証可能な方法を提供するのでセキュリティ的にはマイナスです。例えばYubiKeyを失くした場合にそのPCへログインされてsudoまで使われる可能性があります。</p>

<p>私は自分しか物理アクセスできないマシンでやってるのでそこまで問題にはならないんですがオフィスやコワーキングスペースなどでやろうと思ってる方は注意して下さい。</p>

<h2 id="2段階認証のバックアップ">2段階認証のバックアップ…？</h2>

<p>私がやった設定とは違って <code>u2f</code> を <code>required</code> にして本当に2段階認証にした場合の話です。YubiKeyを失くした場合に認証の代替手段がないので詰みます。やるとしたらシングルユーザモードでログインしてPAMの設定を外すくらいですがちょっと大変そうですね。</p>

<h2 id="ログインの判定がシビア">ログインの判定がシビア</h2>

<p>YubiKeyログインは、ログイン画面にいった瞬間にYubiKeyが挿さっていないとYubiKey認証は失敗したと見做すらしく、そのままパスワード認証に進んでしまいます。なので先にYubiKeyを挿してログイン画面に進むか、パスワード画面まで進んでしまったらYubiKeyを挿してパスワードを間違えれば認証が先頭から再開されるのでYubiKey認証をするチャンスが訪れます。</p>

<h2 id="yubicoソフトウェアとの相性">Yubicoソフトウェアとの相性</h2>

<p>Yubico AuthenticatorやYubikey Personalization Toolを起動するときに内部的に1回YubiKeyを挿し直しているようで、udevが反応して画面がロックされます。特にYubikey Personalization Toolはロックを解除した瞬間にも挿し直しているようで無限ロックに陥ります。</p>

<p>仕方ないので現状Yubico製ソフトウェアを起動するときは一旦udevの設定をコメントアウトしてルールをリロードしてから起動しています。そこまで頻度は多くないのでこれくらいなら我慢の範疇かなというところです。</p>

<h1 id="まとめ">まとめ</h1>

<p>YubiKeyの抜き差しで画面のロック/アンロックができる仕組みを構築しました。細かな点で問題は残るものの仕組みとしては面白いんじゃないでしょうか。今回の作業は以下のスクラップの末尾の方にログが残ってるので参考にして下さい。</p>

<p><a href="https://zenn.dev/blackenedgold/scraps/1c44b845a6aa68">yubikeyを買ったので色々セットアップのメモ</a></p>
                    </section>
                </article>
            </div>
        </div>

        <div class="row li-author">
    <div class="sixteen columns">
        Written by <strong>κeen</strong>
    </div>
</div>


        <div class="row li-pagination">
            <div class="eight columns">
                <div class="li-pagination-previous">
                    
                        Later article<br />
                        <a href="https://KeenS.github.io/blog/2021/04/01/imasarakikenaiaviumupurunusunyuumon/"> 今さら聞けないアヴィウムプルヌス入門</a>
                    
                </div>
            </div>
            <div class="eight columns">
                <div class="li-pagination-next">
                    
                        Older article<br />
                        <a href="https://KeenS.github.io/blog/2021/03/28/yubikeytobitwardendeanshinwebseikatsu/"> YubiKeyとBitWardenで安心Web生活</a>
                    
                </div>
            </div>
        </div>
    </div>

<footer class="li-page-footer">
    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <div class="li-page-footer-legal">
                    &copy; 2021. All rights reserved. 
                </div>
                <div class="li-page-footer-theme">
                    <span class=""><a href="https://github.com/eliasson/liquorice/">liquorice</a> is a theme for <a href="http://hugo.spf13.com">hugo</a></span>
                </div>
            </div>
        </div>
    </div>
</footer>

<script type="text/javascript">
 function toggle(id) {
     var e = document.getElementById(id);
     e.style.display == 'block' ? e.style.display = 'none' : e.style.display = 'block';
 }
</script>
<script src="https://unpkg.com/mermaid@7.0.4/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true
     });</script>

    </body>
</html>

