<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
    <head>
        
        
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-43779888-1"></script>
        <script>
         window.dataLayer = window.dataLayer || [];
         function gtag(){dataLayer.push(arguments);}
         gtag('js', new Date());

         gtag('config', 'UA-43779888-1');
        </script>
        

        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

        <meta name="twitter:site" content="@blackenedgold" />
        <meta name="twitter:title" content="マクロクラブ Rust支部 | κeenのHappy Hacκing Blog"/>
        <meta name="twitter:description" content="マクロ・クラブのルール

マクロを書くな
それがパターンをカプセル化する唯一の方法ならば、マクロを書け
例外: 同等の関数に比べて、 呼び出し側が楽になるならば、マクロを書いても構わない
" />
        <meta property="og:title" content="マクロクラブ Rust支部 | κeenのHappy Hacκing Blog" />
        <meta property="og:type" content="article" />
        <meta property="og:url" content="https://KeenS.github.io/blog/2018/02/17/makurokurabu_rustshibu/" />
        <meta property="og:description" content="マクロ・クラブのルール

マクロを書くな
それがパターンをカプセル化する唯一の方法ならば、マクロを書け
例外: 同等の関数に比べて、 呼び出し側が楽になるならば、マクロを書いても構わない
" />
        <meta name="twitter:card" content="summary_large_image" />
        <meta property="og:image" content="https://KeenS.github.io/images/ogp/post/makurokurabu_Rustshibu.png" />
        <meta name="twitter:image" content="https://KeenS.github.io/images/ogp/post/makurokurabu_Rustshibu.png" />
        
        <meta property="og:article:published_time" content="2018-02-17 15:15:07 &#43;0900 JST" />
        <meta property="og:article:modified_time" content="2018-02-17 15:15:07 &#43;0900 JST" />
        
        <meta property="og:article:author" content="κeen" />

        <title>マクロクラブ Rust支部 | κeenのHappy Hacκing Blog</title>
        <link rel="stylesheet" href='//fonts.googleapis.com/css?family=Open+Sans:400,300,600' type='text/css' />
        <link rel="stylesheet" href="https://KeenS.github.io/libraries/normalize.3.0.1.css" />
        <link rel="stylesheet" href="https://KeenS.github.io/css/liquorice.css" />
        <link rel="apple-touch-icon" sizes="180x180" href="https://KeenS.github.io/apple-touch-icon.png">
        <link rel="icon" type="image/png" href="https://KeenS.github.io/favicon-32x32.png" sizes="32x32">
        <link rel="icon" type="image/png" href="https://KeenS.github.io/favicon-16x16.png" sizes="16x16">
        <link rel="manifest" href="https://KeenS.github.io/manifest.json">
        <link rel="mask-icon" href="https://KeenS.github.io/safari-pinned-tab.svg" color="#5bbad5">
        <meta name="theme-color" content="#ffffff">
        <link rel="apple-touch-icon-precomposed" href="https://KeenS.github.io/apple-touch-icon-144-precomposed.png" sizes="144x144" />
        <link rel="stylesheet" href="https://KeenS.github.io/css/syntax-monokai.css" />
<script type="text/x-mathjax-config">
 MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ["\\(","\\)"]] } });
</script>
<script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_CHTML"></script>
</script>
<meta http-equiv="X-UA-Compatible" CONTENT="IE=EmulateIE7" />
<link rel="stylesheet" href="//unpkg.com/mermaid@7.0.4/dist/mermaid.forest.min.css">

    </head>
    <body class="li-body">

<header class="li-page-header" id="page-header">
    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <div class="li-brand li-left">
                <a href="https://KeenS.github.io/">κeenのHappy Hacκing Blog</a> | Lispエイリアンの狂想曲</div>
                <div class="li-menu li-right">
                    <span class="li-menu-icon" onclick="javascript:toggle('menu');">&#9776;</span>
                    <ul id="menu2" class="li-menu-items">
                        
                            <li><a href="https://KeenS.github.io/about/"> About </a></li>
                        
                            <li><a href="https://KeenS.github.io/post/"> Blog </a></li>
                        
                            <li><a href="https://KeenS.github.io/slide/"> Slide </a></li>
                        
                            <li><a href="https://KeenS.github.io/index.xml"> Atom </a></li>
                        
                            <li><a href="https://KeenS.github.io/search/"> Search </a></li>
                        
                    </ul>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="sixteen columns">
                <ul id="menu" class="li-menu-items li-menu-mobile">
                    
                        <li><a href="https://KeenS.github.io/about/"> About </a></li>
                    
                        <li><a href="https://KeenS.github.io/post/"> Blog </a></li>
                    
                        <li><a href="https://KeenS.github.io/slide/"> Slide </a></li>
                    
                        <li><a href="https://KeenS.github.io/index.xml"> Atom </a></li>
                    
                        <li><a href="https://KeenS.github.io/search/"> Search </a></li>
                    
                </ul>
            </div>
        </div>
    </div>
</header>






    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <article class="li-article">
                    <header class="li-article-header">
                        <h1 class="li-article-title">マクロクラブ Rust支部</h1>
                        <div class="li-article-meta">
    <time class="li-article-date">2018-02-17</time>
    <ul class="li-article-tag">
    
        <li>
            <a href="https://KeenS.github.io/categories/rust">Rust</a>
        </li>
    
        <li>
            <a href="https://KeenS.github.io/categories/%e3%83%9e%e3%82%af%e3%83%ad">マクロ</a>
        </li>
    
</ul>

</div>

                    </header>
                    <section>
                        <p>マクロ・クラブのルール</p>
<ol>
<li>マクロを書くな</li>
<li>それがパターンをカプセル化する唯一の方法ならば、マクロを書け</li>
<li>例外: 同等の関数に比べて、 呼び出し側が楽になるならば、マクロを書いても構わない</li>
</ol>
<p>κeenです。レーシックを受けようとしたら角膜が薄くて手術拒否されました。予定が狂って時間が空いたのでブログを書きます。</p>
<p>冒頭のルールは<a href="https://www.ohmsha.co.jp/book/9784274069130/">プログラミングClojure</a>に出てくるマクロの書き方の指南です。
Rustのマクロって色々できるんだよという記事を書くにあたってマクロに一日の長があるLispの知見を引用されていただきました。
ルールにあるとおり、マクロは関数と違ってRustの第一級オブジェクトでないので扱いづらいですし本体がコピーされるのでコードサイズも膨らんでしまいます。
よく考えながら使いましょう。とはいってもRustの構文はLispに比べると複雑ですし型やパターンマッチなどLispに存在しない構文要素もあるのでLispより使いどころは多くありそうです。</p>
<h1 id="マクロって何">マクロって何？</h1>
<p>簡潔に言うとRustのプログラムをプログラミングする仕組みです。
関数がデータを受け取ってデータを返すのに対してマクロはRustの構文の一部(構文木)を受け取ってRustの構文の一部を返します。</p>
<p>マクロはRustコンパイラがコンパイル中に実行するので関数とは全然違うタイミングで動きます。
初めのうちはマクロも意識せずに使えますがまれにマクロについて理解してないと使えないケースもあります。
必要になったらマクロを意識しはじめましょう。</p>
<p>マクロのドキュメントは<a href="https://rust-lang-ja.github.io/the-rust-programming-language-ja/1.6/book/macros.html">TRPL</a>や<a href="https://doc.rust-lang.org/book/second-edition/appendix-04-macros.html">TRPL 2nd</a>、<a href="https://doc.rust-lang.org/stable/reference/macros-by-example.html">リファレンスマニュアル</a>、非公式ですが<a href="http://danielkeep.github.io/tlborm/book/">The Little Book of Macros</a>などがあるので詳しく見たい方はそちらを当たるといいかもしれません。ここではあまり難しいことは言わずにマクロを使っていきます。ポジションとしてはTRPLのマクロの章を実際のユースケースに合わせて補完できたらなというところです。</p>
<p>また、Rustにはここで扱う宣言的マクロの他に手続き的マクロもあります。
手続きによってRustの構文を作るので生成されるコードがわかりづらく難しい反面、自由度は高いので宣言的マクロで出来ないことも手続き的マクロでは可能になります。
proc_macroはここでは扱わないので気になる方は適当に調べてみて下さい。</p>
<h1 id="マクロでできること">マクロでできること</h1>
<p>大抵のことはできます。</p>
<h2 id="値">値</h2>
<p>要は関数のようにも扱えるわけですね</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="n">macro_rules</span><span class="o">!</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="cp">$e1</span>: <span class="nc">expr</span><span class="p">,</span><span class="w"> </span><span class="cp">$e2</span>: <span class="nc">expr</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="cp">$e1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="cp">$e2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">add!</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;</span><span class="si">{}</span><span class="s">&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">);</span><span class="w"> </span><span class="c1">// -&gt; 3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h2 id="関数呼び出し">関数呼び出し</h2>
<p>関数名を受け取ってそれを呼び出したりもできます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="k">fn</span> <span class="nf">print2</span><span class="p">(</span><span class="n">i</span>: <span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">j</span>: <span class="kt">i32</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;</span><span class="si">{}</span><span class="s">, </span><span class="si">{}</span><span class="s">&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">macro_rules</span><span class="o">!</span><span class="w"> </span><span class="n">call_by_double</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="cp">$name</span>: <span class="nc">ident</span><span class="p">,</span><span class="w"> </span><span class="cp">$e</span>: <span class="nc">expr</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="cp">$name</span><span class="p">(</span><span class="cp">$e</span><span class="p">,</span><span class="w"> </span><span class="cp">$e</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="fm">call_by_double!</span><span class="p">(</span><span class="n">print2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="c1">// -&gt; 1, 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h2 id="変数束縛">変数束縛</h2>
<p>新たな束縛を導入したりもできます。
詳しくは触れませんがRustのマクロは衛生的なのでユーザが指定した以外の変数を導入することはできません。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="n">macro_rules</span><span class="o">!</span><span class="w"> </span><span class="n">bind</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="cp">$var</span>: <span class="nc">ident</span><span class="p">,</span><span class="w"> </span><span class="cp">$val</span>: <span class="nc">expr</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="cp">$var</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="cp">$val</span><span class="p">;)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="fm">bind!</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;</span><span class="si">{}</span><span class="s">&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">);</span><span class="w"> </span><span class="c1">// -&gt; 3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h2 id="パターン">パターン</h2>
<p>パターンも書けます。今試したら<code>|</code>パターンは書けないようでした。残念ですね。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="n">macro_rules</span><span class="o">!</span><span class="w"> </span><span class="n">exact_one</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nb">Some</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">macro_rules</span><span class="o">!</span><span class="w"> </span><span class="n">two</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="cp">$x</span>: <span class="nc">ident</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nb">Some</span><span class="p">(</span><span class="cp">$x</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="mi">2</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">macro_rules</span><span class="o">!</span><span class="w"> </span><span class="n">three</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="cp">$x</span>: <span class="nc">ident</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nb">Some</span><span class="p">(</span><span class="cp">$x</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="mi">3</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">macro_rules</span><span class="o">!</span><span class="w"> </span><span class="n">many_or_none</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="fm">exact_one!</span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;exact one&#34;</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="fm">two!</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="fm">three!</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;</span><span class="si">{}</span><span class="s">&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="fm">many_or_none!</span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h2 id="型">型</h2>
<p>型の位置にもマクロが使えます。残念ながらトレイト制約の一には書けませんでした</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="n">macro_rules</span><span class="o">!</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nb">Result</span><span class="o">&lt;</span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">fn</span> <span class="nf">function</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">result</span><span class="o">!</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h2 id="アイテムの定義">アイテムの定義</h2>
<p><code>struct</code>や<code>impl</code>や<code>trait</code>などの定義もできます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="n">macro_rules</span><span class="o">!</span><span class="w"> </span><span class="n">define_id_type</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="cp">$name</span>: <span class="nc">ident</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="cp">$name</span><span class="p">(</span><span class="k">pub</span><span class="w"> </span><span class="kt">u64</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">impl</span><span class="w"> </span><span class="cp">$name</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">new</span><span class="p">(</span><span class="n">id</span>: <span class="kt">u64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="cp">$name</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="fm">define_id_type!</span><span class="p">(</span><span class="n">UserId</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><hr>
<p>マクロをどこで使えるかはイマイチドキュメントがなく、実験的に確かめるしかありません。</p>
<h1 id="マクロを定義する">マクロを定義する</h1>
<h2 id="基本のき">基本の「き」</h2>
<p>マクロで何が書けるかを見てきたので次はマクロを書いてみましょう。とはいってもいままで定義してきましたね。
最初の<code>add!</code>マクロを取り出してみましょう。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="n">macro_rules</span><span class="o">!</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="cp">$e1</span>: <span class="nc">expr</span><span class="p">,</span><span class="w"> </span><span class="cp">$e2</span>: <span class="nc">expr</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="cp">$e1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="cp">$e2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>これの引数のところを取り出してみましょう</p>
<pre tabindex="0"><code>($e1: expr, $e2: expr)
</code></pre><p><code>$e1</code>, <code>$e2</code> などはいいですね。引数の変数です。
マクロは引数でパターンマッチできるので変数はそれとの違いを明確にするために<code>$</code>をつけます。</p>
<p><code>:expr</code>の方です。マクロの引数にも型があります。構文を受け取るので型は構文の型です。ここでは<code>expr</code>型の構文を受け取ると言っています。
<code>expr</code> 型はRustの構文でいう式、つまりは計算すると値を返す構文の型です。</p>
<p>他にも構文の型はいくつかあります。</p>
<ul>
<li><code>item</code>: <code>fn</code>定義<code>struct</code>定義などのトップレベルに置かれるものです</li>
<li><code>block</code>: ブロック。雑に言うと波括弧で括られた式/文ですね。<code>{let x = 1; x * 2}</code>など。</li>
<li><code>stmt</code>: 文。雑に言うと<code>;</code>で終わるやつです。<code>let x = 1;</code>など。</li>
<li><code>pat</code>: パターン。<code>match</code>や<code>if let</code>、<code>let</code>などで使えるやつです。</li>
<li><code>expr</code>: 式。先程説明したとおり、計算すると値を返すものです。<code>1 + 2</code>など。</li>
<li><code>ty</code>: 型。</li>
<li><code>ident</code>: 識別子。関数名、変数名などですね。</li>
<li><code>path</code>: パスです。<code>std::collections::HashMap</code>などです。</li>
<li><code>tt</code>: トークンツリー。1塊になってる構文要素です。まあ、なんかなんでもアリみたいなやつです。</li>
<li><code>meta</code>: メタアイテムです。雑にいうと<code>#[]</code>の中身です。</li>
</ul>
<p>これを覚えておけばマクロの引数には困りません。
あと比較的最近、可視性(<code>pub</code>や<code>pub(crate)</code>など)も導入された筈ですがドキュメントが見当たらないので流します。</p>
<p>よく使うのは<code>expr</code>, <code>ty</code>, <code>ident</code>あたりかなーといったところです。</p>
<h2 id="パターン-1">パターン</h2>
<p>マクロの引数の位置にはパターンが書けます。試しに<code>Vec</code>を作る<code>vec!</code>マクロのように<code>HashMap</code>を作る<code>map!</code>マクロを作ってみましょう。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="n">macro_rules</span><span class="o">!</span><span class="w"> </span><span class="n">map</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="cp">$($k</span>: <span class="nc">expr</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="cp">$v</span>: <span class="nc">expr</span><span class="p">),</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>::<span class="n">std</span>::<span class="n">collections</span>::<span class="n">HashMap</span>::<span class="n">new</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="cp">$(</span><span class="n">map</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="cp">$k</span><span class="p">,</span><span class="w"> </span><span class="cp">$v</span><span class="p">);)</span><span class="o">*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">map</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">nums</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">map!</span><span class="p">{</span><span class="mi">1</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="s">&#34;one&#34;</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="s">&#34;two&#34;</span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;</span><span class="si">{}</span><span class="s">&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">nums</span><span class="p">[</span><span class="o">&amp;</span><span class="mi">2</span><span class="p">]);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>一気に詰め込みすぎましたかね？ひとつづつ見ていきます。</p>
<p>まずはパターンの<code>$k: expr =&gt; $v: expr</code>の部分。
<code>1 =&gt; &quot;one&quot;</code>や<code>2 =&gt; &quot;two&quot;</code>にマッチしています。
それっぽくパターンを書くとrustコンパイラがいい感じにマッチしてくれます。
ここでの<code>=&gt;</code>のようにマクロを使うとRustにない構文でも自由に受け取れるようになります。マクロ便利ですね。
ところで<code>add!</code>マクロで<code>($e1: expr, $e2:expr)</code>のようにカンマで区切っていたのもカンマに対するマッチだった訳ですね。</p>
<p>この新しい記号の導入はある程度制限があります。たとえばここで<code>+</code>を区切りに使うと怒られます。
<code>map![1+1+1]</code>と渡した場合に<code>+</code>がマクロの区切りなのか足し算をしているのか区別が付かないからです。
これはどの記号が許容されるかはドキュメントに書いてあるので気になる人は確認して下さい。
ドキュメントを読まない人はRustの構文解析器の気持ちになって察して下さい。間違ってたらコンパイラが教えてくれるのでそれでもいいと思います。</p>
<p>次に<code>$(...),*</code>の部分。これは0回以上のパターンの繰り返しです。
複数個使おうと思ったら必要ですね。
地味に<code>,</code>の扱いが特別で、<code>map!{1 =&gt; &quot;one&quot;, 2 =&gt; &quot;two&quot;}</code>の使用からみても分かるとおり区切りの位置にのみマッチします。<code>map!{1 =&gt; &quot;one&quot;, 2 =&gt; &quot;two&quot;,}</code>と最後にカンマを書くとエラーになります。</p>
<p>パターンはいいのですが、使用箇所も見ておきましょう。<code>$(map.insert($k, $v);)*</code>です。
使用時にも<code>$(...)*</code>包んでいます。ここでは<code>$()</code>の中に<code>;</code>を入れているので区切りを使ってませんね。
区切りを外に出して<code>$(map.insert($k, $v));*;</code>と書くことも可能ですが、最後のセミコロンに注意しましょう。</p>
<p>最後に、マクロの本体が複文になったので全体が<code>{{ }}</code>で囲まれています。
外側の<code>{}</code>がマクロの本体を括る括弧で、内側の<code>{}</code>がマクロの返り値を1つの構文要素にするための括弧です。</p>
<p>さて、これでだいたいマクロは説明した気がするので実例をみていきましょう。</p>
<h1 id="マクロ実例集">マクロ実例集</h1>
<h2 id="match_vec"><code>match_vec!</code></h2>
<p>説明していませんでしたが、マクロのパターンは複数書けます。関数定義よりは<code>match</code>を書いている気分に近いですね。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="n">macro_rules</span><span class="o">!</span><span class="w"> </span><span class="n">ignore</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="cp">$pat</span>: <span class="nc">tt</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">macro_rules</span><span class="o">!</span><span class="w"> </span><span class="n">match_vec</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// `vec![]`パターンの末尾カンマに対応するために末尾カンマを取り除いて本体に渡すための節
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="cp">$($pat</span>:<span class="nc">pat</span><span class="p">),</span><span class="o">*</span><span class="p">,]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="cp">$v</span>:<span class="nc">expr</span><span class="p">;)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="fm">match_vec!</span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="cp">$($pat</span><span class="p">),</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="cp">$v</span><span class="p">;)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 本体
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="cp">$($pat</span>:<span class="nc">pat</span><span class="p">),</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="cp">$v</span>:<span class="nc">expr</span><span class="p">;)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="cp">$($pat</span><span class="p">),</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// * exprで受けたので`vec![1, 2, 3]`などのまだ評価されていない式も来うる。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">            </span><span class="c1">//   一旦変数に格納して評価させる。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">            </span><span class="c1">// * ついでに`mut`をつけたりイテレータを取り出したり。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="cp">$v</span><span class="p">.</span><span class="n">into_iter</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// * `$()*`を使いたいが`$pat`は使わないので`ignore`を使って無視する
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">            </span><span class="c1">// * お粗末だが`next()`に対して`unwrap()`している。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">            </span><span class="c1">//   実行時のマッチ失敗panicを投げる余裕があるなら投げるべき。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="cp">$(</span><span class="p">{</span><span class="fm">ignore!</span><span class="p">(</span><span class="cp">$pat</span><span class="p">);</span><span class="w"> </span><span class="n">i</span><span class="p">.</span><span class="n">next</span><span class="p">().</span><span class="n">unwrap</span><span class="p">()}),</span><span class="o">*</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// 同じくvecが余った場合の検査を`assert!`に丸投げしている。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">            </span><span class="fm">assert!</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">next</span><span class="p">().</span><span class="n">is_none</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>使い方</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">];</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="fm">match_vec!</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 上の式を展開するとこうなるはず。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="c1">// // 複数のパターンマッチをタプルのマッチに落とし込んでいる。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="c1">// let (x, y, z) = {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="c1">//   // (マニアックな話):Rustのマクロは衛生的なのでマクロ内で定義した`i`がgensym(rename)される。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="c1">//   let mut i_xxx = v.into_iter();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="c1">//   let ret = (
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="c1">//     {ignore!(x);i_xxx.next().unwrap()},
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="c1">//     {ignore!(y);i_xxx.next().unwrap()},
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="c1">//     {ignore!(z);i_xxx.next().unwrap()},
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="c1">//   );
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="c1">//   assert!(i_xxx.next().is_none());
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="c1">//   ret
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="c1">// };
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;x: </span><span class="si">{}</span><span class="s">, y: </span><span class="si">{}</span><span class="s">, z: </span><span class="si">{}</span><span class="s">&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">);</span><span class="w"> </span><span class="c1">// -&gt; x: 1, y: 2, z: 3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>興味があるなら<code>HashMap</code>向けのものも書くと練習になるかもしれません。</p>
<h2 id="err"><code>err!</code></h2>
<p>定義自体はシンプルです。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="n">macro_rules</span><span class="o">!</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="cp">$e</span>: <span class="nc">expr</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="cp">$e</span><span class="p">.</span><span class="n">into</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>使うのもシンプル</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="k">fn</span> <span class="nf">fact</span><span class="p">(</span><span class="n">n</span>: <span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="fm">err!</span><span class="p">(</span><span class="s">&#34;n is negative&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">..</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;</span><span class="si">{:?}</span><span class="s">&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">fact</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">));</span><span class="w"> </span><span class="c1">// -&gt; Err(&#34;n is negative&#34;) 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>シンプルですが<code>return</code>のようにコントロールフローに干渉するようなものは関数では書けなくて、マクロが必要になります。</p>
<h2 id="define_error_enum"><code>define_error_enum!</code></h2>
<p>エラーハンドリングのときに複数のエラーを束ねるenumの実装を生成するやつです。
現実的には<a href="https://github.com/rust-lang-nursery/error-chain">error_chain</a>などのちゃんとしたものを使うべきですが、似たようなケースに遭遇したときに自分でボイラープレートを削減出来るマクロを書けると便利です。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="n">macro_rules</span><span class="o">!</span><span class="w"> </span><span class="n">define_error_enum</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 普通のenumっぽく書けるようにパターンを工夫してある。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="c1">// 無骨に型名、列挙子と対応するエラー型名だけを受け取っても本質は変わらない。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="p">(</span><span class="cp">$(#[$meta:meta]</span><span class="p">)</span><span class="o">*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="cp">$name</span>: <span class="nc">ident</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cp">$($variant</span>: <span class="nc">ident</span><span class="w"> </span><span class="p">(</span><span class="cp">$ty</span>: <span class="nc">ty</span><span class="p">),)</span><span class="o">*</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// この`$(#[$meta])*`を用意しておくとユーザは好きにderiveなどを書ける。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="cp">$(#[$meta]</span><span class="p">)</span><span class="o">*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="cp">$name</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// 本当はvariantにもmetaをつけれるようにすべきだが、面倒なので読者の課題とする
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">            </span><span class="cp">$($variant</span><span class="p">(</span><span class="cp">$ty</span><span class="p">),)</span><span class="o">*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 各型毎に`From`を実装
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="cp">$(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">impl</span><span class="w"> </span><span class="nb">From</span><span class="o">&lt;</span><span class="cp">$ty</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="cp">$name</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">fn</span> <span class="nf">from</span><span class="p">(</span><span class="n">e</span>: <span class="cp">$ty</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="cp">$name</span>::<span class="cp">$variant</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">)</span><span class="o">*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// この型自体もErrorになるように諸々実装。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="c1">// 実装は内部のエラーにdelegateするだけ。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="k">impl</span><span class="w"> </span>::<span class="n">std</span>::<span class="n">fmt</span>::<span class="n">Display</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="cp">$name</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">fn</span> <span class="nf">fmt</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">f</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span>::<span class="n">std</span>::<span class="n">fmt</span>::<span class="n">Formatter</span><span class="p">)</span><span class="w"> </span>-&gt; ::<span class="n">std</span>::<span class="n">fmt</span>::<span class="nb">Result</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">use</span><span class="w"> </span><span class="bp">self</span>::<span class="cp">$name</span>::<span class="o">*</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">match</span><span class="w"> </span><span class="bp">self</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="cp">$(</span><span class="o">&amp;</span><span class="cp">$variant</span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">fmt</span><span class="p">(</span><span class="n">f</span><span class="p">),)</span><span class="o">*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">impl</span><span class="w"> </span>::<span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="cp">$name</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">fn</span> <span class="nf">description</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="kt">str</span> <span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">use</span><span class="w"> </span><span class="bp">self</span>::<span class="cp">$name</span>::<span class="o">*</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">match</span><span class="w"> </span><span class="bp">self</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="cp">$(</span><span class="o">&amp;</span><span class="cp">$variant</span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">description</span><span class="p">(),)</span><span class="o">*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">fn</span> <span class="nf">cause</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;&amp;</span>::<span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">use</span><span class="w"> </span><span class="bp">self</span>::<span class="cp">$name</span>::<span class="o">*</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">match</span><span class="w"> </span><span class="bp">self</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="cp">$(</span><span class="o">&amp;</span><span class="cp">$variant</span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">e</span><span class="p">),)</span><span class="o">*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>結構大きいですがほぼボイラープレートなのでマクロとしてはあんまりおもしろいことはやってないです。</p>
<p>使い方ですが、まずエラー型を適当に用意しましょう。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">fmt</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cp">#[derive(Debug)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Error1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">impl</span><span class="w"> </span><span class="n">fmt</span>::<span class="n">Display</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Error1</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">fn</span> <span class="nf">fmt</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">f</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">fmt</span>::<span class="n">Formatter</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">fmt</span>::<span class="nb">Result</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="fm">write!</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;this is error1&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">impl</span><span class="w"> </span><span class="n">Error</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Error1</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">fn</span> <span class="nf">description</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="kt">str</span> <span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="s">&#34;error1 occurred&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">fn</span> <span class="nf">cause</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;&amp;</span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nb">None</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cp">#[derive(Debug)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Error2</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">impl</span><span class="w"> </span><span class="n">fmt</span>::<span class="n">Display</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Error2</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">fn</span> <span class="nf">fmt</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">f</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">fmt</span>::<span class="n">Formatter</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">fmt</span>::<span class="nb">Result</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="fm">write!</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;this is error2&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">impl</span><span class="w"> </span><span class="n">Error</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Error2</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">fn</span> <span class="nf">description</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="kt">str</span> <span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="s">&#34;error2 occurred&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">fn</span> <span class="nf">cause</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;&amp;</span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nb">None</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>そして</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//ほぼenumの定義っぽく書ける
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="fm">define_error_enum!</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="cp">#[derive(Debug)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">GenericError</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">E1</span><span class="p">(</span><span class="n">Error1</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">E2</span><span class="p">(</span><span class="n">Error2</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// intoを自動で実装した
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">e</span>: <span class="nc">GenericError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Error1</span><span class="p">.</span><span class="n">into</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// displayを自動で実装した
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;</span><span class="si">{}</span><span class="s">&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w"> </span><span class="c1">// -&gt; this is error1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>便利ですね。</p>
<hr>
<p>こういった、「もうちょっとすっきり書けないかな」「ほぼコピペなコードが量産されるんだけどどうにかならないの」な状況にマクロが便利です。</p>
<h1 id="マクロプログラミング">マクロプログラミング</h1>
<p>ここからはプログラミングの余興、サーカス的プログラミングの世界です。</p>
<p>Rustのマクロには再帰(ループ)とパターンマッチ(分岐)があるのでチューリング完全です。
そう訊いたらとりあえずプログラミングしてみたくなりますよね？</p>
<h1 id="最初の試み">最初の試み</h1>
<p>そう聞いたあなたはすぐさま<code>(1, ...)</code>で数値を表すことにして以下のようなマクロを書き下すでしょう。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="n">macro_rules</span><span class="o">!</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">((</span><span class="cp">$($l</span>: <span class="nc">tt</span><span class="p">),</span><span class="o">*</span><span class="p">),</span><span class="w"> </span><span class="p">())</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">(</span><span class="cp">$($l</span><span class="p">),</span><span class="o">*</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">((</span><span class="cp">$($l</span>: <span class="nc">tt</span><span class="p">),</span><span class="o">*</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="cp">$($l</span><span class="p">),</span><span class="o">*</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">((</span><span class="cp">$($l</span>:<span class="nc">tt</span><span class="p">),</span><span class="o">*</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="cp">$($r</span>: <span class="nc">tt</span><span class="p">),</span><span class="o">*</span><span class="p">))</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="fm">add!</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="cp">$($l</span><span class="p">),</span><span class="o">*</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="cp">$($r</span><span class="p">),</span><span class="o">*</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">macro_rules</span><span class="o">!</span><span class="w"> </span><span class="n">sub</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">((</span><span class="cp">$($l</span>: <span class="nc">tt</span><span class="p">),</span><span class="o">*</span><span class="p">),</span><span class="w"> </span><span class="p">())</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">(</span><span class="cp">$($l</span><span class="p">),</span><span class="o">*</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">((</span><span class="mi">1</span><span class="w"> </span><span class="cp">$(,</span><span class="w"> </span><span class="cp">$l</span>: <span class="nc">tt</span><span class="p">)</span><span class="o">*</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">(</span><span class="cp">$($l</span><span class="p">),</span><span class="o">*</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">((</span><span class="mi">1</span><span class="w"> </span><span class="cp">$(,</span><span class="w"> </span><span class="cp">$l</span>:<span class="nc">tt</span><span class="p">)</span><span class="o">*</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="cp">$(,</span><span class="w"> </span><span class="cp">$r</span>: <span class="nc">tt</span><span class="p">)</span><span class="o">*</span><span class="p">))</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="fm">sub!</span><span class="p">((</span><span class="cp">$($l</span><span class="p">),</span><span class="o">*</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="cp">$($r</span><span class="p">),</span><span class="o">*</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">macro_rules</span><span class="o">!</span><span class="w"> </span><span class="n">fib</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(())</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{(</span><span class="mi">1</span><span class="p">)};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">((</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{(</span><span class="mi">1</span><span class="p">)};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">((</span><span class="cp">$($n</span>:<span class="nc">tt</span><span class="p">),</span><span class="o">*</span><span class="p">))</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="fm">add!</span><span class="p">(</span><span class="fm">fib!</span><span class="p">(</span><span class="fm">sub!</span><span class="p">((</span><span class="cp">$($n</span><span class="p">),</span><span class="o">*</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">))),</span><span class="w"> </span><span class="fm">fib!</span><span class="p">(</span><span class="fm">sub!</span><span class="p">((</span><span class="cp">$($n</span><span class="p">),</span><span class="o">*</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">))))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">fib!</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;</span><span class="si">{:?}</span><span class="s">&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>しかしこれはうまく動作しません。</p>
<pre tabindex="0"><code>error: no rules expected the token `fib`
  --&gt; macro.rs:29:14
   |
29 |         add!(fib!(sub!(($($n),*), (1))), fib!(sub!(($($n),*), (1, 1))))
   |              ^^^
...
34 |     let n = fib!((1, 1, 1));
   |             --------------- in this macro invocation

error: aborting due to previous error

error: Could not compile `macro`.

To learn more, run the command again with --verbose.
internal error: cargo failed with status 101
</code></pre><p>これはマクロの展開の順序が絡んできます。
普通の関数だと内側から展開されますが、マクロは外側から展開するので問題が起きます。
<code>fib!</code>の第3節の本体は<code>add!(sub!($($n),*, (1)), sub!($($n),*, (1, 1)))</code>ですね。
このマクロ式の呼び出しは外側から、つまり<code>add!</code>から展開されます。
<code>add!</code>は<code>(sub!($n, (1)), sub!($n, (1, 1)))</code>に対してパターンマッチしようとして失敗しているのです。</p>
<p>さて、どうしましょう。普通にはプログラミングできません。外側から展開していたものを内側から展開するようにうまいことやる手段はあるでしょうか。</p>
<p>そう、みなさんならおわかりですね。「CPSするとlazyをeagerに変換できる」というやつです。正確にはCPSじゃありませんが。</p>
<h1 id="ck"><code>ck!</code></h1>
<p>コードと継続からなる抽象マシン、CKマシンをマクロで適当にエミュレートするのが<code>ck!</code>マクロです。詳しくはこの記事を→ <a href="https://qiita.com/dico_leque/items/e2c7a88df2e9dfe9a446">syntax-rulesズンドコキヨシ、またはマクロ展開時ズンドコキヨシ</a>。
雑に言うとコールスタックを自前で実装したらネストしたマクロ呼び出しもできるよねってやつです。
ただちょっと面倒なのが引数が複数あるので呼び出しの深さに応じてスタックを縦に積むのと引数の数に応じて中身を横に広げるの2つの操作がある点ですね。これはスタックにタプルを積むことで解決します。</p>
<p>また、rust特有の問題として、マクロ呼び出しが<code>name ! (args...)</code>と3トークンに分かれてしまうのでやや扱いに気をつける必要があります。
もう一つ、値をマクロと同じように扱わないと対応するパターンが爆発してしまうのでLispでいうquote相当のものとして<code>q!</code>という目印を使います。
これは<code>ck!</code>マクロ内で目印として使っているだけのものなので特に実体は必要ありません。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="c1">// ck(スタック, 式)という形で評価していく。なんとなく継続を起動してるイメージ
</span></span></span><span class="line"><span class="cl"><span class="c1">// 評価が終わったら`q!(値)`という形で目印を付ける
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// スタックは以下のような形。
</span></span></span><span class="line"><span class="cl"><span class="c1">// [(マクロ名, (まだ評価していない引数...), (評価が終わった引数 ...)), ...]
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// ここで受け取るマクロは全てスタックを第一引数に取るものとする。CPSでいう継続っぽいもの。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">macro_rules</span><span class="o">!</span><span class="w"> </span><span class="n">ck</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// スタックが空で値が出来ているなら値を返す
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="p">([],</span><span class="w"> </span><span class="fm">q!</span><span class="p">(</span><span class="cp">$value</span>:<span class="nc">tt</span><span class="p">))</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="cp">$value</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 評価対象がマクロ呼び出しならスタックに積んで第一引数から評価を始める
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="p">([</span><span class="cp">$($stack</span>:<span class="nc">tt</span><span class="p">),</span><span class="o">*</span><span class="p">],</span><span class="w"> </span><span class="cp">$name</span>:<span class="nc">ident</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="p">(</span><span class="cp">$argn</span>:<span class="nc">ident</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="cp">$arga</span>:<span class="nc">tt</span><span class="p">,</span><span class="w"> </span><span class="cp">$($args</span>: <span class="nc">tt</span><span class="p">)</span><span class="o">*</span><span class="p">))</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="fm">ck!</span><span class="p">([(</span><span class="cp">$name</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="cp">$($args</span><span class="p">)</span><span class="o">*</span><span class="p">),</span><span class="w"> </span><span class="p">())</span><span class="w"> </span><span class="cp">$(,$stack</span><span class="p">)</span><span class="o">*</span><span class="p">],</span><span class="w"> </span><span class="cp">$argn</span><span class="o">!</span><span class="cp">$arga</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// コンマの扱いのために1引数の場合も別途定義
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="p">([</span><span class="cp">$($stack</span>:<span class="nc">tt</span><span class="p">),</span><span class="o">*</span><span class="p">],</span><span class="w"> </span><span class="cp">$name</span>:<span class="nc">ident</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="p">(</span><span class="cp">$argn</span>:<span class="nc">ident</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="cp">$arga</span>:<span class="nc">tt</span><span class="p">))</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="fm">ck!</span><span class="p">([(</span><span class="cp">$name</span><span class="p">,</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="p">())</span><span class="w"> </span><span class="cp">$(,$stack</span><span class="p">)</span><span class="o">*</span><span class="p">],</span><span class="w"> </span><span class="cp">$argn</span><span class="o">!</span><span class="cp">$arga</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 無引数マクロは即時評価
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="p">([</span><span class="cp">$($stack</span>:<span class="nc">tt</span><span class="p">),</span><span class="o">*</span><span class="p">],</span><span class="w"> </span><span class="cp">$name</span>:<span class="nc">ident</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="p">())</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="fm">name!</span><span class="p">([</span><span class="cp">$($stack</span><span class="p">),</span><span class="o">*</span><span class="p">])</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 1つの引数の評価が終わって、まだ評価していない引数があるなら
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="c1">// 評価が終わったリストにその値を加えてまだ評価していない引数を評価する
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="p">([(</span><span class="cp">$name</span>:<span class="nc">ident</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="cp">$todon</span>:<span class="nc">ident</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="cp">$todoa</span>:<span class="nc">tt</span><span class="p">,</span><span class="w"> </span><span class="cp">$($todos</span>:<span class="nc">tt</span><span class="p">)</span><span class="o">*</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="cp">$($dones</span>:<span class="nc">tt</span><span class="p">),</span><span class="o">*</span><span class="p">))</span><span class="w"> </span><span class="cp">$(,</span><span class="w"> </span><span class="cp">$stack</span>:<span class="nc">tt</span><span class="p">)</span><span class="o">*</span><span class="p">],</span><span class="w"> </span><span class="fm">q!</span><span class="p">(</span><span class="cp">$value</span>:<span class="nc">tt</span><span class="p">))</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="fm">ck!</span><span class="p">([(</span><span class="cp">$name</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="cp">$($todos</span><span class="p">)</span><span class="o">*</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="cp">$($dones</span><span class="p">,)</span><span class="o">*</span><span class="w"> </span><span class="cp">$value</span><span class="p">))</span><span class="w"> </span><span class="cp">$(,</span><span class="w"> </span><span class="cp">$stack</span><span class="p">)</span><span class="o">*</span><span class="p">],</span><span class="w"> </span><span class="cp">$todon</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="cp">$todoa</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// コンマの扱いのためにtodoが1つの場合も別途定義
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="p">([(</span><span class="cp">$name</span>:<span class="nc">ident</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="cp">$todon</span>:<span class="nc">ident</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="cp">$todoa</span>:<span class="nc">tt</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="cp">$($dones</span>:<span class="nc">tt</span><span class="p">),</span><span class="o">*</span><span class="p">))</span><span class="w"> </span><span class="cp">$(,</span><span class="w"> </span><span class="cp">$stack</span>:<span class="nc">tt</span><span class="p">)</span><span class="o">*</span><span class="p">],</span><span class="w"> </span><span class="fm">q!</span><span class="p">(</span><span class="cp">$value</span>:<span class="nc">tt</span><span class="p">))</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="fm">ck!</span><span class="p">([(</span><span class="cp">$name</span><span class="p">,</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="cp">$($dones</span><span class="p">,)</span><span class="o">*</span><span class="w"> </span><span class="cp">$value</span><span class="p">))</span><span class="w"> </span><span class="cp">$(,</span><span class="w"> </span><span class="cp">$stack</span><span class="p">)</span><span class="o">*</span><span class="p">],</span><span class="w"> </span><span class="cp">$todon</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="cp">$todoa</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 全ての引数を評価したなら満を持してマクロを呼ぶ。コールスタックを渡しているので帰ってこれる。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="p">([(</span><span class="cp">$name</span>:<span class="nc">ident</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="cp">$($dones</span>:<span class="nc">tt</span><span class="p">),</span><span class="o">*</span><span class="p">))</span><span class="w"> </span><span class="cp">$(,</span><span class="w"> </span><span class="cp">$stack</span>:<span class="nc">tt</span><span class="p">)</span><span class="o">*</span><span class="p">],</span><span class="w"> </span><span class="fm">q!</span><span class="p">(</span><span class="cp">$value</span>:<span class="nc">tt</span><span class="p">))</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="cp">$name</span><span class="o">!</span><span class="p">([</span><span class="cp">$($stack</span><span class="p">),</span><span class="o">*</span><span class="p">],</span><span class="w"> </span><span class="cp">$($dones</span><span class="p">,)</span><span class="o">*</span><span class="w"> </span><span class="cp">$value</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>このCKマクロを使うと次のようにマクロを定義できます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="n">macro_rules</span><span class="o">!</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="cp">$s</span>:<span class="nc">tt</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="cp">$($l</span>:<span class="nc">tt</span><span class="p">),</span><span class="o">*</span><span class="p">),</span><span class="w"> </span><span class="p">())</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="fm">ck!</span><span class="p">(</span><span class="cp">$s</span><span class="p">,</span><span class="w"> </span><span class="fm">q!</span><span class="p">((</span><span class="cp">$($l</span><span class="p">),</span><span class="o">*</span><span class="p">)))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="cp">$s</span>:<span class="nc">tt</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="cp">$($l</span>:<span class="nc">tt</span><span class="p">),</span><span class="o">*</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="fm">ck!</span><span class="p">(</span><span class="cp">$s</span><span class="p">,</span><span class="w"> </span><span class="fm">q!</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="cp">$($l</span><span class="p">),</span><span class="o">*</span><span class="p">)))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="cp">$s</span>:<span class="nc">tt</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="cp">$($l</span>:<span class="nc">tt</span><span class="p">),</span><span class="o">*</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="cp">$(,</span><span class="w"> </span><span class="cp">$r</span>:<span class="nc">tt</span><span class="p">)</span><span class="o">*</span><span class="p">))</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="fm">ck!</span><span class="p">(</span><span class="cp">$s</span><span class="p">,</span><span class="w"> </span><span class="fm">add!</span><span class="p">(</span><span class="fm">q!</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="cp">$($l</span><span class="p">),</span><span class="o">*</span><span class="p">)),</span><span class="w"> </span><span class="fm">q!</span><span class="p">((</span><span class="cp">$($r</span><span class="p">),</span><span class="o">*</span><span class="p">))))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">macro_rules</span><span class="o">!</span><span class="w"> </span><span class="n">sub</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="cp">$s</span>:<span class="nc">tt</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="cp">$($l</span>: <span class="nc">tt</span><span class="p">),</span><span class="o">*</span><span class="p">),</span><span class="w"> </span><span class="p">())</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="fm">ck!</span><span class="p">(</span><span class="cp">$s</span><span class="p">,</span><span class="w"> </span><span class="fm">q!</span><span class="p">((</span><span class="cp">$($l</span><span class="p">),</span><span class="o">*</span><span class="p">)))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="cp">$s</span>:<span class="nc">tt</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="cp">$(,</span><span class="w"> </span><span class="cp">$l</span>: <span class="nc">tt</span><span class="p">)</span><span class="o">*</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="fm">ck!</span><span class="p">(</span><span class="cp">$s</span><span class="p">,</span><span class="w"> </span><span class="fm">q!</span><span class="p">((</span><span class="cp">$($l</span><span class="p">),</span><span class="o">*</span><span class="p">)))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="cp">$s</span>:<span class="nc">tt</span><span class="p">,</span><span class="w">  </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="cp">$(,</span><span class="w"> </span><span class="cp">$l</span>:<span class="nc">tt</span><span class="p">)</span><span class="o">*</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="cp">$(,</span><span class="w"> </span><span class="cp">$r</span>: <span class="nc">tt</span><span class="p">)</span><span class="o">*</span><span class="p">))</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="fm">ck!</span><span class="p">(</span><span class="cp">$s</span><span class="p">,</span><span class="w"> </span><span class="fm">sub!</span><span class="p">(</span><span class="fm">q!</span><span class="p">((</span><span class="cp">$($l</span><span class="p">),</span><span class="o">*</span><span class="p">)),</span><span class="w"> </span><span class="fm">q!</span><span class="p">((</span><span class="cp">$($r</span><span class="p">),</span><span class="o">*</span><span class="p">))))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">macro_rules</span><span class="o">!</span><span class="w"> </span><span class="n">fib</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="cp">$s</span>: <span class="nc">tt</span><span class="p">,</span><span class="w"> </span><span class="p">())</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="fm">ck!</span><span class="p">(</span><span class="cp">$s</span><span class="p">,</span><span class="w"> </span><span class="fm">q!</span><span class="p">((</span><span class="mi">1</span><span class="p">)))};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="cp">$s</span>: <span class="nc">tt</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="fm">ck!</span><span class="p">(</span><span class="cp">$s</span><span class="p">,</span><span class="w"> </span><span class="fm">q!</span><span class="p">((</span><span class="mi">1</span><span class="p">)))};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="cp">$s</span>: <span class="nc">tt</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="cp">$($n</span>:<span class="nc">tt</span><span class="p">),</span><span class="o">*</span><span class="p">))</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="fm">ck!</span><span class="p">(</span><span class="cp">$s</span><span class="p">,</span><span class="w"> </span><span class="fm">add!</span><span class="p">(</span><span class="fm">fib!</span><span class="p">(</span><span class="fm">sub!</span><span class="p">(</span><span class="fm">q!</span><span class="p">((</span><span class="cp">$($n</span><span class="p">),</span><span class="o">*</span><span class="p">)),</span><span class="w"> </span><span class="fm">q!</span><span class="p">((</span><span class="mi">1</span><span class="p">)))),</span><span class="w"> </span><span class="fm">fib!</span><span class="p">(</span><span class="fm">sub!</span><span class="p">(</span><span class="fm">q!</span><span class="p">((</span><span class="cp">$($n</span><span class="p">),</span><span class="o">*</span><span class="p">)),</span><span class="w"> </span><span class="fm">q!</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">))))))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>これで念願の<code>fib!</code>マクロが動きます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">ck!</span><span class="p">([],</span><span class="w"> </span><span class="fm">fib!</span><span class="p">(</span><span class="fm">q!</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">))));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;</span><span class="si">{:?}</span><span class="s">&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">);</span><span class="w"> </span><span class="c1">// -&gt; (1, 1, 1, 1, 1, 1, 1, 1)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>ただしマクロの再帰が深くなるので<code>#![recursion_limit = &quot;256&quot;]</code>が必要となります。</p>
<h1 id="おわりに">おわりに</h1>
<p>マクロは便利な使い方もアホな使い方もできるよって話でした。</p>
                    </section>
                </article>
            </div>
        </div>

        <div class="row li-author">
    <div class="sixteen columns">
        Written by <strong>κeen</strong>
    </div>
</div>


        <div class="row li-pagination">
            <div class="eight columns">
                <div class="li-pagination-previous">
                    
                        Later article<br />
                        <a href="https://KeenS.github.io/blog/2018/02/24/kansuutekiyou_kansuukarahyoukasuruka_hikisuukarahyoukasuruka/"> 関数適用、関数から評価するか？引数から評価するか？</a>
                    
                </div>
            </div>
            <div class="eight columns">
                <div class="li-pagination-next">
                    
                        Older article<br />
                        <a href="https://KeenS.github.io/blog/2018/02/08/aratamemashiterockdbsan/"> 改めましてRocksDBさん</a>
                    
                </div>
            </div>
        </div>
    </div>

<footer class="li-page-footer">
    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <div class="li-page-footer-legal">
                    &copy; 2024. All rights reserved. 
                </div>
                <div class="li-page-footer-theme">
                    <span class=""><a href="https://github.com/eliasson/liquorice/">liquorice</a> is a theme for <a href="http://hugo.spf13.com">hugo</a></span>
                </div>
            </div>
        </div>
    </div>
</footer>

<script type="text/javascript">
 function toggle(id) {
     var e = document.getElementById(id);
     e.style.display == 'block' ? e.style.display = 'none' : e.style.display = 'block';
 }
</script>
<script src="https://unpkg.com/mermaid@7.0.4/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true
     });</script>

    </body>
</html>

