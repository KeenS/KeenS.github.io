<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
    <head>
        
        
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-43779888-1"></script>
        <script>
         window.dataLayer = window.dataLayer || [];
         function gtag(){dataLayer.push(arguments);}
         gtag('js', new Date());

         gtag('config', 'UA-43779888-1');
        </script>
        

        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

        <meta name="twitter:site" content="@blackenedgold" />
        <meta name="twitter:title" content="線形型の義務オブジェクトパターン | κeenのHappy Hacκing Blog"/>
        <meta name="twitter:description" content="κeenです。線形型でできる面白そうなパターンを思い付いたので書いときます。" />
        <meta property="og:title" content="線形型の義務オブジェクトパターン | κeenのHappy Hacκing Blog" />
        <meta property="og:type" content="article" />
        <meta property="og:url" content="https://KeenS.github.io/blog/2025/12/29/senkeikatanogimuobujiekutopata_n/" />
        <meta property="og:description" content="κeenです。線形型でできる面白そうなパターンを思い付いたので書いときます。" />
        
        <meta name="twitter:card" content="summary" />
        <meta property="og:article:published_time" content="2025-12-29 21:11:30 &#43;0900 JST" />
        <meta property="og:article:modified_time" content="2025-12-29 21:11:30 &#43;0900 JST" />
        
        <meta property="og:article:author" content="κeen" />

        <title>線形型の義務オブジェクトパターン | κeenのHappy Hacκing Blog</title>
        <link rel="stylesheet" href='//fonts.googleapis.com/css?family=Open+Sans:400,300,600' type='text/css' />
        <link rel="stylesheet" href="https://KeenS.github.io/libraries/normalize.3.0.1.css" />
        <link rel="stylesheet" href="https://KeenS.github.io/css/liquorice.css" />
        <link rel="apple-touch-icon" sizes="180x180" href="https://KeenS.github.io/apple-touch-icon.png">
        <link rel="icon" type="image/png" href="https://KeenS.github.io/favicon-32x32.png" sizes="32x32">
        <link rel="icon" type="image/png" href="https://KeenS.github.io/favicon-16x16.png" sizes="16x16">
        <link rel="manifest" href="https://KeenS.github.io/manifest.json">
        <link rel="mask-icon" href="https://KeenS.github.io/safari-pinned-tab.svg" color="#5bbad5">
        <meta name="theme-color" content="#ffffff">
        <link rel="apple-touch-icon-precomposed" href="https://KeenS.github.io/apple-touch-icon-144-precomposed.png" sizes="144x144" />
        <link rel="stylesheet" href="https://KeenS.github.io/css/syntax-monokai.css" />
<script type="text/x-mathjax-config">
 MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ["\\(","\\)"]] } });
</script>
<script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_CHTML"></script>
</script>
<meta http-equiv="X-UA-Compatible" CONTENT="IE=EmulateIE7" />
<link rel="stylesheet" href="//unpkg.com/mermaid@7.0.4/dist/mermaid.forest.min.css">

    </head>
    <body class="li-body">

<header class="li-page-header" id="page-header">
    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <div class="li-brand li-left">
                <a href="https://KeenS.github.io/">κeenのHappy Hacκing Blog</a> | Lispエイリアンの狂想曲</div>
                <div class="li-menu li-right">
                    <span class="li-menu-icon" onclick="javascript:toggle('menu');">&#9776;</span>
                    <ul id="menu2" class="li-menu-items">
                        
                            <li><a href="https://KeenS.github.io/about/"> About </a></li>
                        
                            <li><a href="https://KeenS.github.io/post/"> Blog </a></li>
                        
                            <li><a href="https://KeenS.github.io/slide/"> Slide </a></li>
                        
                            <li><a href="https://KeenS.github.io/index.xml"> Atom </a></li>
                        
                            <li><a href="https://KeenS.github.io/search/"> Search </a></li>
                        
                    </ul>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="sixteen columns">
                <ul id="menu" class="li-menu-items li-menu-mobile">
                    
                        <li><a href="https://KeenS.github.io/about/"> About </a></li>
                    
                        <li><a href="https://KeenS.github.io/post/"> Blog </a></li>
                    
                        <li><a href="https://KeenS.github.io/slide/"> Slide </a></li>
                    
                        <li><a href="https://KeenS.github.io/index.xml"> Atom </a></li>
                    
                        <li><a href="https://KeenS.github.io/search/"> Search </a></li>
                    
                </ul>
            </div>
        </div>
    </div>
</header>






    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <article class="li-article">
                    <header class="li-article-header">
                        <h1 class="li-article-title">線形型の義務オブジェクトパターン</h1>
                        <div class="li-article-meta">
    <time class="li-article-date">2025-12-29</time>
    <ul class="li-article-tag">
    
        <li>
            <a href="https://KeenS.github.io/categories/%e7%b7%9a%e5%bd%a2%e5%9e%8b">線形型</a>
        </li>
    
        <li>
            <a href="https://KeenS.github.io/categories/idris2">Idris2</a>
        </li>
    
</ul>

</div>

                    </header>
                    <section>
                        <p>κeenです。線形型でできる面白そうなパターンを思い付いたので書いときます。</p>
<p>まず、線形型とは値をちょうど一度だけ使えるような型です。つまり、二度使ったり一度も使わなかったりするとエラーになります。</p>
<p>線形型があるIdris2で実験してみましょう。Idris2では線形型を使った関数は <code>-&gt;</code> の代わりに <code>-@</code> (通称ロリポップ)で表現します。</p>
<p>まずは線形型な関数内で値を2回使うケース。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Data.Linear.Notation</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">dup</span><span class="ow">:</span> a <span class="ow">-@</span> <span class="ow">(</span>a, a<span class="ow">)</span>
</span></span><span class="line"><span class="cl">dup x <span class="ow">=</span> <span class="ow">(</span>x, x<span class="ow">)</span>
</span></span></code></pre></div><p>このコードをコンパイルするとエラーになります。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> idris2 -p linear -c dup.idr
</span></span><span class="line"><span class="cl"><span class="go">1/1: Building dup (dup.idr)
</span></span></span><span class="line"><span class="cl"><span class="go">Error: While processing right hand side of dup. Trying to use linear name x in non-linear context.
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">dup:4:13--4:14
</span></span></span><span class="line"><span class="cl"><span class="go"> 1 | import Data.Linear.Notation
</span></span></span><span class="line"><span class="cl"><span class="go"> 2 |
</span></span></span><span class="line"><span class="cl"><span class="go"> 3 | dup: a -@ (a, a)
</span></span></span><span class="line"><span class="cl"><span class="go"> 4 | dup x = (x, x)
</span></span></span><span class="line"><span class="cl"><span class="go">                 ^
</span></span></span></code></pre></div><p>ここまではRustの所有権と同じですね。しかしRustとは違って線形型はデータを使わないのも許しません。以下のコードをみてください。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Data.Linear.Notation</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">ignore</span><span class="ow">:</span> a <span class="ow">-@</span> <span class="ow">()</span>
</span></span><span class="line"><span class="cl">ignore a <span class="ow">=</span> <span class="ow">()</span>
</span></span></code></pre></div><p>引数 <code>a</code> を使わずに放置しています。これもコンパイルするとエラーになります。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> idris2 -p linear -c no_use.idr
</span></span><span class="line"><span class="cl"><span class="go">1/1: Building no_use (no_use.idr)
</span></span></span><span class="line"><span class="cl"><span class="go">Error: While processing right hand side of ignore. There are 0 uses of linear name a.
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">no_use:4:12--4:14
</span></span></span><span class="line"><span class="cl"><span class="go"> 1 | import Data.Linear.Notation
</span></span></span><span class="line"><span class="cl"><span class="go"> 2 |
</span></span></span><span class="line"><span class="cl"><span class="go"> 3 | ignore: a -@ ()
</span></span></span><span class="line"><span class="cl"><span class="go"> 4 | ignore a = ()
</span></span></span><span class="line"><span class="cl"><span class="go">                ^^
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">Suggestion: linearly bounded variables must be used exactly once.
</span></span></span></code></pre></div><p>今度は線形型はちょうど一度使わないとダメだよと指摘してくれてますね。</p>
<p>この線形型の値を「消費」するにはパターンマッチで分解してあげればよいです。例えば以下のようにコンストラクタ <code>MkData</code> を持つデータ型 <code>Data</code> を定義します。それを受けとる <code>destruct</code> 関数は先ほどの <code>ignore</code> と同じことをしていますが、コンストラクタでパターンマッチして分解しているのでこのコードはコンパイルが通ります。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Data.Linear.Notation</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">data</span> <span class="kt">Data</span> <span class="ow">=</span> <span class="kt">MkData</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">destruct</span><span class="ow">:</span> <span class="kt">Data</span> <span class="ow">-@</span> <span class="ow">()</span>
</span></span><span class="line"><span class="cl">destruct <span class="kt">MkData</span> <span class="ow">=</span> <span class="ow">()</span>
</span></span></code></pre></div><p>逆にいうとプリミティブにはこれ以外の方法がありません。コンストラクタが非公開なデータ型は生成したら最後、コンパイルを通す手段がなくなります。
もちろん、そんなコードを書くと不便なだけなのでやる人はいません。コンストラクタを非公開にするならその終了処理関数とセットで提供します。まさしく上の例がそうですね。
それっぽく公開範囲などをいじるとこんな感じのコードになるでしょうか。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Data.Linear.Notation</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">-- export: 名前だけ公開する</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- public export: コンストラクタまで公開する</span>
</span></span><span class="line"><span class="cl">export
</span></span><span class="line"><span class="cl"><span class="kr">data</span> <span class="kt">Data</span> <span class="ow">=</span> <span class="kt">MkData</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">-- データの生成</span>
</span></span><span class="line"><span class="cl">export
</span></span><span class="line"><span class="cl"><span class="nf">newData</span><span class="ow">:</span> <span class="ow">()</span> <span class="ow">-@</span> <span class="kt">Data</span>
</span></span><span class="line"><span class="cl">newData <span class="ow">()</span> <span class="ow">=</span> <span class="kt">MkData</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">-- データの破棄</span>
</span></span><span class="line"><span class="cl">export
</span></span><span class="line"><span class="cl"><span class="nf">destruct</span><span class="ow">:</span> <span class="kt">Data</span> <span class="ow">-@</span> <span class="ow">()</span>
</span></span><span class="line"><span class="cl">destruct <span class="kt">MkData</span> <span class="ow">=</span> <span class="ow">()</span>
</span></span></code></pre></div><p>上のコードはユーザには <code>Data</code> 、 <code>newData</code> 、 <code>destruct</code> しかみえていません。<code>newData</code> でデータを作り出し、必要がなくなったら <code>destruct</code> を呼び出して終了とします。
このようなパターンが活躍するシーンとしては終了処理に気を使うもの、例えばファイルディスクリプタとかそういうものを扱うときとかが挙げられます。Rustだとデータを無視すると暗黙に <code>drop</code> が呼ばれますが、そこで出たエラーを処理する方法がないのでエラーは無視されてしまいます。怖いですね。線形型ならユーザが必ずファイルを閉じる関数を呼ぶのでエラーは必ず通知されます。知らぬうちにエラーが出てるのに気づかず処理を継続してしまって思わぬバグになるなんてことを防げます。</p>
<p>さて、この線形型の終了処理を別の視点でみると、ユーザは<code>data</code> 型の値を受け取ったらどこかで <code>destruct</code> を呼び出さないといけない訳です。つまり、ある種の義務を押し付けることができると思いませんか？これを活用したパターンを義務オブジェクトパターンと呼んでみます。</p>
<p>本質的にはやってることは先の例と同じですが、例えばこんな感じに何か呼び出させたい関数 <code>callMe</code> があるとして、その関数を呼び出さないと消滅しないデータ型 <code>Obligation</code> を作ってあげると、その関数 <code>callMe</code> がどこかで呼ばれることが保証できます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl">export
</span></span><span class="line"><span class="cl"><span class="kr">data</span> <span class="kt">Obligation</span> <span class="ow">=</span>  <span class="kt">MkObligation</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">callFunc</span><span class="ow">:</span> <span class="ow">()</span> <span class="ow">-@</span> <span class="kt">Obligation</span>
</span></span><span class="line"><span class="cl">callFunc <span class="ow">()</span> <span class="ow">=</span> <span class="kt">MkObligation</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">callMe</span><span class="ow">:</span> <span class="kt">Obligation</span> <span class="ow">-@</span> <span class="ow">()</span>
</span></span><span class="line"><span class="cl">callMe <span class="kt">MkObligation</span> <span class="ow">=</span> <span class="ow">()</span> <span class="c1">-- do something</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">-- ユーザ側</span>
</span></span><span class="line"><span class="cl"><span class="nf">doSomething</span><span class="ow">:</span> <span class="kt">Obligation</span> <span class="ow">-@</span> <span class="ow">()</span>
</span></span><span class="line"><span class="cl">doSomething obl <span class="ow">=</span> callMe obl <span class="c1">-- 必ず callMeを呼ばないといけない</span>
</span></span></code></pre></div><p>さらに、Type Stateパターンを組み合わせると複数の関数を呼ばないといけなくすることもできます。
例えばこんなコードになるでしょうか。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-idris" data-lang="idris"><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Data.Linear.Notation</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">-- 義務オブジェクトをたくさん用意する</span>
</span></span><span class="line"><span class="cl">export
</span></span><span class="line"><span class="cl"><span class="kr">data</span> <span class="kt">Yak</span> <span class="ow">=</span> <span class="kt">MkYak</span>
</span></span><span class="line"><span class="cl">export
</span></span><span class="line"><span class="cl"><span class="kr">data</span> <span class="kt">CatchedYak</span> <span class="ow">=</span> <span class="kt">MkCatchedYak</span>
</span></span><span class="line"><span class="cl">export
</span></span><span class="line"><span class="cl"><span class="kr">data</span> <span class="kt">SleepingYak</span> <span class="ow">=</span> <span class="kt">MkSleepingYak</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">export
</span></span><span class="line"><span class="cl"><span class="nf">newYak</span><span class="ow">:</span> <span class="ow">()</span> <span class="ow">-@</span> <span class="kt">Yak</span>
</span></span><span class="line"><span class="cl">newYak <span class="ow">()</span> <span class="ow">=</span> <span class="kt">MkYak</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">-- 状態遷移関数たち</span>
</span></span><span class="line"><span class="cl"><span class="nf">catchYak</span><span class="ow">:</span> <span class="kt">Yak</span> <span class="ow">-@</span> <span class="kt">CatchedYak</span>
</span></span><span class="line"><span class="cl">catchYak <span class="kt">MkYak</span> <span class="ow">=</span> <span class="kt">MkCatchedYak</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">putYakSleep</span><span class="ow">:</span> <span class="kt">CatchedYak</span> <span class="ow">-@</span> <span class="kt">SleepingYak</span>
</span></span><span class="line"><span class="cl">putYakSleep <span class="kt">MkCatchedYak</span> <span class="ow">=</span> <span class="kt">MkSleepingYak</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">shaveYak</span><span class="ow">:</span> <span class="kt">SleepingYak</span> <span class="ow">-@</span> <span class="ow">()</span>
</span></span><span class="line"><span class="cl">shaveYak <span class="kt">MkSleepingYak</span> <span class="ow">=</span> <span class="ow">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">---</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- Yakを受けとった時点でcatchYak、putYakSleep、shaveYakを呼ばないといけないことが確定する</span>
</span></span><span class="line"><span class="cl"><span class="nf">handleYak</span><span class="ow">:</span> <span class="kt">Yak</span> <span class="ow">-@</span> <span class="ow">()</span>
</span></span><span class="line"><span class="cl">handleYak yak <span class="ow">=</span>
</span></span><span class="line"><span class="cl">  <span class="kr">let</span> catched <span class="ow">=</span> catchYak yak <span class="kr">in</span>
</span></span><span class="line"><span class="cl">  <span class="kr">let</span> sleeping <span class="ow">=</span> putYakSleep catched <span class="kr">in</span>
</span></span><span class="line"><span class="cl">  shaveYak sleeping
</span></span></code></pre></div><p>義務オブジェクト <code>Yak</code> が <code>catchYak</code> を強制し、さらに返り値に別の義務オブジェクト <code>CatchedYak</code> を返します。今度は <code>CatchedYak</code> が <code>putYakSleep</code> を強制し、さらにまた別の義務オブジェト <code>SleepingYak</code> を返します。最後に <code>SleepingYak</code> が <code>shaveYak</code> を呼び出させて、ようやくユーザは一連の処理を終えられる訳です。義務オブジェクトとType Stateで3つの関数の呼び出しを特定の順番で呼び出すことを強制できました。</p>
<p>この義務オブジェクトの実用的なユースケースは例えばスレッド間通信をするときに別スレッドに義務オブジェクトを与えて決められた手順通りに通信することを保証するとかですかね(セッション型の亜種)。他にもハードウェアの操作だとか何らかの要因で決められた手順を踏まないといけないケースでのガードレールになると思います。</p>
<p>まあ、そもそも線形型が使える言語がほとんどないのでこのテクニックを実用する場面はないんですが、逆にこういう線形型でできる面白いことの知識が蓄積されると普及の後押しになるかなと思って書いてみました。</p>
                    </section>
                </article>
            </div>
        </div>

        <div class="row li-author">
    <div class="sixteen columns">
        Written by <strong>κeen</strong>
    </div>
</div>


        <div class="row li-pagination">
            <div class="eight columns">
                <div class="li-pagination-previous">
                    
                        &nbsp;
                    
                </div>
            </div>
            <div class="eight columns">
                <div class="li-pagination-next">
                    
                        Older article<br />
                        <a href="https://KeenS.github.io/blog/2025/11/11/kawarujoutaiwokatadearawasu/"> 変わる状態を型で表わす</a>
                    
                </div>
            </div>
        </div>
    </div>

<footer class="li-page-footer">
    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <div class="li-page-footer-legal">
                    &copy; 2025. All rights reserved. 
                </div>
                <div class="li-page-footer-theme">
                    <span class=""><a href="https://github.com/eliasson/liquorice/">liquorice</a> is a theme for <a href="http://hugo.spf13.com">hugo</a></span>
                </div>
            </div>
        </div>
    </div>
</footer>

<script type="text/javascript">
 function toggle(id) {
     var e = document.getElementById(id);
     e.style.display == 'block' ? e.style.display = 'none' : e.style.display = 'block';
 }
</script>
<script src="https://unpkg.com/mermaid@7.0.4/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true
     });</script>

    </body>
</html>

